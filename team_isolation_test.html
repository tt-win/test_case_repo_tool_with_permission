<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ˜éšŠéš”é›¢æ¸¬è©¦é é¢</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-section { border: 1px solid #ddd; margin: 20px 0; padding: 15px; border-radius: 5px; }
        .test-section h3 { color: #333; margin-top: 0; }
        button {
            background: #007bff; color: white; border: none; padding: 10px 15px;
            margin: 5px; border-radius: 4px; cursor: pointer;
        }
        button:hover { background: #0056b3; }
        .success { background: #28a745; }
        .warning { background: #ffc107; color: #333; }
        .danger { background: #dc3545; }
        #output {
            background: #000; color: #0f0; font-family: monospace;
            padding: 15px; border-radius: 4px; height: 400px;
            overflow-y: auto; font-size: 12px;
        }
        .team-info {
            display: inline-block; padding: 5px 10px; margin: 5px;
            border-radius: 4px; background: #e9ecef;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” TRCache åœ˜éšŠéš”é›¢æ•ˆæœæ¸¬è©¦</h1>
        <p>æ­¤é é¢ç”¨æ–¼æ¸¬è©¦ TRCache v3.0 çš„åœ˜éšŠåˆ†é›¢å„²å­˜åŠŸèƒ½</p>

        <div class="test-section">
            <h3>ğŸ“Š ç³»çµ±ç‹€æ…‹</h3>
            <div class="team-info">TRCache ç‰ˆæœ¬: <span id="version">è¼‰å…¥ä¸­...</span></div>
            <div class="team-info">ç›£æ§ç‹€æ…‹: <span id="monitor">è¼‰å…¥ä¸­...</span></div>
            <div class="team-info">ç•¶å‰åœ˜éšŠID: <span id="currentTeam">è¼‰å…¥ä¸­...</span></div>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª å¿«é€Ÿæ¸¬è©¦</h3>
            <button onclick="runBasicTest()">åŸºæœ¬åŠŸèƒ½æ¸¬è©¦</button>
            <button onclick="runTeamSeparationTest()">åœ˜éšŠåˆ†é›¢æ¸¬è©¦</button>
            <button onclick="runFullIsolationTest()" class="success">å®Œæ•´éš”é›¢æ¸¬è©¦</button>
            <button onclick="checkCacheStructure()">æª¢æŸ¥å¿«å–çµæ§‹</button>
            <button onclick="clearOutput()">æ¸…é™¤è¼¸å‡º</button>
        </div>

        <div class="test-section">
            <h3>ğŸ› ï¸ èª¿è©¦å·¥å…·</h3>
            <button onclick="TRCacheDebug.diagnoseTeam()">è¨ºæ–·åœ˜éšŠä¿¡æ¯</button>
            <button onclick="TRCacheDebug.testStores()">æ¸¬è©¦Storeç”Ÿæˆ</button>
            <button onclick="TRCacheDebug.listCacheKeys()">åˆ—å‡ºå¿«å–Keys</button>
            <button onclick="TRCacheDebug.selfTest()">è‡ªæˆ‘æ¸¬è©¦</button>
            <button onclick="TRCacheDebug.clearAll()" class="danger">æ¸…é™¤æ‰€æœ‰å¿«å–</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ æ¸¬è©¦è¼¸å‡º</h3>
            <div id="output">è¼‰å…¥ TRCache...</div>
        </div>
    </div>

    <script src="/static/js/trcache.js"></script>
    <script>
        // é‡å®šå‘ console è¼¸å‡ºåˆ°é é¢
        const output = document.getElementById('output');
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function addToOutput(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : type === 'warn' ? '#ffd43b' : '#51cf66';
            output.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        console.log = (...args) => {
            originalLog.apply(console, args);
            addToOutput(args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : a).join(' '), 'log');
        };

        console.error = (...args) => {
            originalError.apply(console, args);
            addToOutput(args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : a).join(' '), 'error');
        };

        console.warn = (...args) => {
            originalWarn.apply(console, args);
            addToOutput(args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : a).join(' '), 'warn');
        };

        // é é¢è¼‰å…¥å¾Œåˆå§‹åŒ–
        window.addEventListener('load', () => {
            setTimeout(() => {
                updateSystemStatus();
                console.log('ğŸ‰ åœ˜éšŠéš”é›¢æ¸¬è©¦é é¢å·²æº–å‚™å°±ç·’');
                console.log('ğŸ“– ä½¿ç”¨æŒ‡å—:');
                console.log('1. é»æ“Š "å®Œæ•´éš”é›¢æ¸¬è©¦" é–‹å§‹å…¨é¢æ¸¬è©¦');
                console.log('2. ä½¿ç”¨èª¿è©¦å·¥å…·æª¢æŸ¥è©³ç´°ç‹€æ…‹');
                console.log('3. è§€å¯Ÿè¼¸å‡ºä¸­çš„æ¸¬è©¦çµæœ');
            }, 1000);
        });

        function updateSystemStatus() {
            document.getElementById('version').textContent = 'v3.0 (åœ˜éšŠåˆ†é›¢å„²å­˜)';
            document.getElementById('monitor').textContent = TRCache._monitoringEnabled ? 'âœ… å·²å•Ÿç”¨' : 'âŒ æœªå•Ÿç”¨';

            // å˜—è©¦ç²å–ç•¶å‰åœ˜éšŠID
            try {
                if (typeof AppUtils !== 'undefined' && AppUtils.getCurrentTeam) {
                    const team = AppUtils.getCurrentTeam();
                    document.getElementById('currentTeam').textContent = team?.id || 'ç„¡';
                } else {
                    document.getElementById('currentTeam').textContent = 'æ¨¡æ“¬æ¸¬è©¦æ¨¡å¼';
                }
            } catch (e) {
                document.getElementById('currentTeam').textContent = 'ç„¡æ³•ç²å–';
            }
        }

        async function runBasicTest() {
            console.log('ğŸ”§ é–‹å§‹åŸºæœ¬åŠŸèƒ½æ¸¬è©¦...');

            // æ¸¬è©¦åŸºæœ¬è®€å¯«
            const testData = { test: 'åŸºæœ¬åŠŸèƒ½æ¸¬è©¦', timestamp: Date.now() };
            const writeResult = await TRCache.setExecDetail('test1', 'TC001', testData);
            console.log('å¯«å…¥çµæœ:', writeResult ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—');

            if (writeResult) {
                const readResult = await TRCache.getExecDetail('test1', 'TC001');
                console.log('è®€å–çµæœ:', readResult ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—');
                if (readResult) {
                    console.log('è®€å–è³‡æ–™:', readResult.data);
                }
            }

            console.log('åŸºæœ¬åŠŸèƒ½æ¸¬è©¦å®Œæˆ');
        }

        async function runTeamSeparationTest() {
            console.log('ğŸ¢ é–‹å§‹åœ˜éšŠåˆ†é›¢æ¸¬è©¦...');

            const teams = ['team1', 'team2', null, undefined, ''];
            const results = TRCacheDebug.testTeamSeparation(...teams);

            console.log('åœ˜éšŠåˆ†é›¢æ¸¬è©¦å®Œæˆï¼Œçµæœ:', results);
        }

        async function runFullIsolationTest() {
            console.log('ğŸ¯ é–‹å§‹å®Œæ•´éš”é›¢æ¸¬è©¦...');
            try {
                const result = await TRCacheDebug.fullIsolationTest();
                console.log('å®Œæ•´éš”é›¢æ¸¬è©¦å®Œæˆï¼Œç¸½é«”çµæœ:', result.success ? 'âœ… é€šé' : 'âŒ å¤±æ•—');
                return result;
            } catch (error) {
                console.error('å®Œæ•´éš”é›¢æ¸¬è©¦ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }

        async function checkCacheStructure() {
            console.log('ğŸ“‹ æª¢æŸ¥å¿«å–çµæ§‹...');
            const structure = await TRCacheDebug.listCacheKeys();
            console.log('å¿«å–çµæ§‹æª¢æŸ¥å®Œæˆ');
            return structure;
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '<div style="color: #51cf66;">è¼¸å‡ºå·²æ¸…é™¤</div>';
        }
    </script>
</body>
</html>