{% extends "base.html" %}

{% block title %}{{ i18n.t('testRun.execution') if i18n else 'Test Run 執行' }} - Test Case Repository Web Tool{% endblock %}

{% block head %}
<!-- Markdown 編輯器相關資源 -->
<script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>

<script>
function setupQuickSearch_TR() {
    if (!document.getElementById('quickSearchOverlay')) {
        const overlay = document.createElement('div');
        overlay.id = 'quickSearchOverlay';
        overlay.style.cssText = 'position:fixed;inset:0;z-index:1060;display:none;background:rgba(0,0,0,0.35)';
        overlay.innerHTML = `
          <div class="position-fixed" style="top:34vh; left:50%; transform: translateX(-50%); width:min(720px, 92vw);">
            <div class="card shadow">
              <div class="card-body p-2">
                <input id="quickSearchInput" type="text" class="form-control form-control-lg" placeholder="${window.i18n ? window.i18n.t('testRun.searchTestCases') : '搜尋測試案例...'}" autocomplete="off" />
                <div id="quickSearchResults" class="list-group list-group-flush" style="max-height:30vh; overflow:auto;"></div>
              </div>
            </div>
          </div>`;
        document.body.appendChild(overlay);
        // 語言切換時即時更新 placeholder
        try {
            const applyPlaceholder = () => {
                const el = document.getElementById('quickSearchInput');
                if (!el) return;
                if (window.i18n && window.i18n.isReady && window.i18n.isReady()) {
                    let text = window.i18n.t('testRun.searchTestCases');
                    if (!text || text === 'testRun.searchTestCases') {
                        // 後備：沿用 testCase 的搜尋文案或硬編碼中文
                        const alt = window.i18n.t('testCase.searchTestCases');
                        text = (alt && alt !== 'testCase.searchTestCases') ? alt : '搜尋測試案例...';
                    }
                    el.placeholder = text;
                } else {
                    el.placeholder = '搜尋測試案例...';
                }
            };
            applyPlaceholder();
            document.addEventListener('languageChanged', applyPlaceholder);
            document.addEventListener('i18nReady', applyPlaceholder);
        } catch (_) {}
        overlay.addEventListener('click', (e)=>{ if(e.target===overlay) closeQuickSearch_TR(); });
    }
    document.addEventListener('keydown', function(e){
        const tag = (e.target && e.target.tagName || '').toLowerCase();
        const isTyping = ['input','textarea','select'].includes(tag) || (e.target && e.target.isContentEditable);
        if (!isTyping && e.key === '/' && !e.ctrlKey && !e.metaKey && !e.altKey) {
            e.preventDefault();
            openQuickSearch_TR();
        }
    });
}
function openQuickSearch_TR() {
    const overlay = document.getElementById('quickSearchOverlay');
    const input = document.getElementById('quickSearchInput');
    const results = document.getElementById('quickSearchResults');
    if (!overlay || !input || !results) return;
    overlay.style.display = 'block';
    input.value = '';
    results.innerHTML = '';
    input.focus();
    const handleKey = (e) => {
        if (e.key === 'Escape') { closeQuickSearch_TR(); return; }
        if (e.key === 'Enter') {
            const active = results.querySelector('.active');
            if (active) { active.click(); }
        } else if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
            e.preventDefault();
            const items = Array.from(results.querySelectorAll('.list-group-item'));
            if (items.length === 0) return;
            let idx = items.findIndex(li => li.classList.contains('active'));
            if (idx < 0) idx = 0;
            idx = (e.key === 'ArrowDown') ? Math.min(idx+1, items.length-1) : Math.max(idx-1, 0);
            items.forEach(li => li.classList.remove('active'));
            items[idx].classList.add('active');
            items[idx].scrollIntoView({ block:'nearest' });
        }
    };
    input.onkeydown = handleKey;
    input.oninput = () => quickSearchRender_TR(input.value, results);
}
function closeQuickSearch_TR() {
    const overlay = document.getElementById('quickSearchOverlay');
    if (overlay) overlay.style.display = 'none';
}
function quickSearchRender_TR(query, container) {
    const q = (query || '').trim().toLowerCase();
    let matches = [];
    if (q.length > 0) {
        matches = (testRunItems || []).filter(it => {
            const num = (it.test_case_number || '').toLowerCase();
            const title = (it.title || '').toLowerCase();
            return num.includes(q) || title.includes(q);
        }).slice(0, 100);
    }
    if (matches.length === 0) {
        const noText = window.i18n ? window.i18n.t('errors.noMatchingTestCases') : '沒有找到符合條件的測試案例';
        container.innerHTML = `<div class="list-group-item text-muted">${noText}</div>`;
        return;
    }
    container.innerHTML = matches.map((it, idx) => `
      <button type="button" class="list-group-item list-group-item-action ${idx===0?'active':''}" data-num="${it.test_case_number}">
        <div class="d-flex justify-content-between align-items-center">
          <code class="small me-2">${escapeHtml(it.test_case_number || '')}</code>
          <span class="text-truncate">${escapeHtml(it.title || '')}</span>
        </div>
      </button>`).join('');
    
    // 重新應用翻譯到新生成的內容
    if (window.i18n && window.i18n.isReady()) {
        window.i18n.retranslate(container);
    }
    container.querySelectorAll('.list-group-item').forEach(btn => {
        btn.addEventListener('click', async () => {
            const tcNum = btn.getAttribute('data-num');
            closeQuickSearch_TR();
            if (tcNum) {
                await showTestCaseDetailModal(tcNum);
            }
        });
    });
}
</script>
<script>
// Configure marked to treat single newlines as <br> so previews show line breaks
if (window.marked && typeof window.marked.setOptions === 'function') {
    window.marked.setOptions({
        breaks: true,
        gfm: true,
        headerIds: false,
        mangle: false
    });
}
</script>

<!-- Test Run 執行頁面樣式 -->
<style>
/* Test Run 執行頁面整體布局 */
.test-run-execution {
    height: calc(100vh - 140px);
    display: flex;
    flex-direction: column;
}



/* 統計資訊樣式 */
.execution-stats {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
    flex-wrap: wrap;
}

.stat-item {
    background: var(--tr-bg-light);
    padding: 0.375rem 0.75rem;
    border-radius: 0.375rem;
    border: 1px solid var(--tr-border-light);
    min-width: 120px;
    text-align: center;
    transition: all 0.2s ease;
}

/* Bug Tickets 卡片 hover 效果 */
.stat-item.bug-tickets-card:hover {
    background: #fff3cd;
    border-color: #ffc107;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(255, 193, 7, 0.2);
}

.stat-number {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--tr-primary);
    line-height: 1.2;
}

.stat-label {
    font-size: 0.8rem;
    color: var(--tr-text-muted);
    line-height: 1.2;
}

/* Test Run Items 表格樣式 */
.test-run-items-container {
    flex: 1;
    overflow: hidden;
    border: 1px solid var(--tr-border-light);
    border-radius: 0.375rem;
}

.test-run-items-table {
    height: 100%;
    overflow-y: auto;
}

.test-run-items-table table {
    margin-bottom: 0;
}

.test-run-items-table th {
    position: sticky;
    top: 0;
    background: var(--tr-bg-sidebar);
    z-index: 10;
    border-bottom: 2px solid var(--tr-border);
    vertical-align: middle;
    padding: 0.75rem 0.5rem;
    font-weight: 600;
    white-space: nowrap; /* 防止標頭折行 */
}

.test-run-items-table td {
    vertical-align: middle;
    padding: 0.75rem 0.5rem;
}

/* 表格欄位寬度標準化 */
.test-run-items-table th:nth-child(1), 
.test-run-items-table td:nth-child(1) { /* checkbox */
    width: 25px;
    min-width: 25px;
    text-align: center;
    padding: 0.5rem 0.25rem;
}

.test-run-items-table th:nth-child(2), 
.test-run-items-table td:nth-child(2) { /* 案例編號 */
    width: 170px;
    min-width: 170px;
    text-align: left;
}

.test-run-items-table th:nth-child(3), 
.test-run-items-table td:nth-child(3) { /* 標題 */
    min-width: 200px;
    text-align: left;
}

.test-run-items-table th:nth-child(4), 
.test-run-items-table td:nth-child(4) { /* 優先級 */
    width: 120px;
    min-width: 120px;
    text-align: center;
}

.test-run-items-table th:nth-child(5), 
.test-run-items-table td:nth-child(5) { /* 測試結果 */
    width: 170px;
    min-width: 170px;
    text-align: center;
}

.test-run-items-table th:nth-child(6), 
.test-run-items-table td:nth-child(6) { /* 執行者 */
    width: 175px;
    min-width: 175px;
    text-align: center;
}

.test-run-items-table th:nth-child(7), 
.test-run-items-table td:nth-child(7) { /* 執行時間 */
    width: 160px;
    min-width: 160px;
    text-align: center;
}



/* 測試結果選擇器樣式 */
.result-selector {
    min-width: 140px;
}

.result-selector select {
    border: none;
    background: transparent;
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
}

/* 大尺寸測試結果選擇器 */
.result-selector-lg {
    min-width: 150px;
    text-align: center; /* 讓容器內文字置中（對部分瀏覽器有幫助） */
}

.result-selector-lg select {
    font-size: 0.95rem;
    padding: 0.375rem 0.75rem;
    border: 1px solid var(--tr-border-light);
    border-radius: 0.25rem;
    text-align: center;           /* 置中文本 */
    text-align-last: center;      /* 大多數瀏覽器對齊選中項 */
    -moz-text-align-last: center; /* Firefox 專用前綴 */
}

/* 作為回退，讓下拉選項本身也置中 */
.result-selector-lg select option {
    text-align: center;
}

/* 大尺寸優先級 badge */
.priority-badge-lg {
    font-size: 0.85rem;
    padding: 0.4rem 0.8rem;
    font-weight: 500;
}

/* 大尺寸測試結果 badge */
.result-badge-lg {
    font-size: 0.85rem;
    padding: 0.4rem 0.8rem;
    font-weight: 500;
    display: inline-block;        /* 讓寬度可控制並可置中內容 */
    text-align: center;           /* 置中文本 */
    min-width: 140px;             /* 與下拉寬度接近，視覺對齊 */
}

/* 執行者編輯器樣式 */
.assignee-editor {
    border: 1px solid transparent;
    background: transparent;
    transition: all 0.2s ease;
    text-align: center;
    width: 100%;
}

.assignee-editor:hover {
    border-color: var(--tr-border-light);
    background: var(--tr-bg-light);
}

.assignee-editor:focus {
    border-color: var(--tr-primary);
    background: white;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.1);
}

.result-passed { color: var(--tr-success-dark); background: var(--tr-success-light); }
.result-failed { color: var(--tr-danger-dark); background: var(--tr-danger-light); }
.result-retest { color: var(--tr-warning-dark); background: var(--tr-warning-light); }
.result-na { color: var(--tr-secondary-dark); background: var(--tr-secondary-light); }
.result-pending { color: var(--tr-text-muted); background: var(--tr-bg-light); }

/* 操作按鈕樣式 */
.item-actions {
    display: flex;
    gap: 0.25rem;
}

.btn-icon-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

/* 可點擊項目樣式 */
.test-run-items-table a {
    color: var(--tr-primary);
    cursor: pointer;
}

.test-run-items-table a:hover {
    color: var(--tr-primary-dark, #0056b3);
    text-decoration: underline !important;
}

.test-run-items-table code a {
    color: inherit;
}

.test-run-items-table code a:hover {
    color: var(--tr-primary);
}

/* 表格行 hover 效果優化 */
.test-run-items-table tbody tr:hover {
    background-color: var(--tr-bg-light, #f8f9fa);
    transition: background-color 0.15s ease-in-out;
}

/* 表格整體美化 */
.test-run-items-table table {
    border-collapse: separate;
    border-spacing: 0;
}

.test-run-items-table th:first-child {
    border-top-left-radius: 0.375rem;
}

.test-run-items-table th:last-child {
    border-top-right-radius: 0.375rem;
}

/* Checkbox 欄位狀態控制 */
.checkbox-cell {
    width: 25px !important;
    padding: 0.5rem 0.25rem !important;
}

/* 隱藏 checkbox 欄位的樣式（completed 狀態） */
.test-run-items-table.hide-checkbox #checkbox-header,
.test-run-items-table.hide-checkbox .checkbox-cell {
    display: none !important;
}

/* 批次操作工具區樣式（統一與 Test Case Management） */
#batchOperationsToolbar {
    white-space: nowrap; /* 保持單行，不加背景與邊框 */
}

/* 響應式調整 */
@media (max-width: 768px) {
    .execution-stats {
        justify-content: center;
    }
    
    .stat-item {
        min-width: 100px;
    }
    
    /* 小螢幕時批次操作區域換行顯示 */
    .d-flex.flex-wrap.gap-3.align-items-center {
        flex-direction: column;
        align-items: stretch !important;
        gap: 1rem !important;
    }
    
    #batchOperationsToolbar {
        justify-content: center;
    }
    
    /* 小螢幕時隱藏部分欄位 */
    .test-run-items-table th:nth-child(7),
    .test-run-items-table td:nth-child(7) {
        display: none;
    }
}
/* Test Case 詳細資料 Modal 內部固定與捲動區域 */
#testCaseDetailModal .modal-dialog { max-height: 95vh; }
#testCaseDetailModal .modal-content { display: flex; max-height: 95vh; }
#testCaseDetailModal .modal-body { display: flex; flex-direction: column; overflow: hidden; }
#testCaseDetailFixed { flex: 0 0 auto; }
#testCaseDetailScrollable { flex: 1 1 auto; overflow-y: auto; min-height: 0; max-height: 100%; }

/* Bug Tickets Summary Modal 樣式 */
#bugTicketsSummaryModal .modal-dialog {
    max-width: 800px;
    max-height: 90vh;
}

#bugTicketsSummaryModal .modal-content {
    height: 600px;
    display: flex;
    flex-direction: column;
}

#bugTicketsSummaryModal .modal-body {
    flex: 1;
    padding: 1rem;
    overflow-y: auto;
}

/* 確保 Bug Tickets 內容區域可見 */
#bugTicketsSummaryContent {
    width: 100%;
    min-height: 200px;
}

#bugTicketsList {
    width: 100%;
    min-height: 100px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 0.5rem;
}

#bugTicketsSummaryList {
    width: 100%;
    min-height: 100px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 0.5rem;
}

/* Bug tickets 卡片樣式 */
.bug-ticket-card {
    border: 1px solid var(--tr-border-light);
    border-radius: 0.5rem;
    background: white;
    margin-bottom: 1rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: all 0.2s ease;
    overflow: hidden;
}

.bug-ticket-card:hover {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
}

.bug-ticket-card-body {
    display: flex;
    min-height: 120px;
}

.bug-ticket-left-panel {
    flex: 0 0 200px;
    background: #f8f9fa;
    border-right: 1px solid var(--tr-border-light);
    padding: 1rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
}

.bug-ticket-number {
    font-weight: 600;
    color: var(--tr-primary);
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    text-decoration: none;
}

.bug-ticket-number:hover {
    text-decoration: underline;
    color: var(--tr-primary);
}

.bug-ticket-status {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.bug-ticket-summary {
    font-size: 0.8rem;
    color: var(--tr-text-muted);
    line-height: 1.3;
    text-align: center;
}

.bug-ticket-right-panel {
    flex: 1;
    padding: 1rem;
}

.test-cases-header {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--tr-text-dark);
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.test-cases-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    max-height: 200px;
    overflow-y: auto;
}

.test-case-item {
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--tr-border-light);
    border-radius: 0.25rem;
    background: #f8f9fa;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.85rem;
}

.test-case-item:hover {
    background: #e9ecef;
    border-color: var(--tr-primary);
    transform: translateX(2px);
}

.test-case-number {
    font-weight: 600;
    color: var(--tr-primary);
}

.test-case-result {
    font-size: 0.75rem;
    padding: 0.1rem 0.4rem;
    border-radius: 0.2rem;
    margin-left: auto;
}

/* 空狀態樣式 */
.bug-tickets-empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--tr-text-muted);
    text-align: center;
}

.bug-tickets-empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.3;
}

/* 響應式設計 */
@media (max-width: 768px) {
    #bugTicketsSummaryModal .modal-dialog {
        max-width: 95vw;
        margin: 0.5rem;
    }
    
    #bugTicketsSummaryModal .modal-content {
        height: 85vh;
    }
    
    .bug-ticket-card-body {
        flex-direction: column;
        min-height: auto;
    }
    
    .bug-ticket-left-panel {
        flex: none;
        border-right: none;
        border-bottom: 1px solid var(--tr-border-light);
        padding: 0.75rem;
    }
    
    .bug-ticket-right-panel {
        padding: 0.75rem;
    }
    
    .test-cases-list {
        max-height: 150px;
    }
}

/* Timeline 樣式 */
.timeline-item { position: relative; padding-left: 1rem; margin-bottom: 0.75rem; }
.timeline-item::before { content: ''; position: absolute; left: 0.38rem; top: 0.2rem; width: 8px; height: 8px; border-radius: 50%; background-color: var(--tr-primary, #0d6efd); }
.timeline-item .time { font-size: 0.75rem; color: var(--tr-text-muted); }
.timeline-item .status { font-size: 0.85rem; font-weight: 500; }
.timeline-divider { height: 1px; background: var(--tr-border-light); margin: 0.25rem 0 0.5rem; }

/* 淡色區塊配色（保留配色，不影響捲動） */
.section-block { padding: 0.75rem; border-radius: 0.375rem; border: 1px solid var(--tr-border-light); }
.section-precondition { background: rgba(13, 110, 253, 0.06); border-color: rgba(13, 110, 253, 0.2); }
.section-steps { background: rgba(255, 193, 7, 0.08); border-color: rgba(255, 193, 7, 0.25); }
.section-expected { background: rgba(25, 135, 84, 0.08); border-color: rgba(25, 135, 84, 0.25); }
.section-attachments { background: rgba(108, 117, 125, 0.06); border-color: rgba(108, 117, 125, 0.25); }

/* AssigneeSelector 在 Modal 中的樣式調整 */
#testCaseDetailModal .assignee-selector-container {
    width: 100%;
}

#testCaseDetailModal .assignee-selector-container .form-control {
    text-align: left;
}

/* Basic Info 區域樣式 */
.basic-info-body {
    padding-top: 0.25rem;
    padding-bottom: 0.25rem;
}

.basic-info-table {
    line-height: 1.2;
}

.basic-info-label {
    font-weight: 600;
    width: 15%;
    font-size: 0.85rem;
    padding: 0.15rem 0.5rem;
}

.basic-info-label-top {
    vertical-align: top;
}

.basic-info-value {
    padding: 0.15rem 0.5rem;
}

.basic-info-code {
    font-size: 0.85rem;
}

.basic-info-title {
    word-break: break-word;
    font-size: 0.9rem;
}

.basic-info-badge {
    font-size: 0.75rem;
}

.basic-info-input {
    font-size: 0.9rem;
}

/* Scrollable Content 區域樣式 */
.scrollable-content-card {
    border: none;
}

.scrollable-content-body {
    padding: 1rem;
}

/* Content Markdown 樣式 */
.content-markdown {
    font-size: 0.9rem;
}

#testCaseDetailModal .assignee-selector-dropdown {
    z-index: 1060; /* 高於 Modal 的 z-index */
    left: 0;
    right: auto;
    text-align: left;
}

#testCaseDetailModal .assignee-selector-item {
    text-align: left;
    justify-content: flex-start;
}

/* Markdown 內容樣式（Test Case Detail Modal） */
#testCaseDetailModal .markdown-preview {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6;
}
#testCaseDetailModal .markdown-preview h1,
#testCaseDetailModal .markdown-preview h2,
#testCaseDetailModal .markdown-preview h3,
#testCaseDetailModal .markdown-preview h4,
#testCaseDetailModal .markdown-preview h5,
#testCaseDetailModal .markdown-preview h6 {
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    font-weight: 600;
}
#testCaseDetailModal .markdown-preview h1 { font-size: 1.4rem; }
#testCaseDetailModal .markdown-preview h2 { font-size: 1.2rem; }
#testCaseDetailModal .markdown-preview h3 { font-size: 1.05rem; }
#testCaseDetailModal .markdown-preview h4 { font-size: 0.95rem; }
#testCaseDetailModal .markdown-preview h5 { font-size: 0.9rem; }
#testCaseDetailModal .markdown-preview h6 { font-size: 0.85rem; }
#testCaseDetailModal .markdown-preview ul,
#testCaseDetailModal .markdown-preview ol {
    padding-left: 1.5rem;
    margin-bottom: 1rem;
}
#testCaseDetailModal .markdown-preview code {
    background-color: var(--tr-bg-sidebar);
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
}
#testCaseDetailModal .markdown-preview pre {
    background-color: var(--tr-bg-sidebar);
    padding: 0.75rem;
    border-radius: 0.375rem;
    overflow-x: auto;
}
#testCaseDetailModal .markdown-preview pre code {
    background: none;
    padding: 0;
}
#testCaseDetailModal .markdown-preview a {
    color: var(--tr-primary);
    text-decoration: none;
}
#testCaseDetailModal .markdown-preview a:hover {
    text-decoration: underline;
}
#testCaseDetailModal .markdown-preview blockquote {
    border-left: 4px solid var(--tr-primary);
    margin: 1rem 0;
    padding-left: 1rem;
    color: var(--tr-text-muted);
}
#testCaseDetailModal .markdown-preview table {
    border-collapse: collapse;
    width: 100%;
    margin: 1rem 0;
}
#testCaseDetailModal .markdown-preview th,
#testCaseDetailModal .markdown-preview td {
    border: 1px solid var(--tr-border-light);
    padding: 0.5rem;
    text-align: left;
}
#testCaseDetailModal .markdown-preview th {
    background-color: var(--tr-bg-light);
    font-weight: 600;
}
</style>
{% endblock %}

{% block page_title_text %}
<span data-i18n="testRun.execution">Test Run 執行</span>
{% endblock %}

{% block page_subtitle_text %}
<span id="test-run-subtitle" data-i18n="testRun.executeTestRun">執行測試案例並記錄結果</span>
{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2">
    <button type="button" class="btn btn-success" id="startBtn" style="display: none;">
        <i class="fas fa-play me-2"></i><span data-i18n="testRun.startExecution">開始執行</span>
    </button>
    <button type="button" class="btn btn-warning" id="completeBtn" style="display: none;">
        <i class="fas fa-stop me-2"></i><span data-i18n="testRun.completeExecution">結束執行</span>
    </button>
    <button type="button" class="btn btn-info" id="restartBtn" style="display: none;">
        <i class="fas fa-redo me-2"></i><span data-i18n="testRun.restartExecution">重新執行</span>
    </button>
    <div class="ms-auto d-flex gap-2">
        <button type="button" class="btn btn-outline-primary" id="exportBtn">
            <i class="fas fa-chart-pie me-2"></i><span data-i18n="testRun.chartsReports">Charts & Reports</span>
        </button>
        <button type="button" class="btn btn-secondary" id="refreshBtn">
            <i class="fas fa-sync-alt me-2"></i><span data-i18n="common.refresh">重新整理</span>
        </button>
        <a href="/test-run-management" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i><span data-i18n="navigation.backToManagement">回到管理</span>
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid test-run-execution">
    <!-- 移除全頁載入狀態，改在列表區顯示載入動畫 -->

    <!-- Test Run 資訊與控制區 -->
    <div id="test-run-header" style="display: none;">
        <!-- 統計資訊區域已簡化 -->

        <!-- 統計資訊和批次操作一體化區域 -->
        <div class="d-flex flex-wrap gap-3 align-items-center">
            <!-- 統計資訊 -->
            <div class="execution-stats flex-grow-1">
                <div class="stat-item">
                    <div class="stat-number" id="total-count">0</div>
                    <div class="stat-label" data-i18n="testRun.totalItems">總項目</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="executed-count">0</div>
                    <div class="stat-label" data-i18n="testRun.executedItems">已執行</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number text-success" id="passed-count">0</div>
                    <div class="stat-label" data-i18n="testRun.passedItems">Passed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number text-danger" id="failed-count">0</div>
                    <div class="stat-label" data-i18n="testRun.failedItems">Failed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="execution-rate">0%</div>
                    <div class="stat-label" data-i18n="testRun.executionRate">執行率</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="pass-rate">0%</div>
                    <div class="stat-label" data-i18n="testRun.passRate">通過率</div>
                </div>
                <div class="stat-item bug-tickets-card" onclick="showBugTicketsModal()" style="cursor: pointer;">
                    <div class="stat-number text-warning" id="bug-tickets-count">0</div>
                    <div class="stat-label" data-i18n="testRun.bugTicketsCount">Bug Tickets</div>
                </div>
            </div>
            
            <!-- 批次操作工具區 -->
            <div id="batchOperationsToolbar" class="d-none d-flex align-items-center gap-2 ms-lg-auto mb-2 mb-lg-0">
                <button type="button" class="btn btn-outline-secondary btn-sm" id="clearSelectionExecBtn" data-i18n-title="common.clearSelection" title="清除選取">
                    <i class="fas fa-xmark"></i>
                </button>
                <span class="text-muted" id="selectedItemsCount" data-i18n="testRun.selectedItemsCount" data-i18n-params='{"count": 0}'>已選取 0 個項目</span>
                <button type="button" class="btn btn-primary btn-sm" id="batchModifyBtn">
                    <i class="fas fa-edit me-2"></i><span data-i18n="testRun.batchModify">批次修改</span>
                </button>
                <button type="button" class="btn btn-danger btn-sm" id="batchDeleteBtn">
                    <i class="fas fa-trash me-2"></i><span data-i18n="testRun.batchDelete">批次刪除</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Test Run Items 表格 -->
    <div id="test-run-items-container" class="test-run-items-container" style="display: none;">
        <!-- 列表區載入動畫（預設隱藏） -->
        <div id="items-loading" class="align-items-center justify-content-center py-5 d-none" style="min-height: 240px;">
            <div class="text-center text-muted">
                <div class="spinner-border text-primary" role="status"></div>
                <div class="mt-2" data-i18n="testRun.loadingItems">載入測試項目中...</div>
            </div>
        </div>

        <div class="test-run-items-table">
            <table class="table table-hover table-sm">
                <thead>
                    <tr id="table-header-row">
                        <th id="checkbox-header">
                            <input type="checkbox" class="form-check-input" id="selectAllItemsCheckbox">
                        </th>
                        <th><span data-i18n="testRun.caseNumber">案例編號</span></th>
                        <th><span data-i18n="testRun.caseTitle">標題</span></th>
                        <th><span data-i18n="testRun.priority">優先級</span></th>
                        <th><span data-i18n="testRun.testResult">測試結果</span></th>
                        <th><span data-i18n="testRun.assignee">執行者</span></th>
                        <th><span data-i18n="testRun.executedAt">執行時間</span></th>
                    </tr>
                </thead>
                <tbody id="items-table-body">
                    <!-- Test Run Items 將在此處動態載入 -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Test Run Item 詳情 Modal -->
<div class="modal fade" id="itemDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-clipboard-list me-2"></i>
                    <span data-i18n="testRun.itemDetails">測試項目詳情</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="item-detail-content">
                <!-- 詳情內容將動態載入 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" data-i18n="common.close">關閉</button>
            </div>
        </div>
    </div>
</div>

<!-- 確認對話框 -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    <span data-i18n="common.confirm">確認操作</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirm-message"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-primary" id="confirm-action-btn" data-i18n="common.confirm">確認</button>
            </div>
        </div>
    </div>
</div>

<!-- 批次修改模態框 -->
<div class="modal fade" id="batchModifyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit text-primary me-2"></i>
                    <span data-i18n="testRun.batchModify">批次修改</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">
                    <span data-i18n="testRun.batchModifyDescription">將對選中的</span>
                    <strong id="batchModifyCount">0</strong>
                    <span data-i18n="testRun.itemsApplyChanges">個項目套用以下變更：</span>
                </p>
                
                <!-- 執行者批次設定 -->
                <div class="mb-3">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="batchModifyAssignee" checked>
                        <label class="form-check-label" for="batchModifyAssignee">
                            <strong data-i18n="testRun.batchSetAssignee">批次設定執行者</strong>
                        </label>
                    </div>
                    <input type="text" class="form-control" id="batchAssigneeInput" 
                           data-assignee-selector
                           data-i18n-placeholder="testRun.enterAssigneeName"
                           placeholder="{{ i18n.t('testRun.enterAssigneeName') if i18n else '輸入執行者姓名' }}">
                </div>
                
                <!-- 測試結果批次設定 -->
                <div class="mb-3" id="batchResultSection">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="batchModifyResult">
                        <label class="form-check-label" for="batchModifyResult">
                            <strong data-i18n="testRun.batchSetResult">批次設定測試結果</strong>
                            <br><small class="text-muted" data-i18n="testRun.onlyActiveStatus">（僅適用於執行中狀態）</small>
                        </label>
                    </div>
                    <select class="form-select" id="batchResultSelect" disabled>
                        <option value="" data-i18n="testRun.selectResult">請選擇結果</option>
                        <option value="Passed" data-i18n="testRun.passed">Passed</option>
                        <option value="Failed" data-i18n="testRun.failed">Failed</option>
                        <option value="Retest" data-i18n="testRun.retest">Retest</option>
                        <option value="Not Available" data-i18n="testRun.notAvailable">Not Available</option>
                    </select>
                </div>
                
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    <span data-i18n="testRun.batchModifyNote">只會套用已勾選的項目，空白值將不會變更現有資料。</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-primary" id="confirmBatchModifyBtn">
                    <i class="fas fa-edit me-2"></i><span data-i18n="testRun.confirmModify">確認修改</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 重新執行模態框 -->
<div class="modal fade" id="restartModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-redo text-info me-2"></i>
                    <span data-i18n="testRun.restartExecution">重新執行 Test Run</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3" data-i18n="testRun.selectRestartMode">請選擇重新執行模式：</p>
                
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="restartMode" id="restartAll" value="all" checked>
                    <label class="form-check-label" for="restartAll">
                        <strong data-i18n="testRun.restartAllItems">全部重新執行</strong>
                        <br><small class="text-muted" data-i18n="testRun.restartAllDescription">清空所有項目的測試結果，重新開始執行</small>
                    </label>
                </div>
                
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="restartMode" id="restartFailed" value="failed">
                    <label class="form-check-label" for="restartFailed">
                        <strong data-i18n="testRun.restartFailedItems">只執行失敗的項目</strong>
                        <br><small class="text-muted" data-i18n="testRun.restartFailedDescription">只清空標記為「失敗」和「重測」的項目結果</small>
                    </label>
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="restartMode" id="restartPending" value="pending">
                    <label class="form-check-label" for="restartPending">
                        <strong data-i18n="testRun.restartPendingItems">只執行未完成的項目</strong>
                        <br><small class="text-muted" data-i18n="testRun.restartPendingDescription">只清空尚未執行的項目，保留已通過的結果</small>
                    </label>
                </div>
                <div class="mb-3">
                    <label for="rerunNameInput" class="form-label" data-i18n="testRun.rerunNameLabel">新的 Test Run 名稱</label>
                    <input type="text" class="form-control" id="rerunNameInput" placeholder="Rerun - ">
                    <small class="text-muted" data-i18n="testRun.rerunNameHint">預設為「Rerun - 原有名稱」</small>
                </div>
                
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span data-i18n="testRun.restartWarning">重新執行會將 Test Run 狀態重置為「執行中」，請確認後繼續。</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-info" id="confirmRestartBtn">
                    <i class="fas fa-redo me-2"></i><span data-i18n="testRun.confirmRestart">確認重新執行</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Test Case 詳細資料 Modal -->
<div class="modal fade" id="testCaseDetailModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header align-items-center">
                <h5 class="modal-title d-flex align-items-center">
                    <i class="fas fa-tasks me-2"></i>
                    <span data-i18n="testRun.testCaseDetails">Test Case 詳細資料</span>
                </h5>
                <!-- Test Result 下拉/Badge：緊貼在標題後面 -->
                <div id="testCaseDetailHeaderResult" class="ms-3" style="min-width: 170px;"></div>
                <!-- 標頭靠右：上一隻 / 下一隻 / 關閉 -->
                <div class="d-flex align-items-center gap-2 ms-auto">
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="prevExecCaseBtn" title="上一隻">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="nextExecCaseBtn" title="下一隻">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body" style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                <div id="testCaseDetailLoading" class="text-center py-4">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    <span data-i18n="common.loading">載入中...</span>
                </div>
                <!-- 內容 + 歷程並排區域 -->
                <div id="testCaseDetailBodyRow" class="d-none" style="flex: 1; min-height: 0; display: flex; gap: 12px;">
                    <!-- 左側：Basic Info（固定）+ 詳情（可捲動） -->
                    <div id="testCaseDetailLeft" style="flex: 1 1 auto; min-width: 0; display: flex; flex-direction: column; overflow: hidden;">
                        <!-- 固定區：Basic Info + 測試詳情標題 -->
                        <div id="testCaseDetailFixed" style="display:none;"></div>
                        <!-- 可捲動區：僅測試詳情內容 -->
                        <div id="testCaseDetailScrollable" style="display:none;"></div>
                    </div>
                    <!-- 右側：結果歷程 Timeline（1/4 寬） -->
                    <aside id="testCaseDetailTimelinePane" style="flex: 0 0 25%; max-width: 25%; border-left: 1px solid var(--tr-border-light); padding-left: 10px; display: none; min-width: 240px;">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <h6 class="mb-0"><i class="fas fa-history me-2"></i><span data-i18n="testRun.resultHistory">結果歷程</span></h6>
                            <button type="button" id="refreshTimelineBtn" class="btn btn-link text-secondary p-0" title="刷新" style="border: none; background: none;"><i class="fas fa-sync-alt"></i></button>
                        </div>
                        <div id="timelineLoading" class="text-center py-2" style="display:none;">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                        <div id="timelineEmpty" class="text-muted small" style="display:none;">
                            <i class="fas fa-info-circle me-1"></i><span data-i18n="testRun.noHistory">尚無歷程</span>
                        </div>
                        <div id="timelineList" style="height: 400px; overflow-y: auto;"></div>
                        
                        <!-- Bug Tickets 區域 -->
                        <div class="mt-3 border-top pt-3">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <h6 class="mb-0"><i class="fas fa-bug me-2"></i><span data-i18n="testRun.bugTickets">Bug Tickets</span></h6>
                                <button type="button" id="addBugTicketBtn" class="btn btn-link text-secondary p-0" data-i18n-title="testRun.addBugTicket" style="border: none; background: none;">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div id="bugTicketsLoading" class="text-center py-2" style="display:none;">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                            <div id="bugTicketsEmpty" class="text-muted small" style="display:none;">
                                <i class="fas fa-info-circle me-1"></i><span data-i18n="testRun.noBugTickets">尚無關聯的 Bug Tickets</span>
                            </div>
                            <div id="bugTicketsList" style="height: 160px; overflow-y: auto;"></div>
                        </div>
                    </aside>
                </div>
                <div id="testCaseDetailError" style="display: none;">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span data-i18n="testRun.loadTestCaseError">載入 Test Case 詳細資料失敗</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    <span data-i18n="common.close">關閉</span>
                </button>
                <button type="button" class="btn btn-primary" id="openFullTestCaseBtn" style="display: none;">
                    <i class="fas fa-external-link-alt me-2"></i>
                    <span data-i18n="testRun.openInTestCaseManagement">在測試案例管理中開啟</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bug Ticket 新增模態框 -->
<div class="modal fade" id="addBugTicketModal" tabindex="-1" aria-labelledby="addBugTicketModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addBugTicketModalLabel">
                    <i class="fas fa-bug me-2"></i><span data-i18n="testRun.addBugTicket">新增 Bug Ticket</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addBugTicketForm">
                    <div class="mb-3">
                        <label for="bugTicketNumber" class="form-label"><span data-i18n="testRun.ticketNumber">Ticket 編號</span></label>
                        <input type="text" class="form-control" id="bugTicketNumber" placeholder="例如: PRJ-123" required>
                        <div class="form-text"><span data-i18n="testRun.ticketNumberHelp">請輸入 JIRA Ticket 編號</span></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <span data-i18n="common.cancel">取消</span>
                </button>
                <button type="button" class="btn btn-primary" id="confirmAddBugTicket">
                    <i class="fas fa-plus me-2"></i><span data-i18n="common.create">新增</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 刪除 Bug Ticket 確認對話框 -->
<div class="modal fade" id="deleteBugTicketModal" tabindex="-1" aria-labelledby="deleteBugTicketModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteBugTicketModalLabel">
                    <i class="fas fa-trash me-2"></i><span data-i18n="testRun.deleteBugTicket">刪除 Bug Ticket</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><span data-i18n="testRun.confirmDeleteBugTicket">確定要刪除這個 Bug Ticket 嗎？</span></p>
                <div class="text-center">
                    <strong id="deleteBugTicketNumber" class="text-primary"></strong>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <span data-i18n="common.cancel">取消</span>
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBugTicket">
                    <i class="fas fa-trash me-2"></i><span data-i18n="common.delete">刪除</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bug Tickets 摘要 Modal -->
<div class="modal fade" id="bugTicketsSummaryModal" tabindex="-1" aria-labelledby="bugTicketsSummaryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bugTicketsSummaryModalLabel">
                    <i class="fas fa-bug me-2"></i><span data-i18n="testRun.bugTicketsSummary">Bug Tickets 摘要</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="bugTicketsSummaryLoading" class="text-center py-4" style="display:none;">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    <span data-i18n="testRun.loadingBugTickets">載入 Bug Tickets 中...</span>
                </div>
                
                <div id="bugTicketsSummaryEmpty" class="text-center py-4 text-muted" style="display:none;">
                    <i class="fas fa-info-circle me-2"></i>
                    <span data-i18n="testRun.noBugTicketsInRun">此 Test Run 尚無 Bug Tickets</span>
                </div>
                
                <div id="bugTicketsSummaryContent" style="display:none;">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="btn-group btn-group-sm" role="group" aria-label="Status Filter">
                                <button type="button" class="btn btn-outline-secondary active" data-status="ALL" data-i18n="testRun.statusFilter.all" onclick="filterBugTicketsByStatus('ALL')">All</button>
                                <button type="button" class="btn btn-outline-warning" data-status="OPEN" data-i18n="testRun.statusFilter.open" onclick="filterBugTicketsByStatus('OPEN')">Open</button>
                                <button type="button" class="btn btn-outline-primary" data-status="TO DO" data-i18n="testRun.statusFilter.toDo" onclick="filterBugTicketsByStatus('TO DO')">To Do</button>
                                <button type="button" class="btn btn-outline-info" data-status="IN PROGRESS" data-i18n="testRun.statusFilter.inProgress" onclick="filterBugTicketsByStatus('IN PROGRESS')">In Progress</button>
                                <button type="button" class="btn btn-outline-success" data-status="RESOLVED" data-i18n="testRun.statusFilter.resolved" onclick="filterBugTicketsByStatus('RESOLVED')">Resolved</button>
                                <button type="button" class="btn btn-outline-secondary" data-status="SCHEDULED" data-i18n="testRun.statusFilter.scheduled" onclick="filterBugTicketsByStatus('SCHEDULED')">Scheduled</button>
                                <button type="button" class="btn btn-outline-dark" data-status="CLOSED" data-i18n="testRun.statusFilter.closed" onclick="filterBugTicketsByStatus('CLOSED')">Closed</button>
                            </div>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="refreshBugTicketsStatus()">
                                <i class="fas fa-sync-alt me-1"></i><span data-i18n="testRun.refreshBugStatus">重新整理狀態</span>
                            </button>
                        </div>
                    </div>
                    <div id="bugTicketsSummaryList" style="max-height: 500px; overflow-y: auto;">
                        <!-- Bug tickets cards will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/assignee-selector.js"></script>
<script>
// Test Run 執行頁面
console.log('=== Test Run 執行頁面 JavaScript 已載入 ===');
let currentConfigId = null;
let currentTeamId = null; // 由 AppUtils 取得，無則退回 1
let testRunConfig = null;
let testRunItems = [];
let itemDetailModal = null;
let confirmModal = null;
let restartModal = null;
let batchModifyModal = null;
let selectedItems = new Set(); // 追踪選中的測試執行項目
// Shift 連續多選的錨點索引
let lastItemCheckboxIndex = null;
// Test Case 詳細快取（localStorage），以測試案例編號為 key
const TEST_CASE_CACHE_PREFIX = 'tr_exec_tc_cache_v1';
const TEST_CASE_CACHE_TTL_MS = 60 * 60 * 1000; // 1 小時

// 頁面初始化
document.addEventListener('DOMContentLoaded', function() {
    // 從 URL 參數取得 config ID
    const urlParams = new URLSearchParams(window.location.search);
    currentConfigId = parseInt(urlParams.get('config_id'));
    
    if (!currentConfigId) {
        AppUtils.showError('{{ i18n.t("testRun.missingConfigId") if i18n else "缺少測試執行配置 ID" }}');
        window.location.href = '/test-run-management';
        return;
    }
    
    
    initializePage();
    bindEventListeners();
    bindBugTicketEvents();
    setupQuickSearch_TR();
    // 左下角熱鍵提示
    if (!document.getElementById('quickSearchHint')) {
        const hint = document.createElement('div');
        hint.id = 'quickSearchHint';
        hint.className = 'position-fixed';
        hint.style.cssText = 'left:12px; bottom:12px; z-index:1040; opacity:0.85; pointer-events:none;';
        const label = window.i18n && window.i18n.isReady() ? (window.i18n.t('hotkeys.quickSearch') || 'Press / for quick search') : 'Press / for quick search';
        hint.innerHTML = `<span class="badge bg-secondary-subtle text-secondary border" style="--bs-bg-opacity:.65;">${label}</span>`;
        document.body.appendChild(hint);
        // i18n 準備完成時同步更新
        document.addEventListener('i18nReady', () => {
            const text = window.i18n ? (window.i18n.t('hotkeys.quickSearch') || 'Press / for quick search') : 'Press / for quick search';
            const badge = document.querySelector('#quickSearchHint .badge');
            if (badge) badge.textContent = text;
        });
        document.addEventListener('languageChanged', () => {
            const text = window.i18n ? (window.i18n.t('hotkeys.quickSearch') || 'Press / for quick search') : 'Press / for quick search';
            const badge = document.querySelector('#quickSearchHint .badge');
            if (badge) badge.textContent = text;
        });
    }
});

function initializePage() {
    // 取得目前團隊 ID（與管理頁一致），無則暫用 1
    currentTeamId = AppUtils.getCurrentTeam()?.id;
    if (!currentTeamId) {
        currentTeamId = 1;
        console.log('Using temporary hardcoded team ID:', currentTeamId);
    }

    itemDetailModal = new bootstrap.Modal(document.getElementById('itemDetailModal'));
    confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
    restartModal = new bootstrap.Modal(document.getElementById('restartModal'));
    batchModifyModal = new bootstrap.Modal(document.getElementById('batchModifyModal'));
    
    // 綁定重新執行確認按鈕事件
    document.getElementById('confirmRestartBtn').addEventListener('click', handleRestartConfirm);
    
    // 綁定批次修改相關事件
    document.getElementById('confirmBatchModifyBtn').addEventListener('click', handleBatchModifyConfirm);
    document.getElementById('batchModifyAssignee').addEventListener('change', toggleBatchAssigneeInput);
    document.getElementById('batchModifyResult').addEventListener('change', toggleBatchResultSelect);
    
    // 初始化 AssigneeSelector 元件（批次修改模態框中的）
    if (window.AssigneeSelector && currentTeamId) {
        // 為批次修改的 input 初始化 AssigneeSelector
        const batchInput = document.getElementById('batchAssigneeInput');
        if (batchInput && batchInput.dataset.assigneeSelector !== undefined) {
            const options = {
                teamId: currentTeamId,
                allowCustomValue: true,  // 批次修改允許自定義值
                onSelect: (contact) => {
                    // 批次修改不需要立即更新，只需要設定值
                    console.log('Batch assignee selected:', contact.name);
                }
            };
            
            if (batchInput._assigneeSelector) {
                batchInput._assigneeSelector.destroy();
            }
            batchInput._assigneeSelector = new AssigneeSelector(batchInput, options);
        }
    }
    
    loadTestRunConfig();
}


function bindEventListeners() {
    document.getElementById('refreshBtn').addEventListener('click', async () => {
        const refreshBtn = document.getElementById('refreshBtn');
        const originalHTML = refreshBtn.innerHTML;
        
        // 顯示載入動畫在按鈕內（像 Test Case Management 一樣）
        refreshBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status"></span>${window.i18n ? window.i18n.t('common.refresh') : '重新整理'}`;
        refreshBtn.disabled = true;
        
        try {
            // 清除 Test Case Management 的列表快取
            try {
                const TEST_CASES_CACHE_KEY = 'test_cases_list_cache_v1';
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.startsWith(TEST_CASES_CACHE_KEY)) {
                        localStorage.removeItem(key);
                    }
                });
            } catch (e) {
                console.debug('清除 Test Case Management 快取失敗:', e);
            }
            
            // 清除所有個別快取
            try {
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.startsWith('tr_exec_tc_cache_v1')) {
                        localStorage.removeItem(key);
                    }
                });
            } catch (e) {
                console.debug('清除個別快取失敗:', e);
            }
            
            // 重新載入 Items（不顯示 Test Case 區域載入動畫）
            await loadTestRunItemsWithoutLoading();
            // 強制重新抓取 Test Case 詳細並更新快取
            await preloadAllTeamTestCasesForRun(testRunItems);
            // 更新統計（包含 Bug Tickets 數量）- 會自動顯示統計區域轉圈動畫
            await updateStatistics();
            // 更新 Bug Tickets 狀態
            try {
                await refreshBugTicketsStatus();
            } catch (e) {
                console.debug('更新 Bug Tickets 狀態失敗:', e);
            }
            // 若詳情 Modal 開啟中則刷新 timeline（以目前顯示的 test case）
            try {
                const modalEl = document.getElementById('testCaseDetailModal');
                const isShown = modalEl && modalEl.classList.contains('show');
                if (isShown && currentDetailTestCase && currentDetailTestCase.test_case_number) {
                    renderResultHistoryTimeline({ test_case_number: currentDetailTestCase.test_case_number });
                }
            } catch (_) {}
            // 若 Bug Tickets Summary Modal 開啟中則刷新其內容
            try {
                const bugModalEl = document.getElementById('bugTicketsSummaryModal');
                const isBugModalShown = bugModalEl && bugModalEl.classList.contains('show');
                if (isBugModalShown) {
                    await loadBugTicketsSummary();
                }
            } catch (_) {}
            
            // 顯示成功訊息
            AppUtils.showSuccess(window.i18n ? window.i18n.t('messages.dataReloaded') : '資料已重新載入');
            
        } finally {
            // 恢復按鈕原始狀態
            refreshBtn.innerHTML = originalHTML;
            refreshBtn.disabled = false;
        }
    });
    
    document.getElementById('startBtn').addEventListener('click', () => {
        confirmStatusChange('active', '{{ i18n.t("testRun.startExecutionConfirm") if i18n else "開始執行此 Test Run？" }}');
    });
    
    document.getElementById('completeBtn').addEventListener('click', () => {
        confirmStatusChange('completed', '{{ i18n.t("testRun.completeExecutionConfirm") if i18n else "結束此 Test Run？結束後將無法再修改測試結果。" }}');
    });
    
    document.getElementById('restartBtn').addEventListener('click', showRestartModal);
    
    // 全選 checkbox 事件
    document.getElementById('selectAllItemsCheckbox').addEventListener('change', toggleSelectAllItems);
    
    // 批次修改按鈕事件
    document.getElementById('batchModifyBtn').addEventListener('click', showBatchModifyModal);

    // 批次刪除按鈕事件
    document.getElementById('batchDeleteBtn').addEventListener('click', showBatchDeleteConfirm);
    // 清除選取
    const clearSelectionExecBtn = document.getElementById('clearSelectionExecBtn');
    if (clearSelectionExecBtn) clearSelectionExecBtn.addEventListener('click', clearSelectedItems);
    
    // 監聽個別項目 checkbox 變化（單點選 or 程式設定觸發）
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('test-run-item-checkbox')) {
            const itemId = parseInt(e.target.value);
            if (e.target.checked) {
                selectedItems.add(itemId);
            } else {
                selectedItems.delete(itemId);
            }
            updateItemSelectionUI();
        }
    });

    // 支援 Shift-點選 連續多選
    document.addEventListener('click', function(e) {
        const cb = e.target;
        if (!cb.classList || !cb.classList.contains('test-run-item-checkbox')) return;

        const checkboxes = Array.from(document.querySelectorAll('.test-run-item-checkbox'));
        const currentIndex = checkboxes.indexOf(cb);
        if (currentIndex === -1) return;

        if (e.shiftKey && lastItemCheckboxIndex !== null && lastItemCheckboxIndex !== -1) {
            const start = Math.min(lastItemCheckboxIndex, currentIndex);
            const end = Math.max(lastItemCheckboxIndex, currentIndex);
            const shouldCheck = cb.checked; // 依照目前點選狀態套用整段

            for (let i = start; i <= end; i++) {
                const c = checkboxes[i];
                if (c.checked !== shouldCheck) {
                    c.checked = shouldCheck;
                }
                const id = parseInt(c.value);
                if (shouldCheck) {
                    selectedItems.add(id);
                } else {
                    selectedItems.delete(id);
                }
            }
            updateItemSelectionUI();
        }

        // 更新錨點索引（不論是否有按 Shift）
        lastItemCheckboxIndex = currentIndex;
    });
}

async function loadTestRunConfig() {
    try {
        const response = await fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        testRunConfig = await response.json();
        updateHeader();
        await loadTestRunItems();
        await updateStatistics();
        
    } catch (error) {
        console.error('Failed to load Test Run config:', error);
        AppUtils.showError('{{ i18n.t("testRun.loadFailed") if i18n else "載入失敗" }}' + ': ' + error.message);
    } finally {
        hideItemsLoading();
    }
}

async function loadTestRunItems() {
    try {
        showItemsLoading();
        const response = await fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        testRunItems = await response.json();
        // 預設按 Test Case Number 升冪排序（與 Test Case Management 一致）
        try {
            testRunItems.sort((a, b) => {
                const aNumber = a && a.test_case_number ? a.test_case_number : '';
                const bNumber = b && b.test_case_number ? b.test_case_number : '';
                return aNumber.localeCompare(bNumber);
            });
        } catch (_) { /* 忽略排序中的非致命錯誤 */ }
        // 比照 Test Case Management：一次抓取整個團隊的測試案例清單，
        // 並將本次 Test Run 需要的案例寫入本地快取（改為背景預抓，不阻塞列表顯示）。
        Promise.resolve().then(() => preloadAllTeamTestCasesForRun(testRunItems)).catch(() => {});
        renderTestRunItems();
        hideItemsLoading();
        
    } catch (error) {
        console.error('Failed to load test items:', error);
        AppUtils.showError('{{ i18n.t("testRun.loadItemsFailed") if i18n else "載入測試項目失敗" }}' + ': ' + error.message);
        hideItemsLoading();
    }
}

// 不顯示載入動畫的版本（用於 Refresh）
async function loadTestRunItemsWithoutLoading() {
    try {
        const response = await fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        testRunItems = await response.json();
        // 預設按 Test Case Number 升冪排序（與 Test Case Management 一致）
        try {
            testRunItems.sort((a, b) => {
                const aNumber = a && a.test_case_number ? a.test_case_number : '';
                const bNumber = b && b.test_case_number ? b.test_case_number : '';
                return aNumber.localeCompare(bNumber);
            });
        } catch (_) { /* 忽略排序中的非致命錯誤 */ }
        
        // 直接渲染，不顯示載入動畫
        renderTestRunItems();
        
    } catch (error) {
        console.error('Failed to load test items:', error);
        AppUtils.showError('{{ i18n.t("testRun.loadItemsFailed") if i18n else "載入測試項目失敗" }}' + ': ' + error.message);
    }
}

function updateHeader() {
    if (!testRunConfig) return;
    
    // 更新頁面標題
    document.getElementById('test-run-subtitle').textContent = testRunConfig.name;
    
    // 顯示對應的控制按鈕
    updateControlButtons(testRunConfig.status);
    
    // 顯示頁面內容
    document.getElementById('test-run-header').style.display = 'block';
    document.getElementById('test-run-items-container').style.display = 'block';
}

function updateControlButtons(status) {
    // 隱藏所有按鈕
    document.getElementById('startBtn').style.display = 'none';
    document.getElementById('completeBtn').style.display = 'none';
    document.getElementById('restartBtn').style.display = 'none';
    
    // 根據狀態顯示對應按鈕
    switch (status) {
        case 'draft':
            document.getElementById('startBtn').style.display = 'inline-block';
            break;
        case 'active':
            document.getElementById('completeBtn').style.display = 'inline-block';
            break;
        case 'completed':
            document.getElementById('restartBtn').style.display = 'inline-block';
            break;
    }
    
    // 更新批量修改按鈕狀態
    const batchModifyBtn = document.getElementById('batchModifyBtn');
    if (batchModifyBtn) {
        if (status === 'completed') {
            batchModifyBtn.disabled = true;
            batchModifyBtn.classList.add('disabled');
            batchModifyBtn.title = window.i18n && window.i18n.isReady() 
                ? window.i18n.t('testRun.cannotEditCompleted')
                : '已完成的 Test Run 不可編輯 Test Case';
        } else {
            batchModifyBtn.disabled = false;
            batchModifyBtn.classList.remove('disabled');
            batchModifyBtn.removeAttribute('title');
        }
    }
}

function renderTestRunItems() {
    const tbody = document.getElementById('items-table-body');
    const canUpdate = testRunConfig && testRunConfig.status === 'active';
    
    // 更新表格標頭顯示
    updateTableHeader();
    
    tbody.innerHTML = testRunItems.map((item, index) => {
        return createItemRow(item, index + 1, canUpdate);
    }).join('');
    
    // 重新應用翻譯到新生成的內容
    if (window.i18n && window.i18n.isReady()) {
        window.i18n.retranslate(tbody);
    }
    
    // 綁定事件處理器
    bindItemEventHandlers(canUpdate);

    // 確保載入動畫關閉，顯示列表
    hideItemsLoading();
}

// 列表區載入動畫控制（顯示空框 + spinner）
function showItemsLoading() {
    try {
        const container = document.getElementById('test-run-items-container');
        const loading = document.getElementById('items-loading');
        const tableWrap = container.querySelector('.test-run-items-table');
        if (container) container.style.display = 'block';
        if (loading) {
            loading.classList.remove('d-none');
            loading.classList.add('d-flex');
            loading.style.display = '';
        }
        if (tableWrap) tableWrap.style.display = 'none';
        const tbody = document.getElementById('items-table-body');
        if (tbody) tbody.innerHTML = '';
    } catch (_) {}
}

function hideItemsLoading() {
    try {
        const container = document.getElementById('test-run-items-container');
        const loading = document.getElementById('items-loading');
        const tableWrap = container.querySelector('.test-run-items-table');
        if (loading) {
            loading.classList.remove('d-flex');
            loading.classList.add('d-none');
            loading.style.display = '';
        }
        if (tableWrap) tableWrap.style.display = 'block';
    } catch (_) {}
}

function shouldShowCheckbox(status) {
    return status === 'draft' || status === 'active';
}

function updateTableHeader() {
    const table = document.querySelector('.test-run-items-table');
    const showCheckbox = shouldShowCheckbox(testRunConfig ? testRunConfig.status : 'draft');
    
    if (showCheckbox) {
        table.classList.remove('hide-checkbox');
    } else {
        table.classList.add('hide-checkbox');
        // 清空選擇狀態
        selectedItems.clear();
        updateItemSelectionUI();
    }
}

function createItemRow(item, index, canUpdate) {
    const resultClass = getResultClass(item.test_result);
    const resultText = getResultText(item.test_result);
    const executedAt = item.executed_at ? AppUtils.formatDate(item.executed_at, 'datetime') : '-';
    const assigneeName = (item.assignee_name || (item.assignee && item.assignee.name)) || '-';
    const canEditAssignee = testRunConfig && testRunConfig.status !== 'completed' && testRunConfig.status !== 'archived';
    const showCheckbox = shouldShowCheckbox(testRunConfig ? testRunConfig.status : 'draft');
    const hasExecutionHistory = item.executed_at !== null && item.executed_at !== undefined;
    
    return `
        <tr data-item-id="${item.id}">
            ${showCheckbox ? `
                <td class="checkbox-cell">
                    <input type="checkbox" class="form-check-input test-run-item-checkbox" value="${item.id}">
                </td>
            ` : ''}
            <td><code><a href="#" class="text-decoration-none" onclick="navigateToTestCase('${item.test_case_number}'); return false;">${escapeHtml(item.test_case_number)}</a></code></td>
            <td class="text-truncate" title="${escapeHtml(item.title)}"><a href="#" class="text-decoration-none" onclick="navigateToTestCase('${item.test_case_number}'); return false;">${escapeHtml(item.title)}</a></td>
            <td><span class="badge bg-secondary priority-badge-lg">${escapeHtml(item.priority || 'Medium')}</span></td>
            <td>
                ${canUpdate ? `
                    <select class="form-select result-selector-lg ${resultClass}"
                            data-item-id="${item.id}" onchange="updateTestResult(${item.id}, this.value)">
                        ${!hasExecutionHistory ? `<option value="">${escapeHtml('{{ i18n.t("testRun.notExecuted") if i18n else "Not Executed" }}')}</option>` : ''}
                        <option value="Passed" ${item.test_result === 'Passed' ? 'selected' : ''}>${escapeHtml('{{ i18n.t("testRun.passed") if i18n else "Passed" }}')}</option>
                        <option value="Failed" ${item.test_result === 'Failed' ? 'selected' : ''}>${escapeHtml('{{ i18n.t("testRun.failed") if i18n else "Failed" }}')}</option>
                        <option value="Retest" ${item.test_result === 'Retest' ? 'selected' : ''}>${escapeHtml('{{ i18n.t("testRun.retest") if i18n else "Retest" }}')}</option>
                        <option value="Not Available" ${item.test_result === 'Not Available' ? 'selected' : ''}>${escapeHtml('{{ i18n.t("testRun.notAvailable") if i18n else "Not Available" }}')}</option>
                    </select>
                ` : `
                    <span class="badge result-badge-lg ${resultClass}">${resultText}</span>
                `}
            </td>
            <td>
                ${canEditAssignee ? `
                    <input type="text" class="form-control form-control-sm assignee-editor" 
                           value="${escapeHtml(assigneeName === '-' ? '' : assigneeName)}"
                           data-item-id="${item.id}" 
                           data-assignee-selector
                           data-i18n-placeholder="testRun.enterAssigneeName"
                           placeholder="{{ i18n.t('testRun.enterAssigneeName') if i18n else '輸入執行者姓名' }}"
                           onblur="updateAssignee(${item.id}, this.value)">
                ` : `
                    ${assigneeName}
                `}
            </td>
            <td class="small text-muted">${executedAt}</td>
        </tr>
    `;
}

function bindItemEventHandlers(canUpdate) {
    if (!canUpdate) return;
    
    // 結果選擇器樣式更新（同時支援 .result-selector 與 .result-selector-lg）
    document.querySelectorAll('.result-selector, .result-selector-lg').forEach(select => {
        select.addEventListener('change', function() {
            updateSelectClass(this);
        });
        updateSelectClass(select);
    });
    
    // 初始化新渲染的 AssigneeSelector 元件（行內編輯器）
    if (window.initAssigneeSelectors && currentTeamId) {
        // 清理之前的 AssigneeSelector 實例
        document.querySelectorAll('.assignee-editor[data-assignee-selector]').forEach(input => {
            if (input._assigneeSelector) {
                input._assigneeSelector.destroy();
            }
        });
        
        // 為每個 assignee editor 設定自訂選項，包含選擇回調
        document.querySelectorAll('.assignee-editor[data-assignee-selector]').forEach(input => {
            const itemId = parseInt(input.dataset.itemId);
            
            if (input._assigneeSelector) {
                input._assigneeSelector.destroy();
            }
            
            const options = {
                teamId: currentTeamId,
                allowCustomValue: true,
                onSelect: (contact) => {
                    // 當選擇聯絡人時，自動更新 assignee
                    updateAssignee(itemId, contact.name);
                },
                onClear: () => {
                    // 當清空選擇時，自動清空 assignee
                    updateAssignee(itemId, '');
                }
            };
            
            input._assigneeSelector = new AssigneeSelector(input, options);
        });
    }
}

function updateSelectClass(select) {
    const value = select.value;
    const hasSm = select.classList.contains('form-select-sm');
    const sizeClass = hasSm ? 'form-select-sm ' : '';
    select.className = `form-select ${sizeClass}result-selector-lg ${getResultClass(value)}`;
}

async function updateTestResult(itemId, result) {
    try {
        const executedAt = result ? new Date().toISOString() : null;
        
        const response = await fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/${itemId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                test_result: result || null,
                executed_at: executedAt
            })
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        // 更新本地資料
        const itemIndex = testRunItems.findIndex(item => item.id === itemId);
        if (itemIndex !== -1) {
            testRunItems[itemIndex].test_result = result || null;
            testRunItems[itemIndex].executed_at = executedAt;
        }
        
        // 更新統計
        await updateStatistics();

        // 重新渲染列表頁以反映更新
        renderTestRunItems();

        // 若詳情 Modal 開啟中且為同一測試案例，刷新右側 timeline 和標題區域
        try {
            const modalEl = document.getElementById('testCaseDetailModal');
            const isShown = modalEl && modalEl.classList.contains('show');
            const item = testRunItems.find(i => i.id === itemId);
            if (isShown && item && currentDetailTestCase && currentDetailTestCase.test_case_number === item.test_case_number) {
                // 刷新標題區域的 Test Result 顯示
                renderModalHeaderResult(currentDetailTestCase);
                // 刷新右側 timeline
                renderResultHistoryTimeline({ test_case_number: item.test_case_number });
            }
        } catch (_) {}
        
    } catch (error) {
        console.error('Failed to update test result:', error);
        AppUtils.showError('{{ i18n.t("testRun.updateFailed") if i18n else "更新失敗" }}' + ': ' + error.message);
        // 重新載入項目以恢復狀態
        await loadTestRunItems();
    }
}

// 顯示統計載入狀態
function showStatsLoading() {
    const statIds = ['total-count', 'executed-count', 'passed-count', 'failed-count', 'execution-rate', 'pass-rate', 'bug-tickets-count'];
    statIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        }
    });
}

// 隱藏統計載入狀態並恢復數字顯示
function hideStatsLoading() {
    const statIds = ['total-count', 'executed-count', 'passed-count', 'failed-count', 'execution-rate', 'pass-rate', 'bug-tickets-count'];
    statIds.forEach(id => {
        const element = document.getElementById(id);
        if (element && element.innerHTML.includes('fa-spinner')) {
            element.textContent = '0';
        }
    });
}

async function updateStatistics() {
    try {
        // 顯示載入動畫
        showStatsLoading();
        
        const response = await fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/statistics`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const stats = await response.json();
        
        document.getElementById('total-count').textContent = stats.total_runs;
        document.getElementById('executed-count').textContent = stats.executed_runs;
        document.getElementById('passed-count').textContent = stats.passed_runs;
        document.getElementById('failed-count').textContent = stats.failed_runs;
        document.getElementById('bug-tickets-count').textContent = stats.unique_bug_tickets_count || 0;
        // 顯示為無條件捨去之整數百分比
        document.getElementById('execution-rate').textContent = Math.floor(stats.execution_rate) + '%';
        // 通過率顯示為無條件捨去之整數百分比
        document.getElementById('pass-rate').textContent = Math.floor(stats.pass_rate) + '%';
        
        // 同步配置統計
        await fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/sync`);
        
    } catch (error) {
        console.error('Failed to update statistics:', error);
        // 錯誤時也要隱藏載入動畫
        hideStatsLoading();
    }
}

function showItemDetail(itemId) {
    const item = testRunItems.find(i => i.id === itemId);
    if (!item) return;
    
    const basicInfoLabel = '{{ i18n.t("testRun.basicInfo") if i18n else "基本資訊" }}';
    const executionInfoLabel = '{{ i18n.t("testRun.executionInfo") if i18n else "執行資訊" }}';
    const testCaseNumberLabel = '{{ i18n.t("testRun.testCaseNumber") if i18n else "測試案例編號" }}';
    const titleLabel = '{{ i18n.t("common.title") if i18n else "標題" }}';
    const priorityLabel = '{{ i18n.t("testRun.priority") if i18n else "優先級" }}';
    const testResultLabel = '{{ i18n.t("testRun.testResult") if i18n else "測試結果" }}';
    const executorLabel = '{{ i18n.t("testRun.executor") if i18n else "執行者" }}';
    const executionTimeLabel = '{{ i18n.t("testRun.executionTime") if i18n else "執行時間" }}';
    const executionDurationLabel = '{{ i18n.t("testRun.executionDuration") if i18n else "執行時長" }}';
    const attachmentCountLabel = '{{ i18n.t("testRun.attachmentCount") if i18n else "附件數量" }}';
    const preconditionsLabel = '{{ i18n.t("testRun.preconditions") if i18n else "前置條件" }}';
    const testStepsLabel = '{{ i18n.t("testRun.testSteps") if i18n else "測試步驟" }}';
    const expectedResultsLabel = '{{ i18n.t("testRun.expectedResults") if i18n else "預期結果" }}';
    const minutesLabel = '{{ i18n.t("testRun.minutes") if i18n else "分鐘" }}';
    
    const content = `
        <div class="row">
            <div class="col-md-6">
                <h6>${basicInfoLabel}</h6>
                <table class="table table-sm">
                    <tr><td>${testCaseNumberLabel}</td><td><code>${escapeHtml(item.test_case_number)}</code></td></tr>
                    <tr><td>${titleLabel}</td><td>${escapeHtml(item.title)}</td></tr>
                    <tr><td>${priorityLabel}</td><td>${escapeHtml(item.priority || 'Medium')}</td></tr>
                    <tr><td>${testResultLabel}</td><td><span class="badge ${getResultClass(item.test_result)}">${getResultText(item.test_result)}</span></td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>${executionInfoLabel}</h6>
                <table class="table table-sm">
                    <tr><td>${executorLabel}</td><td>${escapeHtml(item.assignee_name || '-')}</td></tr>
                    <tr><td>${executionTimeLabel}</td><td>${item.executed_at ? AppUtils.formatDate(item.executed_at, 'datetime') : '-'}</td></tr>
                    <tr><td>${executionDurationLabel}</td><td>${item.execution_duration ? item.execution_duration + ' ' + minutesLabel : '-'}</td></tr>
                    <tr><td>${attachmentCountLabel}</td><td>${item.attachment_count || 0}</td></tr>
                </table>
            </div>
        </div>
        ${item.precondition ? `<div class="mt-3"><h6>${preconditionsLabel}</h6><p class="text-muted">${escapeHtml(item.precondition)}</p></div>` : ''}
        ${item.steps ? `<div class="mt-3"><h6>${testStepsLabel}</h6><p class="text-muted">${escapeHtml(item.steps).replace(/\n/g, '<br>')}</p></div>` : ''}
        ${item.expected_result ? `<div class="mt-3"><h6>${expectedResultsLabel}</h6><p class="text-muted">${escapeHtml(item.expected_result)}</p></div>` : ''}
    `;
    
    document.getElementById('item-detail-content').innerHTML = content;
    itemDetailModal.show();
}

function confirmStatusChange(newStatus, message) {
    document.getElementById('confirm-message').textContent = message;
    const confirmBtn = document.getElementById('confirm-action-btn');
    
    confirmBtn.onclick = async () => {
        try {
            await changeTestRunStatus(newStatus);
            confirmModal.hide();
        } catch (error) {
            AppUtils.showError('{{ i18n.t("testRun.statusChangeFailed") if i18n else "狀態變更失敗" }}' + ': ' + error.message);
        }
    };
    
    confirmModal.show();
}

async function changeTestRunStatus(newStatus) {
    try {
        const response = await fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus })
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        testRunConfig.status = newStatus;
        updateHeader();
        
        // 重新渲染項目以更新 checkbox 顯示和編輯權限
        renderTestRunItems();
        
        const statusMsg = {
            'active': '{{ i18n.t("testRun.executionStarted") if i18n else "已開始執行" }}',
            'completed': '{{ i18n.t("testRun.executionCompleted") if i18n else "已結束執行" }}'
        };
        
        AppUtils.showSuccess(statusMsg[newStatus] || '{{ i18n.t("testRun.statusUpdated") if i18n else "狀態已更新" }}');
        
    } catch (error) {
        console.error('Failed to change status:', error);
        throw error;
    }
}

function showRestartModal() {
    if (!testRunConfig || testRunConfig.status !== 'completed') {
        AppUtils.showWarning('{{ i18n.t("testRun.onlyCompletedCanRestart") if i18n else "只有已完成的 Test Run 才能重新執行" }}');
        return;
    }
    
    // 重置選項為默認值
    document.getElementById('restartAll').checked = true;
    // 預設名稱：Rerun - 原有名稱
    const input = document.getElementById('rerunNameInput');
    if (input) {
        const base = (testRunConfig && testRunConfig.name) ? `Rerun - ${testRunConfig.name}` : 'Rerun -';
        input.value = base;
    }
    restartModal.show();
}

async function handleRestartConfirm() {
    const selectedMode = document.querySelector('input[name="restartMode"]:checked');
    if (!selectedMode) {
        AppUtils.showWarning('{{ i18n.t("testRun.selectRestartMode") if i18n else "請選擇重新執行模式" }}');
        return;
    }
    
    try {
        await restartTestRun(selectedMode.value);
        restartModal.hide();
        
    } catch (error) {
        AppUtils.showError('{{ i18n.t("testRun.restartFailed") if i18n else "重新執行失敗" }}' + ': ' + error.message);
    }
}

async function restartTestRun(mode) {
    try {
        // 調用重新執行 API
        const nameInput = document.getElementById('rerunNameInput');
        const newName = nameInput && nameInput.value ? nameInput.value.trim() : '';
        const response = await fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/restart`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode: mode, name: newName })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        const newId = result && result.new_config_id;
        if (!newId) throw new Error('Missing new_config_id');
        AppUtils.showSuccess('{{ i18n.t("testRun.rerunCreated") if i18n else "已建立新的 Test Run" }}');
        window.location.href = `/test-run-execution?config_id=${encodeURIComponent(newId)}`;
        
    } catch (error) {
        const consoleMsg = window.i18n && window.i18n.isReady() 
            ? window.i18n.t('testRun.restartFailed')
            : '重新執行 Test Run 失敗';
        console.error(consoleMsg + ':', error);
        throw error;
    }
}

// 輔助函數（狀態文字映射已移除，因為不再需要狀態指示器）

function getResultClass(result) {
    const classMap = {
        'Passed': 'result-passed',
        'Failed': 'result-failed', 
        'Retest': 'result-retest',
        'Not Available': 'result-na'
    };
    return classMap[result] || 'result-pending';
}

function getResultText(result) {
    const textMap = {
        'Passed': '{{ i18n.t("testRun.passed") if i18n else "Passed" }}',
        'Failed': '{{ i18n.t("testRun.failed") if i18n else "Failed" }}',
        'Retest': '{{ i18n.t("testRun.retest") if i18n else "Retest" }}', 
        'Not Available': '{{ i18n.t("testRun.notAvailable") if i18n else "Not Available" }}'
    };
    return textMap[result] || '{{ i18n.t("testRun.notExecuted") if i18n else "Not Executed" }}';
}

// 全頁載入已移除，使用列表區載入動畫（showItemsLoading/hideItemsLoading）

function toggleSelectAllItems() {
    const selectAll = document.getElementById('selectAllItemsCheckbox').checked;
    const checkboxes = document.querySelectorAll('.test-run-item-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll;
        const itemId = parseInt(checkbox.value);
        if (selectAll) {
            selectedItems.add(itemId);
        } else {
            selectedItems.delete(itemId);
        }
    });
    
    updateItemSelectionUI();
    // 重置 Shift 多選錨點
    lastItemCheckboxIndex = null;
}

function clearSelectedItems() {
    try {
        document.querySelectorAll('.test-run-item-checkbox').forEach(cb => cb.checked = false);
    } catch (_) {}
    const header = document.getElementById('selectAllItemsCheckbox');
    if (header) header.checked = false;
    selectedItems.clear();
    updateItemSelectionUI();
    lastItemCheckboxIndex = null;
}

function updateItemSelectionUI() {
    const totalCheckboxes = document.querySelectorAll('.test-run-item-checkbox').length;
    const selectedCount = selectedItems.size;
    const selectAllCheckbox = document.getElementById('selectAllItemsCheckbox');
    const toolbar = document.getElementById('batchOperationsToolbar');
    const countDisplay = document.getElementById('selectedItemsCount');
    
    // 如果不顯示 checkbox，隱藏工具列
    if (!shouldShowCheckbox(testRunConfig ? testRunConfig.status : 'draft')) {
        toolbar.classList.add('d-none');
        return;
    }
    
    // 更新全選 checkbox 狀態
    if (selectedCount === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
        toolbar.classList.add('d-none');
    } else if (selectedCount === totalCheckboxes) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
        toolbar.classList.remove('d-none');
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
        toolbar.classList.remove('d-none');
    }
    
    // 更新選中項目計數
    if (window.i18n && window.i18n.isReady()) {
        countDisplay.textContent = window.i18n.t('testRun.selectedItemsCount', {count: selectedCount});
    } else {
        countDisplay.textContent = `已選取 ${selectedCount} 個項目`;
    }
    // 更新 data-i18n-params 屬性以支持語言切換
    countDisplay.setAttribute('data-i18n-params', JSON.stringify({count: selectedCount}));
}

function showBatchModifyModal() {
    if (selectedItems.size === 0) {
        const noSelectionMsg = window.i18n && window.i18n.isReady() 
            ? window.i18n.t('testRun.noItemsSelected')
            : '{{ i18n.t("testRun.noItemsSelected") if i18n else "請先選擇要修改的項目" }}';
        AppUtils.showWarning(noSelectionMsg);
        return;
    }
    
    // 檢查 Test Run 狀態，已完成的不允許編輯
    if (testRunConfig && testRunConfig.status === 'completed') {
        const completedEditMsg = window.i18n && window.i18n.isReady() 
            ? window.i18n.t('testRun.cannotEditCompleted')
            : '{{ i18n.t("testRun.cannotEditCompleted") if i18n else "已完成的 Test Run 不可編輯 Test Case" }}';
        AppUtils.showWarning(completedEditMsg);
        return;
    }
    
    // 更新選中項目數量
    document.getElementById('batchModifyCount').textContent = selectedItems.size;
    
    // 根據當前狀態顯示/隱藏測試結果選項
    const canUpdateResult = testRunConfig && testRunConfig.status === 'active';
    const resultSection = document.getElementById('batchResultSection');
    
    if (canUpdateResult) {
        resultSection.style.display = 'block';
    } else {
        resultSection.style.display = 'none';
        document.getElementById('batchModifyResult').checked = false;
    }
    
    // 重置表單
    document.getElementById('batchAssigneeInput').value = '';
    document.getElementById('batchResultSelect').value = '';
    document.getElementById('batchModifyAssignee').checked = true;
    document.getElementById('batchModifyResult').checked = false;
    
    toggleBatchAssigneeInput();
    toggleBatchResultSelect();
    
    batchModifyModal.show();
}

function toggleBatchAssigneeInput() {
    const checkbox = document.getElementById('batchModifyAssignee');
    const input = document.getElementById('batchAssigneeInput');
    input.disabled = !checkbox.checked;
}

function toggleBatchResultSelect() {
    const checkbox = document.getElementById('batchModifyResult');
    const select = document.getElementById('batchResultSelect');
    select.disabled = !checkbox.checked;
}

async function handleBatchModifyConfirm() {
    try {
        const modifyAssignee = document.getElementById('batchModifyAssignee').checked;
        const modifyResult = document.getElementById('batchModifyResult').checked;
        const assigneeName = document.getElementById('batchAssigneeInput').value.trim();
        const testResult = document.getElementById('batchResultSelect').value;
        
        if (!modifyAssignee && !modifyResult) {
            const selectOptionMsg = window.i18n && window.i18n.isReady() 
                ? window.i18n.t('testRun.selectAtLeastOneOption')
                : '{{ i18n.t("testRun.selectAtLeastOneOption") if i18n else "請至少選擇一個要修改的項目" }}';
            AppUtils.showWarning(selectOptionMsg);
            return;
        }
        
        if (modifyAssignee && !assigneeName) {
            const enterAssigneeMsg = window.i18n && window.i18n.isReady() 
                ? window.i18n.t('testRun.enterAssigneeName')
                : '{{ i18n.t("testRun.enterAssigneeName") if i18n else "請輸入執行者姓名" }}';
            AppUtils.showWarning(enterAssigneeMsg);
            return;
        }
        
        if (modifyResult && !testResult) {
            const selectResultMsg = window.i18n && window.i18n.isReady() 
                ? window.i18n.t('testRun.selectTestResult')
                : '{{ i18n.t("testRun.selectTestResult") if i18n else "請選擇測試結果" }}';
            AppUtils.showWarning(selectResultMsg);
            return;
        }
        
        await batchModifyItems({ modifyAssignee, modifyResult, assigneeName, testResult });
        batchModifyModal.hide();
        
    } catch (error) {
        const batchFailedMsg = window.i18n && window.i18n.isReady() 
            ? window.i18n.t('testRun.batchModifyFailed')
            : '{{ i18n.t("testRun.batchModifyFailed") if i18n else "批次修改失敗" }}';
        AppUtils.showError(batchFailedMsg + ': ' + error.message);
    }
}

async function batchModifyItems(modifications) {
    try {
        const itemsToModify = Array.from(selectedItems);

        // 為每個選中的項目建立更新資料
        const updates = itemsToModify.map(itemId => {
            const updateData = { id: itemId };

            if (modifications.modifyAssignee) {
                updateData.assignee_name = modifications.assigneeName || null;
            }

            if (modifications.modifyResult) {
                updateData.test_result = modifications.testResult;
                updateData.executed_at = new Date().toISOString();
            }

            return updateData;
        });

        // 批次修改 API 調用（使用正確的端點）
        const response = await fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/batch-update-results`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                updates: updates
            })
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(`HTTP ${response.status}: ${errorData.detail || 'Unknown error'}`);
        }

        // 解析API響應
        const result = await response.json();

        // 樂觀更新本地列表（避免等待重載也能即時看到變更）
        try {
            updates.forEach(u => {
                const id = u.id;
                const idx = testRunItems.findIndex(it => it.id === id);
                if (idx !== -1) {
                    if ('assignee_name' in u) {
                        testRunItems[idx].assignee_name = (u.assignee_name || null);
                    }
                    if ('test_result' in u) {
                        testRunItems[idx].test_result = (u.test_result || null);
                        testRunItems[idx].executed_at = u.executed_at || new Date().toISOString();
                    }
                }
            });
            renderTestRunItems();
        } catch (_) {}

        // 再從伺服器重載一次，確保資料正確
        await loadTestRunItems();
        await updateStatistics();

        // 若詳情 Modal 開啟中則刷新 timeline（以目前顯示的 test case）
        try {
            const modalEl = document.getElementById('testCaseDetailModal');
            const isShown = modalEl && modalEl.classList.contains('show');
            if (isShown && currentDetailTestCase && currentDetailTestCase.test_case_number) {
                renderResultHistoryTimeline({ test_case_number: currentDetailTestCase.test_case_number });
            }
        } catch (_) {}

        // 清空選擇狀態並更新 UI
        selectedItems.clear();
        updateItemSelectionUI();

        // 顯示成功訊息，包括處理結果
        if (result.success) {
            const successMsg = window.i18n && window.i18n.isReady()
                ? window.i18n.t('testRun.batchModifySuccess', {count: result.success_count})
                : `成功修改 ${result.success_count} 個測試執行項目`;
            AppUtils.showSuccess(successMsg);
        } else {
            // 部分成功的情況
            const partialMsg = window.i18n && window.i18n.isReady()
                ? window.i18n.t('testRun.batchModifyPartial', {success: result.success_count, total: result.processed_count})
                : `已處理 ${result.processed_count} 個項目，成功 ${result.success_count} 個`;
            AppUtils.showWarning(partialMsg);

            if (result.error_messages && result.error_messages.length > 0) {
                console.warn('批次修改錯誤:', result.error_messages);
            }
        }

    } catch (error) {
        const consoleMsg = window.i18n && window.i18n.isReady()
            ? window.i18n.t('testRun.batchModifyFailed')
            : '批次修改測試執行項目失敗';
        console.error(consoleMsg + ':', error);
        throw error;
    }
}

// 顯示批次刪除確認對話框
function showBatchDeleteConfirm() {
    if (selectedItems.size === 0) {
        const noSelectionMsg = window.i18n && window.i18n.isReady()
            ? window.i18n.t('testRun.noItemsSelected')
            : '{{ i18n.t("testRun.noItemsSelected") if i18n else "請先選擇要刪除的項目" }}';
        AppUtils.showWarning(noSelectionMsg);
        return;
    }

    const confirmMessage = window.i18n && window.i18n.isReady()
        ? window.i18n.t('testRun.batchDeleteConfirm', {count: selectedItems.size})
        : `確定要刪除選中的 ${selectedItems.size} 個測試執行項目嗎？\n\n⚠️ 警告：此操作將同時清除所有相關的測試歷程記錄，此動作無法復原！`;

    // 為批次刪除添加特殊的警告樣式
    const modalDialog = document.querySelector('#confirmModal .modal-dialog');
    const modalContent = document.querySelector('#confirmModal .modal-content');
    const modalHeader = document.querySelector('#confirmModal .modal-header');
    const confirmBtn = document.getElementById('confirm-action-btn');

    // 保存原始樣式
    const originalClasses = {
        dialog: modalDialog.className,
        content: modalContent.className,
        header: modalHeader.className,
        btn: confirmBtn.className
    };

    // 應用危險操作的樣式
    modalDialog.className = 'modal-dialog modal-dialog-centered modal-dialog-scrollable';
    modalContent.className = 'modal-content border-danger';
    modalHeader.className = 'modal-header bg-danger text-white';
    confirmBtn.className = 'btn btn-danger';

    // 更新標題圖標和文字
    const modalTitle = document.querySelector('#confirmModal .modal-title');
    modalTitle.innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>
        <span data-i18n="testRun.batchDeleteWarning">危險操作警告</span>
    `;

    document.getElementById('confirm-message').innerHTML = confirmMessage.replace(/\n/g, '<br>');

    // 設置確認按鈕事件
    confirmBtn.onclick = async () => {
        try {
            await batchDeleteItems();
            confirmModal.hide();
        } catch (error) {
            AppUtils.showError('{{ i18n.t("testRun.batchDeleteFailed") if i18n else "批次刪除失敗" }}' + ': ' + error.message);
        }
    };

    // 當對話框隱藏時恢復原始樣式
    const modalElement = document.getElementById('confirmModal');
    modalElement.addEventListener('hidden.bs.modal', function() {
        modalDialog.className = originalClasses.dialog;
        modalContent.className = originalClasses.content;
        modalHeader.className = originalClasses.header;
        confirmBtn.className = originalClasses.btn;
        modalTitle.innerHTML = `
            <i class="fas fa-exclamation-triangle text-warning me-2"></i>
            <span data-i18n="common.confirm">確認操作</span>
        `;
    }, { once: true });

    confirmModal.show();
}

// 批次刪除測試執行項目
async function batchDeleteItems() {
    try {
        const itemsToDelete = Array.from(selectedItems);
        let successCount = 0;
        let errorMessages = [];

        // 逐個刪除項目（因為可能沒有批次刪除 API）
        for (const itemId of itemsToDelete) {
            try {
                const response = await fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/${itemId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    successCount++;
                    // 從本地列表中移除已刪除的項目
                    const idx = testRunItems.findIndex(it => it.id === itemId);
                    if (idx !== -1) {
                        testRunItems.splice(idx, 1);
                    }
                } else {
                    let errorMessage = 'Unknown error';
                    try {
                        const errorData = await response.json();
                        if (typeof errorData.detail === 'string') {
                            errorMessage = errorData.detail;
                        } else if (errorData.detail && typeof errorData.detail === 'object') {
                            errorMessage = JSON.stringify(errorData.detail);
                        } else if (errorData.message) {
                            errorMessage = errorData.message;
                        }
                    } catch (e) {
                        errorMessage = response.statusText || 'Request failed';
                    }
                    errorMessages.push(`項目 ${itemId}: ${errorMessage}`);
                }
            } catch (error) {
                errorMessages.push(`項目 ${itemId}: ${error.message}`);
            }
        }

        // 重新渲染列表
        renderTestRunItems();

        // 重新載入項目和統計
        await loadTestRunItems();
        await updateStatistics();

        // 若詳情 Modal 開啟中且顯示的項目已被刪除，則關閉 Modal
        try {
            const modalEl = document.getElementById('testCaseDetailModal');
            const isShown = modalEl && modalEl.classList.contains('show');
            if (isShown && currentDetailTestCase) {
                const item = testRunItems.find(i => i.test_case_number === currentDetailTestCase.test_case_number);
                if (!item) {
                    // 如果當前顯示的項目已被刪除，關閉 Modal
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    if (modal) modal.hide();
                }
            }
        } catch (_) {}

        // 清空選擇狀態並更新 UI
        selectedItems.clear();
        updateItemSelectionUI();

        // 顯示結果訊息
        if (successCount === itemsToDelete.length) {
            // 全部成功
            const successMsg = window.i18n && window.i18n.isReady()
                ? window.i18n.t('testRun.batchDeleteSuccess', {count: successCount})
                : `成功刪除 ${successCount} 個測試執行項目及其測試歷程`;
            AppUtils.showSuccess(successMsg);
        } else if (successCount > 0) {
            // 部分成功
            const partialMsg = window.i18n && window.i18n.isReady()
                ? window.i18n.t('testRun.batchDeletePartial', {success: successCount, total: itemsToDelete.length})
                : `已處理 ${itemsToDelete.length} 個項目，成功刪除 ${successCount} 個測試執行項目`;
            AppUtils.showWarning(partialMsg);

            if (errorMessages.length > 0) {
                console.warn('批次刪除錯誤:', errorMessages);
            }
        } else {
            // 全部失敗
            const failMsg = window.i18n && window.i18n.isReady()
                ? window.i18n.t('testRun.batchDeleteFailed')
                : '批次刪除失敗';
            throw new Error(`${failMsg}: ${errorMessages.join(', ')}`);
        }

    } catch (error) {
        const consoleMsg = window.i18n && window.i18n.isReady()
            ? window.i18n.t('testRun.batchDeleteFailed')
            : '批次刪除測試執行項目失敗';
        console.error(consoleMsg + ':', error);
        throw error;
    }
}

function navigateToTestCase(testCaseNumber) {
    if (!testCaseNumber) {
        AppUtils.showWarning('{{ i18n.t("testRun.invalidTestCaseNumber") if i18n else "無效的測試案例編號" }}');
        return;
    }
    
    // 顯示 Test Case 詳細資料 Modal
    showTestCaseDetailModal(testCaseNumber);
}

// Test Case 詳細資料 Modal 相關函數
let testCaseDetailModalInstance = null;
let currentDetailTestCase = null; // 目前顯示於執行頁 Modal 的 Test Case，用於鍵盤導航

// 初始化 Test Case 詳細資料 Modal 中的 AssigneeSelector
function initializeTestCaseAssigneeSelector(testCase) {
    if (!window.AssigneeSelector || !currentTeamId) return;

    const assigneeInput = document.querySelector('#testCaseDetailModal .assignee-editor[data-assignee-selector]');
    if (!assigneeInput) return;

    // 清理之前的實例
    if (assigneeInput._assigneeSelector) {
        assigneeInput._assigneeSelector.destroy();
    }

    const options = {
        teamId: currentTeamId,
        allowCustomValue: true,
        onSelect: (contact) => {
            // 更新當前 Test Run Item 的 assignee（以本地 SQLite 為準）
            const item = (testRunItems || []).find(i => i.test_case_number === testCase.test_case_number);
            if (item) updateAssignee(item.id, contact.name);
        },
        onClear: () => {
            const item = (testRunItems || []).find(i => i.test_case_number === testCase.test_case_number);
            if (item) updateAssignee(item.id, '');
        }
    };

    assigneeInput._assigneeSelector = new AssigneeSelector(assigneeInput, options);
}

// 已移除：原先更新 Test Case 的 Assignee（改為只更新 Test Run Item 的本地欄位）

// 卷動到附件區域
function scrollToAttachments() {
    const attachmentsSection = document.getElementById('attachmentsSection');
    if (attachmentsSection) {
        // 找到可捲動的容器
        const scrollableContainer = document.getElementById('testCaseDetailScrollable');
        if (scrollableContainer) {
            // 計算附件區域相對於可捲動容器的位置
            const containerRect = scrollableContainer.getBoundingClientRect();
            const attachmentRect = attachmentsSection.getBoundingClientRect();

            // 計算需要捲動的距離
            const scrollTop = attachmentRect.top - containerRect.top + scrollableContainer.scrollTop;

            // 平滑捲動到附件區域
            scrollableContainer.scrollTo({
                top: scrollTop - 20, // 留一點邊距
                behavior: 'smooth'
            });
        }
    }
}

// 卷動到附件區域
function scrollToAttachments() {
    const attachmentsSection = document.getElementById('attachmentsSection');
    if (attachmentsSection) {
        // 找到可捲動的容器
        const scrollableContainer = document.getElementById('testCaseDetailScrollable');
        if (scrollableContainer) {
            // 計算附件區域相對於可捲動容器的位置
            const containerRect = scrollableContainer.getBoundingClientRect();
            const attachmentRect = attachmentsSection.getBoundingClientRect();

            // 計算需要捲動的距離
            const scrollTop = attachmentRect.top - containerRect.top + scrollableContainer.scrollTop;

            // 平滑捲動到附件區域
            scrollableContainer.scrollTo({
                top: scrollTop - 20, // 留一點邊距
                behavior: 'smooth'
            });
        }
    }
}

async function showTestCaseDetailModal(testCaseNumber) {
    // 初始化 Modal
    const modalElement = document.getElementById('testCaseDetailModal');
    if (!testCaseDetailModalInstance) {
        testCaseDetailModalInstance = new bootstrap.Modal(modalElement);
    }
    
    // 確保這個 Modal 有最高的 z-index (高於其他 Modal)
    // Bug Tickets Summary Modal 預設是 1055，所以設置為 1080 確保在上層
    modalElement.style.zIndex = '1080';
    
    // 設置 Modal 事件監聽器來處理 backdrop z-index
    modalElement.addEventListener('shown.bs.modal', function() {
        // 找到最新的 backdrop 並設置正確的 z-index
        const backdrops = document.querySelectorAll('.modal-backdrop');
        if (backdrops.length > 0) {
            // 設置最新的 backdrop 有較高的 z-index
            const latestBackdrop = backdrops[backdrops.length - 1];
            latestBackdrop.style.zIndex = '1079';
        }
        
        // 確保 Modal 本身的 z-index 是最高的
        modalElement.style.zIndex = '1080';
    });
    
    // 重置 Modal 狀態
    document.getElementById('testCaseDetailLoading').style.display = 'block';
    const fixedDiv = document.getElementById('testCaseDetailFixed');
    const scrollDiv = document.getElementById('testCaseDetailScrollable');
    fixedDiv.style.display = 'none';
    scrollDiv.style.display = 'none';
    document.getElementById('testCaseDetailError').style.display = 'none';
    document.getElementById('openFullTestCaseBtn').style.display = 'none';
    // 在載入期間先隱藏/清空標頭的 Test Result，避免顯示舊資料
    const headerResult = document.getElementById('testCaseDetailHeaderResult');
    if (headerResult) {
        headerResult.innerHTML = '';
        headerResult.style.visibility = 'hidden';
    }
    
    // 顯示 Modal
    testCaseDetailModalInstance.show();
    // 綁定鍵盤左右鍵支援
    const modalEl = document.getElementById('testCaseDetailModal');
    if (!modalEl._keydownBound) {
        modalEl.addEventListener('shown.bs.modal', function() {
            document.addEventListener('keydown', handleExecDetailModalKeydown);
        });
        modalEl.addEventListener('hidden.bs.modal', function() {
            document.removeEventListener('keydown', handleExecDetailModalKeydown);
        });
        modalEl._keydownBound = true;
    }
    
    try {
        // 載入 Test Case 資料
        await loadTestCaseDetail(testCaseNumber);
    } catch (error) {
        console.error('Failed to load test case detail:', error);
        showTestCaseDetailError();
    }
}

async function loadTestCaseDetail(testCaseNumber) {
    try {
        // 先嘗試從 localStorage 讀取快取，若 1 小時內則直接顯示
        const cached = getCachedTestCase(testCaseNumber);
        if (cached && (Date.now() - cached.ts) < TEST_CASE_CACHE_TTL_MS) {
            displayTestCaseDetail(cached.data);
            return; // 使用快取，不發出請求
        }

        // 從當前團隊的測試案例中搜尋
        const url = new URL(`/api/teams/${currentTeamId}/testcases/`, window.location.origin);
        url.searchParams.set('search', testCaseNumber);
        url.searchParams.set('limit', '1');
        
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const testCases = await response.json();
        
        if (testCases.length === 0) {
            throw new Error('找不到指定的測試案例');
        }
        
        const testCase = testCases.find(tc => tc.test_case_number === testCaseNumber);
        if (!testCase) {
            throw new Error('找不到指定的測試案例');
        }

        // 寫入快取
        setCachedTestCase(testCaseNumber, testCase);

        // 顯示 Test Case 詳細資料
        displayTestCaseDetail(testCase);
        
    } catch (error) {
        console.error('Error loading test case detail:', error);
        throw error;
    }
}

function displayTestCaseDetail(testCase) {
    // 隱藏載入狀態
    document.getElementById('testCaseDetailLoading').style.display = 'none';
    
    // 準備顯示資料
    const fixedDiv = document.getElementById('testCaseDetailFixed');
    const scrollDiv = document.getElementById('testCaseDetailScrollable');
    const openBtn = document.getElementById('openFullTestCaseBtn');
    
    // 生成詳細資料 HTML（拆分固定與可捲動內容）
    const { fixedHtml, scrollableHtml } = createTestCaseDetailHtml(testCase);
    fixedDiv.innerHTML = fixedHtml;
    scrollDiv.innerHTML = scrollableHtml;
    
    // 顯示內容和開啟按鈕
    const bodyRow = document.getElementById('testCaseDetailBodyRow');
    if (bodyRow) bodyRow.classList.remove('d-none');
    fixedDiv.style.display = 'block';
    scrollDiv.style.display = 'block';
    openBtn.style.display = 'inline-block';
    // 記錄目前展示的 Test Case，供鍵盤導航使用
    currentDetailTestCase = testCase;
    
    // 設定開啟按鈕的點擊事件
    openBtn.onclick = function() {
        const url = `/test-case-management?tc=${encodeURIComponent(testCase.test_case_number)}&team_id=${encodeURIComponent(currentTeamId)}&minimal=1&mode=edit`;
        window.open(url, 'TestCaseEditor', 'width=1200,height=800,noopener,noreferrer');
    };
    
    // 應用 i18n 翻譯
    if (window.i18n && window.i18n.isReady()) {
        window.i18n.retranslate(fixedDiv);
        window.i18n.retranslate(scrollDiv);
    }

    // 在標頭區渲染 Test Result 下拉或唯讀 badge
    renderModalHeaderResult(testCase);

    // 渲染右側 Timeline（結果歷程）
    renderResultHistoryTimeline(testCase);
    // 載入完成後再顯示，避免切換時顯示上一筆資料
    const headerResult = document.getElementById('testCaseDetailHeaderResult');
    if (headerResult) {
        headerResult.style.visibility = 'visible';
    }

    // 綁定上一隻、下一隻按鈕
    const prevBtn = document.getElementById('prevExecCaseBtn');
    const nextBtn = document.getElementById('nextExecCaseBtn');
    if (prevBtn && nextBtn) {
        prevBtn.onclick = () => navigateExecCase(testCase, -1);
        nextBtn.onclick = () => navigateExecCase(testCase, 1);
        // 依序號狀態啟用/停用
        const idx = (testRunItems || []).findIndex(i => i.test_case_number === testCase.test_case_number);
        prevBtn.disabled = idx <= 0;
        nextBtn.disabled = idx < 0 || idx >= testRunItems.length - 1;
    }

    // 初始化 AssigneeSelector
    initializeTestCaseAssigneeSelector(testCase);

    // 控制 Bug Tickets 新增按鈕狀態
    const addBugTicketBtn = document.getElementById('addBugTicketBtn');
    if (addBugTicketBtn && testRunConfig) {
        const canAddBugTickets = testRunConfig.status !== 'completed' && testRunConfig.status !== 'archived';
        addBugTicketBtn.disabled = !canAddBugTickets;
        addBugTicketBtn.style.opacity = canAddBugTickets ? '1' : '0.3';
        addBugTicketBtn.style.cursor = canAddBugTickets ? 'pointer' : 'not-allowed';
    }

    // 載入 Bug Tickets
    const testRunItem = (testRunItems || []).find(item => item.test_case_number === testCase.test_case_number);
    if (testRunItem && testRunItem.id) {
        loadBugTickets(testRunItem.id);
    }
}

// 生成基本資訊區域的 HTML
function generateBasicInfoHtml(testCase) {
    // 以 Test Run Item 的 assignee_name 為準（本地 DB），而非 Test Case 的 assignee
    const itemForCase = (testRunItems || []).find(i => i.test_case_number === testCase.test_case_number);
    const assigneeName = itemForCase ? (itemForCase.assignee_name || '') : '';
    const tcgText = testCase.tcg && testCase.tcg.length > 0 ? testCase.tcg.map(t => t.text || t).join(', ') : '';
    const attachmentCount = testCase.attachments ? testCase.attachments.length : 0;

    return `
        <!-- Basic Info 區域 -->
        <div class="card mb-2">
            <div class="card-header py-1">
                <h6 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    <span data-i18n="testRun.basicInfo">基本資訊</span>
                </h6>
            </div>
            <div class="card-body px-2 basic-info-body">
                <table class="table table-sm table-borderless mb-0 basic-info-table">
                    <tr>
                        <td class="basic-info-label" data-i18n="testRun.testCaseNumber">編號</td>
                        <td class="basic-info-value"><code class="basic-info-code">${escapeHtml(testCase.test_case_number)}</code></td>
                        <td class="basic-info-label">${tcgText ? 'TCG' : ''}</td>
                        <td class="basic-info-value">${tcgText ? '<code class="basic-info-code tcg-tag" data-tcg="' + escapeHtml(tcgText) + '">' + escapeHtml(tcgText) + '</code>' + 
                            '<button type="button" title="檢視 JIRA Ticket 資訊" data-i18n-title="tooltips.viewJiraInfo" onclick="showTCGPreviewInTestRun(\'' + escapeHtml(tcgText) + '\', event)" style="border: none; background: none; padding: 0; margin-left: 8px; color: #6c757d; cursor: pointer; font-size: 0.8em;"><i class="fas fa-eye"></i></button>' : ''}</td>
                    </tr>
                    <tr>
                        <td class="basic-info-label" data-i18n="testRun.title">標題</td>
                        <td class="basic-info-value basic-info-title" colspan="3">${escapeHtml(testCase.title)}</td>
                    </tr>
                    <tr>
                        <td class="basic-info-label" data-i18n="testRun.priority">優先級</td>
                        <td class="basic-info-value"><span class="badge bg-secondary basic-info-badge">${escapeHtml(testCase.priority || 'Medium')}</span></td>
                        <td class="basic-info-label" data-i18n="testRun.assignee">執行者</td>
                        <td class="basic-info-value">
                            <input type="text" class="form-control form-control-sm assignee-editor basic-info-input"
                                   value="${escapeHtml(assigneeName || '')}"
                                   data-assignee-selector
                                   data-test-case-id="${testCase.test_case_number}"
                                   placeholder="{{ i18n.t('testRun.enterAssigneeName') if i18n else '輸入執行者姓名' }}">
                        </td>
                    </tr>
                    <tr>
                        <td class="basic-info-label basic-info-label-top" data-i18n="testRun.attachments">附件</td>
                        <td colspan="3" class="basic-info-value">
                            <div class="d-flex align-items-center">
                                ${attachmentCount > 0 ? `
                                    <a href="#" class="text-decoration-none" onclick="scrollToAttachments(); return false;" title="${escapeHtml('{{ i18n.t("testRun.attachments") if i18n else "附件" }}')}">
                                        <i class="fas fa-paperclip me-1"></i>
                                        ${attachmentCount} <span data-i18n="testRun.files">個文件</span>
                                    </a>
                                ` : `
                                    <span class="text-muted"><i class="fas fa-paperclip me-1"></i>0 <span data-i18n="testRun.files">個文件</span></span>
                                `}
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        <!-- Test Details 標題（固定） -->
        <div class="card mb-2">
            <div class="card-header py-2">
                <h6 class="card-title mb-0">
                    <i class="fas fa-clipboard-list me-2"></i>
                    <span data-i18n="testRun.testDetails">測試詳情</span>
                </h6>
            </div>
        </div>`;
}

// 生成可捲動內容區域的 HTML
function generateScrollableContentHtml(testCase) {
    const attachmentCount = testCase.attachments ? testCase.attachments.length : 0;

    return `
        <div class="card scrollable-content-card">
            <div class="card-body scrollable-content-body">
                ${testCase.precondition ? `
                <div class="mb-3">
                    <h6 class="mb-2" data-i18n="testRun.precondition">前置條件</h6>
                    <div class="section-block section-precondition">
                        <div class="markdown-preview mb-0 content-markdown">${renderMarkdown(testCase.precondition)}</div>
                    </div>
                </div>
                ` : ''}
                ${testCase.steps ? `
                <div class="mb-3">
                    <h6 class="mb-2" data-i18n="testRun.steps">測試步驟</h6>
                    <div class="section-block section-steps">
                        <div class="markdown-preview mb-0 content-markdown">${renderMarkdown(testCase.steps)}</div>
                    </div>
                </div>
                ` : ''}
                ${testCase.expected_result ? `
                <div class="mb-3">
                    <h6 class="mb-2" data-i18n="testRun.expectedResult">預期結果</h6>
                    <div class="section-block section-expected">
                        <div class="markdown-preview mb-0 content-markdown">${renderMarkdown(testCase.expected_result)}</div>
                    </div>
                </div>
                ` : ''}
                ${attachmentCount > 0 ? `
                <div class="mt-3" id="attachmentsSection">
                    <h6 class="mb-2" data-i18n="testRun.attachments">附件</h6>
                    <div class="section-block section-attachments">
                    <div class="d-flex flex-wrap align-items-center">
                        ${testCase.attachments.map((attachment, index) => {
                            const fileExtension = attachment.name ? attachment.name.split('.').pop().toLowerCase() : '';
                            let iconClass = 'fas fa-file';
                            let iconColor = 'text-secondary';
                            switch(fileExtension) {
                                case 'pdf': iconClass = 'fas fa-file-pdf'; iconColor = 'text-danger'; break;
                                case 'doc': case 'docx': iconClass = 'fas fa-file-word'; iconColor = 'text-primary'; break;
                                case 'xls': case 'xlsx': iconClass = 'fas fa-file-excel'; iconColor = 'text-success'; break;
                                case 'jpg': case 'jpeg': case 'png': case 'gif': case 'bmp': case 'webp': iconClass = 'fas fa-file-image'; iconColor = 'text-info'; break;
                                case 'txt': iconClass = 'fas fa-file-alt'; iconColor = 'text-secondary'; break;
                                case 'zip': case 'rar': case '7z': iconClass = 'fas fa-file-archive'; iconColor = 'text-warning'; break;
                                default: iconClass = 'fas fa-file'; iconColor = 'text-secondary';
                            }
                            const attachmentToken = attachment.file_token || attachment.token || '';
                            const attachmentName = attachment.name || ('附件 ' + (index + 1));
                            const attachmentUrl = attachment.url || '';
                            return '<span class="d-inline-flex align-items-center me-3 mb-2 attachment-item" '
                                + 'style="cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 0.25rem; transition: background-color 0.15s;" '
                                + 'onclick="handleAttachmentClick(\'' + escapeHtml(attachmentName) + '\', \'' + attachmentToken + '\', \'' + attachmentUrl + '\')" '
                                + 'onmouseover="this.style.backgroundColor=\'var(--tr-bg-light)\'" '
                                + 'onmouseout="this.style.backgroundColor=\'transparent\'" '
                                + 'title="點擊查看附件: ' + escapeHtml(attachmentName) + '">'
                                + '<i class="' + iconClass + ' ' + iconColor + ' me-1"></i>'
                                + '<small style="text-decoration: underline; color: var(--tr-primary);">' + escapeHtml(attachmentName) + '</small>'
                                + '</span>';
                        }).join('')}
                    </div>
                    </div>
                </div>
                ` : ''}
            </div>
        </div>`;
}

function createTestCaseDetailHtml(testCase) {
    const fixedHtml = generateBasicInfoHtml(testCase);
    const scrollableHtml = generateScrollableContentHtml(testCase);

    return { fixedHtml, scrollableHtml };
}


function renderModalHeaderResult(testCase) {
    const container = document.getElementById('testCaseDetailHeaderResult');
    if (!container) return;

    const item = getItemByTestCaseNumber(testCase.test_case_number);
    const currentResult = item ? (item.test_result || '') : '';
    const canEdit = testRunConfig && testRunConfig.status === 'active';
    const hasExecutionHistory = item && item.executed_at !== null && item.executed_at !== undefined;

    if (canEdit && item) {
        container.innerHTML = `
            <select class="form-select form-select-sm result-selector-lg ${getResultClass(currentResult)}"
                    onchange="updateSelectClass(this); updateTestResult(${item.id}, this.value)">
                ${!hasExecutionHistory ? `<option value="">${escapeHtml('{{ i18n.t("testRun.notExecuted") if i18n else "Not Executed" }}')}</option>` : ''}
                <option value="Passed" ${currentResult === 'Passed' ? 'selected' : ''}>${escapeHtml('{{ i18n.t("testRun.passed") if i18n else "Passed" }}')}</option>
                <option value="Failed" ${currentResult === 'Failed' ? 'selected' : ''}>${escapeHtml('{{ i18n.t("testRun.failed") if i18n else "Failed" }}')}</option>
                <option value="Retest" ${currentResult === 'Retest' ? 'selected' : ''}>${escapeHtml('{{ i18n.t("testRun.retest") if i18n else "Retest" }}')}</option>
                <option value="Not Available" ${currentResult === 'Not Available' ? 'selected' : ''}>${escapeHtml('{{ i18n.t("testRun.notAvailable") if i18n else "Not Available" }}')}</option>
            </select>
        `;
        const select = container.querySelector('select');
        if (select) updateSelectClass(select);
    } else {
        container.innerHTML = `
            <span class="badge result-badge-lg ${getResultClass(currentResult)}">${getResultText(currentResult)}</span>
        `;
    }
}

// 依 test_case_number 找到對應 item
function getItemByTestCaseNumber(testCaseNumber) {
    return (testRunItems || []).find(i => i.test_case_number === testCaseNumber);
}

async function renderResultHistoryTimeline(testCase) {
    try {
        const pane = document.getElementById('testCaseDetailTimelinePane');
        const loading = document.getElementById('timelineLoading');
        const empty = document.getElementById('timelineEmpty');
        const list = document.getElementById('timelineList');
        if (!pane || !list) return;

        // 顯示區塊與載入中
        pane.style.display = 'block';
        loading.style.display = 'block';
        empty.style.display = 'none';
        list.innerHTML = '';

        const item = getItemByTestCaseNumber(testCase.test_case_number);
        if (!item) { loading.style.display = 'none'; empty.style.display = 'block'; return; }
        
        // 設定當前項目 ID 供 Bug Ticket 功能使用
        currentItemIdForBugTicket = item.id;

        const resp = await fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/${item.id}/result-history?limit=50`);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const records = await resp.json();
        loading.style.display = 'none';

        if (!Array.isArray(records) || records.length === 0) {
            empty.style.display = 'block';
            return;
        }

        // 生成 timeline 項目
        const rows = records.map(r => {
            const time = r.changed_at ? AppUtils.formatDate(r.changed_at, 'datetime') : '';
            const from = r.prev_result ? getResultText(r.prev_result) : '{{ i18n.t("testRun.notExecuted") if i18n else "Not Executed" }}';
            const to = r.new_result ? getResultText(r.new_result) : '{{ i18n.t("testRun.notExecuted") if i18n else "Not Executed" }}';
            const badgeFrom = `<span class="badge ${getResultClass(r.prev_result)}">${from}</span>`;
            const badgeTo = `<span class="badge ${getResultClass(r.new_result)}">${to}</span>`;
            const who = r.changed_by_name || '';
            const reason = r.change_reason ? `<div class="text-muted small">${escapeHtml(r.change_reason)}</div>` : '';
            return `
                <div class="timeline-item">
                    <div class="time">${time}${who ? ` · ${escapeHtml(who)}` : ''}</div>
                    <div class="status">${badgeFrom} <i class="fas fa-arrow-right mx-1"></i> ${badgeTo}</div>
                    ${reason}
                    <div class="timeline-divider"></div>
                </div>
            `;
        }).join('');
        list.innerHTML = rows;

        // Bug Tickets 在 displayTestCaseDetail 中載入

        // 綁定刷新按鈕
        const refreshBtn = document.getElementById('refreshTimelineBtn');
        if (refreshBtn) refreshBtn.onclick = () => renderResultHistoryTimeline(testCase);
    } catch (e) {
        const loading = document.getElementById('timelineLoading');
        const empty = document.getElementById('timelineEmpty');
        if (loading) loading.style.display = 'none';
        if (empty) empty.style.display = 'block';
        console.warn('load result history failed:', e);
    }
}

// 點擊 Basic Info 的附件摘要時，捲動到內容區的附件區塊
function scrollToAttachments() {
    try {
        const container = document.getElementById('testCaseDetailScrollable');
        const target = container ? container.querySelector('#attachmentsSection') : null;
        if (container && target) {
            const top = target.offsetTop - 8; // 預留一點上邊距
            container.scrollTo({ top, behavior: 'smooth' });
        }
    } catch (_) {}
}

// 鍵盤支援：在執行頁的 Test Case 詳細 Modal 使用左右鍵切換
function handleExecDetailModalKeydown(e) {
    try {
        const modal = document.getElementById('testCaseDetailModal');
        if (!modal || !modal.classList.contains('show')) return;
        // 避免在輸入元件或可編輯區域觸發
        const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
        const isEditable = e.target && (e.target.isContentEditable || tag === 'input' || tag === 'textarea' || tag === 'select');
        if (isEditable) return;
        if (!currentDetailTestCase) return;
        if (e.key === 'ArrowLeft') {
            e.preventDefault();
            navigateExecCase(currentDetailTestCase, -1);
        } else if (e.key === 'ArrowRight') {
            e.preventDefault();
            navigateExecCase(currentDetailTestCase, 1);
        }
    } catch (_) {}
}

// ====== 本地快取（localStorage）工具 ======
function getCacheKey(testCaseNumber) {
    // 以 teamId + testCaseNumber 組成個人快取 key
    const team = currentTeamId || 'unknown';
    return `${TEST_CASE_CACHE_PREFIX}:${team}:${testCaseNumber}`;
}

function getCachedTestCase(testCaseNumber) {
    try {
        const key = getCacheKey(testCaseNumber);
        const raw = localStorage.getItem(key);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed.ts !== 'number' || !parsed.data) return null;
        return parsed;
    } catch (_) {
        return null;
    }
}

function setCachedTestCase(testCaseNumber, testCaseData) {
    try {
        const key = getCacheKey(testCaseNumber);
        const payload = { ts: Date.now(), data: testCaseData };
        localStorage.setItem(key, JSON.stringify(payload));
    } catch (_) {
        // 忽略快取錯誤（例如超出容量）
    }
}

// 判斷是否為新鮮快取
function isFreshCache(cached) {
    return cached && (Date.now() - cached.ts) < TEST_CASE_CACHE_TTL_MS;
}

// 以 test_case_number 從後端取得詳細並寫入快取
async function fetchAndCacheTestCase(testCaseNumber) {
    if (!testCaseNumber) return;
    try {
        const url = new URL(`/api/teams/${currentTeamId}/testcases/`, window.location.origin);
        url.searchParams.set('search', testCaseNumber);
        url.searchParams.set('limit', '1');
        const resp = await fetch(url);
        if (!resp.ok) return;
        const list = await resp.json();
        const tc = Array.isArray(list) ? list.find(t => t.test_case_number === testCaseNumber) : null;
        if (tc) setCachedTestCase(testCaseNumber, tc);
    } catch (_) {}
}

// 針對目前的 Test Run Items 預先載入所有 Test Case 詳細
async function prefetchTestCasesForItems(items) {
    try {
        const numbers = (items || []).map(i => i.test_case_number).filter(Boolean);
        if (numbers.length === 0) return;
        // 過濾已新鮮快取者
        const toFetch = numbers.filter(n => !isFreshCache(getCachedTestCase(n)));
        if (toFetch.length === 0) return;
        // 控制併發量，避免過多同時請求
        const queue = Array.from(new Set(toFetch)); // 去重
        const concurrency = 5;
        const workers = new Array(Math.min(concurrency, queue.length)).fill(0).map(async () => {
            while (queue.length > 0) {
                const n = queue.pop(); // 先取出，再 await，避免競態
                await fetchAndCacheTestCase(n);
            }
        });
        await Promise.all(workers);
    } catch (e) {
        console.debug('prefetch test cases skipped:', e);
    }
}

// 參考 Test Case Management 的做法：
// 一次性抓取整個團隊的 Test Cases，將與本次 Test Run 有關的案例寫入快取
async function preloadAllTeamTestCasesForRun(items) {
    try {
        const resp = await fetch(`/api/teams/${currentTeamId}/testcases/`);
        if (!resp.ok) {
            // 若整批抓取失敗，退回逐筆預抓策略
            await prefetchTestCasesForItems(items);
            return;
        }
        const all = await resp.json();
        const need = new Set((items || []).map(i => i.test_case_number).filter(Boolean));
        if (!all || !Array.isArray(all)) return;
        for (const tc of all) {
            if (tc && tc.test_case_number && need.has(tc.test_case_number)) {
                setCachedTestCase(tc.test_case_number, tc);
            }
        }
    } catch (e) {
        console.debug('preloadAllTeamTestCasesForRun failed, fallback to prefetch each:', e);
        await prefetchTestCasesForItems(items);
    }
}

// 在 Test Run 項目清單中，根據目前 Test Case 移動到前/後一筆
async function navigateExecCase(currentTestCase, step) {
    if (!Array.isArray(testRunItems) || testRunItems.length === 0) return;
    const idx = testRunItems.findIndex(i => i.test_case_number === currentTestCase.test_case_number);
    if (idx < 0) return;
    const newIdx = idx + step;
    if (newIdx < 0 || newIdx >= testRunItems.length) return;
    const nextItem = testRunItems[newIdx];
    if (!nextItem) return;
    // 重用現有流程：以 test_case_number 載入詳細
    await showTestCaseDetailModal(nextItem.test_case_number);
}

// 移除 Modal 內更新結果的輔助函式（已回滾設計）

function showTestCaseDetailError() {
    document.getElementById('testCaseDetailLoading').style.display = 'none';
    document.getElementById('testCaseDetailContent').style.display = 'none';
    document.getElementById('testCaseDetailError').style.display = 'block';
}

async function updateAssignee(itemId, assigneeName) {
    try {
        // 清理輸入值
        const cleanAssignee = assigneeName ? assigneeName.trim() : '';
        
        const response = await fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/${itemId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                assignee_name: cleanAssignee || null
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        // 更新本地資料
        const itemIndex = testRunItems.findIndex(item => item.id === itemId);
        if (itemIndex !== -1) {
            testRunItems[itemIndex].assignee_name = cleanAssignee || null;
        }
        
        // 不顯示成功訊息，讓編輯過程更流暢
        
    } catch (error) {
        console.error('Failed to update assignee:', error);
        AppUtils.showError('{{ i18n.t("testRun.updateAssigneeFailed") if i18n else "更新執行者失敗" }}' + ': ' + error.message);
        
        // 恢復原始值
        const input = document.querySelector(`input[data-item-id="${itemId}"]`);
        if (input) {
            const originalItem = testRunItems.find(item => item.id === itemId);
            input.value = originalItem ? (originalItem.assignee_name || '') : '';
        }
    }
}

function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

// Markdown 渲染輔助函數
function renderMarkdown(content) {
    if (!content) return '';
    
    if (typeof marked !== 'undefined') {
        try {
            return marked.parse(content);
        } catch (error) {
            console.error('Markdown parse error:', error);
            // 如果 Markdown 渲染失敗，回退到純文字顯示
            return `<pre style="white-space: pre-wrap; font-size: 0.9rem;">${escapeHtml(content)}</pre>`;
        }
    } else {
        // 如果 marked 庫未載入，回退到純文字顯示
        return `<pre style="white-space: pre-wrap; font-size: 0.9rem;">${escapeHtml(content)}</pre>`;
    }
}

// 處理附件點擊事件
function handleAttachmentClick(attachmentName, fileToken, fileUrl) {
    console.log('附件點擊:', { attachmentName, fileToken, fileUrl });
    
    // 如果有 file_token 或 file_url，嘗試通過代理 API 下載
    if ((fileToken && fileToken.trim() !== '') || (fileUrl && fileUrl.trim() !== '')) {
        try {
            // 構建代理下載 URL
            const proxyUrl = new URL(`/api/attachments/teams/${currentTeamId}/attachments/download`, window.location.origin);
            
            if (fileUrl && fileUrl.trim() !== '') {
                proxyUrl.searchParams.set('file_url', fileUrl);
            } else if (fileToken && fileToken.trim() !== '') {
                proxyUrl.searchParams.set('file_token', fileToken);
            }
            
            if (attachmentName && attachmentName.trim() !== '') {
                proxyUrl.searchParams.set('filename', attachmentName);
            }
            
            // 在新窗口中打開代理下載 URL
            window.open(proxyUrl.toString(), '_blank', 'noopener,noreferrer');
            return;
        } catch (error) {
            console.error('構建代理下載 URL 失敗:', error);
        }
    }
    
    // 如果沒有有效的 token 或 URL，顯示附件信息
    console.log('沒有有效的附件 token 或 URL，顯示附件信息');
    showAttachmentInfo(attachmentName, fileToken, fileUrl);
}

// 顯示附件信息
function showAttachmentInfo(attachmentName, fileToken, fileUrl) {
    const modalHtml = `
        <div class="modal fade" id="attachmentInfoModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-paperclip me-2"></i>
                            <span data-i18n="testRun.attachmentDetails">附件詳情</span>
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <table class="table table-borderless">
                            <tr>
                                <td class="fw-bold" data-i18n="testRun.attachmentName">附件名稱:</td>
                                <td>${escapeHtml(attachmentName)}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">File Token:</td>
                                <td><code style="font-size: 0.8rem; word-break: break-all;">${escapeHtml(fileToken)}</code></td>
                            </tr>
                            ${fileUrl ? `
                            <tr>
                                <td class="fw-bold">URL:</td>
                                <td><a href="${escapeHtml(fileUrl)}" target="_blank" rel="noopener">${escapeHtml(fileUrl)}</a></td>
                            </tr>
                            ` : ''}
                        </table>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <span data-i18n="testRun.attachmentNote">此附件存儲在 Lark 中。如需下載，請前往原始 Lark 多維表格查看。</span>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.close">關閉</button>
                        ${(fileUrl || fileToken) ? `
                        <button type="button" class="btn btn-primary" onclick="handleAttachmentDownload('${escapeHtml(attachmentName)}', '${fileToken}', '${escapeHtml(fileUrl)}')">
                            <i class="fas fa-download me-2"></i>
                            <span data-i18n="testRun.downloadAttachment">下載附件</span>
                        </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>`;
    
    // 移除舊的模態框（如果存在）
    const existingModal = document.getElementById('attachmentInfoModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // 添加新的模態框到頁面
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // 顯示模態框
    const modal = new bootstrap.Modal(document.getElementById('attachmentInfoModal'));
    
    // 應用翻譯（如果可用）
    if (window.i18n && window.i18n.isReady()) {
        window.i18n.retranslate(document.getElementById('attachmentInfoModal'));
    }
    
    modal.show();
    
    // 模態框關閉後清理
    document.getElementById('attachmentInfoModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

// 處理附件下載（從信息模態框中）
function handleAttachmentDownload(attachmentName, fileToken, fileUrl) {
    console.log('附件下載:', { attachmentName, fileToken, fileUrl });
    
    if ((fileToken && fileToken.trim() !== '') || (fileUrl && fileUrl.trim() !== '')) {
        try {
            // 構建代理下載 URL
            const proxyUrl = new URL(`/api/attachments/teams/${currentTeamId}/attachments/download`, window.location.origin);
            
            if (fileUrl && fileUrl.trim() !== '') {
                proxyUrl.searchParams.set('file_url', fileUrl);
            } else if (fileToken && fileToken.trim() !== '') {
                proxyUrl.searchParams.set('file_token', fileToken);
            }
            
            if (attachmentName && attachmentName.trim() !== '') {
                proxyUrl.searchParams.set('filename', attachmentName);
            }
            
            // 在新窗口中打開代理下載 URL
            window.open(proxyUrl.toString(), '_blank', 'noopener,noreferrer');
        } catch (error) {
            console.error('構建附件下載 URL 失敗:', error);
            const errorMessage = window.i18n ? window.i18n.t('errors.attachmentDownloadFailed', {}, '附件下載失敗') : '附件下載失敗';
            AppUtils.showError(errorMessage + ': ' + error.message);
        }
    } else {
        const warningMessage = window.i18n ? window.i18n.t('errors.noAttachmentDownloadInfo', {}, '沒有可用的附件下載信息') : '沒有可用的附件下載信息';
        AppUtils.showWarning(warningMessage);
    }
}

// ===== JIRA Tooltip 功能 =====

// Tooltip 相關變數
let jiraTooltipTimeout = null;
let currentJiraHoveredElement = null;
let isJiraHoveringTooltip = false;

// 建立 JIRA tooltip 元素
function createJIRATooltip() {
    // 如果已經存在，先移除
    const existingTooltip = document.getElementById('jira-tooltip');
    if (existingTooltip) {
        existingTooltip.remove();
    }

    const tooltip = document.createElement('div');
    tooltip.id = 'jira-tooltip';
    tooltip.className = 'jira-tooltip';
    tooltip.style.cssText = `
        position: fixed;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        padding: 12px;
        max-width: 300px;
        z-index: 1100;
        display: none;
        font-size: 0.875rem;
        pointer-events: auto;
    `;

    document.body.appendChild(tooltip);
    return tooltip;
}

// 從 JIRA 取得 ticket 資訊
async function fetchJIRATicketInfo(tcgNumber) {
    try {
        const response = await fetch(`/api/jira/ticket/${tcgNumber}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            return data;
        } else if (response.status === 404) {
            return null;
        } else {
            console.error('JIRA API 錯誤:', response.status, response.statusText);
            return null;
        }
    } catch (error) {
        console.error('取得 JIRA ticket 資訊失敗:', error);
        return null;
    }
}

// 格式化 ticket tooltip 內容
function formatJIRATicketTooltip(tcgNumber, ticketData) {
    const summary = ticketData.summary || '無標題';
    const status = ticketData.status?.name || '未知狀態';
    const assignee = ticketData.assignee?.displayName || '未指派';
    const created = ticketData.created || '';
    const updated = ticketData.updated || '';

    // 格式化建立時間
    let createdDate = '未知';
    if (created) {
        try {
            const date = new Date(created);
            createdDate = date.toLocaleDateString('zh-TW');
        } catch (e) {
            console.warn('日期解析錯誤:', e);
        }
    }

    // 格式化更新時間
    let updatedDate = '';
    if (updated) {
        try {
            const date = new Date(updated);
            updatedDate = date.toLocaleDateString('zh-TW');
        } catch (e) {
            console.warn('更新日期解析錯誤:', e);
        }
    }

    // 取得翻譯文字
    const statusLabel = window.i18n ? window.i18n.t('common.status') : '狀態';
    const assigneeLabel = window.i18n ? window.i18n.t('common.assignee') : '執行者';
    const createdLabel = window.i18n ? window.i18n.t('common.createDate') : '建立';
    const updatedLabel = window.i18n ? window.i18n.t('common.updateDate') : '更新';
    const noDataText = window.i18n ? window.i18n.t('common.noDescription') : '無';

    // 組合 JIRA URL
    const jiraUrl = ticketData.url || `https://jira.example.com/browse/${tcgNumber}`;
    
    return `
        <div class="jira-tooltip-content">
            <div class="mb-2">
                <div class="fw-bold">
                    <a href="${jiraUrl}" target="_blank" class="text-primary text-decoration-none" style="cursor: pointer;">
                        ${tcgNumber}
                        <i class="fas fa-external-link-alt ms-1" style="font-size: 0.8em;"></i>
                    </a>
                </div>
                <div class="small text-muted mb-2" style="word-break: break-word; line-height: 1.3;">${summary}</div>
            </div>
            <div class="row g-2">
                <div class="col-6">
                    <div class="small">
                        <i class="fas fa-tasks me-1"></i>
                        <strong>${statusLabel}:</strong>
                    </div>
                    <div class="small text-muted">${status}</div>
                </div>
                <div class="col-6">
                    <div class="small">
                        <i class="fas fa-user me-1"></i>
                        <strong>${assigneeLabel}:</strong>
                    </div>
                    <div class="small text-muted" style="word-break: break-word;">${assignee}</div>
                </div>
                <div class="col-6">
                    <div class="small">
                        <i class="fas fa-calendar me-1"></i>
                        <strong>${createdLabel}:</strong>
                    </div>
                    <div class="small text-muted">${createdDate}</div>
                </div>
                <div class="col-6">
                    <div class="small">
                        <i class="fas fa-clock me-1"></i>
                        <strong>${updatedLabel}:</strong>
                    </div>
                    <div class="small text-muted">${updatedDate || noDataText}</div>
                </div>
            </div>
        </div>
    `;
}

// 定位 tooltip
function positionJIRATooltip(tooltip, element) {
    if (!element || !tooltip) return;
    
    const rect = element.getBoundingClientRect();
    
    // 先設置初始位置並確保可見，這樣才能獲取準確的尺寸
    tooltip.style.visibility = 'hidden';
    tooltip.style.display = 'block';
    
    const tooltipRect = tooltip.getBoundingClientRect();

    // 預設位置：元素下方
    let top = rect.bottom + 8;
    let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);

    // 如果下方空間不足，顯示在元素上方
    if (top + tooltipRect.height > window.innerHeight - 8) {
        top = rect.top - tooltipRect.height - 8;
    }

    // 確保不超出視窗邊界
    if (left < 8) {
        left = 8;
    } else if (left + tooltipRect.width > window.innerWidth - 8) {
        left = window.innerWidth - tooltipRect.width - 8;
    }

    // 應用最終位置並顯示
    tooltip.style.top = top + 'px';
    tooltip.style.left = left + 'px';
    tooltip.style.visibility = 'visible';
}

// Test Run 頁面的 TCG 預覽函數
async function showTCGPreviewInTestRun(tcgNumber, eventObj) {
    if (!tcgNumber || !tcgNumber.trim()) {
        return;
    }
    
    // 找到觸發元素（查找包含該 TCG 號碼的按鈕）
    const triggerButton = eventObj ? eventObj.target : event.target;
    
    const tooltip = createJIRATooltip();

    // 設定載入狀態
    tooltip.innerHTML = `
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span>載入中...</span>
        </div>
    `;

    // 顯示 tooltip
    positionJIRATooltip(tooltip, triggerButton);

    try {
        const ticketData = await fetchJIRATicketInfo(tcgNumber);

        if (ticketData) {
            tooltip.innerHTML = formatJIRATicketTooltip(tcgNumber, ticketData);
        } else {
            tooltip.innerHTML = `
                <div class="text-muted small">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    無法取得 ${tcgNumber} 的資訊
                </div>
            `;
        }
        
        // 重新定位
        positionJIRATooltip(tooltip, triggerButton);
        
        // 添加點擊關閉事件
        tooltip.addEventListener('click', function(e) {
            e.stopPropagation();
        });
        
        // 點擊其他地方關閉 tooltip
        const closeTooltip = function(e) {
            if (!tooltip.contains(e.target) && e.target !== triggerButton) {
                tooltip.style.display = 'none';
                document.removeEventListener('click', closeTooltip);
            }
        };
        
        setTimeout(() => {
            document.addEventListener('click', closeTooltip);
        }, 100);
        
        // 自動隱藏 tooltip
        setTimeout(() => {
            if (tooltip && tooltip.style.display !== 'none') {
                tooltip.style.display = 'none';
                document.removeEventListener('click', closeTooltip);
            }
        }, 8000);
        
    } catch (error) {
        console.error('JIRA tooltip 載入失敗:', error);
        tooltip.innerHTML = `
            <div class="text-danger small">
                <i class="fas fa-times-circle me-1"></i>
                載入失敗
            </div>
        `;
        
        // 重新定位
        positionJIRATooltip(tooltip, triggerButton);
        
        // 添加點擊關閉事件
        tooltip.addEventListener('click', function(e) {
            e.stopPropagation();
        });
        
        // 點擊其他地方關閉 tooltip
        const closeTooltip = function(e) {
            if (!tooltip.contains(e.target) && e.target !== triggerButton) {
                tooltip.style.display = 'none';
                document.removeEventListener('click', closeTooltip);
            }
        };
        
        setTimeout(() => {
            document.addEventListener('click', closeTooltip);
        }, 100);
        
        // 自動隱藏 tooltip
        setTimeout(() => {
            if (tooltip && tooltip.style.display !== 'none') {
                tooltip.style.display = 'none';
                document.removeEventListener('click', closeTooltip);
            }
        }, 5000);
    }
}

// ================== Bug Tickets 功能 ==================
let addBugTicketModal = null;
let deleteBugTicketModal = null;
let currentItemIdForBugTicket = null;
let currentTicketNumberForDelete = null;

// 初始化 Bug Ticket Modal
function initBugTicketModal() {
    if (!addBugTicketModal) {
        addBugTicketModal = new bootstrap.Modal(document.getElementById('addBugTicketModal'));
    }
    
    // 確保 Bug Ticket Modal 有最高的 z-index (高於 Test Case Detail Modal)
    const modalElement = document.getElementById('addBugTicketModal');
    modalElement.style.zIndex = '1090';
    
    // 設置 Modal 事件監聽器來處理 backdrop z-index
    modalElement.addEventListener('shown.bs.modal', function() {
        // 找到最新的 backdrop 並設置正確的 z-index
        const backdrops = document.querySelectorAll('.modal-backdrop');
        if (backdrops.length > 0) {
            // 設置最新的 backdrop 有較高的 z-index
            const latestBackdrop = backdrops[backdrops.length - 1];
            latestBackdrop.style.zIndex = '1089';
        }
        
        // 確保 Modal 本身的 z-index 是最高的
        modalElement.style.zIndex = '1090';
    });
}

// 初始化刪除 Bug Ticket Modal
function initDeleteBugTicketModal() {
    if (!deleteBugTicketModal) {
        deleteBugTicketModal = new bootstrap.Modal(document.getElementById('deleteBugTicketModal'));
    }
    
    // 確保刪除 Bug Ticket Modal 有最高的 z-index
    const modalElement = document.getElementById('deleteBugTicketModal');
    modalElement.style.zIndex = '1090';
    
    // 設置 Modal 事件監聽器來處理 backdrop z-index
    modalElement.addEventListener('shown.bs.modal', function() {
        const backdrops = document.querySelectorAll('.modal-backdrop');
        if (backdrops.length > 0) {
            const latestBackdrop = backdrops[backdrops.length - 1];
            latestBackdrop.style.zIndex = '1089';
        }
        modalElement.style.zIndex = '1090';
    });
}

// 顯示 Bug Tickets
async function loadBugTickets(itemId) {
    try {
        // 顯示載入狀態
        const bugTicketsList = document.getElementById('bugTicketsList');
        const bugTicketsEmpty = document.getElementById('bugTicketsEmpty');
        const bugTicketsLoading = document.getElementById('bugTicketsLoading');

        if (bugTicketsLoading) bugTicketsLoading.style.display = 'block';
        if (bugTicketsEmpty) bugTicketsEmpty.style.display = 'none';
        if (bugTicketsList) bugTicketsList.innerHTML = '';
        
        const url = `/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/${itemId}/bug-tickets`;
        
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: Failed to load bug tickets`);
        }
        
        const bugTickets = await response.json();
        
        bugTicketsLoading.style.display = 'none';
        
        if (bugTickets.length === 0) {
            bugTicketsEmpty.style.display = 'block';
            bugTicketsList.innerHTML = '';
        } else {
            bugTicketsEmpty.style.display = 'none';
            bugTicketsList.innerHTML = bugTickets.map(ticket => `
                <div class="bug-ticket-item d-flex justify-content-between align-items-center mb-2 p-2 border rounded bg-light">
                    <div>
                        <strong class="bug-ticket-link" data-ticket="${ticket.ticket_number}" style="cursor: pointer; color: #0066cc;">
                            ${ticket.ticket_number}
                        </strong>
                    </div>
                    <button type="button" class="btn btn-link text-secondary p-0" onclick="confirmDeleteBugTicket(${itemId}, '${ticket.ticket_number}')" data-i18n-title="common.delete" style="border: none; background: none;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
            
            // 重新翻譯動態添加的元素
            if (window.i18n && window.i18n.isReady()) {
                window.i18n.retranslate(bugTicketsList);
            }
        }
        
        return bugTickets;
    } catch (error) {
        console.error('載入 Bug Tickets 失敗:', error);
        const bugTicketsLoading = document.getElementById('bugTicketsLoading');
        const bugTicketsEmpty = document.getElementById('bugTicketsEmpty');
        
        bugTicketsLoading.style.display = 'none';
        bugTicketsEmpty.style.display = 'block';
        bugTicketsEmpty.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i><span data-i18n="testRun.loadBugTicketsFailed">載入 Bug Tickets 失敗</span>';
        return [];
    }
}

// 新增 Bug Ticket
async function addBugTicket() {
    const ticketNumber = document.getElementById('bugTicketNumber').value.trim();
    
    if (!ticketNumber) {
        AppUtils.showError(window.i18n ? window.i18n.t('testRun.ticketNumberHelp') : '請輸入 JIRA Ticket 編號');
        return;
    }
    
    if (!currentItemIdForBugTicket) {
        AppUtils.showError('Missing item ID');
        return;
    }
    
    try {
        const response = await fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/${currentItemIdForBugTicket}/bug-tickets`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                ticket_number: ticketNumber
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to add bug ticket');
        }
        
        // 關閉模態框並清空表單
        addBugTicketModal.hide();
        document.getElementById('bugTicketNumber').value = '';
        
        // 重新載入 Bug Tickets 列表
        await loadBugTickets(currentItemIdForBugTicket);
        
        AppUtils.showSuccess(window.i18n ? window.i18n.t('testRun.bugTicketAdded') : 'Bug Ticket 新增成功');
        
    } catch (error) {
        console.error('新增 Bug Ticket 失敗:', error);
        AppUtils.showError(error.message || (window.i18n ? window.i18n.t('testRun.addBugTicketFailed') : '新增 Bug Ticket 失敗'));
    }
}

// 顯示刪除 Bug Ticket 確認對話框
function confirmDeleteBugTicket(itemId, ticketNumber) {
    initDeleteBugTicketModal();
    currentItemIdForBugTicket = itemId;
    currentTicketNumberForDelete = ticketNumber;
    
    // 顯示票號
    document.getElementById('deleteBugTicketNumber').textContent = ticketNumber;
    
    deleteBugTicketModal.show();
}

// 刪除 Bug Ticket
async function deleteBugTicket(itemId, ticketNumber) {
    
    try {
        const response = await fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/${itemId}/bug-tickets/${encodeURIComponent(ticketNumber)}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error('Failed to delete bug ticket');
        }
        
        // 重新載入 Bug Tickets 列表
        await loadBugTickets(itemId);
        
        AppUtils.showSuccess(window.i18n ? window.i18n.t('testRun.bugTicketDeleted') : 'Bug Ticket 已刪除');
        
    } catch (error) {
        console.error('刪除 Bug Ticket 失敗:', error);
        AppUtils.showError(error.message || (window.i18n ? window.i18n.t('testRun.deleteBugTicketFailed') : '刪除 Bug Ticket 失敗'));
    }
}

// 綁定 Bug Ticket 相關事件
function bindBugTicketEvents() {
    // 新增 Bug Ticket 按鈕
    const addBugTicketBtn = document.getElementById('addBugTicketBtn');
    if (addBugTicketBtn) {
        addBugTicketBtn.addEventListener('click', () => {
            // 檢查按鈕是否被禁用
            if (addBugTicketBtn.disabled) {
                return;
            }
            
            initBugTicketModal();
            currentItemIdForBugTicket = getCurrentItemId();
            if (currentItemIdForBugTicket) {
                addBugTicketModal.show();
                // 清空表單
                document.getElementById('bugTicketNumber').value = '';
                // 焦點到輸入框
                setTimeout(() => {
                    document.getElementById('bugTicketNumber').focus();
                }, 300);
            } else {
                AppUtils.showError('請先選擇一個測試項目');
            }
        });
    }
    
    // 確認新增 Bug Ticket 按鈕
    const confirmAddBugTicket = document.getElementById('confirmAddBugTicket');
    if (confirmAddBugTicket) {
        confirmAddBugTicket.addEventListener('click', addBugTicket);
    }

    // 確認刪除 Bug Ticket 按鈕
    const confirmDeleteBugTicketBtn = document.getElementById('confirmDeleteBugTicket');
    if (confirmDeleteBugTicketBtn) {
        confirmDeleteBugTicketBtn.addEventListener('click', async () => {
            if (currentItemIdForBugTicket && currentTicketNumberForDelete) {
                deleteBugTicketModal.hide();
                await deleteBugTicket(currentItemIdForBugTicket, currentTicketNumberForDelete);
                currentItemIdForBugTicket = null;
                currentTicketNumberForDelete = null;
            }
        });
    }
    
    // Enter 鍵提交表單
    const bugTicketNumberInput = document.getElementById('bugTicketNumber');
    if (bugTicketNumberInput) {
        bugTicketNumberInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addBugTicket();
            }
        });
    }
    
    // 委託事件：Bug Ticket 點擊預覽
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('bug-ticket-link')) {
            const ticketNumber = e.target.getAttribute('data-ticket');
            if (ticketNumber) {
                showBugTicketPreview(ticketNumber, e.target);
            }
        }
    });
}

// 取得當前選中的測試項目 ID
function getCurrentItemId() {
    // 使用在 renderResultHistoryTimeline 中設定的 currentItemIdForBugTicket
    return currentItemIdForBugTicket;
}

// Bug Ticket 預覽 (使用類似 TCG 預覽的方式)
async function showBugTicketPreview(ticketNumber, triggerElement) {
    try {
        console.log('Loading Bug ticket preview for:', ticketNumber);
        
        // 檢查是否已存在 tooltip，如果存在先移除
        const existingTooltip = document.getElementById('bugTicketTooltip');
        if (existingTooltip) {
            existingTooltip.remove();
        }
        
        // 創建 tooltip 容器
        const tooltip = document.createElement('div');
        tooltip.id = 'bugTicketTooltip';
        tooltip.style.cssText = `
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1080;
            max-width: 400px;
            font-size: 14px;
            display: none;
            pointer-events: auto;
        `;
        
        // 顯示載入中
        tooltip.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-spinner fa-spin me-2"></i>
                <span>載入 JIRA Ticket 資訊中...</span>
            </div>
        `;
        
        document.body.appendChild(tooltip);
        
        // 定位 tooltip
        positionJIRATooltip(tooltip, triggerElement);
        tooltip.style.display = 'block';
        
        // 獲取 JIRA ticket 資訊
        const response = await fetch(`/api/jira/ticket/${encodeURIComponent(ticketNumber)}`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const ticketData = await response.json();
        
        // 顯示 ticket 資訊
        const createdDate = ticketData.created ? new Date(ticketData.created).toLocaleDateString() : '';
        const updatedDate = ticketData.updated ? new Date(ticketData.updated).toLocaleDateString() : '';
        const createdLabel = window.i18n ? window.i18n.t('tooltip.created') : '建立日期';
        const updatedLabel = window.i18n ? window.i18n.t('tooltip.updated') : '更新日期';
        
        tooltip.innerHTML = `
            <div class="mb-2">
                <div class="d-flex align-items-center mb-1">
                    <i class="fas fa-bug text-danger me-2"></i>
                    <strong>${ticketData.ticket_key || ticketNumber}</strong>
                    <span class="badge ms-2 ${getJIRAStatusBadgeClass(ticketData.status?.name)}">${ticketData.status?.name || 'Unknown'}</span>
                </div>
                <div class="text-muted small mb-2">${ticketData.summary || 'No summary available'}</div>
            </div>
            <div class="small text-muted border-top pt-2">
                <div class="row">
                    <div class="col-6">
                        <strong>${createdLabel}:</strong><br>
                        ${createdDate}
                    </div>
                    <div class="col-6">
                        <strong>${updatedLabel}:</strong><br>
                        ${updatedDate}
                    </div>
                </div>
                ${ticketData.assignee?.displayName ? `<div class="mt-2"><strong>${window.i18n ? window.i18n.t('tooltip.assignedTo') : '指派給'}:</strong> ${ticketData.assignee.displayName}</div>` : ''}
                ${ticketData.url ? `<div class="mt-2"><a href="${ticketData.url}" target="_blank" class="text-primary"><i class="fas fa-external-link-alt me-1"></i>${window.i18n ? window.i18n.t('tooltip.openInJira') : '在 JIRA 中開啟'}</a></div>` : ''}
            </div>
        `;
        
        // 重新定位
        positionJIRATooltip(tooltip, triggerElement);
        
        // 添加點擊關閉事件
        tooltip.addEventListener('click', function(e) {
            e.stopPropagation();
        });
        
        // 點擊其他地方關閉 tooltip
        const closeTooltip = function(e) {
            if (!tooltip.contains(e.target) && e.target !== triggerElement) {
                tooltip.style.display = 'none';
                document.removeEventListener('click', closeTooltip);
            }
        };
        
        setTimeout(() => {
            document.addEventListener('click', closeTooltip);
        }, 100);
        
        // 自動隱藏 tooltip
        setTimeout(() => {
            if (tooltip && tooltip.style.display !== 'none') {
                tooltip.style.display = 'none';
                document.removeEventListener('click', closeTooltip);
            }
        }, 8000);
        
    } catch (error) {
        console.error('Bug ticket tooltip 載入失敗:', error);
        const tooltip = document.getElementById('bugTicketTooltip');
        if (tooltip) {
            tooltip.innerHTML = `
                <div class="text-danger small">
                    <i class="fas fa-times-circle me-1"></i>
                    載入失敗
                </div>
            `;
            
            // 重新定位
            positionJIRATooltip(tooltip, triggerElement);
            
            // 自動隱藏錯誤 tooltip
            setTimeout(() => {
                if (tooltip && tooltip.style.display !== 'none') {
                    tooltip.style.display = 'none';
                }
            }, 3000);
        }
    }
}

// JIRA 狀態對應的 Badge 類別
function getJIRAStatusBadgeClass(status) {
    if (!status) return 'bg-secondary';
    
    const statusLower = status.toLowerCase();
    if (['done', 'closed', 'resolved', 'fixed'].includes(statusLower)) {
        return 'bg-success';
    }
    if (['in progress', 'in-progress', 'inprogress'].includes(statusLower)) {
        return 'bg-primary';
    }
    if (['open', 'to do', 'todo', 'new'].includes(statusLower)) {
        return 'bg-info';
    }
    if (['blocked', 'on hold'].includes(statusLower)) {
        return 'bg-danger';
    }
    return 'bg-warning';
}

// ================== Bug Tickets Summary 功能 ==================
let bugTicketsSummaryModal = null;
let currentBugTicketsSummary = null;
let currentBugStatusFilter = 'ALL';

// Bug Tickets 狀態到徽章顏色的映射
function getBugStatusBadgeClass(status) {
    const statusName = (status || '').toUpperCase().trim();
    
    const statusMap = {
        'TO DO': 'bg-primary',
        'TODO': 'bg-primary',
        'IN PROGRESS': 'bg-info', 
        'INPROGRESS': 'bg-info',
        'RESOLVED': 'bg-success',
        'CLOSED': 'bg-dark',
        'OPEN': 'bg-warning',
        'SCHEDULED': 'bg-secondary'
    };
    
    return statusMap[statusName] || 'bg-secondary';
}

// Bug Tickets 狀態篩選功能
function filterBugTicketsByStatus(status) {
    currentBugStatusFilter = status;
    
    // 更新按鈕狀態
    document.querySelectorAll('[data-status]').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-status') === status) {
            btn.classList.add('active');
        }
    });
    
    // 重新渲染
    if (currentBugTicketsSummary) {
        renderBugTicketsCards(currentBugTicketsSummary, document.getElementById('bugTicketsSummaryList'));
        // 重新翻譯動態生成的內容
        if (window.i18n && window.i18n.isReady()) {
            window.i18n.retranslate(document.getElementById('bugTicketsSummaryList'));
        }
    }
}

// 初始化 Bug Tickets Summary Modal
function initBugTicketsSummaryModal() {
    console.log('初始化 Bug Tickets Summary Modal');
    const modalElement = document.getElementById('bugTicketsSummaryModal');
    if (modalElement && !bugTicketsSummaryModal) {
        bugTicketsSummaryModal = new bootstrap.Modal(modalElement);
        console.log('Modal 已初始化');
    } else if (!modalElement) {
        console.error('找不到 bugTicketsSummaryModal 元素');
    }
}

// 顯示 Bug Tickets Summary Modal
async function showBugTicketsModal() {
    console.log('=== 開始顯示 Bug Tickets Modal ===');
    console.log('準備顯示 Bug Tickets Modal');
    initBugTicketsSummaryModal();
    
    if (bugTicketsSummaryModal) {
        bugTicketsSummaryModal.show();
        console.log('Modal 已顯示，開始載入資料');
        
        // 延遲一下確保 Modal 完全打開
        setTimeout(() => {
            loadBugTicketsSummary();
        }, 100);
    } else {
        console.error('無法顯示 Modal');
    }
}

// 載入 Bug Tickets Summary 資料
async function loadBugTicketsSummary() {
    console.log('開始載入 Bug Tickets Summary 資料');
    console.log('當前 Team ID:', currentTeamId, 'Config ID:', currentConfigId);
    
    const loadingEl = document.getElementById('bugTicketsSummaryLoading');
    const emptyEl = document.getElementById('bugTicketsSummaryEmpty');
    const contentEl = document.getElementById('bugTicketsSummaryContent');
    
    // 檢查所有必要元素
    if (!loadingEl) {
        console.error('找不到 bugTicketsSummaryLoading 元素');
        return;
    }
    if (!emptyEl) {
        console.error('找不到 bugTicketsSummaryEmpty 元素');
        return;
    }
    if (!contentEl) {
        console.error('找不到 bugTicketsSummaryContent 元素');
        return;
    }
    
    console.log('所有必要元素都存在，開始載入');
    
    // 重置所有狀態
    loadingEl.style.display = 'block';
    emptyEl.style.display = 'none';
    contentEl.style.display = 'none';
    
    try {
        const url = `/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/bug-tickets/summary`;
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const summaryData = await response.json();
        currentBugTicketsSummary = summaryData;
        loadingEl.style.display = 'none';
        
        if (!summaryData || summaryData.total_unique_tickets === 0 || !summaryData.tickets || summaryData.tickets.length === 0) {
            emptyEl.style.display = 'block';
            return;
        }
        
        contentEl.style.display = 'block';
        renderBugTicketsSummary(summaryData);
        
    } catch (error) {
        console.error('載入失敗:', error);
        loadingEl.style.display = 'none';
        emptyEl.style.display = 'block';
        emptyEl.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i><span class="text-danger">載入失敗: ' + error.message + '</span>';
    }
}

// 渲染 Bug Tickets Summary
function renderBugTicketsSummary(summaryData) {
    const bugTicketsList = document.getElementById('bugTicketsSummaryList');
    
    if (!bugTicketsList) {
        console.error('找不到必要的元素');
        return;
    }
    
    renderBugTicketsCards(summaryData, bugTicketsList);
}

function renderBugTicketsCards(summaryData, bugTicketsList) {
    if (!summaryData.tickets || summaryData.tickets.length === 0) {
        const noBugTicketsText = '{{ i18n.t("testRun.noBugTicketsInRun") if i18n else "此 Test Run 尚無 Bug Tickets" }}';
        bugTicketsList.innerHTML = `<div class="text-muted text-center p-4"><i class="fas fa-info-circle me-2"></i>${noBugTicketsText}</div>`;
        return;
    }
    
    // 根據當前篩選條件過濾 tickets
    let filteredTickets = summaryData.tickets;
    if (currentBugStatusFilter !== 'ALL') {
        filteredTickets = summaryData.tickets.filter(ticket => {
            const statusName = (ticket.ticket_info.status.name || '').toUpperCase().trim();
            const filterStatus = currentBugStatusFilter.toUpperCase().trim();
            return statusName === filterStatus || 
                   (filterStatus === 'IN PROGRESS' && statusName === 'INPROGRESS') ||
                   (filterStatus === 'TO DO' && statusName === 'TODO');
        });
    }
    
    if (filteredTickets.length === 0) {
        const noTicketsForStatusText = '{{ i18n.t("testRun.noTicketsForStatus") if i18n else "此狀態下無 Bug Tickets" }}';
        bugTicketsList.innerHTML = `<div class="text-muted text-center p-4"><i class="fas fa-filter me-2"></i>${noTicketsForStatusText}</div>`;
        return;
    }
    
    let cardsHTML = '';
    
    filteredTickets.forEach(ticket => {
        const ticketInfo = ticket.ticket_info;
        const testCases = ticket.test_cases;
        
        let testCasesHTML = '';
        testCases.forEach(testCase => {
            testCasesHTML += `
                <div class="border rounded p-2 mb-2 bg-white" style="cursor: pointer;" 
                     onclick="showTestCaseQuickView('${testCase.test_case_number}')">
                    <strong class="text-primary">${testCase.test_case_number}</strong><br>
                    <small class="text-muted">${testCase.title || ''}</small>
                </div>
            `;
        });
        
        // 使用新的狀態顏色映射函數
        const badgeClass = getBugStatusBadgeClass(ticketInfo.status.name);
        
        cardsHTML += `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6 class="card-title">
                                <a href="${ticketInfo.url}" target="_blank" class="text-decoration-none">
                                    ${ticketInfo.ticket_number} 
                                    <i class="fas fa-external-link-alt fa-sm"></i>
                                </a>
                            </h6>
                            <span class="badge ${badgeClass}">${ticketInfo.status.name}</span>
                            <p class="card-text mt-2">
                                <small class="text-muted">${ticketInfo.summary || 'No summary available'}</small>
                            </p>
                        </div>
                        <div class="col-md-8">
                            <h6><i class="fas fa-list-ul me-1"></i><span data-i18n="testRun.relatedTestCases">相關測試案例</span>
                                <span class="badge bg-info">${testCases.length}</span>
                            </h6>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${testCasesHTML}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    bugTicketsList.innerHTML = cardsHTML;
}



// 重新整理 Bug Tickets 狀態（呼叫 JIRA API 更新狀態）
async function refreshBugTicketsStatus() {
    if (!currentBugTicketsSummary || currentBugTicketsSummary.total_unique_tickets === 0) {
        return;
    }
    
    // 顯示重新整理進度
    const refreshBtn = document.querySelector('button[onclick="refreshBugTicketsStatus()"]');
    const originalHtml = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>更新中...';
    refreshBtn.disabled = true;
    
    try {
        // 依序呼叫 JIRA API 更新每個 ticket 的狀態
        for (let ticket of currentBugTicketsSummary.tickets) {
            try {
                const response = await fetch(`/api/jira/ticket/${encodeURIComponent(ticket.ticket_info.ticket_number)}`);
                if (response.ok) {
                    const jiraData = await response.json();
                    // 更新本地資料
                    ticket.ticket_info.status = jiraData.status;
                    ticket.ticket_info.summary = jiraData.summary;
                }
            } catch (error) {
                console.warn(`Failed to update ticket ${ticket.ticket_info.ticket_number}:`, error);
            }
        }
        
        // 重新渲染
        renderBugTicketsSummary(currentBugTicketsSummary);
        AppUtils.showSuccess('Bug Tickets 狀態已更新');
        
    } catch (error) {
        console.error('重新整理 Bug Tickets 狀態失敗:', error);
        AppUtils.showError('更新狀態失敗: ' + error.message);
    } finally {
        refreshBtn.innerHTML = originalHtml;
        refreshBtn.disabled = false;
    }
}

// 測試案例快速預覽（使用瀏覽器 popup）
function showTestCaseQuickView(testCaseNumber) {
    // 直接使用現有的 Test Case Detail Modal
    showTestCaseDetailModal(testCaseNumber);
}

// 頁面載入完成後進行基礎檢查
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== DOM 載入完成，開始檢查 Bug Tickets 功能 ===');
    
    // 檢查 Bug Tickets 卡片
    const bugTicketsCard = document.querySelector('.bug-tickets-card');
    if (bugTicketsCard) {
        console.log('✓ Bug Tickets 卡片元素存在');
        console.log('✓ 點擊事件:', bugTicketsCard.getAttribute('onclick'));
    } else {
        console.error('✗ 找不到 Bug Tickets 卡片元素');
    }
    
    // 檢查 Modal 元素
    const modal = document.getElementById('bugTicketsSummaryModal');
    if (modal) {
        console.log('✓ Bug Tickets Modal 元素存在');
    } else {
        console.error('✗ 找不到 Bug Tickets Modal 元素');
    }
    
    // 檢查關鍵子元素
    const loading = document.getElementById('bugTicketsSummaryLoading');
    const empty = document.getElementById('bugTicketsSummaryEmpty');
    const content = document.getElementById('bugTicketsSummaryContent');
    const list = document.getElementById('bugTicketsSummaryList');
    
    console.log('Modal 子元素檢查:');
    console.log('  Loading元素:', loading ? '✓存在' : '✗缺失');
    console.log('  Empty元素:', empty ? '✓存在' : '✗缺失');
    console.log('  Content元素:', content ? '✓存在' : '✗缺失');
    console.log('  List元素:', list ? '✓存在' : '✗缺失');
    
    // 檢查函數是否存在
    console.log('函數檢查:');
    console.log('  showBugTicketsModal:', typeof showBugTicketsModal);
    console.log('  loadBugTicketsSummary:', typeof loadBugTicketsSummary);
    console.log('  renderBugTicketsSummary:', typeof renderBugTicketsSummary);
});

// Charts & Reports 功能
document.getElementById('exportBtn').addEventListener('click', function() {
    showChartsReportsModal();
});

function showChartsReportsModal() {
    const modal = new bootstrap.Modal(document.getElementById('chartsReportsModal'));
    modal.show();
    
    console.log('準備顯示 Charts & Reports modal');
    
    // Modal 顯示後載入圖表
    document.getElementById('chartsReportsModal').addEventListener('shown.bs.modal', function() {
        console.log('Modal 已完全顯示，開始初始化圖表');
        // 稍微延遲以確保所有元素都已渲染
        setTimeout(() => {
            initializeChartsAndReports();
        }, 200);
    }, { once: true });
}

async function initializeChartsAndReports() {
    console.log('開始初始化 Charts & Reports');
    
    try {
        // 顯示載入狀態
        showChartsLoading();
        console.log('顯示載入狀態');
        
        // 收集統計資料
        console.log('開始收集統計資料...');
        const statsData = collectTestRunStats();
        console.log('收集到的統計資料:', statsData);
        
        // 更新基本資訊
        console.log('更新基本資訊...');
        updateReportBasicInfo(statsData);
        
        // 渲染圖表
        console.log('開始渲染圖表...');
        await renderTestRunCharts(statsData);
        console.log('圖表渲染完成');
        
        // 隱藏載入狀態
        hideChartsLoading();
        console.log('Charts & Reports 初始化完成');
        
    } catch (error) {
        console.error('初始化圖表失敗:', error);
        hideChartsLoading();
        showChartsError();
    }
}

function collectTestRunStats() {
    const stats = {
        statusData: {
            passed: parseInt(document.getElementById('passed-count')?.textContent || '0'),
            failed: parseInt(document.getElementById('failed-count')?.textContent || '0'),
            retest: 0, // 需要從 testRunItems 中計算
            notAvailable: 0, // 需要從 testRunItems 中計算
            notExecuted: parseInt(document.getElementById('total-count')?.textContent || '0') - parseInt(document.getElementById('executed-count')?.textContent || '0')
        },
        priorityData: {
            high: 0,
            medium: 0,
            low: 0
        },
        testRunInfo: {
            name: testRunConfig?.name || 'Test Run',
            environment: testRunConfig?.test_environment || '',
            buildNumber: testRunConfig?.build_number || '',
            version: testRunConfig?.test_version || '',
            totalItems: parseInt(document.getElementById('total-count')?.textContent || '0'),
            executedItems: parseInt(document.getElementById('executed-count')?.textContent || '0'),
            executionRate: document.getElementById('execution-rate')?.textContent || '0%',
            passRate: document.getElementById('pass-rate')?.textContent || '0%'
        }
    };
    
    // 從 testRunItems 計算詳細統計
    if (testRunItems && Array.isArray(testRunItems)) {
        testRunItems.forEach(item => {
            // 計算測試結果分布
            switch (item.test_result) {
                case 'Retest':
                    stats.statusData.retest++;
                    break;
                case 'Not Available':
                    stats.statusData.notAvailable++;
                    break;
            }
            
            // 計算優先級分布
            switch (item.priority) {
                case 'High':
                    stats.priorityData.high++;
                    break;
                case 'Medium':
                    stats.priorityData.medium++;
                    break;
                case 'Low':
                    stats.priorityData.low++;
                    break;
            }
        });
    }
    
    return stats;
}

function updateReportBasicInfo(statsData) {
    // 更新基本資訊
    document.getElementById('reportTestRunName').textContent = statsData.testRunInfo.name;
    document.getElementById('reportEnvironment').textContent = statsData.testRunInfo.environment || '-';
    document.getElementById('reportBuildNumber').textContent = statsData.testRunInfo.buildNumber || '-';
    
    // 更新執行摘要
    document.getElementById('reportTotalItems').textContent = statsData.testRunInfo.totalItems;
    document.getElementById('reportExecutedItems').textContent = statsData.testRunInfo.executedItems;
    document.getElementById('reportExecutionRate').textContent = statsData.testRunInfo.executionRate;
    document.getElementById('reportPassRate').textContent = statsData.testRunInfo.passRate;
    
    // 更新統計卡片
    document.getElementById('chartPassedCount').textContent = statsData.statusData.passed;
    document.getElementById('chartFailedCount').textContent = statsData.statusData.failed;
    document.getElementById('chartRetestCount').textContent = statsData.statusData.retest;
    document.getElementById('chartNotAvailableCount').textContent = statsData.statusData.notAvailable;
}

let testRunCharts = {};

async function renderTestRunCharts(statsData) {
    console.log('開始渲染圖表，統計資料:', statsData);
    
    // 清理舊圖表
    Object.values(testRunCharts).forEach(chart => {
        if (chart) chart.destroy();
    });
    testRunCharts = {};
    
    // 確保 Chart.js 已載入
    if (typeof Chart === 'undefined') {
        throw new Error('Chart.js not loaded');
    }
    
    console.log('Chart.js 已載入，版本:', Chart.version);
    
    // 註冊 DataLabels 插件（如果可用）
    try {
        if (typeof ChartDataLabels !== 'undefined') {
            Chart.register(ChartDataLabels);
            console.log('ChartDataLabels 插件已註冊');
        } else {
            console.warn('ChartDataLabels 插件未載入，圖表將不顯示數據標籤');
        }
    } catch (error) {
        console.warn('註冊 ChartDataLabels 插件時出錯:', error);
    }
    
    // 圖表配色
    const colorScheme = {
        passed: '#28a745',
        failed: '#dc3545',
        retest: '#ffc107',
        notAvailable: '#6c757d',
        notExecuted: '#adb5bd',
        high: '#dc3545',
        medium: '#ffc107',
        low: '#28a745'
    };
    
    // 1. 測試狀態分布圓餅圖
    const statusCtx = document.getElementById('statusPieChart');
    console.log('圓餅圖 Canvas 元素:', statusCtx);
    if (statusCtx) {
        console.log('開始創建圓餅圖...');
        testRunCharts.statusPie = new Chart(statusCtx, {
            type: 'pie',
            data: {
                labels: ['Passed', 'Failed', 'Retest', 'Not Available', 'Not Executed'],
                datasets: [{
                    data: [
                        statsData.statusData.passed,
                        statsData.statusData.failed,
                        statsData.statusData.retest,
                        statsData.statusData.notAvailable,
                        statsData.statusData.notExecuted
                    ],
                    backgroundColor: [
                        colorScheme.passed,
                        colorScheme.failed,
                        colorScheme.retest,
                        colorScheme.notAvailable,
                        colorScheme.notExecuted
                    ],
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 1500,
                    easing: 'easeInOutQuart',
                    onComplete: function() {
                        console.log('圓餅圖動畫完成');
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.raw / total) * 100).toFixed(1);
                                return `${context.label}: ${context.raw} (${percentage}%)`;
                            }
                        }
                    },
                    ...(typeof ChartDataLabels !== 'undefined' ? {
                        datalabels: {
                            color: 'white',
                            font: {
                                weight: 'bold',
                                size: 14
                            },
                            formatter: (value, context) => {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return percentage > 5 ? percentage + '%' : '';
                            }
                        }
                    } : {})
                }
            }
        });
        console.log('圓餅圖創建完成');
    }
    
    // 2. 優先級分布長條圖
    const priorityCtx = document.getElementById('priorityBarChart');
    console.log('長條圖 Canvas 元素:', priorityCtx);
    if (priorityCtx) {
        console.log('開始創建長條圖...');
        testRunCharts.priorityBar = new Chart(priorityCtx, {
            type: 'bar',
            data: {
                labels: ['高', '中', '低'],
                datasets: [{
                    label: '測試案例數量',
                    data: [
                        statsData.priorityData.high,
                        statsData.priorityData.medium,
                        statsData.priorityData.low
                    ],
                    backgroundColor: [
                        colorScheme.high,
                        colorScheme.medium,
                        colorScheme.low
                    ],
                    borderColor: [
                        colorScheme.high,
                        colorScheme.medium,
                        colorScheme.low
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 1200,
                    easing: 'easeInOutQuart',
                    onComplete: function() {
                        console.log('長條圖動畫完成');
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
        console.log('長條圖創建完成');
    }
}

function showChartsLoading() {
    const loadingElement = document.getElementById('chartsLoadingOverlay');
    console.log('準備顯示載入畫面，元素:', loadingElement);
    if (loadingElement) {
        // 確保載入畫面可以顯示
        loadingElement.style.display = 'flex';
        loadingElement.style.visibility = 'visible';
        loadingElement.classList.remove('d-none');
        console.log('載入畫面已顯示');
    } else {
        console.error('找不到載入畫面元素 chartsLoadingOverlay');
    }
}

function hideChartsLoading() {
    const loadingElement = document.getElementById('chartsLoadingOverlay');
    console.log('準備隱藏載入畫面，元素:', loadingElement);
    console.log('當前 display 樣式:', loadingElement?.style.display);
    if (loadingElement) {
        // 使用多種方式確保載入畫面被隱藏
        loadingElement.style.display = 'none';
        loadingElement.style.visibility = 'hidden';
        loadingElement.classList.add('d-none');
        // 強制刷新樣式
        loadingElement.offsetHeight;
        console.log('載入畫面已隱藏，新的 display 樣式:', loadingElement.style.display);
        console.log('是否有 d-none 類:', loadingElement.classList.contains('d-none'));
    } else {
        console.error('找不到載入畫面元素 chartsLoadingOverlay');
    }
}

function showChartsError() {
    const errorElement = document.getElementById('chartsErrorMessage');
    if (errorElement) {
        errorElement.style.display = 'block';
    }
}

// PDF 下載功能
// 將 Chart.js 圖表轉換為靜態圖片以支援 PDF 列印
async function convertChartsToImages() {
    const conversions = [];
    const canvasElements = document.querySelectorAll('#chartsReportsModal canvas');
    
    console.log(`找到 ${canvasElements.length} 個圖表需要轉換`);
    
    // 首先等待所有圖表完全渲染（包括動畫和插件）
    await waitForAllChartsToRender(canvasElements);
    console.log('所有圖表渲染完成，開始轉換...');
    
    // 使用 Promise.all 確保所有轉換都完成
    const conversionPromises = Array.from(canvasElements).map((canvas, index) => {
        return new Promise(async (resolve) => {
            try {
                // 確認圖表存在且已渲染
                const chart = Chart.getChart(canvas);
                if (chart) {
                    // 確保圖表處於靜止狀態（禁用動畫效果）
                    const originalAnimation = chart.options.animation;
                    chart.options.animation = false;
                    chart.update('none'); // 立即更新，不使用動畫
                    
                    // 等待更新完成
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                    // 獲取高品質的圖片資料，考慮高DPI顯示
                    const deviceRatio = window.devicePixelRatio || 1;
                    const imageData = canvas.toDataURL('image/png', 1.0);
                    
                    console.log(`圖表 ${index + 1} 轉換 - 裝置比率: ${deviceRatio}, 圖片大小: ${imageData.length}`);
                    
                    // 驗證圖片數據是否有效
                    if (!imageData || imageData === 'data:,' || imageData.length < 100) {
                        throw new Error(`圖表 ${index + 1} 轉換產生無效圖片數據`);
                    }
                    
                    // 創建 img 元素替換 canvas
                    const img = document.createElement('img');
                    img.src = imageData;
                    img.style.width = '100%';
                    img.style.height = 'auto';
                    img.style.maxWidth = '100%';
                    img.style.display = 'block';
                    img.classList.add('chart-image-replacement');
                    
                    // 等待圖片載入完成
                    await new Promise((imgResolve) => {
                        if (img.complete) {
                            imgResolve();
                        } else {
                            img.onload = imgResolve;
                            img.onerror = imgResolve;
                        }
                    });
                    
                    // 保存原始 canvas 以便後續恢復
                    canvas.style.display = 'none';
                    canvas.dataset.originalDisplay = 'block';
                    canvas.dataset.originalAnimation = JSON.stringify(originalAnimation);
                    canvas.parentNode.insertBefore(img, canvas.nextSibling);
                    
                    const conversionResult = { canvas, img, chart, originalAnimation };
                    console.log(`圖表 ${index + 1} 轉換成功`);
                    conversions.push(conversionResult);
                    resolve(conversionResult);
                } else {
                    console.warn(`Canvas ${index + 1} 沒有對應的 Chart 實例`);
                    resolve(null);
                }
            } catch (error) {
                console.error(`圖表 ${index + 1} 轉換失敗:`, error);
                resolve(null);
            }
        });
    });
    
    // 等待所有轉換完成
    await Promise.all(conversionPromises);
    console.log(`完成轉換，成功轉換 ${conversions.length} 個圖表`);
    
    return conversions;
}

// 等待所有圖表完全渲染的輔助函數
async function waitForAllChartsToRender(canvasElements) {
    console.log('開始等待圖表渲染完成...');
    
    const chartPromises = Array.from(canvasElements).map(async (canvas, index) => {
        const chart = Chart.getChart(canvas);
        if (chart) {
            return waitForSingleChartRender(chart, index);
        }
        return Promise.resolve();
    });
    
    await Promise.all(chartPromises);
    
    // 額外等待時間確保插件（如 DataLabels）完全渲染
    await new Promise(resolve => setTimeout(resolve, 800));
    console.log('所有圖表和插件渲染等待完成');
}

// 等待單個圖表渲染完成
async function waitForSingleChartRender(chart, index) {
    return new Promise(resolve => {
        console.log(`等待圖表 ${index + 1} 渲染完成...`);
        
        // 檢查圖表是否正在動畫中
        if (chart.isAnimating && chart.isAnimating()) {
            console.log(`圖表 ${index + 1} 正在動畫中，等待完成...`);
            
            // Chart.js 3.x 使用 onAnimationComplete
            const originalOnComplete = chart.options.animation?.onComplete;
            chart.options.animation = chart.options.animation || {};
            chart.options.animation.onComplete = function(context) {
                console.log(`圖表 ${index + 1} 動畫完成`);
                // 恢復原始回調
                if (originalOnComplete) {
                    originalOnComplete.call(this, context);
                }
                resolve();
            };
            
            // 超時保護機制（3秒）
            setTimeout(() => {
                console.warn(`圖表 ${index + 1} 動畫等待超時，強制繼續`);
                resolve();
            }, 3000);
        } else {
            // 如果沒有動畫，短暫等待確保渲染穩定
            console.log(`圖表 ${index + 1} 沒有動畫，直接等待渲染穩定`);
            setTimeout(resolve, 300);
        }
    });
}

// PDF 下載狀態管理
function showPDFLoadingState() {
    const button = document.getElementById('downloadPDFBtn');
    const icon = document.getElementById('downloadIcon');
    const text = document.getElementById('downloadText');
    
    if (button && icon && text) {
        button.disabled = true;
        button.classList.add('disabled');
        icon.className = 'fas fa-spinner fa-spin me-2';
        text.textContent = window.i18n ? window.i18n.t('testRun.generatingPDF', {}, '正在生成 PDF...') : '正在生成 PDF...';
    }
}

function hidePDFLoadingState() {
    const button = document.getElementById('downloadPDFBtn');
    const icon = document.getElementById('downloadIcon');
    const text = document.getElementById('downloadText');
    
    if (button && icon && text) {
        button.disabled = false;
        button.classList.remove('disabled');
        icon.className = 'fas fa-download me-2';
        text.textContent = window.i18n ? window.i18n.t('testRun.downloadPDF', {}, '下載 PDF 報告') : '下載 PDF 報告';
    }
}

// 恢復 Canvas 圖表元素
function restoreChartsFromImages(conversions) {
    conversions.forEach(({ canvas, img, chart, originalAnimation }, index) => {
        try {
            // 移除替換的圖片
            if (img && img.parentNode) {
                img.parentNode.removeChild(img);
            }
            
            // 恢復原始 canvas
            canvas.style.display = canvas.dataset.originalDisplay || 'block';
            delete canvas.dataset.originalDisplay;
            
            // 恢復原始動畫設置
            if (chart && originalAnimation !== undefined) {
                chart.options.animation = originalAnimation;
                // 如果需要，重新啟用動畫
                if (originalAnimation) {
                    chart.update(); // 使用預設動畫重新渲染
                }
                console.log(`圖表 ${index + 1} 動畫設置已恢復`);
            }
            
            // 清理 dataset
            if (canvas.dataset.originalAnimation) {
                delete canvas.dataset.originalAnimation;
            }
        } catch (error) {
            console.error('恢復圖表時發生錯誤:', error);
        }
    });
}

async function downloadReportAsPDF() {
    // 顯示載入狀態
    showPDFLoadingState();
    
    try {
        console.log('開始生成 PDF 報告...');
        
        // 檢查必要參數
        if (!currentTeamId || !currentConfigId) {
            throw new Error('缺少必要參數：team_id 或 config_id');
        }
        
        // 呼叫後端 API 生成 PDF
        const response = await fetch(`/api/teams/${currentTeamId}/test-runs/${currentConfigId}/generate-pdf`, {
            method: 'GET',
            headers: {
                'Accept': 'application/pdf'
            }
        });
        
        if (!response.ok) {
            if (response.status === 404) {
                throw new Error('找不到指定的 Test Run 配置');
            } else if (response.status === 500) {
                throw new Error('伺服器內部錯誤，請重試或聯繫管理員');
            } else {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
        }
        
        // 獲取 PDF 內容
        const pdfBlob = await response.blob();
        
        // 創建下載連結並自動下載
        const url = window.URL.createObjectURL(pdfBlob);
        const link = document.createElement('a');
        link.href = url;
        
        // 設定檔案名稱（包含時間戳記）
        const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
        link.download = `test-run-report-${currentConfigId}-${timestamp}.pdf`;
        
        // 觸發下載
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // 釋放記憶體
        window.URL.revokeObjectURL(url);
        
        console.log('PDF 報告下載完成');
        
    } catch (error) {
        console.error('PDF 生成錯誤:', error);
        
        // 使用 i18n 友好的錯誤提示
        const errorMessage = window.i18n ? 
            window.i18n.t('testRun.pdfGenerationFailed', {}, 'PDF 生成失敗，請重試或聯繫管理員') : 
            'PDF 生成失敗，請重試或聯繫管理員';
        
        alert(errorMessage + '\n\n錯誤詳情：' + error.message);
    } finally {
        // 恢復載入狀態
        hidePDFLoadingState();
    }
}

</script>

<!-- Charts & Reports Modal -->
<div class="modal fade" id="chartsReportsModal" tabindex="-1" aria-labelledby="chartsReportsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="chartsReportsModalLabel">
                    <i class="fas fa-chart-pie me-2"></i>
                    <span data-i18n="testRun.chartsReports">Charts & Reports</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="position: relative;">
                <!-- 載入覆蓋層 -->
                <div id="chartsLoadingOverlay" class="position-absolute w-100 h-100 d-flex align-items-center justify-content-center bg-white" style="z-index: 1000; display: none; top: 0; left: 0;">
                    <div class="text-center">
                        <div class="spinner-border text-primary mb-3" role="status"></div>
                        <div data-i18n="testRun.loadingCharts">載入圖表中...</div>
                    </div>
                </div>
                
                <!-- 錯誤訊息 -->
                <div id="chartsErrorMessage" class="alert alert-danger text-center" style="display: none;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span data-i18n="testRun.chartsLoadError">圖表載入失敗，請重新整理後再試</span>
                </div>
                
                <!-- 報告標題區域 -->
                <div class="text-center mb-4">
                    <h2 class="display-6">
                        <i class="fas fa-chart-pie me-3 text-primary"></i>
                        <span data-i18n="testRun.executionAnalytics">Test Run 執行分析報告</span>
                    </h2>
                    <p class="lead text-muted" data-i18n="testRun.analyticsSubtitle">測試執行狀態分布與統計分析</p>
                </div>
                
                <!-- 基本資訊區域 -->
                <div class="row mb-4 report-section">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <span data-i18n="testRun.basicInfo">基本資訊</span>
                                </h6>
                                <table class="table table-sm">
                                    <tr>
                                        <td><span data-i18n="testRun.configName">名稱</span></td>
                                        <td id="reportTestRunName">-</td>
                                    </tr>
                                    <tr>
                                        <td><span data-i18n="testRun.testEnvironment">測試環境</span></td>
                                        <td id="reportEnvironment">-</td>
                                    </tr>
                                    <tr>
                                        <td><span data-i18n="testRun.buildNumber">建置版本</span></td>
                                        <td id="reportBuildNumber">-</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-chart-bar me-2"></i>
                                    <span data-i18n="testRun.executionSummary">執行摘要</span>
                                </h6>
                                <table class="table table-sm">
                                    <tr>
                                        <td><span data-i18n="testRun.totalItems">總項目</span></td>
                                        <td id="reportTotalItems">0</td>
                                    </tr>
                                    <tr>
                                        <td><span data-i18n="testRun.executedItems">已執行</span></td>
                                        <td id="reportExecutedItems">0</td>
                                    </tr>
                                    <tr>
                                        <td><span data-i18n="testRun.executionRate">執行率</span></td>
                                        <td id="reportExecutionRate">0%</td>
                                    </tr>
                                    <tr>
                                        <td><span data-i18n="testRun.passRate">Pass Rate</span></td>
                                        <td id="reportPassRate">0%</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 圖表區域 -->
                <div class="row report-section">
                    <div class="col-lg-6 mb-4">
                        <div class="card chart-container">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-chart-pie me-2 text-primary"></i>
                                    <span data-i18n="testRun.statusDistribution">測試結果狀態分布</span>
                                </h6>
                                <div style="position: relative; height: 400px;">
                                    <canvas id="statusPieChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-6 mb-4">
                        <div class="card chart-container">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-chart-bar me-2 text-success"></i>
                                    <span data-i18n="testRun.priorityDistribution">優先級分布</span>
                                </h6>
                                <div style="position: relative; height: 400px;">
                                    <canvas id="priorityBarChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 統計卡片 -->
                <div class="row report-section">
                    <div class="col-md-3 mb-3">
                        <div class="card text-center border-left-success">
                            <div class="card-body">
                                <div class="h4 text-success mb-1" id="chartPassedCount">0</div>
                                <div class="text-muted" data-i18n="testRun.passedItems">Passed</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center border-left-danger">
                            <div class="card-body">
                                <div class="h4 text-danger mb-1" id="chartFailedCount">0</div>
                                <div class="text-muted" data-i18n="testRun.failedItems">Failed</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center border-left-warning">
                            <div class="card-body">
                                <div class="h4 text-warning mb-1" id="chartRetestCount">0</div>
                                <div class="text-muted" data-i18n="testRun.retestItems">Retest</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center border-left-secondary">
                            <div class="card-body">
                                <div class="h4 text-secondary mb-1" id="chartNotAvailableCount">0</div>
                                <div class="text-muted" data-i18n="testRun.notAvailableItems">Not Available</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="downloadPDFBtn" onclick="downloadReportAsPDF()">
                    <i class="fas fa-download me-2" id="downloadIcon"></i>
                    <span data-i18n="testRun.downloadPDF" id="downloadText">下載 PDF 報告</span>
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <span data-i18n="common.close">關閉</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js 相關 CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

<style>
.chart-container {
    transition: all 0.2s ease;
}

.chart-container:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    transform: translateY(-1px);
}

.border-left-success { border-left: 4px solid #28a745; }
.border-left-danger { border-left: 4px solid #dc3545; }
.border-left-warning { border-left: 4px solid #ffc107; }
.border-left-secondary { border-left: 4px solid #6c757d; }

/* Print styles moved to dynamic PDF generation function for better control */
</style>

{% endblock %}
/* reverted: no fixed height for attachments list */
