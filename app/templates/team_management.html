{% extends "base.html" %}

{% block title %}團隊管理 - Test Case Repository Web Tool{% endblock %}

{% block page_title_text %}
<span class="text-primary" data-i18n="team.management">團隊管理</span>
{% endblock %}

{% block page_subtitle_text %}
<span data-i18n="team.subtitle">管理各團隊的 Lark 多維表格連結設定</span>
{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2">
    <a href="/" class="btn btn-outline-secondary">
        <i class="fas fa-home me-2"></i><span data-i18n="navigation.backToHome">回到首頁</span>
    </a>
    <button type="button" class="btn btn-primary" id="createTeamBtn">
        <i class="fas fa-plus me-2"></i><span data-i18n="team.createTeam">新增團隊</span>
    </button>
    <button type="button" class="btn btn-secondary" id="refreshBtn">
        <i class="fas fa-sync-alt me-2"></i><span data-i18n="common.refresh">重新整理</span>
    </button>
    <button type="button" class="btn btn-secondary" id="syncOrgBtn">
        <i class="fas fa-users me-2"></i><span data-i18n="orgSync.openButton">同步組織架構</span>
    </button>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">


    <!-- 載入狀態 -->
    <div id="loading-state" class="text-center py-5" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden" data-i18n="common.loading">載入中...</span>
        </div>
        <div class="mt-3 text-muted" data-i18n="messages.loadingTeams">載入團隊資料中...</div>
    </div>

    <!-- 團隊列表區域 -->
    <div id="teams-section">
        <div class="row" id="teams-container">
            <!-- 團隊卡片將在此處動態生成 -->
        </div>
    </div>

    <!-- 無團隊時的提示 -->
    <div id="no-teams-section" class="text-center py-5" style="display: none;">
        <i class="fas fa-users fa-3x text-muted mb-3"></i>
        <h5 class="text-muted mb-2" data-i18n="team.noTeams">尚未建立任何團隊</h5>
        <p class="text-muted" data-i18n="team.noTeamsHint">點擊上方「新增團隊」按鈕開始建立第一個團隊</p>
    </div>
</div>

<!-- 建立/編輯團隊模態視窗 -->
<div class="modal fade" id="teamModal" tabindex="-1" aria-labelledby="teamModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="teamModalLabel" data-i18n="team.createTeam">新增團隊</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" data-i18n-aria-label="common.close" aria-label="關閉"></button>
            </div>
            <div class="modal-body">
                <form id="teamForm">
                    <!-- 基本資訊 -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3" data-i18n="team.basicInfo">基本資訊</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="teamName" class="form-label"><span data-i18n="team.teamName">團隊名稱</span> <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="teamName" name="name" required 
                                       data-i18n-placeholder="team.teamNamePlaceholder">
                            </div>
                            <div class="col-md-6">
                                <label for="teamDescription" class="form-label" data-i18n="team.teamDescription">團隊描述</label>
                                <input type="text" class="form-control" id="teamDescription" name="description" 
                                       data-i18n-placeholder="team.teamDescriptionPlaceholder">
                            </div>
                        </div>
                    </div>

                    <!-- Lark 設定 -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-table me-2"></i><span data-i18n="team.larkSettings">Lark 多維表格設定</span>
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="wikiToken" class="form-label"><span data-i18n="team.wikiToken">Wiki Token</span> <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="wikiToken" name="wiki_token" required 
                                       data-i18n-placeholder="team.wikiTokenPlaceholder">
                                <div class="form-text" data-i18n="team.wikiTokenHelp">從 Lark 多維表格分享連結中取得</div>
                            </div>
                            <div class="col-md-6">
                                <label for="testCaseTableId" class="form-label"><span data-i18n="team.testCaseTableId">Test Case 表格 ID</span> <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="testCaseTableId" name="test_case_table_id" required 
                                       data-i18n-placeholder="team.testCaseTableIdPlaceholder">
                                <div class="form-text" data-i18n="team.testCaseTableIdHelp">測試案例表格的 ID</div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="d-flex align-items-center">
                                    <button type="button" class="btn btn-outline-info" id="validateLarkBtn">
                                        <i class="fas fa-check me-2"></i><span data-i18n="team.validateConnection">驗證 Lark 連線</span>
                                    </button>
                                    <div id="larkValidationResult" class="ms-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- 團隊設定 -->
                    <div class="mb-3">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-cog me-2"></i><span data-i18n="team.teamSettings">團隊設定</span>
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enableNotifications" name="enable_notifications" checked>
                                    <label class="form-check-label" for="enableNotifications" data-i18n="team.enableNotifications">啟用通知</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="autoCreateBugs" name="auto_create_bugs">
                                    <label class="form-check-label" for="autoCreateBugs" data-i18n="team.autoCreateBugs">自動建立 Bug</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-primary" id="saveTeamBtn">
                    <i class="fas fa-save me-2"></i><span data-i18n="team.saveTeam">儲存團隊</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 同步歷史模態視窗 -->
<div class="modal fade" id="syncHistoryModal" tabindex="-1" aria-labelledby="syncHistoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="syncHistoryModalLabel" data-i18n="orgSync.historyModalTitle">同步歷史記錄</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" data-i18n-aria-label="common.close" aria-label="關閉"></button>
            </div>
            <div class="modal-body">
                <div id="syncHistoryLoading" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden" data-i18n="common.loading">載入中...</span>
                    </div>
                    <div class="mt-2 text-muted" data-i18n="orgSync.historyLoading">載入同步歷史記錄...</div>
                </div>
                
                <div id="syncHistoryContent">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th width="12%" data-i18n="orgSync.table.type">類型</th>
                                    <th width="12%" data-i18n="orgSync.table.status">狀態</th>
                                    <th width="22%" data-i18n="orgSync.table.startTime">開始時間</th>
                                    <th width="22%" data-i18n="orgSync.table.endTime">結束時間</th>
                                    <th width="12%" data-i18n="orgSync.table.duration">耗時</th>
                                    <th width="20%" data-i18n="orgSync.table.stats">統計</th>
                                </tr>
                            </thead>
                            <tbody id="syncHistoryTableBody">
                                <!-- 同步記錄將在此處動態生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="noSyncHistory" class="text-center py-4" style="display: none;">
                    <i class="fas fa-history fa-3x text-muted mb-3"></i>
                    <h6 class="text-muted" data-i18n="orgSync.historyNoRecordsTitle">尚無同步記錄</h6>
                    <p class="text-muted small" data-i18n="orgSync.historyNoRecordsHint">請先執行組織架構同步</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.close">關閉</button>
                <button type="button" class="btn btn-primary" id="refreshHistoryBtn">
                    <i class="fas fa-sync-alt me-2"></i><span data-i18n="common.refresh">重新整理</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 同步功能框模態視窗 -->
<div class="modal fade" id="syncModal" tabindex="-1" aria-labelledby="syncModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="syncModalLabel">
                    <i class="fas fa-users me-2"></i><span data-i18n="orgSync.modalTitle">組織架構同步管理</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" data-i18n-aria-label="common.close" aria-label="關閉"></button>
            </div>
            <div class="modal-body">
                <!-- 同步狀態區域 -->
                <div class="mb-4">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-info-circle me-2"></i><span data-i18n="orgSync.currentStatus">當前同步狀態</span>
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="syncStatusContent">
                                <div id="syncStatusLoading" class="text-center py-3" style="display: none;">
                                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                                    <span class="text-muted" data-i18n="orgSync.loadingStatus">載入狀態中...</span>
                                </div>
                                
                                <div id="syncStatusIdle" class="d-flex align-items-center" style="display: none;">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-check-circle text-success fa-2x"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-1 text-success" data-i18n="orgSync.idle">系統空閒</h6>
                                        <p class="mb-0 text-muted small" data-i18n="orgSync.readyToRun">準備執行新的同步作業</p>
                                        <div id="lastSyncTime" class="text-muted small mt-1"></div>
                                    </div>
                                </div>
                                
                                <div id="syncStatusRunning" class="d-flex align-items-center" style="display: none;">
                                    <div class="flex-shrink-0">
                                        <div class="spinner-border text-primary" role="status"></div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-1 text-primary" data-i18n="orgSync.syncing">同步進行中</h6>
                                        <p class="mb-2 text-muted small" data-i18n="orgSync.syncingDesc">正在同步組織架構資料...</p>
                                        <div class="progress mb-2" style="height: 6px;">
                                            <div id="syncProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <div id="syncProgressText" class="text-muted small" data-i18n="orgSync.preparing">準備開始...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 組織統計區域 -->
                <div class="mb-4">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-chart-bar me-2"></i><span data-i18n="orgSync.statsTitle">組織架構統計</span>
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="orgStatsContent">
                                <div id="orgStatsLoading" class="text-center py-3" style="display: none;">
                                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                                    <span class="text-muted" data-i18n="orgSync.statsLoading">載入統計資料中...</span>
                                </div>
                                
                                <div id="orgStatsData" class="text-muted" style="display: none;">
                                    <div class="d-flex flex-nowrap align-items-center org-compact-stats">
                                        <span class="stat me-3">
                                            <i class="fas fa-building text-info me-1" style="font-size: 0.95rem;"></i>
                                            <span class="fw-semibold" id="totalDepartments">-</span>
                                        </span>
                                        <span class="stat">
                                            <i class="fas fa-users text-success me-1" style="font-size: 0.95rem;"></i>
                                            <span class="fw-semibold" id="totalUsers">-</span>
                                        </span>
                                    </div>
                                </div>
                                
                                <div id="orgStatsError" class="text-center py-3 text-muted" style="display: none;">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <span data-i18n="orgSync.statsError">統計資料載入失敗</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 同步歷史快速檢視 -->
                <div class="mb-4">
                    <div class="card">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-history me-2"></i><span data-i18n="orgSync.recentHistory">最近同步記錄</span>
                            </h6>
                            <button type="button" class="btn btn-sm btn-primary" id="viewFullHistoryBtn">
                                <i class="fas fa-external-link-alt me-1"></i><span data-i18n="orgSync.viewFullHistory">查看完整歷史</span>
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="recentSyncHistory">
                                <div id="historyLoading" class="text-center py-3" style="display: none;">
                                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                                    <span class="text-muted" data-i18n="orgSync.historyLoading">載入歷史記錄中...</span>
                                </div>
                                
                                <div id="recentHistoryList">
                                    <!-- 最近的同步記錄將在此處動態生成 -->
                                </div>
                                
                                <div id="noRecentHistory" class="text-center py-3 text-muted" style="display: none;">
                                    <i class="fas fa-history me-2"></i>
                                    <span data-i18n="orgSync.noRecentHistory">尚無同步記錄</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <div>
                    <button type="button" class="btn btn-outline-secondary" id="refreshSyncDataBtn">
                        <i class="fas fa-sync-alt me-2"></i><span data-i18n="common.refresh">重新整理</span>
                    </button>
                </div>
                <div>
                    <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal" data-i18n="common.close">關閉</button>
                    <div class="btn-group no-stretch" role="group" aria-label="Sync Actions">
                        <button type="button" class="btn btn-primary" id="startDeptSyncBtn">
                            <i class="fas fa-sitemap me-2"></i><span data-i18n="orgSync.departmentsSync">部門同步</span>
                        </button>
                        <button type="button" class="btn btn-primary" id="startUserSyncBtn">
                            <i class="fas fa-address-book me-2"></i><span data-i18n="orgSync.contactsSync">用戶同步</span>
                        </button>
                        <button type="button" class="btn btn-primary" id="startSyncBtn">
                            <i class="fas fa-play me-2"></i><span data-i18n="orgSync.fullSync">完整同步</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let teams = [];
let currentEditTeam = null;

document.addEventListener('DOMContentLoaded', function() {
    initTeamManagement();
});

function initTeamManagement() {
    // 綁定事件監聽器
    document.getElementById('createTeamBtn').addEventListener('click', showCreateTeamModal);
    document.getElementById('refreshBtn').addEventListener('click', loadTeams);
    document.getElementById('saveTeamBtn').addEventListener('click', saveTeam);
    document.getElementById('validateLarkBtn').addEventListener('click', validateLarkConnection);
    document.getElementById('syncOrgBtn').addEventListener('click', openSyncModal);
    document.getElementById('refreshHistoryBtn').addEventListener('click', () => {
        if (currentHistoryTeamId) {
            loadSyncHistory(currentHistoryTeamId);
        }
    });
    
    // 同步功能框事件監聽器
    document.getElementById('startSyncBtn').addEventListener('click', () => startSyncFromModal('full'));
    document.getElementById('startDeptSyncBtn').addEventListener('click', () => startSyncFromModal('departments'));
    document.getElementById('startUserSyncBtn').addEventListener('click', () => startSyncFromModal('users'));
    document.getElementById('refreshSyncDataBtn').addEventListener('click', refreshSyncModalData);
    document.getElementById('viewFullHistoryBtn').addEventListener('click', () => {
        // 關閉同步功能框，開啟完整歷史模態框
        const syncModal = bootstrap.Modal.getInstance(document.getElementById('syncModal'));
        if (syncModal) {
            syncModal.hide();
        }
        showGlobalSyncHistory();
    });

    // 載入團隊列表
    loadTeams();
}

async function loadTeams() {
    try {
        showLoading();
        
        const response = await fetch('/api/teams/');
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        teams = await response.json();
        renderTeams();
        
    } catch (error) {
        console.error('Load teams failed:', error);
        if (AppUtils && AppUtils.showError) {
            const errorMsg = window.i18n ? window.i18n.t('messages.loadFailed') : '載入失敗';
            AppUtils.showError(errorMsg + '：' + error.message);
        } else {
            console.error('AppUtils not available:', error.message);
        }
        showNoTeams();
    } finally {
        hideLoading();
    }
}

function renderTeams() {
    if (!teams || teams.length === 0) {
        showNoTeams();
        return;
    }
    
    showTeamsList();
    renderTeamCards();
}

function showLoading() {
    document.getElementById('loading-state').style.display = 'block';
    document.getElementById('teams-section').style.display = 'none';
    document.getElementById('no-teams-section').style.display = 'none';
}

function hideLoading() {
    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('teams-section').style.display = 'block';
}

function showNoTeams() {
    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('teams-section').style.display = 'none';
    document.getElementById('no-teams-section').style.display = 'block';
}

function showTeamsList() {
    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('no-teams-section').style.display = 'none';
    document.getElementById('teams-section').style.display = 'block';
}

function renderTeamCards() {
    const container = document.getElementById('teams-container');
    
    const teamsHtml = teams.map(team => `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 team-card">
                <div class="card-body d-flex flex-column h-100">
                    <div class="d-flex align-items-start mb-3">
                        <div class="flex-shrink-0 me-3">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                 style="width: 48px; height: 48px; font-size: 18px; font-weight: bold;">
                                ${getTeamInitials(team.name)}
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="card-title text-primary mb-1">${escapeHtml(team.name)}</h5>
                            <p class="card-text text-muted small mb-0">
                                ${escapeHtml(team.description || ((window.i18n && window.i18n.isReady()) ? window.i18n.t('common.noDescription') : '無描述'))}
                            </p>
                        </div>
                    </div>
                    <div class="mt-auto pt-2">
                        <div class="mb-2">
                            <div class="d-flex align-items-center mb-1">
                                <i class="fas fa-table me-2 text-success"></i>
                                <small class="text-muted">Lark: ${team.is_lark_configured ? 
                                    ((window.i18n && window.i18n.isReady()) ? window.i18n.t('team.configured') : '已設定') : 
                                    ((window.i18n && window.i18n.isReady()) ? window.i18n.t('team.notConfigured') : '未設定')}</small>
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-list me-2 text-muted"></i>
                                <small class="text-muted">${(window.i18n && window.i18n.isReady()) ? 
                                    window.i18n.t('team.testCaseCount', {count: team.test_case_count || 0}) : 
                                    `${team.test_case_count || 0} 個測試案例`}</small>
                            </div>
                        </div>
                        <div class="btn-group w-100" role="group">
                            <button class="btn btn-outline-primary btn-sm" onclick="editTeam(${team.id})" title="${(window.i18n && window.i18n.isReady()) ? window.i18n.t('common.edit') : '編輯'}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="selectTeam(${team.id})" title="${(window.i18n && window.i18n.isReady()) ? window.i18n.t('tooltips.enterTeam') : '進入團隊'}">
                                <i class="fas fa-arrow-right"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteTeam(${team.id})" title="${(window.i18n && window.i18n.isReady()) ? window.i18n.t('common.delete') : '刪除'}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = teamsHtml;
    
    // Retranslate the newly added content only within container
    if (window.i18n && window.i18n.isReady()) {
        window.i18n.retranslate(container);
    }
}

function showCreateTeamModal() {
    currentEditTeam = null;
    const modalTitle = window.i18n ? window.i18n.t('team.createTeam') : '新增團隊';
    document.getElementById('teamModalLabel').textContent = modalTitle;
    document.getElementById('teamForm').reset();
    
    const modal = new bootstrap.Modal(document.getElementById('teamModal'));
    modal.show();
}

function editTeam(teamId) {
    const team = teams.find(t => t.id === teamId);
    if (!team) return;
    
    currentEditTeam = team;
    const modalTitle = window.i18n ? window.i18n.t('team.editTeam') : '編輯團隊';
    document.getElementById('teamModalLabel').textContent = modalTitle;
    
    // 填入表單資料
    document.getElementById('teamName').value = team.name;
    document.getElementById('teamDescription').value = team.description || '';
    document.getElementById('wikiToken').value = team.lark_config.wiki_token;
    document.getElementById('testCaseTableId').value = team.lark_config.test_case_table_id;
    
    document.getElementById('enableNotifications').checked = team.settings.enable_notifications;
    document.getElementById('autoCreateBugs').checked = team.settings.auto_create_bugs;
    
    const modal = new bootstrap.Modal(document.getElementById('teamModal'));
    modal.show();
}

async function saveTeam() {
    const form = document.getElementById('teamForm');
    const formData = new FormData(form);
    
    // 構建團隊資料
    const teamData = {
        name: formData.get('name'),
        description: formData.get('description') || null,
        lark_config: {
            wiki_token: formData.get('wiki_token'),
            test_case_table_id: formData.get('test_case_table_id')
        },
        settings: {
            enable_notifications: formData.get('enable_notifications') === 'on',
            auto_create_bugs: formData.get('auto_create_bugs') === 'on',
            default_priority: 'Medium'
        }
    };
    
    // 驗證必填欄位
    if (!teamData.name || !teamData.lark_config.wiki_token || !teamData.lark_config.test_case_table_id) {
        const errorMsg = window.i18n ? window.i18n.t('messages.fillRequiredFields') : '請填寫所有必填欄位';
        AppUtils.showError(errorMsg);
        return;
    }
    
    try {
        let url = '/api/teams';
        let method = 'POST';
        
        if (currentEditTeam) {
            url = `/api/teams/${currentEditTeam.id}`;
            method = 'PUT';
        }
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(teamData)
        });
        
        if (!response.ok) {
            const error = await response.json();
            const defaultMsg = window.i18n ? window.i18n.t('messages.saveFailed') : '儲存失敗';
            throw new Error(error.detail || defaultMsg);
        }
        
        const successMsg = currentEditTeam ? 
            (window.i18n ? window.i18n.t('team.teamUpdated') : '團隊更新成功') :
            (window.i18n ? window.i18n.t('team.teamSaved') : '團隊建立成功');
        AppUtils.showSuccess(successMsg);
        
        // 關閉模態視窗
        const modal = bootstrap.Modal.getInstance(document.getElementById('teamModal'));
        modal.hide();
        
        // 重新載入團隊列表
        await loadTeams();
        
    } catch (error) {
        console.error('Save team failed:', error);
        const errorMsg = window.i18n ? window.i18n.t('messages.saveFailed') : '儲存失敗';
        AppUtils.showError(errorMsg + '：' + error.message);
    }
}

async function validateLarkConnection() {
    const wikiToken = document.getElementById('wikiToken').value;
    const testCaseTableId = document.getElementById('testCaseTableId').value;
    const resultDiv = document.getElementById('larkValidationResult');
    
    if (!wikiToken || !testCaseTableId) {
        const warningMsg = window.i18n ? window.i18n.t('team.pleaseEnterToken') : '請先填寫 Wiki Token 和 Test Case 表格 ID';
        showValidationMessage(warningMsg, 'warning');
        return;
    }
    
    const validateBtn = document.getElementById('validateLarkBtn');
    validateBtn.disabled = true;
    const validatingMsg = window.i18n ? window.i18n.t('team.validating') : '驗證中...';
    validateBtn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${validatingMsg}`;
    
    try {
        const response = await fetch('/api/teams/validate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: 'test',
                lark_config: {
                    wiki_token: wikiToken,
                    test_case_table_id: testCaseTableId
                },
                settings: {
                    enable_notifications: true,
                    auto_create_bugs: false,
                    default_priority: 'Medium'
                }
            })
        });
        
        const result = await response.json();
        
        if (result.valid) {
            const successMsg = window.i18n ? window.i18n.t('team.connectionValid') : '連線驗證成功';
            showValidationMessage(successMsg, 'success');
        } else {
            const failMsg = window.i18n ? window.i18n.t('team.connectionInvalid') : '連線驗證失敗';
            showValidationMessage(failMsg, 'danger');
        }
        
    } catch (error) {
        console.error('Validation failed:', error);
        const errorMsg = window.i18n ? window.i18n.t('team.connectionError') : '驗證過程發生錯誤';
        showValidationMessage(errorMsg, 'danger');
    } finally {
        validateBtn.disabled = false;
        const validateText = window.i18n ? window.i18n.t('team.validateConnection') : '驗證 Lark 連線';
        validateBtn.innerHTML = `<i class="fas fa-check me-2"></i>${validateText}`;
    }
}

function selectTeam(teamId) {
    const team = teams.find(t => t.id === teamId);
    if (!team) return;
    
    // 儲存選擇的團隊，直接導向（不顯示 Toast）
    if (AppUtils && AppUtils.setCurrentTeam) {
        AppUtils.setCurrentTeam(team);
        window.location.href = '/test-case-management';
    }
}

async function deleteTeam(teamId) {
    const team = teams.find(t => t.id === teamId);
    if (!team) return;
    
    const confirmMsg = window.i18n ? 
        window.i18n.t('team.confirmDelete', {name: team.name}) : 
        `確定要刪除團隊「${team.name}」嗎？此操作無法復原。`;
    if (!confirm(confirmMsg)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/teams/${teamId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            const errorMsg = window.i18n ? window.i18n.t('messages.deleteFailed') : '刪除失敗';
            throw new Error(errorMsg);
        }
        
        const successMsg = window.i18n ? window.i18n.t('team.teamDeleted') : '團隊刪除成功';
        AppUtils.showSuccess(successMsg);
        await loadTeams();
        
    } catch (error) {
        console.error('Delete team failed:', error);
        const errorMsg = window.i18n ? window.i18n.t('messages.deleteFailed') : '刪除失敗';
        AppUtils.showError(errorMsg + '：' + error.message);
    }
}

function getTeamInitials(name) {
    if (!name) return 'T';
    
    return name
        .split(' ')
        .map(word => word.charAt(0).toUpperCase())
        .slice(0, 2)
        .join('');
}

function showValidationMessage(message, type) {
    const resultDiv = document.getElementById('larkValidationResult');
    
    // 設定顏色和圖示
    let iconClass, textClass;
    switch(type) {
        case 'success':
            iconClass = 'fas fa-check-circle';
            textClass = 'text-success';
            break;
        case 'danger':
            iconClass = 'fas fa-times-circle';
            textClass = 'text-danger';
            break;
        case 'warning':
            iconClass = 'fas fa-exclamation-triangle';
            textClass = 'text-warning';
            break;
        default:
            iconClass = 'fas fa-info-circle';
            textClass = 'text-info';
    }
    
    // 顯示訊息
    resultDiv.innerHTML = `<small class="${textClass}"><i class="${iconClass} me-1"></i>${message}</small>`;
    
    // 3秒後自動清除
    setTimeout(() => {
        resultDiv.innerHTML = '';
    }, 3000);
}

function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

// 更新頁面標題翻譯
function updatePageTitle() {
    const pageTitle = window.i18n ? window.i18n.t('team.management') : '團隊管理';
    const siteTitle = window.i18n ? window.i18n.t('navigation.title') : 'Test Case Repository';
    document.title = `${pageTitle} - ${siteTitle} Web Tool`;
}

// 監聽 i18n 初始化和語言變更事件
document.addEventListener('i18nReady', updatePageTitle);
document.addEventListener('languageChanged', updatePageTitle);

// ===== 組織架構同步功能 =====

// ===== 同步功能框模態視窗管理 =====

// 模態視窗狀態管理
let syncModalInstance = null;
let syncPollingInterval = null;

// 開啟同步功能框
async function openSyncModal() {
    // 檢查是否有可用的團隊
    if (!teams || teams.length === 0) {
        AppUtils.showError(getI18n('orgSync.addTeamFirst', '請先新增團隊後再執行同步'));
        return;
    }

    const modal = document.getElementById('syncModal');
    if (!syncModalInstance) {
        syncModalInstance = new bootstrap.Modal(modal);
        
        // 監聽模態框關閉事件，保存狀態到localStorage
        modal.addEventListener('hidden.bs.modal', saveSyncModalState);
        modal.addEventListener('shown.bs.modal', loadSyncModalState);
    }

    // 載入模態框數據
    await loadSyncModalData();
    
    syncModalInstance.show();
}

// 載入同步功能框所有數據
async function loadSyncModalData() {
    await Promise.all([
        loadSyncStatus(),
        loadOrgStats(),
        loadRecentSyncHistory()
    ]);
}

// 重新整理同步功能框數據
async function refreshSyncModalData() {
    const refreshBtn = document.getElementById('refreshSyncDataBtn');
    const originalHtml = refreshBtn.innerHTML;
    
    refreshBtn.disabled = true;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>重新整理中...';
    
    try {
        await loadSyncModalData();
    } finally {
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = originalHtml;
    }
}

// 載入同步狀態
async function loadSyncStatus() {
    const loadingDiv = document.getElementById('syncStatusLoading');
    const idleDiv = document.getElementById('syncStatusIdle');
    const runningDiv = document.getElementById('syncStatusRunning');
    
    // 顯示載入狀態（使用 Bootstrap d-none 以避免 d-flex !important 影響）
    loadingDiv.classList.remove('d-none');
    idleDiv.classList.add('d-none');
    runningDiv.classList.add('d-none');
    
    try {
        const defaultTeamId = teams[0].id;
        const response = await fetch(`/api/teams/${defaultTeamId}/sync/status`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        if (result.success && result.data) {
            const data = result.data;
            
            loadingDiv.classList.add('d-none');
            
            if (data.is_syncing) {
                // 同步進行中
                setSyncStatus('running');
                
                // 更新進度信息
                const progressText = document.getElementById('syncProgressText');
                const progressBar = document.getElementById('syncProgressBar');
                
                if (data.current_sync_id) {
                    const idPrefix = getI18n('orgSync.syncIdPrefix', '同步ID:');
                    progressText.textContent = `${idPrefix} ${data.current_sync_id}`;
                    progressBar.style.width = '50%'; // 暫時顯示50%進度
                }
                
                // 開始輪詢狀態
                startSyncPolling();
                
                // 按鈕狀態由 setSyncStatus 控制
            } else {
                // 系統空閒
                setSyncStatus('idle');
                
                // 顯示最後同步時間
                if (data.last_sync_end) {
                    const lastSyncDiv = document.getElementById('lastSyncTime');
                    const lastPrefix = getI18n('orgSync.lastSyncPrefix', '最後同步:');
                    lastSyncDiv.textContent = `${lastPrefix} ${new Date(data.last_sync_end).toLocaleString()}`;
                }
                
                // 按鈕狀態由 setSyncStatus 控制
            }
        }
    } catch (error) {
        console.error('載入同步狀態失敗:', error);
        loadingDiv.classList.add('d-none');
        setSyncStatus('idle');
    }
}

function setSyncStatus(mode) {
    const idleDiv = document.getElementById('syncStatusIdle');
    const runningDiv = document.getElementById('syncStatusRunning');
    const startBtn = document.getElementById('startSyncBtn');
    const deptBtn = document.getElementById('startDeptSyncBtn');
    const userBtn = document.getElementById('startUserSyncBtn');

    if (mode === 'running') {
        idleDiv.classList.add('d-none');
        runningDiv.classList.remove('d-none');
        if (startBtn) startBtn.disabled = true;
        if (deptBtn) deptBtn.disabled = true;
        if (userBtn) userBtn.disabled = true;
    } else if (mode === 'idle') {
        runningDiv.classList.add('d-none');
        idleDiv.classList.remove('d-none');
        if (startBtn) startBtn.disabled = false;
        if (deptBtn) deptBtn.disabled = false;
        if (userBtn) userBtn.disabled = false;
    } else {
        runningDiv.classList.add('d-none');
        idleDiv.classList.add('d-none');
        if (startBtn) startBtn.disabled = false;
        if (deptBtn) deptBtn.disabled = false;
        if (userBtn) userBtn.disabled = false;
    }
}

// 載入組織統計
async function loadOrgStats() {
    const loadingDiv = document.getElementById('orgStatsLoading');
    const dataDiv = document.getElementById('orgStatsData');
    const errorDiv = document.getElementById('orgStatsError');
    
    // 顯示載入狀態
    loadingDiv.style.display = 'block';
    dataDiv.style.display = 'none';
    errorDiv.style.display = 'none';
    
    try {
        const defaultTeamId = teams[0].id;
        const response = await fetch(`/api/teams/${defaultTeamId}/sync/stats`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        if (result.success && result.data) {
            const data = result.data;
            
            // 更新部門統計
            document.getElementById('totalDepartments').textContent = data.total_departments || 0;
            // 更新用戶統計
            document.getElementById('totalUsers').textContent = data.total_users || 0;
            
            loadingDiv.style.display = 'none';
            dataDiv.style.display = 'block';
        } else {
            throw new Error('API 返回錯誤');
        }
    } catch (error) {
        console.error('載入組織統計失敗:', error);
        loadingDiv.style.display = 'none';
        errorDiv.style.display = 'block';
    }
}

// 載入最近同步記錄
async function loadRecentSyncHistory() {
    const loadingDiv = document.getElementById('historyLoading');
    const listDiv = document.getElementById('recentHistoryList');
    const noHistoryDiv = document.getElementById('noRecentHistory');
    
    // 顯示載入狀態
    loadingDiv.style.display = 'block';
    listDiv.innerHTML = '';
    noHistoryDiv.style.display = 'none';
    
    try {
        const defaultTeamId = teams[0].id;
        const response = await fetch(`/api/teams/${defaultTeamId}/sync/history?limit=3`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        if (result.success && result.data && result.data.history.length > 0) {
            const history = result.data.history;
            
            let html = '';
            history.forEach(record => {
                const statusClass = record.status === 'completed' ? 'success' : 
                                  record.status === 'failed' ? 'danger' : 'warning';
                const statusText = record.status === 'completed' ? getI18n('orgSync.status.completed', '完成') :
                                 record.status === 'failed' ? getI18n('orgSync.status.failed', '失敗') : getI18n('orgSync.status.running', '進行中');
                
                html += `
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center">
                                <span class="badge badge-status-lg bg-${statusClass} me-2">${statusText}</span>
                                <span class="text-muted small">${
                                    record.sync_type === 'full' ? getI18n('orgSync.type.full', '完整同步') :
                                    record.sync_type === 'departments' ? getI18n('orgSync.type.departments', '部門同步') :
                                    record.sync_type === 'users' ? getI18n('orgSync.type.users', '用戶同步') : record.sync_type
                                }</span>
                            </div>
                            <div class="text-muted small mt-1">
                                ${new Date(record.start_time).toLocaleString()}
                            </div>
                        </div>
                        <div class="text-end">
                            <small class="text-muted">ID: ${record.id}</small>
                        </div>
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
            loadingDiv.style.display = 'none';
        } else {
            loadingDiv.style.display = 'none';
            noHistoryDiv.style.display = 'block';
        }
    } catch (error) {
        console.error('載入最近同步記錄失敗:', error);
        loadingDiv.style.display = 'none';
        noHistoryDiv.style.display = 'block';
    }
}

// 從模態框開始同步
async function startSyncFromModal(syncType = 'full') {
    const startBtn = syncType === 'full' ? document.getElementById('startSyncBtn') : 
        (syncType === 'departments' ? document.getElementById('startDeptSyncBtn') : document.getElementById('startUserSyncBtn'));
    const originalHtml = startBtn.innerHTML;
    
    startBtn.disabled = true;
    startBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>啟動中...';
    
    try {
        // Guard: ensure not already syncing
        try {
            const defaultTeamId = teams[0].id;
            const statusResp = await fetch(`/api/teams/${defaultTeamId}/sync/status`);
            if (statusResp.ok) {
                const statusJson = await statusResp.json();
                if (statusJson.success && statusJson.data && statusJson.data.is_syncing) {
                    AppUtils.showWarning(getI18n('orgSync.syncing', '同步進行中'));
                    startBtn.disabled = false;
                    startBtn.innerHTML = originalHtml;
                    return;
                }
            }
        } catch (_) {}
        const defaultTeamId = teams[0].id;
        
        const response = await fetch(`/api/teams/${defaultTeamId}/sync/trigger`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                sync_type: syncType,
                trigger_user: 'user-sync-modal' // 識別來自功能框的同步
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            // 同步啟動成功，重新載入狀態
            await loadSyncStatus();
            
            // 保存觸發用戶到localStorage，用於後續的Toast通知
            localStorage.setItem('sync_trigger_user', 'user-sync-modal');
            
            AppUtils.showSuccess(getI18n('orgSync.syncStarted', '組織架構同步已啟動'));
        } else {
            throw new Error(result.message || '同步啟動失敗');
        }
    } catch (error) {
        console.error('啟動同步失敗:', error);
        AppUtils.showError(getI18n('orgSync.startFailedPrefix', '啟動同步失敗') + '：' + error.message);
        
        startBtn.disabled = false;
        startBtn.innerHTML = originalHtml;
    }
}

// 開始同步狀態輪詢
function startSyncPolling() {
    if (syncPollingInterval) {
        clearInterval(syncPollingInterval);
    }
    
    let pollCount = 0;
    const maxPolls = 120; // 10分鐘最大輪詢時間
    
    const poll = async () => {
        try {
            const defaultTeamId = teams[0].id;
            const response = await fetch(`/api/teams/${defaultTeamId}/sync/status`);
            
            if (response.ok) {
                const result = await response.json();
                
                if (result.success && result.data) {
                    const data = result.data;
                    
                    if (!data.is_syncing) {
                        // 同步完成
                        clearInterval(syncPollingInterval);
                        syncPollingInterval = null;
                        
                        // 重新載入所有數據
                        await loadSyncModalData();
                        
                        // 檢查是否是當前用戶觸發的同步
                        const triggerUser = localStorage.getItem('sync_trigger_user');
                        if (triggerUser === 'user-sync-modal') {
                            AppUtils.showSuccess(getI18n('orgSync.syncCompleted', '組織架構同步已完成！'));
                            localStorage.removeItem('sync_trigger_user');
                        }
                    } else {
                        // 更新進度顯示
                        setSyncStatus('running');
                        const progressText = document.getElementById('syncProgressText');
                        const progressBar = document.getElementById('syncProgressBar');
                        
                        if (data.current_sync_id) {
                            const syncingText = getI18n('orgSync.syncing', '同步進行中');
                            const idPrefix = getI18n('orgSync.syncIdPrefix', '同步ID:');
                            progressText.textContent = `${syncingText} (${idPrefix} ${data.current_sync_id})`;
                            // 根據時間推算進度百分比
                            const elapsed = pollCount * 5; // 5秒間隔
                            const estimatedProgress = Math.min(50 + (elapsed / 120) * 40, 90); // 50-90%之間
                            progressBar.style.width = `${estimatedProgress}%`;
                        }
                    }
                }
            }
            
            pollCount++;
            if (pollCount >= maxPolls) {
                // 超時停止輪詢
                clearInterval(syncPollingInterval);
                syncPollingInterval = null;
                AppUtils.showWarning(getI18n('orgSync.statusTimeout', '同步狀態檢查超時，請手動刷新查看結果'));
                // 恢復按鈕
                document.getElementById('startSyncBtn').disabled = false;
                const deptBtn = document.getElementById('startDeptSyncBtn');
                const userBtn = document.getElementById('startUserSyncBtn');
                if (deptBtn) deptBtn.disabled = false;
                if (userBtn) userBtn.disabled = false;
            }
        } catch (error) {
            console.error('輪詢同步狀態失敗:', error);
        }
    };
    
    // 每5秒輪詢一次
    syncPollingInterval = setInterval(poll, 5000);
}

// 保存模態框狀態到localStorage
function saveSyncModalState() {
    const modalState = {
        lastClosed: Date.now(),
        wasPolling: syncPollingInterval !== null
    };
    localStorage.setItem('sync_modal_state', JSON.stringify(modalState));
}

// 從localStorage載入模態框狀態
function loadSyncModalState() {
    try {
        const savedState = localStorage.getItem('sync_modal_state');
        if (savedState) {
            const state = JSON.parse(savedState);
            
            // 如果之前在輪詢且關閉時間不超過30秒，繼續輪詢
            const timeSinceClose = Date.now() - state.lastClosed;
            if (state.wasPolling && timeSinceClose < 30000) {
                // 先載入一次狀態，如果仍在同步則開始輪詢
                loadSyncStatus();
            }
        }
    } catch (error) {
        console.error('載入模態框狀態失敗:', error);
    }
}

// ===== 全域組織架構同步功能 =====

// 觸發全域同步
async function triggerGlobalSync() {
    const syncBtn = document.getElementById('syncOrgBtn');
    const statusDiv = document.getElementById('global-sync-status');
    
    // 檢查是否有可用的團隊
    if (!teams || teams.length === 0) {
        AppUtils.showError(getI18n('orgSync.addTeamFirst', '請先新增團隊後再執行同步'));
        return;
    }
    
    // 使用第一個團隊作為預設
    const defaultTeamId = teams[0].id;
    
    try {
        // 顯示同步中狀態
        syncBtn.disabled = true;
        statusDiv.style.display = 'block';
        
        // 觸發同步
        const response = await fetch(`/api/teams/${defaultTeamId}/sync/trigger`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                sync_type: 'full',
                trigger_user: 'web-user'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // 同步開始成功
            AppUtils.showSuccess(getI18n('orgSync.syncStarted', '組織架構同步已開始'));
            
            // 開始輪詢同步狀態
            pollGlobalSyncStatus(defaultTeamId);
            
        } else {
            // 同步開始失敗
            AppUtils.showError(getI18n('orgSync.syncFailedPrefix', '同步失敗') + `: ${result.message}`);
            syncBtn.disabled = false;
            statusDiv.style.display = 'none';
        }
        
    } catch (error) {
        console.error('觸發全域同步失敗:', error);
        AppUtils.showError(getI18n('orgSync.triggerFailedPrefix', '觸發全域同步失敗') + `: ${error.message}`);
        syncBtn.disabled = false;
        statusDiv.style.display = 'none';
    }
}

// 輪詢全域同步狀態
async function pollGlobalSyncStatus(teamId) {
    const maxPolls = 60; // 最多輪詢 60 次 (5 分鐘)
    let pollCount = 0;
    
    const poll = async () => {
        try {
            const response = await fetch(`/api/teams/${teamId}/sync/status`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const result = await response.json();
            
            if (result.success && result.data) {
                const data = result.data;
                
                if (!data.is_syncing) {
                    // 同步完成
                    const syncBtn = document.getElementById('syncOrgBtn');
                    const statusDiv = document.getElementById('global-sync-status');
                    
                    syncBtn.disabled = false;
                    statusDiv.style.display = 'none';
                    
                    // 檢查最後結果
                    if (data.last_result && data.last_result.success) {
                        AppUtils.showSuccess(getI18n('orgSync.syncCompleted', '組織架構同步完成'));
                    } else {
                        AppUtils.showWarning(getI18n('orgSync.syncCompletedWithIssues', '同步完成，但可能有部分錯誤'));
                    }
                    
                    return; // 停止輪詢
                }
                
                // 繼續輪詢
                pollCount++;
                if (pollCount < maxPolls) {
                    setTimeout(poll, 5000); // 5秒後再次檢查
                } else {
                    // 超時停止
                    document.getElementById('syncOrgBtn').disabled = false;
                    document.getElementById('global-sync-status').style.display = 'none';
                    AppUtils.showWarning(getI18n('orgSync.statusTimeout', '同步狀態檢查超時，請手動刷新頁面查看結果'));
                }
            }
            
        } catch (error) {
            console.error('檢查全域同步狀態失敗:', error);
            // 發生錯誤時也停止輪詢
            document.getElementById('syncOrgBtn').disabled = false;
            document.getElementById('global-sync-status').style.display = 'none';
        }
    };
    
    // 開始第一次輪詢
    setTimeout(poll, 2000); // 2秒後開始檢查
}

// 顯示全域同步歷史模態框
let currentHistoryTeamId = null;

async function showGlobalSyncHistory() {
    // 檢查是否有可用的團隊
    if (!teams || teams.length === 0) {
        AppUtils.showError(getI18n('orgSync.addTeamFirstForHistory', '請先新增團隊後再查看同步歷史'));
        return;
    }
    
    // 使用第一個團隊作為預設
    const defaultTeamId = teams[0].id;
    currentHistoryTeamId = defaultTeamId;
    
    // 設定模態框標題為全域模式
    document.getElementById('syncHistoryModalLabel').textContent = getI18n('orgSync.historyModalTitle', '組織架構同步歷史記錄');
    
    // 顯示模態框
    const modal = new bootstrap.Modal(document.getElementById('syncHistoryModal'));
    modal.show();
    
    // 載入歷史記錄
    await loadSyncHistory(defaultTeamId);
}

async function loadSyncHistory(teamId) {
    const loadingDiv = document.getElementById('syncHistoryLoading');
    const contentDiv = document.getElementById('syncHistoryContent');
    const noHistoryDiv = document.getElementById('noSyncHistory');
    const tableBody = document.getElementById('syncHistoryTableBody');
    
    try {
        // 顯示載入狀態
        loadingDiv.style.display = 'block';
        contentDiv.style.display = 'none';
        noHistoryDiv.style.display = 'none';
        
        const response = await fetch(`/api/teams/${teamId}/sync/history`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success && result.data.history.length > 0) {
            // 有歷史記錄，渲染表格
            renderSyncHistoryTable(result.data.history);
            contentDiv.style.display = 'block';
        } else {
            // 無歷史記錄
            noHistoryDiv.style.display = 'block';
        }
        
    } catch (error) {
        console.error('載入同步歷史失敗:', error);
        AppUtils.showError(getI18n('orgSync.loadHistoryFailedPrefix', '載入同步歷史失敗') + `: ${error.message}`);
        noHistoryDiv.style.display = 'block';
    } finally {
        loadingDiv.style.display = 'none';
    }
}

function renderSyncHistoryTable(history) {
    const tableBody = document.getElementById('syncHistoryTableBody');
    
    const rows = history.map(record => {
        // 格式化時間
        const startTime = record.start_time ? new Date(record.start_time).toLocaleString('zh-TW') : '-';
        const endTime = record.end_time ? new Date(record.end_time).toLocaleString('zh-TW') : '-';
        
        // 計算耗時
        let duration = '-';
        if (record.duration_seconds) {
            const minutes = Math.floor(record.duration_seconds / 60);
            const seconds = Math.round(record.duration_seconds % 60);
            duration = minutes > 0 ? `${minutes}分${seconds}秒` : `${seconds}秒`;
        }
        
        // 狀態標籤
        let statusBadge = '';
        switch (record.status) {
            case 'completed':
                statusBadge = `<span class=\"badge badge-status-lg bg-success\">${getI18n('orgSync.status.completed', '完成')}</span>`;
                break;
            case 'failed':
                statusBadge = `<span class=\"badge badge-status-lg bg-danger\">${getI18n('orgSync.status.failed', '失敗')}</span>`;
                break;
            case 'running':
                statusBadge = `<span class=\"badge badge-status-lg bg-primary\">${getI18n('orgSync.status.running', '進行中')}</span>`;
                break;
            default:
                statusBadge = `<span class=\"badge badge-status-lg bg-secondary\">${getI18n('orgSync.status.unknown', '未知')}</span>`;
        }
        
        // 同步類型
        let syncTypeText = '';
        switch (record.sync_type) {
            case 'full':
                syncTypeText = getI18n('orgSync.type.full', '完整同步');
                break;
            case 'departments':
                syncTypeText = getI18n('orgSync.type.departments', '部門同步');
                break;
            case 'users':
                syncTypeText = getI18n('orgSync.type.users', '用戶同步');
                break;
            default:
                syncTypeText = record.sync_type;
        }
        
        // 統計信息（使用 i18n 標籤）
        const stats = [];
        const deptLabel = getI18n('orgSync.labels.departments', '部門');
        const userLabel = getI18n('orgSync.labels.users', '用戶');
        if (record.departments_created || record.departments_updated) {
            stats.push(`${deptLabel}: +${record.departments_created || 0}/${record.departments_updated || 0}`);
        }
        if (record.users_created || record.users_updated) {
            stats.push(`${userLabel}: +${record.users_created || 0}/${record.users_updated || 0}`);
        }
        const statsText = stats.length > 0 ? stats.join('<br>') : '-';
        
        return `
            <tr>
                <td>${syncTypeText}</td>
                <td>${statusBadge}</td>
                <td>${startTime}</td>
                <td>${endTime}</td>
                <td>${duration}</td>
                <td><small>${statsText}</small></td>
            </tr>
        `;
    }).join('');
    
    tableBody.innerHTML = rows;
}

function showErrorDetails(recordId, errorMessage) {
    AppUtils.showError(`${getI18n('orgSync.errorPrefix', '同步錯誤')} (ID: ${recordId})：${errorMessage}`);
}

// ===== i18n helper without calling window.i18n.t =====
function getI18n(key, fallback = '') {
    const container = document.getElementById('org-sync-i18n');
    if (!container) return fallback || key;
    const el = container.querySelector(`[data-i18n="${key}"]`);
    if (el && el.textContent && el.textContent.trim().length > 0) {
        return el.textContent.trim();
    }
    return fallback || key;
}
</script>

<!-- Hidden i18n texts for Organization Sync (used by JS without window.i18n.t) -->
<div id="org-sync-i18n" class="d-none">
    <span data-i18n="orgSync.openButton">同步組織架構</span>
    <span data-i18n="orgSync.modalTitle">組織架構同步管理</span>
    <span data-i18n="orgSync.currentStatus">當前同步狀態</span>
    <span data-i18n="orgSync.loadingStatus">載入狀態中...</span>
    <span data-i18n="orgSync.idle">系統空閒</span>
    <span data-i18n="orgSync.readyToRun">準備執行新的同步作業</span>
    <span data-i18n="orgSync.syncing">同步進行中</span>
    <span data-i18n="orgSync.syncingDesc">正在同步組織架構資料...</span>
    <span data-i18n="orgSync.preparing">準備開始...</span>
    <span data-i18n="orgSync.statsTitle">組織架構統計</span>
    <span data-i18n="orgSync.statsLoading">載入統計資料中...</span>
    <span data-i18n="orgSync.statsError">統計資料載入失敗</span>
    <span data-i18n="orgSync.departmentsStats">部門統計</span>
    <span data-i18n="orgSync.usersStats">用戶統計</span>
    <span data-i18n="orgSync.total">總數</span>
    <span data-i18n="orgSync.active">活躍</span>
    <span data-i18n="orgSync.recentHistory">最近同步記錄</span>
    <span data-i18n="orgSync.viewFullHistory">查看完整歷史</span>
    <span data-i18n="orgSync.noRecentHistory">尚無同步記錄</span>
    <span data-i18n="orgSync.fullSync">完整同步</span>
    <span data-i18n="orgSync.departmentsSync">部門同步</span>
    <span data-i18n="orgSync.contactsSync">用戶同步</span>
    <span data-i18n="orgSync.historyModalTitle">同步歷史記錄</span>
    <span data-i18n="orgSync.historyLoading">載入歷史記錄中...</span>
    <span data-i18n="orgSync.historyNoRecordsTitle">尚無同步記錄</span>
    <span data-i18n="orgSync.historyNoRecordsHint">請先執行組織架構同步</span>
    <span data-i18n="orgSync.table.type">類型</span>
    <span data-i18n="orgSync.table.status">狀態</span>
    <span data-i18n="orgSync.table.startTime">開始時間</span>
    <span data-i18n="orgSync.table.endTime">結束時間</span>
    <span data-i18n="orgSync.table.duration">耗時</span>
    <span data-i18n="orgSync.table.stats">統計</span>
    <span data-i18n="orgSync.table.trigger">觸發者</span>
    <span data-i18n="orgSync.table.actions">操作</span>
    <span data-i18n="orgSync.lastSyncPrefix">最後同步:</span>
    <span data-i18n="orgSync.syncIdPrefix">同步ID:</span>
    <span data-i18n="orgSync.addTeamFirst">請先新增團隊後再執行同步</span>
    <span data-i18n="orgSync.addTeamFirstForHistory">請先新增團隊後再查看同步歷史</span>
    <span data-i18n="orgSync.syncStarted">組織架構同步已開始</span>
    <span data-i18n="orgSync.syncCompleted">組織架構同步已完成！</span>
    <span data-i18n="orgSync.syncCompletedWithIssues">同步完成，但可能有部分錯誤</span>
    <span data-i18n="orgSync.syncFailedPrefix">同步失敗</span>
    <span data-i18n="orgSync.startFailedPrefix">啟動同步失敗</span>
    <span data-i18n="orgSync.triggerFailedPrefix">觸發全域同步失敗</span>
    <span data-i18n="orgSync.statusTimeout">同步狀態檢查超時，請手動刷新頁面查看結果</span>
    <span data-i18n="orgSync.viewErrorDetails">查看錯誤詳情</span>
    <span data-i18n="orgSync.errorPrefix">同步錯誤</span>
    <span data-i18n="orgSync.status.completed">完成</span>
    <span data-i18n="orgSync.status.failed">失敗</span>
    <span data-i18n="orgSync.status.running">進行中</span>
    <span data-i18n="orgSync.status.unknown">未知</span>
    <span data-i18n="orgSync.type.full">完整同步</span>
    <span data-i18n="orgSync.type.departments">部門同步</span>
    <span data-i18n="orgSync.type.users">用戶同步</span>
    <span data-i18n="orgSync.labels.departments">部門</span>
    <span data-i18n="orgSync.labels.users">用戶</span>
</div>
<style>
.team-card {
    transition: all 0.2s ease;
    border: 1px solid var(--tr-border-light);
}

.team-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--tr-shadow-md);
    border-color: var(--tr-primary);
}

.alert-sm {
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
}

.btn-group .btn {
    flex: 1;
}

.form-text {
    font-size: 0.8rem;
}

#teamModal .modal-lg {
    max-width: 800px;
}

/* Prevent sync action buttons from wrapping and stretching */
.no-stretch .btn {
    flex: 0 0 auto;
    white-space: nowrap;
}

/* Keep org stats in one line and aligned */
.org-compact-stats { white-space: nowrap; }
.org-compact-stats .stat { display: inline-flex; align-items: baseline; }

/* Enlarge status badges in Sync History */
/* moved to /static/css/style.css */
</style>
{% endblock %}
