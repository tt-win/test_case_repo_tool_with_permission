{% extends "base.html" %}

{% block title %}系統初始化 - Test Case Repository Web Tool{% endblock %}

<!-- 禁用基礎模板的 header 和 footer -->
{% block page_title %}{% endblock %}
{% block page_actions %}{% endblock %}

{% block head %}
<style>
        /* 隐藏 header 和 footer */
        .app-header,
        .app-footer {
            display: none !important;
        }
        
        /* 使 main 填滿全屏 */
        .app-main {
            min-height: 100vh !important;
            padding: 0 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            background: var(--tr-bg-body);
        }
        
        .setup-container {
            padding: 20px;
            width: 100%;
        }
        
        .setup-card {
            background: var(--tr-bg-card);
            border: 1px solid var(--tr-border-light);
            border-radius: 8px;
            box-shadow: var(--tr-shadow-md);
            overflow: hidden;
            max-width: 600px;
            width: 100%;
            margin: 0 auto;
        }
        
        .setup-header {
            background: linear-gradient(135deg, var(--tr-primary) 0%, #5BA0F2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .setup-header .logo {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .setup-header h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
        }
        
        .setup-header .subtitle {
            opacity: 0.9;
            margin-top: 0.5rem;
            font-size: 1rem;
        }
        
        .setup-body {
            padding: 2rem;
        }
        
        .welcome-section {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .welcome-section .icon {
            font-size: 4rem;
            color: var(--tr-primary);
            margin-bottom: 1rem;
        }
        
        .welcome-section h2 {
            color: var(--tr-text-primary);
            margin-bottom: 1rem;
        }
        
        .welcome-section p {
            color: var(--tr-text-secondary);
            margin-bottom: 0;
        }
        
        .steps-section {
            margin: 2rem 0;
        }
        
        .step-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin-bottom: 1rem;
            background: var(--tr-bg-light);
            border-radius: 8px;
            border-left: 4px solid var(--tr-primary);
        }
        
        .step-number {
            background: var(--tr-primary);
            color: white;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
        }
        
        .step-content h5 {
            margin: 0 0 0.25rem 0;
            color: var(--tr-text-primary);
        }
        
        .step-content p {
            margin: 0;
            color: var(--tr-text-secondary);
            font-size: 0.9rem;
        }
        
        .form-section {
            background: var(--tr-bg-light);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }
        
        .form-label {
            font-weight: 500;
            color: var(--tr-text-primary);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        .form-control {
            border: 1px solid var(--tr-border);
            border-radius: 6px;
            padding: 0.625rem 0.875rem;
            font-size: 14px;
            transition: all 0.2s ease;
            background-color: var(--tr-bg-card);
            color: var(--tr-text-primary);
        }
        
        .form-control:focus {
            border-color: var(--tr-primary);
            box-shadow: 0 0 0 0.2rem rgba(var(--tr-primary-rgb), 0.25);
            background-color: var(--tr-bg-card);
            color: var(--tr-text-primary);
        }
        
        .password-input-group {
            position: relative;
        }
        
        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--tr-text-secondary);
            cursor: pointer;
            font-size: 1.1rem;
        }
        
        .password-toggle:hover {
            color: var(--tr-primary);
        }
        
        .requirements-list {
            font-size: 0.875rem;
            color: var(--tr-text-secondary);
            margin-top: 0.5rem;
        }
        
        .requirements-list li {
            margin-bottom: 0.25rem;
        }
        
        .alert {
            border-radius: 6px;
            border: 1px solid var(--tr-border-light);
            font-weight: 500;
            box-shadow: var(--tr-shadow-sm);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--tr-primary) 0%, #5BA0F2 100%);
            border: 1px solid var(--tr-primary);
            border-radius: 6px;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            color: white;
            box-shadow: var(--tr-shadow-sm);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--tr-primary-dark) 0%, #4A8FD1 100%);
            border-color: var(--tr-primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--tr-shadow-md);
            color: white;
        }
        
        .btn-primary:focus,
        .btn-primary:active {
            background: linear-gradient(135deg, var(--tr-primary-dark) 0%, #4A8FD1 100%);
            border-color: var(--tr-primary-dark);
            color: white;
            box-shadow: 0 0 0 0.2rem rgba(var(--tr-primary-rgb), 0.25);
        }
        
        .btn-primary:disabled {
            background: var(--tr-text-muted);
            border-color: var(--tr-text-muted);
            transform: none;
            box-shadow: none;
            color: white;
        }
        
        .security-notes {
            background: var(--tr-warning-light);
            border: 1px solid var(--tr-warning);
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1.5rem;
        }
        
        .security-notes .icon {
            color: var(--tr-warning);
            margin-right: 0.5rem;
        }
        
        .security-notes h6 {
            color: var(--tr-warning-dark);
            margin-bottom: 0.5rem;
        }
        
        .security-notes ul {
            margin: 0;
            padding-left: 1.2rem;
        }
        
        .security-notes li {
            color: var(--tr-warning-dark);
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }
        
        @media (max-width: 768px) {
            .setup-container {
                padding: 10px;
            }
            
            .setup-header {
                padding: 1.5rem;
            }
            
            .setup-body {
                padding: 1.5rem;
            }
            
            .setup-header h1 {
                font-size: 1.5rem;
            }
            
            .welcome-section .icon {
                font-size: 3rem;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="setup-container">
    <div class="setup-card">
            <!-- Header -->
            <div class="setup-header">
                <div class="logo">
                    <i class="fas fa-cogs"></i>
                </div>
                <h1>系統初始化</h1>
                <div class="subtitle">建立第一個 Super Admin 帳戶</div>
            </div>
            
            <!-- Body -->
            <div class="setup-body">
                <!-- Welcome Section -->
                <div class="welcome-section">
                    <div class="icon">
                        <i class="fas fa-rocket"></i>
                    </div>
                    <h2>歡迎使用測試用例管理系統！</h2>
                    <p>系統需要建立第一個 Super Admin 帳戶才能開始使用。</p>
                </div>
                
                <!-- Steps Section -->
                <div class="steps-section">
                    <div class="step-item">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h5>建立 Super Admin 帳戶</h5>
                            <p>設定系統管理員的使用者名稱和密碼</p>
                        </div>
                    </div>
                    
                    <div class="step-item">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h5>登入系統</h5>
                            <p>使用建立的帳戶登入系統</p>
                        </div>
                    </div>
                    
                    <div class="step-item">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h5>建立團隊和使用者</h5>
                            <p>開始建立團隊並邀請其他使用者</p>
                        </div>
                    </div>
                </div>
                
                <!-- Alert Messages -->
                <div id="alert-container"></div>
                
                <!-- Setup Form -->
                <div class="form-section">
                    <form id="setup-form">
                        <div class="mb-3">
                            <label for="username" class="form-label">
                                <i class="fas fa-user me-2"></i>使用者名稱
                            </label>
                            <input type="text" class="form-control" id="username" name="username" 
                                   placeholder="請輸入管理員使用者名稱" required
                                   minlength="3" maxlength="50">
                            <div class="requirements-list">
                                <i class="fas fa-info-circle me-1"></i>需要 3-50 個字符
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="password" class="form-label">
                                <i class="fas fa-lock me-2"></i>密碼
                            </label>
                            <div class="password-input-group">
                                <input type="password" class="form-control" id="password" name="password" 
                                       placeholder="請輸入密碼" required minlength="8">
                                <button type="button" class="password-toggle" onclick="togglePassword('password')">
                                    <i class="fas fa-eye" id="password-eye"></i>
                                </button>
                            </div>
                            <div class="requirements-list">
                                <i class="fas fa-info-circle me-1"></i>至少需要 8 個字符
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="confirm_password" class="form-label">
                                <i class="fas fa-lock me-2"></i>確認密碼
                            </label>
                            <div class="password-input-group">
                                <input type="password" class="form-control" id="confirm_password" name="confirm_password" 
                                       placeholder="請再次輸入密碼" required minlength="8">
                                <button type="button" class="password-toggle" onclick="togglePassword('confirm_password')">
                                    <i class="fas fa-eye" id="confirm_password-eye"></i>
                                </button>
                            </div>
                            <div class="requirements-list">
                                <i class="fas fa-info-circle me-1"></i>必須與上方密碼一致
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary" id="submit-btn">
                                <i class="fas fa-rocket me-2"></i>
                                <span id="submit-text">建立 Super Admin 並初始化系統</span>
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Security Notes -->
                <div class="security-notes">
                    <h6><i class="fas fa-shield-alt icon"></i>安全提醒</h6>
                    <ul>
                        <li>請使用強密碼保護 Super Admin 帳戶</li>
                        <li>Super Admin 擁有系統所有權限，請妥善保管</li>
                        <li>建議完成初始化後建立其他管理員帳戶分散風險</li>
                    </ul>
                </div>
            </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
        /**
         * 系統設置管理器
         */
        class SystemSetupManager {
            constructor() {
                this.form = document.getElementById('setup-form');
                this.submitBtn = document.getElementById('submit-btn');
                this.submitText = document.getElementById('submit-text');
                this.alertContainer = document.getElementById('alert-container');
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.checkSystemStatus();
            }
            
            setupEventListeners() {
                this.form.addEventListener('submit', (e) => this.handleSubmit(e));
                
                // 密碼確認檢查
                const passwordInput = document.getElementById('password');
                const confirmPasswordInput = document.getElementById('confirm_password');
                
                confirmPasswordInput.addEventListener('input', () => {
                    this.validatePasswordMatch();
                });
                
                passwordInput.addEventListener('input', () => {
                    this.validatePasswordMatch();
                });
            }
            
            validatePasswordMatch() {
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirm_password').value;
                const confirmInput = document.getElementById('confirm_password');
                
                if (confirmPassword && password !== confirmPassword) {
                    confirmInput.setCustomValidity('密碼不一致');
                    confirmInput.classList.add('is-invalid');
                } else {
                    confirmInput.setCustomValidity('');
                    confirmInput.classList.remove('is-invalid');
                }
            }
            
            async checkSystemStatus() {
                try {
                    const response = await fetch('/api/system/status');
                    const data = await response.json();
                    
                    if (data.is_initialized) {
                        this.showAlert('warning', '系統已初始化', '系統已經有 Super Admin，將重導向到登入頁面。');
                        setTimeout(() => {
                            window.location.href = '/login';
                        }, 3000);
                    }
                    
                } catch (error) {
                    console.warn('檢查系統狀態時發生錯誤:', error);
                    // 不阻止設置流程，可能是首次設置
                }
            }
            
            async handleSubmit(e) {
                e.preventDefault();
                
                // 禁用提交按鈕
                this.setSubmitState(true, '正在初始化系統...');
                
                try {
                    const formData = new FormData(this.form);
                    const setupData = {
                        username: formData.get('username').trim(),
                        password: formData.get('password'),
                        confirm_password: formData.get('confirm_password')
                    };
                    
                    // 前端驗證
                    const validationError = this.validateSetupData(setupData);
                    if (validationError) {
                        this.showAlert('danger', '驗證錯誤', validationError);
                        this.setSubmitState(false);
                        return;
                    }
                    
                    // 發送請求
                    const response = await fetch('/api/system/initialize', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(setupData)
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.success) {
                        this.showAlert('success', '初始化成功！', result.message);
                        
                        // 3秒後重導向到登入頁面
                        setTimeout(() => {
                            window.location.href = '/login';
                        }, 3000);
                        
                    } else {
                        const errorMsg = result.error || '初始化失敗，請稍後再試';
                        this.showAlert('danger', '初始化失敗', errorMsg);
                        this.setSubmitState(false);
                    }
                    
                } catch (error) {
                    console.error('系統初始化錯誤:', error);
                    this.showAlert('danger', '系統錯誤', '初始化時發生未知錯誤，請重新整理頁面後再試');
                    this.setSubmitState(false);
                }
            }
            
            validateSetupData(data) {
                if (!data.username || data.username.length < 3) {
                    return '使用者名稱至少需要3個字符';
                }
                
                if (data.username.length > 50) {
                    return '使用者名稱不能超過50個字符';
                }
                
                if (!data.password || data.password.length < 8) {
                    return '密碼至少需要8個字符';
                }
                
                if (data.password !== data.confirm_password) {
                    return '密碼與確認密碼不一致';
                }
                
                return null;
            }
            
            setSubmitState(loading, text = null) {
                if (loading) {
                    this.submitBtn.disabled = true;
                    this.submitBtn.innerHTML = `
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        <span>${text || '處理中...'}</span>
                    `;
                } else {
                    this.submitBtn.disabled = false;
                    this.submitBtn.innerHTML = `
                        <i class="fas fa-rocket me-2"></i>
                        <span>建立 Super Admin 並初始化系統</span>
                    `;
                }
            }
            
            showAlert(type, title, message) {
                const alertHtml = `
                    <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                        <strong><i class="fas ${this.getAlertIcon(type)} me-2"></i>${title}</strong>
                        <div>${message}</div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
                
                this.alertContainer.innerHTML = alertHtml;
                this.alertContainer.scrollIntoView({ behavior: 'smooth' });
            }
            
            getAlertIcon(type) {
                const icons = {
                    'success': 'fa-check-circle',
                    'danger': 'fa-exclamation-triangle',
                    'warning': 'fa-exclamation-circle',
                    'info': 'fa-info-circle'
                };
                return icons[type] || 'fa-info-circle';
            }
        }
        
        /**
         * 切換密碼顯示/隱藏
         */
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const eyeIcon = document.getElementById(`${inputId}-eye`);
            
            if (input.type === 'password') {
                input.type = 'text';
                eyeIcon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                eyeIcon.className = 'fas fa-eye';
            }
        }
        
        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', () => {
            window.setupManager = new SystemSetupManager();
        });
</script>
{% endblock %}
