{% extends "base.html" %}

{% block title %}{{ i18n.t('testRun.management') if i18n else '測試執行管理' }} - Test Case Repository Web Tool{% endblock %}

{% block head %}
<!-- Test Run 入口頁面樣式 -->
<style>
/* Test Run 卡片樣式 - 增強狀態視覺標示 */
.test-run-card {
    transition: all 0.3s ease;
    border: 1px solid var(--tr-border-light);
    cursor: pointer;
    position: relative;
    border-left-width: 4px;
}

/* 狀態顏色左邊框標示 */
.test-run-card.status-draft {
    border-left-color: #F57C00;
    background: linear-gradient(135deg, #FFFEF7 0%, #FFF9E1 100%);
}

.test-run-card.status-active {
    border-left-color: #1976D2;
    background: linear-gradient(135deg, #F8FBFF 0%, #E3F2FD 100%);
    animation: card-glow-active 3s infinite;
}

.test-run-card.status-completed {
    border-left-color: #388E3C;
    background: linear-gradient(135deg, #F9FDF9 0%, #E8F5E8 100%);
}

.test-run-card.status-archived {
    border-left-color: #757575;
    background: linear-gradient(135deg, #FAFAFA 0%, #F5F5F5 100%);
    opacity: 0.85;
}

/* 狀態光暈動畫 - Active 狀態 */
@keyframes card-glow-active {
    0%, 100% { box-shadow: 0 2px 8px rgba(25,118,210,0.1); }
    50% { box-shadow: 0 4px 16px rgba(25,118,210,0.2); }
}

.test-run-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.test-run-card.status-active:hover {
    box-shadow: 0 8px 25px rgba(25,118,210,0.3);
}

.test-run-card.status-completed:hover {
    box-shadow: 0 8px 25px rgba(56,142,60,0.2);
}

.test-run-card.status-draft:hover {
    box-shadow: 0 8px 25px rgba(245,124,0,0.2);
}

.test-run-card:hover .card-title {
    color: var(--tr-primary-dark) !important;
}

.test-run-card .card-body {
    padding: 1.25rem;
}

/* 狀態指示角標 */
.test-run-card::before {
    content: '';
    position: absolute;
    top: -1px;
    right: -1px;
    width: 0;
    height: 0;
    border-style: solid;
    border-width: 0 12px 12px 0;
    opacity: 0.7;
}

.test-run-card.status-draft::before { border-color: transparent #F57C00 transparent transparent; }
.test-run-card.status-active::before { border-color: transparent #1976D2 transparent transparent; }
.test-run-card.status-completed::before { border-color: transparent #388E3C transparent transparent; }
.test-run-card.status-archived::before { border-color: transparent #757575 transparent transparent; }

/* 新增 Test Run 卡片樣式 */
.add-test-run-card {
    transition: all 0.2s ease;
    border: 2px dashed var(--tr-border-light);
    cursor: pointer;
    background-color: var(--tr-bg-light);
}

.add-test-run-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--tr-shadow-md);
    border-color: var(--tr-primary);
    background-color: var(--tr-primary-light);
}

.add-test-run-card:hover h5,
.add-test-run-card:hover h6 {
    color: var(--tr-primary-dark) !important;
}

.add-test-run-card:hover .fas {
    color: var(--tr-primary-dark) !important;
}

/* 進度條樣式 */
.progress {
    height: 8px;
    border-radius: 4px;
}

.progress-bar {
    border-radius: 4px;
}

/* 狀態標籤樣式 - 增強視覺識別 */
.status-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.6rem;
    border-radius: 0.5rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
}

.status-badge:hover {
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    transform: translateY(-1px);
}

/* 狀態顏色系統 - 更直覺的色彩語意 */
.status-badge.status-draft { 
    background: linear-gradient(135deg, #FFF3CD 0%, #FFE69C 100%);
    color: #856404; 
    border: 1px solid #F0C419;
}

.status-badge.status-active { 
    background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
    color: #0D47A1; 
    border: 1px solid #2196F3;
    animation: pulse-active 2s infinite;
}

.status-badge.status-completed { 
    background: linear-gradient(135deg, #E8F5E8 0%, #C8E6C9 100%);
    color: #2E7D32; 
    border: 1px solid #4CAF50;
}

.status-badge.status-archived { 
    background: linear-gradient(135deg, #F5F5F5 0%, #E0E0E0 100%);
    color: #616161; 
    border: 1px solid #9E9E9E;
    opacity: 0.8;
}

/* 狀態脈動動畫 - 強調進行中狀態 */
@keyframes pulse-active {
    0%, 100% { box-shadow: 0 1px 3px rgba(33,150,243,0.2); }
    50% { box-shadow: 0 1px 8px rgba(33,150,243,0.4); }
}

/* 狀態圖示 */
.status-badge::before {
    content: '';
    width: 6px;
    height: 6px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 0.25rem;
}

.status-badge.status-draft::before { background-color: #F57C00; }
.status-badge.status-active::before { background-color: #1976D2; animation: blink-dot 1.5s infinite; }
.status-badge.status-completed::before { background-color: #388E3C; }
.status-badge.status-archived::before { background-color: #757575; }

/* 閃爍點 - 進行中狀態指示器 */
@keyframes blink-dot {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0.3; }
}
/* 自訂狀態下拉選單 - 使用 fixed positioning 解決層級問題 */
.custom-status-dropdown {
    position: fixed !important;
    z-index: 999999 !important;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15);
    min-width: 120px;
    padding: 0.5rem 0;
    display: none;
}

.custom-status-dropdown.show {
    display: block !important;
}

.custom-status-dropdown-item {
    display: flex;
    align-items: center;
    width: 100%;
    padding: 0.5rem 1rem;
    clear: both;
    font-weight: 400;
    color: #212529;
    text-align: inherit;
    text-decoration: none;
    white-space: nowrap;
    background-color: transparent;
    border: 0;
    cursor: pointer;
    transition: all 0.15s ease-in-out;
    line-height: 1.5;
}

.custom-status-dropdown-item i {
    width: 16px;
    text-align: center;
    flex-shrink: 0;
}

.custom-status-dropdown-item:hover {
    background-color: #f8f9fa;
    color: #1e2125;
}

.custom-status-dropdown-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 999998;
    display: none;
}

.custom-status-dropdown-overlay.show {
    display: block;
}

/* 統計資訊樣式 */
.stats-item {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
}


.stats-item:last-child {
    margin-bottom: 0;
}

/* TP 標籤間距調整 */
.stats-item .tp-tag {
    margin-left: 0.25rem;
}

/* T028: 快速搜尋結果樣式 - 現代化設計 */
.quick-search-tp-item {
    background-color: var(--tr-bg-card) !important;
    border-radius: 6px !important;
    margin: 4px 0 !important;
    transition: all 0.2s ease-in-out !important;
    box-shadow: var(--tr-shadow-sm) !important;
    font-size: 0.875rem !important;
    border: 1px solid var(--tr-border-light) !important;
    line-height: 1.5 !important;
    overflow: hidden !important;
    box-sizing: border-box !important;
}

/* T028: 圖示對齊樣式 */
.quick-search-tp-item .fas {
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    line-height: 1 !important;
    vertical-align: middle !important;
}

/* 統一圖示樣式 */
.quick-search-tp-item i.fas {
    width: 14px !important;
    text-align: center !important;
    font-size: 13px !important;
}

.quick-search-tp-item:hover {
    background: linear-gradient(135deg, var(--tr-primary-light) 0%, #f8fbff 100%) !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 3px 12px rgba(74, 144, 226, 0.15) !important;
    border-color: var(--tr-primary) !important;
}

.quick-search-tp-item.quick-search-active {
    background: linear-gradient(135deg, var(--tr-primary-light) 0%, #e8f4fd 100%) !important;
    border: 1px solid var(--tr-primary) !important;
    border-left: 3px solid var(--tr-primary) !important;
    box-shadow: 0 2px 8px rgba(74, 144, 226, 0.2) !important;
    transform: translateX(2px) !important;
}

.stats-icon {
    width: 1.25rem;
    text-align: center;
    margin-right: 0.5rem;
    opacity: 0.7;
}

/* TP 標籤樣式 */
.tp-tag {
    transition: all 0.2s ease;
    font-size: 0.75rem !important;
    font-weight: 500;
    border-radius: 0.375rem;
    padding: 0.25rem 0.5rem;
    margin: 0.125rem 0.25rem 0.125rem 0;
    display: inline-block;
    max-width: 100px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.tp-tag:hover {
    background-color: #495057 !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.tp-tag:active {
    transform: translateY(0);
}

/* TP 標籤容器樣式 */
.stats-item .tp-tag {
    vertical-align: middle;
}

/* Loading animation */
.loading-skeleton {
    background: linear-gradient(90deg, var(--tr-bg-sidebar) 25%, var(--tr-border-light) 50%, var(--tr-bg-sidebar) 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
}

@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* TP 票號標籤樣式 */
.tp-ticket-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.375rem 0.75rem;
    background-color: var(--tr-primary-light);
    color: var(--tr-primary-dark);
    border: 1px solid var(--tr-primary);
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.2s ease;
    cursor: pointer;
}

.tp-ticket-tag:hover {
    background-color: var(--tr-primary);
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.tp-ticket-tag .remove-btn {
    margin-left: 0.25rem;
    padding: 0;
    border: none;
    background: none;
    color: inherit;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 16px;
    height: 16px;
}

.tp-ticket-tag .remove-btn:hover {
    opacity: 1;
}

.tp-ticket-tag .remove-btn:focus {
    outline: none;
    opacity: 1;
}

/* 響應式設計 - 小螢幕適配 */
@media (max-width: 768px) {
    .tp-ticket-tag {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
    
    #tpTicketTags {
        gap: 0.375rem !important;
    }
}

/* 輸入欄位提示樣式 */
.form-text .fas {
    opacity: 0.6;
}

/* JIRA 預覽 tooltip 樣式 */
.jira-preview-tooltip {
    position: absolute;
    z-index: 9999;
    background: #ffffff;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.12);
    max-width: 380px;
    min-width: 320px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-8px);
    transition: all 0.2s ease;
    pointer-events: auto;
}

.jira-preview-tooltip.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.jira-preview-tooltip .tooltip-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid #eee;
}

.jira-preview-tooltip .ticket-number {
    font-weight: 600;
    color: var(--tr-primary);
    font-size: 0.875rem;
}

.jira-preview-tooltip .ticket-status {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
}

.jira-preview-tooltip .status-todo {
    background-color: #e3f2fd;
    color: #1976d2;
}

.jira-preview-tooltip .status-in-progress {
    background-color: #fff3e0;
    color: #f57c00;
}

.jira-preview-tooltip .status-done {
    background-color: #e8f5e8;
    color: #388e3c;
}

.jira-preview-tooltip .ticket-title {
    font-size: 0.9rem;
    font-weight: 500;
    color: #333;
    margin-bottom: 8px;
    line-height: 1.4;
}

.jira-preview-tooltip .ticket-details {
    font-size: 0.8rem;
    color: #666;
    margin-bottom: 8px;
}

.jira-preview-tooltip .assignee-info {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 8px;
}

.jira-preview-tooltip .assignee-info .fas {
    color: #666;
    width: 14px;
}

.jira-preview-tooltip .jira-link {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    color: var(--tr-primary);
    text-decoration: none;
    font-size: 0.8rem;
    font-weight: 500;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid #eee;
}

.jira-preview-tooltip .jira-link:hover {
    color: var(--tr-primary-dark);
    text-decoration: underline;
}

.jira-preview-tooltip .loading-spinner {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 16px;
    color: #666;
}

.jira-preview-tooltip .error-message {
    color: #dc3545;
    font-size: 0.8rem;
    text-align: center;
    padding: 8px;
}

/* TCG 風格的 tooltip 樣式 */
.jira-preview-tooltip .tcg-tooltip-header {
    background: #f8fafc;
    padding: 12px 16px;
    border-bottom: 1px solid #e2e8f0;
    margin: 0;
}

.jira-preview-tooltip .tcg-ticket-info {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.jira-preview-tooltip .tcg-ticket-number {
    font-weight: 600;
    color: #1e40af;
    font-size: 0.9rem;
}

.jira-preview-tooltip .tcg-ticket-status {
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
}

.jira-preview-tooltip .tcg-ticket-content {
    padding: 14px 16px;
}

.jira-preview-tooltip .tcg-ticket-title {
    font-size: 0.95rem;
    font-weight: 500;
    color: #1f2937;
    margin-bottom: 12px;
    line-height: 1.4;
}

.jira-preview-tooltip .tcg-ticket-meta {
    display: grid;
    gap: 8px;
}

.jira-preview-tooltip .tcg-assignee,
.jira-preview-tooltip .tcg-priority {
    display: flex;
    align-items: center;
}

.jira-preview-tooltip .tcg-label {
    font-size: 0.8rem;
    color: #6b7280;
    font-weight: 500;
    min-width: 65px;
    margin-right: 8px;
}

.jira-preview-tooltip .tcg-value {
    font-size: 0.8rem;
    color: #374151;
    font-weight: 400;
}

.jira-preview-tooltip .tcg-tooltip-footer {
    background: #f8fafc;
    padding: 10px 16px;
    border-top: 1px solid #e2e8f0;
    margin: 0;
}

.jira-preview-tooltip .tcg-jira-link {
    display: inline-flex;
    align-items: center;
    color: #3b82f6;
    text-decoration: none;
    font-size: 0.8rem;
    font-weight: 500;
    transition: color 0.15s ease;
}

.jira-preview-tooltip .tcg-jira-link:hover {
    color: #1d4ed8;
    text-decoration: underline;
}

/* 通知設定區域樣式 */
#notificationGroupsSection {
    transition: all 0.3s ease;
}

#groupSearchResults {
    background-color: #ffffff;
    border-color: #dee2e6;
    transition: all 0.2s ease;
}

#groupSearchResults:empty {
    display: none !important;
}

.group-search-item {
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    border-bottom: 1px solid #f1f3f4;
    transition: background-color 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.group-search-item:last-child {
    border-bottom: none;
}

.group-search-item:hover {
    background-color: #f8f9fa;
}

.group-search-item .group-icon {
    color: #6c757d;
    width: 16px;
    text-align: center;
}

.group-search-item .group-name {
    font-weight: 500;
    color: #212529;
    flex-grow: 1;
}

.group-search-item .group-id {
    font-size: 0.75rem;
    color: #6c757d;
    font-family: 'Courier New', monospace;
}

/* 已選群組標籤樣式 */
.selected-group-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.375rem 0.75rem;
    background-color: var(--tr-primary-light);
    color: var(--tr-primary-dark);
    border: 1px solid var(--tr-primary);
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.2s ease;
    cursor: default;
}

.selected-group-tag:hover {
    background-color: var(--tr-primary);
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.selected-group-tag .group-remove-btn {
    margin-left: 0.25rem;
    padding: 0;
    border: none;
    background: none;
    color: inherit;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 16px;
    height: 16px;
}

.selected-group-tag .group-remove-btn:hover {
    opacity: 1;
}

.selected-group-tag .group-remove-btn:focus {
    outline: none;
    opacity: 1;
}

/* 群組設定动画 */
.notification-groups-entering {
    opacity: 0;
    transform: translateY(-10px);
}

.notification-groups-entered {
    opacity: 1;
    transform: translateY(0);
}

.notification-groups-exiting {
    opacity: 1;
    transform: translateY(0);
}

.notification-groups-exited {
    opacity: 0;
    transform: translateY(-10px);
}

/* 群組標認欄位呼呼效果 */
.notifications-indicator {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.125rem 0.5rem;
    background-color: #e3f2fd;
    color: #1976d2;
    border: 1px solid #bbdefb;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    font-weight: 500;
}

.notifications-indicator .fas {
    animation: bell-ring 2s infinite;
}

@keyframes bell-ring {
    0%, 50%, 100% {
        transform: rotate(0deg);
    }
    10% {
        transform: rotate(10deg);
    }
    20% {
        transform: rotate(-10deg);
    }
    30% {
        transform: rotate(8deg);
    }
    40% {
        transform: rotate(-8deg);
    }
}

</style>
{% endblock %}

{% block page_title_text %}
<span data-i18n="testRun.management">測試執行管理</span>
{% endblock %}

{% block page_subtitle_text %}
<span data-i18n="testRun.subtitle">管理測試執行記錄，追蹤測試進度和結果</span>
{% endblock %}

{% block page_specific_actions %}
<div class="d-flex flex-column flex-md-row gap-3">
    <!-- 狀態過濾按鈕群組 -->
    <div class="btn-group" role="group" aria-label="Status filter buttons">
        <input type="radio" class="btn-check" name="statusFilter" id="filterAll" value="all" checked>
        <label class="btn btn-outline-secondary" for="filterAll">
            <i class="fas fa-list me-1"></i><span data-i18n="testRun.filter.all">全部</span>
        </label>

        <input type="radio" class="btn-check" name="statusFilter" id="filterDraft" value="draft">
        <label class="btn btn-outline-warning" for="filterDraft">
            <i class="fas fa-edit me-1"></i><span data-i18n="testRun.filter.draft">草稿</span>
        </label>

        <input type="radio" class="btn-check" name="statusFilter" id="filterActive" value="active">
        <label class="btn btn-outline-primary" for="filterActive">
            <i class="fas fa-play me-1"></i><span data-i18n="testRun.filter.active">進行中</span>
        </label>

        <input type="radio" class="btn-check" name="statusFilter" id="filterCompleted" value="completed">
        <label class="btn btn-outline-success" for="filterCompleted">
            <i class="fas fa-check me-1"></i><span data-i18n="testRun.filter.completed">已完成</span>
        </label>

        <input type="radio" class="btn-check" name="statusFilter" id="filterArchived" value="archived">
        <label class="btn btn-outline-secondary" for="filterArchived">
            <i class="fas fa-archive me-1"></i><span data-i18n="testRun.filter.archived">已歸檔</span>
        </label>
    </div>

    <!-- 其他操作按鈕 -->
    <div class="d-flex gap-2">
        <button type="button" class="btn btn-secondary" id="refreshBtn">
            <i class="fas fa-sync-alt me-2"></i><span data-i18n="common.refresh">重新整理</span>
        </button>
        <a href="/" class="btn btn-outline-secondary">
            <i class="fas fa-home me-2"></i><span data-i18n="navigation.backToHome">回到首頁</span>
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">

    <!-- Loading state -->
    <div id="loading-state" class="text-center py-5" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden" data-i18n="common.loading">載入中...</span>
        </div>
        <div class="mt-3 text-muted" data-i18n="testRun.loadingConfigs">載入測試執行配置中...</div>
    </div>

    <!-- 無配置時的提示區域 -->
    <div id="no-configs-section" style="display: none;">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-4">
                <div class="card text-center add-test-run-card" onclick="openConfigFormModal()">
                    <div class="card-body py-5">
                        <div class="text-primary rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 64px; height: 64px; font-size: 24px; border: 2px dashed var(--tr-primary);">
                            <i class="fas fa-plus"></i>
                        </div>
                        <h5 class="text-primary mb-2" data-i18n="testRun.createFirstConfig">建立第一個測試執行</h5>
                        <p class="text-muted small mb-0" data-i18n="testRun.createFirstConfigHint">
                            設定 Lark 資料表開始測試執行
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Run 配置卡片區域 -->
    <div id="test-run-configs-section">
        <div class="row" id="test-run-configs-container">
            <!-- Test Run 配置卡片將在此處動態生成 -->
        </div>
    </div>
</div>

<!-- Create/Edit Test Run Configuration Modal -->
<div class="modal fade" id="configFormModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="configFormModalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="testRunConfigForm">
                    <input type="hidden" id="configId" name="id">
                    <div class="mb-3">
                        <label for="configName" class="form-label">
                            <span data-i18n="testRun.configName">Test Run 名稱</span> 
                            <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="configName" name="name" required 
                               data-i18n-placeholder="testRun.configNamePlaceholder"
                               placeholder="輸入 Test Run 名稱">
                    </div>
                    
                    
                    <div class="mb-3">
                        <label for="configDescription" class="form-label" data-i18n="common.description">描述</label>
                        <textarea class="form-control" id="configDescription" name="description" rows="3" 
                                data-i18n-placeholder="testRun.descriptionPlaceholder"></textarea>

                    </div>

                    <div class="row">
                      <div class="col-md-4">
                        <div class="mb-3">
                          <label for="testEnvironment" class="form-label"><span data-i18n="testRun.testEnvironment">測試環境</span> <span class="badge bg-secondary ms-2" data-i18n="common.optional">選填</span></label>
                          <input type="text" class="form-control" id="testEnvironment" name="test_environment" data-i18n-placeholder="testRun.testEnvironmentPlaceholder" placeholder="例如：Staging / UAT / Prod Sandbox">
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="mb-3">
                          <label for="buildNumber" class="form-label"><span data-i18n="testRun.buildNumber">建置版本</span> <span class="badge bg-secondary ms-2" data-i18n="common.optional">選填</span></label>
                          <input type="text" class="form-control" id="buildNumber" name="build_number" data-i18n-placeholder="testRun.buildNumberPlaceholder" placeholder="例如：v1.2.3 / build #4567">
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="mb-3">
                          <label for="relatedTpTickets" class="form-label">
                            <span data-i18n="testRun.relatedTpTickets">相關 TP 開發單</span> 
                            <span class="badge bg-secondary ms-2" data-i18n="common.optional">選填</span>
                          </label>
                          <input type="text" class="form-control" id="relatedTpTicketsInput" 
                                 data-i18n-placeholder="testRun.relatedTpTicketsPlaceholder" 
                                 placeholder="輸入 TP 票號，例如：TP-12345"
                                 autocomplete="off">
                          <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            <span data-i18n="testRun.tpTicketInputHint">按 Enter 鍵新增票號</span>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- TP 標籤顯示區域 -->
                    <div class="mb-3" id="tpTicketsDisplay" style="display: none;">
                        <label class="form-label">
                            <span data-i18n="testRun.addedTpTickets">已新增的 TP 開發單</span>
                        </label>
                        <div id="tpTicketTags" class="d-flex flex-wrap gap-2">
                            <!-- TP 票號標籤將在這裡動態生成 -->
                        </div>
                    </div>

                    <!-- 通知設定區域 -->
                    <div class="mb-3">
                        <h6 class="mb-3">
                            <i class="fas fa-bell me-2"></i>
                            <span data-i18n="testRun.notifications.title">通知設定</span>
                            <span class="badge bg-secondary ms-2" data-i18n="common.optional">選填</span>
                        </h6>
                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="notificationsEnabled" name="notifications_enabled">
                            <label class="form-check-label" for="notificationsEnabled">
                                <span data-i18n="testRun.notifications.enable">啟用 Lark 群組通知</span>
                            </label>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                <span data-i18n="testRun.notifications.enableHint">在測試執行狀態變更時發送通知到選定的 Lark 群組</span>
                            </div>
                        </div>
                        
                        <!-- 群組選擇區域，預設隱藏 -->
                        <div id="notificationGroupsSection" style="display: none;">
                            <label for="notifyGroupsSelect" class="form-label">
                                <span data-i18n="testRun.notifications.selectGroups">選擇通知群組</span>
                            </label>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" id="notifyGroupsInput" 
                                       data-i18n-placeholder="testRun.notifications.searchPlaceholder" 
                                       placeholder="搜尋群組名稱..." 
                                       autocomplete="off">
                                <button class="btn btn-outline-secondary" type="button" id="searchGroupsBtn">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div id="groupSearchResults" class="border rounded p-2" style="max-height: 200px; overflow-y: auto; display: none;">
                                <!-- 群組搜尋結果將在這裡顯示 -->
                            </div>
                            <div class="form-text mb-3">
                                <i class="fas fa-info-circle me-1"></i>
                                <span data-i18n="testRun.notifications.selectHint">輸入群組名稱關鍵字搜尋並選擇通知群組，最多可選 100 個</span>
                            </div>
                            
                            <!-- 已選群組顯示區域 -->
                            <div id="selectedGroupsDisplay" class="mb-3" style="display: none;">
                                <label class="form-label">
                                    <span data-i18n="testRun.notifications.selectedGroups">已選群組</span>
                                    <span class="badge bg-primary ms-2" id="selectedGroupsCount">0</span>
                                </label>
                                <div id="selectedGroupsTags" class="d-flex flex-wrap gap-2">
                                    <!-- 已選群組標籤將在這裡動態生成 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-primary" id="saveConfigBtn">
                    <i class="fas fa-save me-2"></i><span id="saveConfigBtnText"></span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Test Case 選擇 Modal -->
<div class="modal fade" id="caseSelectModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-tasks me-2"></i><span data-i18n="testRun.caseSelect.title">選擇要加入的 Test Case</span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="input-group input-group-search mb-3">
          <div class="position-relative flex-grow-1">
            <input id="caseSearchInput" class="form-control pe-4" data-i18n-placeholder="testRun.caseSelect.searchPlaceholder" placeholder="搜尋標題或編號...">
            <button class="input-clear-btn d-none" id="caseClearBtn" type="button" data-i18n-title="common.clear" title="清除" tabindex="-1" aria-label="Clear">
              <i class="fas fa-times-circle"></i>
            </button>
          </div>
          <button class="btn btn-secondary" id="caseSearchBtn" type="button"><i class="fas fa-search me-1"></i><span data-i18n="common.search">搜尋</span></button>
        </div>
        <div id="caseSelectInfo" class="text-muted small mb-2"></div>
        <div class="table-responsive" style="max-height: 50vh; overflow:auto;">
          <table class="table table-sm align-middle table-sticky">
            <thead>
              <tr>
                <th style="width:32px;"><input type="checkbox" id="selectAllCases"></th>
                <th style="width:160px;"><span data-i18n="testRun.caseSelect.columns.caseNumber">Test Case Number</span></th>
                <th><span data-i18n="testRun.caseSelect.columns.title">Title</span></th>
                <th style="width:100px;"><span data-i18n="testRun.caseSelect.columns.priority">Priority</span></th>
                <th style="width:100px;"><span data-i18n="testRun.caseSelect.columns.attachments">Attachments</span></th>
              </tr>
            </thead>
            <tbody id="caseListBody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <div class="me-auto text-muted small"><span id="selectedCount">0</span></div>
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
        <button type="button" class="btn btn-primary" id="confirmCreateItemsBtn"><i class="fas fa-check me-1"></i><span data-i18n="common.create">建立</span></button>
      </div>
    </div>
  </div>
  </div>

<!-- Test Run 配置詳情 Modal -->
<div class="modal fade" id="configDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog me-2"></i>
                    <span id="configDetailTitle" data-i18n="testRun.configDetails">Test Run 配置詳情</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="configDetailContent">
                <!-- Configuration details will be dynamically loaded by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" data-i18n="common.close">關閉</button>
                <button type="button" class="btn btn-warning" id="editConfigBtn">
                    <i class="fas fa-edit me-2"></i><span data-i18n="common.edit">編輯</span>
                </button>
                <button type="button" class="btn btn-danger" id="deleteConfigBtn">
                    <i class="fas fa-trash me-2"></i><span data-i18n="common.delete">刪除</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Test Run Delete Confirmation Dialog - Temporarily commented to fix loading issues -->
<!--
<div class="modal fade" id="deleteTestRunModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-exclamation-triangle text-warning me-2"></i>
          <span data-i18n="common.confirm">確認刪除</span>
        </h5>
      </div>
      <div class="modal-body">
        <p id="deleteConfirmMessage" class="mb-3"></p>
        <div class="alert alert-warning mb-0">
          <i class="fas fa-info-circle me-2"></i>
          <span data-i18n="form.deleteWarning">此操作無法復原，請仔細確認</span>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <span data-i18n="common.cancel">取消</span>
        </button>
        <button type="button" class="btn btn-danger" id="confirmDeleteTestRun">
          <i class="fas fa-trash me-2"></i>
          <span data-i18n="common.delete">刪除</span>
        </button>
      </div>
    </div>
  </div>
</div>
-->
<!-- Test Run Delete Confirmation Dialog -->
<div class="modal fade" id="deleteConfigModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title d-flex align-items-center">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <span data-i18n="common.confirm">確認刪除</span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="deleteConfirmMessage" class="mb-3"></p>
        <div class="alert alert-danger mb-0">
          <i class="fas fa-exclamation-circle me-2"></i>
          <span data-i18n="form.deleteWarning">此操作無法復原，請仔細確認</span>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <span data-i18n="common.cancel">取消</span>
        </button>
        <button type="button" class="btn btn-danger" id="confirmDeleteConfigBtn">
          <i class="fas fa-trash me-2"></i>
          <span data-i18n="common.delete">刪除</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 自訂狀態下拉選單 - Fixed positioning -->
<div class="custom-status-dropdown-overlay" id="statusDropdownOverlay" onclick="hideCustomStatusDropdown()"></div>
<div class="custom-status-dropdown" id="customStatusDropdown">
    <!-- 選項將由 JavaScript 動態生成 -->
</div>
{% endblock %}

{% block scripts %}
<script>
// Test Run 配置管理

let testRunConfigs = [];
let currentTeamId = null;
let configDetailModalInstance = null;
let configFormModalInstance = null;
// delete config modal is handled via bootstrap instance on demand

// 頁面狀態旗標，避免競態與重複綁定
let teamIdReady = false;      // 取得有效 teamId 後才為 true
let dataLoadedOnce = false;   // 成功載入過資料後為 true
let eventsBound = false;      // 避免重複綁定 i18n/page 事件

document.addEventListener('DOMContentLoaded', function() {
    // 監聽全域 team 變更事件，隨時更新 URL 的 team_id
    try {
        window.addEventListener('teamChanged', function(e) {
            const newTeam = e && e.detail && e.detail.team;
            if (newTeam && newTeam.id) {
                ensureTeamIdInUrl_TRM(newTeam.id);
            }
        });
    } catch (_) {}

    initializePage();
    bindEventListeners();

    // 綁定 i18n 事件（僅重翻譯，不觸發資料重載）
    if (!eventsBound) {
        document.addEventListener('i18nReady', onI18nEventOnce);
        document.addEventListener('languageChanged', onI18nEvent);
        // 處理 bfcache 返回
        window.addEventListener('pageshow', onPageShow);
        eventsBound = true;
    }

    // DOM 就緒且 i18n 已就緒時，僅重翻譯
    if (window.i18n && window.i18n.isReady && window.i18n.isReady()) {
        refreshStatusTexts();
    }
});

function onI18nEventOnce() {
    // i18n 初始化完成後，不重打 API，僅更新文案
    refreshStatusTexts();
}

function onI18nEvent() {
    // 語言切換後，不重打 API，僅更新文案
    refreshStatusTexts();
}

function onPageShow(event) {
    // bfcache 或一般顯示時，確認 teamId 狀態
    const latestTeamId = AppUtils.getCurrentTeamId ? AppUtils.getCurrentTeamId() : (AppUtils.getCurrentTeam()?.id ?? null);
    if (latestTeamId && latestTeamId !== currentTeamId) {
        currentTeamId = latestTeamId;
        teamIdReady = true;
        // 只有在尚未載入過資料時才載入，避免返回頁面時不必要的 API 呼叫
        if (!dataLoadedOnce) {
            loadTestRunConfigs();
        } else {
            refreshStatusTexts();
        }
    } else if (!latestTeamId) {
        teamIdReady = false;
        console.warn('pageshow: Skip loading due to missing teamId');
        // 可選：顯示需選擇團隊的提示
    } else {
        // teamId 未變更
        refreshStatusTexts();
    }
}

function initializePage() {
    // 以 AppUtils.getCurrentTeamId 為單一資料源
    currentTeamId = (typeof AppUtils.getCurrentTeamId === 'function')
        ? AppUtils.getCurrentTeamId()
        : (AppUtils.getCurrentTeam()?.id ?? null);

    // 確保網址列包含 team_id（不重新載入頁面）
    try { if (currentTeamId) ensureTeamIdInUrl_TRM(currentTeamId); } catch (_) {}

    if (currentTeamId) {
        teamIdReady = true;
        loadTestRunConfigs();
    } else {
        teamIdReady = false;
        console.warn('initializePage: teamId not ready, skip loading');
        // 不打 API；可選：顯示需先選擇團隊的 UI 狀態
        showNoConfigs();
    }
}

function bindEventListeners() {
    const refreshBtn = document.getElementById('refreshBtn');
    if (refreshBtn) refreshBtn.addEventListener('click', () => {
        if (!teamIdReady) {
            // 嘗試延遲取得 teamId
            const latestTeamId = (typeof AppUtils.getCurrentTeamId === 'function')
                ? AppUtils.getCurrentTeamId()
                : (AppUtils.getCurrentTeam()?.id ?? null);
            if (latestTeamId) {
                currentTeamId = latestTeamId;
                teamIdReady = true;
            }
        }
        if (teamIdReady) {
            loadTestRunConfigs();
        } else {
            console.warn('Refresh skipped: teamId not ready');
            AppUtils.showWarning && AppUtils.showWarning((window.i18n && window.i18n.isReady()) ? window.i18n.t('errors.teamNotSelected') : '請先選擇團隊');
        }
    });
    
    document.addEventListener('click', function(e) {
        if (e.target.closest('.add-test-run-card')) {
            openConfigFormModal(); // Changed from openCreateTestRunConfigModal
        }
    });
    
    const saveBtn = document.getElementById('saveConfigBtn');
    if (saveBtn) saveBtn.addEventListener('click', handleSaveConfig);
    
    // 狀態過濾事件監聽器
    document.querySelectorAll('input[name="statusFilter"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.checked) {
                const filterValue = this.value;
                console.log('過濾狀態變更為:', filterValue);
                renderConfigCards(filterValue);
            }
        });
    });
}

async function loadTestRunConfigs() {
    try {
        // 防護：若 teamId 尚未就緒，嘗試回填，否則中止
        if (!currentTeamId) {
            const latestTeamId = (typeof AppUtils.getCurrentTeamId === 'function')
                ? AppUtils.getCurrentTeamId()
                : (AppUtils.getCurrentTeam()?.id ?? null);
            if (latestTeamId) {
                currentTeamId = latestTeamId;
                teamIdReady = true;
            }
        }
        if (!currentTeamId) {
            console.warn('loadTestRunConfigs: Skip loading due to missing teamId');
            showNoConfigs();
            return;
        }

        console.log('Loading Test Run configurations, Team ID:', currentTeamId);
        showLoading();
        const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-configs/`);
        console.log('API 回應狀態:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        testRunConfigs = await response.json();
        dataLoadedOnce = true;
        console.log('Loaded configurations count:', testRunConfigs.length);
        console.log('Configuration data:', testRunConfigs);
        renderTestRunConfigs();
    } catch (error) {
        console.error('Failed to load Test Run configurations:', error);
        const errorMsg = window.i18n ? window.i18n.t('messages.loadConfigsFailed') : '載入失敗';
        AppUtils.showError(errorMsg + '：' + error.message);
        showNoConfigs();
    } finally {
        hideLoading();
    }
}

function renderTestRunConfigs() {
    console.log('Starting to render Test Run configurations');
    console.log('testRunConfigs:', testRunConfigs);
    if (!testRunConfigs || testRunConfigs.length === 0) {
        console.log('No configuration data, showing no configs state');
        showNoConfigs();
        return;
    }
    console.log('Showing configs section and rendering cards');
    showConfigsSection();
    renderConfigCards();
}

function showLoading() {
    document.getElementById('loading-state').style.display = 'block';
    document.getElementById('test-run-configs-section').style.display = 'none';
    document.getElementById('no-configs-section').style.display = 'none';
}

function hideLoading() {
    document.getElementById('loading-state').style.display = 'none';
}

function showNoConfigs() {
    document.getElementById('no-configs-section').style.display = 'block';
    document.getElementById('test-run-configs-section').style.display = 'none';
}

function showConfigsSection() {
    document.getElementById('no-configs-section').style.display = 'none';
    document.getElementById('test-run-configs-section').style.display = 'block';
}

function renderConfigCards(filterStatus = 'all') {
    const container = document.getElementById('test-run-configs-container');
    
    // 過濾配置
    let filteredConfigs = testRunConfigs;
    if (filterStatus !== 'all') {
        filteredConfigs = testRunConfigs.filter(config => config.status === filterStatus);
    }
    
    const configsHtml = filteredConfigs.map(config => createConfigCard(config)).join('');
    const addConfigCard = `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 add-test-run-card text-center" onclick="openConfigFormModal()">
                <div class="card-body d-flex flex-column justify-content-center">
                    <div class="text-primary rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                         style="width: 48px; height: 48px; font-size: 18px; border: 2px dashed var(--tr-primary);">
                        <i class="fas fa-plus"></i>
                    </div>
                    <h6 class="text-primary mb-1" data-i18n="testRun.addMoreConfigs">新增更多 Test Run</h6>
                    <small class="text-muted" data-i18n="testRun.addMoreConfigsHint">建立新的測試執行配置</small>
                </div>
            </div>
        </div>
    `;
    container.innerHTML = configsHtml + addConfigCard;
    
    if (window.i18n && window.i18n.isReady()) {
        window.i18n.retranslate(container);
    }
}

function createConfigCard(config) {
    const statusClass = getStatusClass(config.status);
    const statusText = getStatusText(config.status);
    const progressPercentage = config.execution_rate || 0;
    const passPercentage = config.pass_rate || 0;
    const createdDate = AppUtils.formatDate(config.created_at, 'datetime-tz');
    const envLine = config.test_environment ? `<div class=\"stats-item\"><i class=\"fas fa-server stats-icon\"></i><small class=\"text-muted\"><span data-i18n=\"testRun.testEnvironment\">測試環境</span>: ${escapeHtml(config.test_environment)}</small></div>` : '';
    
    // TP 標籤顯示邏輯
    let tpLine = '';
    if (config.related_tp_tickets && Array.isArray(config.related_tp_tickets) && config.related_tp_tickets.length > 0) {
        const maxDisplay = 5; // 最多顯示5個標籤
        const visibleTickets = config.related_tp_tickets.slice(0, maxDisplay);
        const remainingCount = config.related_tp_tickets.length - maxDisplay;
        
        const tpTags = visibleTickets.map(ticket => 
            `<span class="tp-tag badge bg-secondary me-1" data-tp-ticket="${escapeHtml(ticket)}" 
                   onmouseenter="showJiraPreview(event, '${escapeHtml(ticket)}')" 
                   onmouseleave="hideJiraPreview()" 
                   onclick="event.stopPropagation(); openJiraTicket('${escapeHtml(ticket)}')" 
                   style="cursor: pointer; font-size: 0.75rem;">${escapeHtml(ticket)}</span>`
        ).join('');
        
        const remainingTag = remainingCount > 0 ? 
            `<span class="badge bg-light text-dark" style="font-size: 0.75rem;">+${remainingCount}</span>` : '';
            
        tpLine = `<div class="stats-item"><i class="fas fa-ticket-alt stats-icon"></i><small class="text-muted"><span data-i18n="testRun.relatedTpTickets">相關 TP 開發單</span>: <span class="ms-1">${tpTags}${remainingTag}</span></small></div>`;
    }
    
    const buildLine = config.build_number ? `<div class=\"stats-item\"><i class=\"fas fa-code-branch stats-icon\"></i><small class=\"text-muted\"><span data-i18n=\"testRun.buildNumber\">建置版本</span>: ${escapeHtml(config.build_number)}</small></div>` : '';
    
    return `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 test-run-card ${getStatusClass(config.status)}" onclick="enterTestRun(${config.id})">
                <div class="card-body d-flex flex-column h-100">
                    <div class="d-flex align-items-start mb-3">
                        <div class="flex-shrink-0 me-3">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                 style="width: 48px; height: 48px; font-size: 16px; font-weight: bold;">
                                <i class="fas fa-play"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 min-width-0">
                            <h5 class="card-title text-primary mb-1 text-truncate">${escapeHtml(config.name)}</h5>
                            <div class="d-flex align-items-center mb-2">
                                <span class="status-badge ${statusClass} me-2">${statusText}</span>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="text-muted" data-i18n="testRun.progressLabel">執行進度</small>
                            <small class="text-muted">${progressPercentage.toFixed(1)}%</small>
                        </div>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-primary" style="width: ${progressPercentage}%"></div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="text-muted" data-i18n="testRun.passRateLabel">Pass Rate</small>
                            <small class="text-muted">${passPercentage.toFixed(1)}%</small>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-success" style="width: ${passPercentage}%"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        ${envLine}
                        ${tpLine}
                        ${buildLine}
                        <div class="stats-item">
                            <i class="fas fa-list-ul stats-icon"></i>
                            <small class="text-muted">${(window.i18n && window.i18n.isReady()) ? window.i18n.t('testRun.totalExecuted', {total: config.total_test_cases, executed: config.executed_cases}) : `總數: ${config.total_test_cases} | 已執行: ${config.executed_cases}`}</small>
                        </div>
                        <div class="stats-item">
                            <i class="fas fa-calendar stats-icon"></i>
                            <small class="text-muted">${(window.i18n && window.i18n.isReady()) ? window.i18n.t('testRun.createdLabel', {date: createdDate}) : `建立: ${createdDate}`}</small>
                        </div>
                    </div>
                    <div class="d-flex gap-2 mt-auto pt-2">
                        <button class="btn btn-primary btn-sm flex-grow-1" onclick="event.stopPropagation(); enterTestRun(${config.id})">
                            <i class="fas fa-arrow-right me-1"></i><span data-i18n="testRun.enterButton">進入</span>
                        </button>
                        <button class="btn btn-outline-secondary btn-sm${(config.status === 'completed' || config.status === 'archived') ? ' disabled' : ''}" 
                                ${(config.status === 'completed' || config.status === 'archived') ? 'disabled' : ''} 
                                ${(config.status === 'completed' || config.status === 'archived') ? `title="${window.i18n && window.i18n.isReady() ? window.i18n.t('testRun.cannotEditCompleted') : '已完成或已歸檔的 Test Run 不可編輯'}"` : ''}
                                onclick="event.stopPropagation(); editBasicSettings(${config.id})">
                            <i class="fas fa-edit me-1"></i><span data-i18n="testRun.editBasicSettings">編輯基本設定</span>
                        </button>
                        <button class="btn btn-outline-info btn-sm${(config.status === 'completed' || config.status === 'archived') ? ' disabled' : ''}" 
                                ${(config.status === 'completed' || config.status === 'archived') ? 'disabled' : ''} 
                                ${(config.status === 'completed' || config.status === 'archived') ? `title="${window.i18n && window.i18n.isReady() ? window.i18n.t('testRun.cannotEditCompleted') : '已完成或已歸檔的 Test Run 不可編輯 Test Case'}"` : ''}
                                onclick="event.stopPropagation(); editTestCases(${config.id})">
                            <i class="fas fa-list me-1"></i><span data-i18n="testRun.editTestCases">編輯 Test Case</span>
                        </button>
                        <!-- 自訂狀態切換下拉選單 -->
                        <div class="position-relative" onclick="event.stopPropagation()">
                            <button type="button" class="btn btn-outline-warning btn-sm custom-status-btn" 
                                    data-config-id="${config.id}" 
                                    onclick="event.stopPropagation(); toggleCustomStatusDropdown(this, ${config.id})">
                                <i class="fas fa-exchange-alt me-1"></i><span data-i18n="testRun.changeStatus">狀態</span>
                                <i class="fas fa-chevron-down ms-1"></i>
                            </button>
                        </div>
                        <button class="btn btn-outline-danger btn-sm" onclick="event.stopPropagation(); deleteTestRun(${config.id}, '${escapeHtml(config.name)}')">
                            <i class="fas fa-trash me-1"></i><span data-i18n="common.delete">刪除</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function getStatusClass(status) {
    switch (status) {
        case 'active': return 'status-active';
        case 'completed': return 'status-completed';
        case 'draft': return 'status-draft';
        case 'archived': return 'status-archived';
        default: return 'status-draft';
    }
}

function getStatusText(status) {
    if (window.i18n && window.i18n.isReady && window.i18n.isReady()) {
        const statusKey = `testRun.status.${status}`;
        const translated = window.i18n.t(statusKey);
        // 如果翻譯失敗（返回原始鍵），使用預設文字
        if (translated === statusKey || !translated) {
            return getDefaultStatusText(status);
        }
        return translated;
    }
    return getDefaultStatusText(status);
}

function getDefaultStatusText(status) {
    const defaultTexts = {
        'active': '進行中',
        'completed': '已完成', 
        'draft': '草稿',
        'archived': '已歸檔',
        'unknown': '未知'
    };
    return defaultTexts[status] || '未知';
}

// 自訂下拉選單邏輯
let currentDropdownConfig = null;

function toggleCustomStatusDropdown(button, configId) {
    const dropdown = document.getElementById('customStatusDropdown');
    const overlay = document.getElementById('statusDropdownOverlay');
    
    // 如果已經打開，則關閉
    if (dropdown.classList.contains('show')) {
        hideCustomStatusDropdown();
        return;
    }
    
    // 找到對應的配置
    const config = testRunConfigs.find(c => c.id === configId);
    if (!config) return;
    
    currentDropdownConfig = config;
    
    // 生成下拉選單內容
    generateCustomStatusDropdownItems(config, dropdown);
    
    // 計算位置
    const rect = button.getBoundingClientRect();
    dropdown.style.left = rect.left + 'px';
    dropdown.style.top = (rect.bottom + 5) + 'px';
    
    // 顯示下拉選單和覆蓋層
    overlay.classList.add('show');
    dropdown.classList.add('show');
}

function hideCustomStatusDropdown() {
    const dropdown = document.getElementById('customStatusDropdown');
    const overlay = document.getElementById('statusDropdownOverlay');
    
    dropdown.classList.remove('show');
    overlay.classList.remove('show');
    currentDropdownConfig = null;
}

function generateCustomStatusDropdownItems(config, dropdown) {
    const currentStatus = config.status;
    
    // 定義狀態轉換規則
    const statusTransitions = {
        'draft': ['active', 'archived'],
        'active': ['completed', 'archived'],  // 進行中不可回到草稿
        'completed': ['archived'],  // 已完成只能歸檔
        'archived': ['active', 'draft']
    };
    
    const availableStatuses = statusTransitions[currentStatus] || [];
    
    let html = '';
    
    availableStatuses.forEach(status => {
        const statusText = getStatusText(status);
        const icon = getStatusIcon(status);
        
        html += `
            <div class="custom-status-dropdown-item" onclick="handleCustomStatusChange('${status}')">
                <i class="${icon} me-2"></i>${statusText}
            </div>
        `;
    });
    
    dropdown.innerHTML = html;
}

function handleCustomStatusChange(newStatus) {
    if (currentDropdownConfig) {
        changeTestRunStatus(currentDropdownConfig.id, newStatus, currentDropdownConfig.name);
        hideCustomStatusDropdown();
    }
}

function generateStatusDropdownItems(config) {
    const currentStatus = config.status;
    
    // 定義狀態轉換規則
    const statusTransitions = {
        'draft': ['active', 'archived'],
        'active': ['completed', 'archived'],  // 進行中不可回到草稿
        'completed': ['archived'],  // 已完成只能歸檔
        'archived': ['active', 'draft']
    };
    
    const availableStatuses = statusTransitions[currentStatus] || [];
    
    let items = [];
    
    availableStatuses.forEach(status => {
        const statusText = getStatusText(status);
        const icon = getStatusIcon(status);
        
        items.push(`
            <li><a class="dropdown-item" href="#" onclick="event.stopPropagation(); changeTestRunStatus(${config.id}, '${status}', '${escapeHtml(config.name)}')">
                <i class="${icon} me-2"></i>${statusText}
            </a></li>
        `);
    });
    
    return items.join('');
}

function getStatusIcon(status) {
    const icons = {
        'active': 'fas fa-play text-primary',
        'completed': 'fas fa-check text-success',
        'draft': 'fas fa-edit text-warning',
        'archived': 'fas fa-archive text-secondary'
    };
    return icons[status] || 'fas fa-question text-muted';
}

async function changeTestRunStatus(configId, newStatus, configName) {
    // 直接執行狀態變更，不需要輸入原因
    
    try {
        const teamId = currentTeamId; // 使用全域變數
        const response = await window.AuthClient.fetch(`/api/teams/${teamId}/test-run-configs/${configId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                status: newStatus
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || '狀態變更失敗');
        }
        
        const updatedConfig = await response.json();
        
        // 顯示成功訊息 - 使用 fallback 參數確保有預設文字
        const successMsg = (window.i18n && window.i18n.isReady()) ? 
            window.i18n.t('testRun.statusChangedSuccess', {name: configName, status: getStatusText(newStatus)}, 
                         `Test Run "${configName}" 狀態已變更為 ${getStatusText(newStatus)}`) : 
            `Test Run "${configName}" 狀態已變更為 ${getStatusText(newStatus)}`;
        
        AppUtils.showSuccess(successMsg);
        
        // 重新載入 Test Run 列表
        await loadTestRunConfigs();
        
    } catch (error) {
        console.error('Change status error:', error);
        const errorMsg = (window.i18n && window.i18n.isReady()) ? 
            window.i18n.t('testRun.statusChangeFailed', {}, '狀態變更失敗：' + error.message) : 
            '狀態變更失敗：' + error.message;
        
        AppUtils.showError(errorMsg);
    }
}

function refreshStatusTexts() {
    // 僅做文案重翻譯，不重打 API，避免 teams/null 之類錯誤
    try {
        if (window.i18n && window.i18n.isReady && window.i18n.isReady()) {
            window.i18n.retranslate(document);
        }
    } catch (e) {
        console.warn('refreshStatusTexts: retranslate failed', e);
    }
    
    // 同步更新已開啟的詳情視窗中的狀態徽章文案
    const detailModal = document.getElementById('configDetailModal');
    if (detailModal && detailModal.classList.contains('show')) {
        const statusBadges = detailModal.querySelectorAll('.status-badge');
        statusBadges.forEach(badge => {
            const statusClass = badge.className.match(/status-(\w+)/);
            if (statusClass && statusClass[1]) {
                const status = statusClass[1];
                badge.textContent = getStatusText(status);
            }
        });
    }
}

function openConfigFormModal(configId = null) {
    const modalElement = document.getElementById('configFormModal');
    if (!configFormModalInstance) {
        configFormModalInstance = new bootstrap.Modal(modalElement);
    }

    const form = document.getElementById('testRunConfigForm');
    form.reset();
    document.getElementById('configId').value = '';

    const titleEl = document.getElementById('configFormModalTitle');
    const saveBtnTextEl = document.getElementById('saveConfigBtnText');

    if (configId) {
        // Edit mode
        const config = testRunConfigs.find(c => c.id === configId);
        if (config) {
            titleEl.setAttribute('data-i18n', 'testRun.editConfig');
            saveBtnTextEl.setAttribute('data-i18n', 'common.update');
            document.getElementById('configId').value = config.id;
            document.getElementById('configName').value = config.name;
            document.getElementById('configDescription').value = config.description || '';
            // 嘗試載入詳細配置以填入可選欄位和 TP 票號
            window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-configs/${configId}`)
              .then(r => r.ok ? r.json() : null)
              .then(full => {
                if (full) {
                  document.getElementById('testEnvironment').value = full.test_environment || '';
                  document.getElementById('buildNumber').value = full.build_number || '';
                  // 載入 TP 票號
                  const tpTickets = full.related_tp_tickets || [];
                  setTpTickets(tpTickets);
                  // 載入通知設定
                  loadNotificationSettings(full.notifications_enabled || false, full.notify_chat_ids || [], full.notify_chat_names_snapshot || []);
                }
              }).catch(() => {});
        }
    } else {
        // Create mode
        titleEl.setAttribute('data-i18n', 'testRun.createConfig');
        saveBtnTextEl.setAttribute('data-i18n', 'common.create');
        // 清空 TP 票號
        clearAllTpTickets();
    }
    
    // 初始化 TP 標籤輸入功能
    initTpTicketInput();
    
    // 初始化通知設定功能
    initNotificationSettings();
    
    // 監聽 Modal 關閉事件，清理 TP 標籤狀態和通知設定
    modalElement.addEventListener('hidden.bs.modal', function() {
        clearAllTpTickets();
        clearNotificationSettings();
    }, { once: true }); // 只監聽一次，避免重複綁定
    
    if (window.i18n) window.i18n.retranslate(modalElement);
    configFormModalInstance.show();
}

async function handleSaveConfig() {
    const form = document.getElementById('testRunConfigForm');
    
    // 執行綜合表單驗證
    const validationResult = validateTestRunConfigForm();
    if (!validationResult.isValid) {
        // 顯示第一個錯誤並聚焦到對應欄位
        showFormValidationError(validationResult);
        return;
    }
    
    // HTML5 基礎驗證
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const configId = document.getElementById('configId').value;
    const isEdit = !!configId;

    const configData = { name: document.getElementById('configName').value };
    const descVal = (document.getElementById('configDescription').value || '').trim();
    const envVal = (document.getElementById('testEnvironment').value || '').trim();
    const buildVal = (document.getElementById('buildNumber').value || '').trim();
    const tpTickets = getCurrentTpTickets(); // 獲取當前 TP 票號列表
    const notificationSettings = getCurrentNotificationSettings(); // 獲取當前通知設定
    
    if (descVal) configData.description = descVal;
    if (envVal) configData.test_environment = envVal;
    if (buildVal) configData.build_number = buildVal;
    configData.related_tp_tickets = tpTickets;  // 總是傳送，即使是空陣列
    // 加入通知設定
    configData.notifications_enabled = notificationSettings.enabled;
    if (notificationSettings.enabled && notificationSettings.chatIds.length > 0) {
        configData.notify_chat_ids = notificationSettings.chatIds;
        configData.notify_chat_names_snapshot = notificationSettings.chatNames;
    }

    const url = isEdit ? `/api/teams/${currentTeamId}/test-run-configs/${configId}` : `/api/teams/${currentTeamId}/test-run-configs/`;
    const method = isEdit ? 'PUT' : 'POST';

    const saveBtn = document.getElementById('saveConfigBtn');
    try {
        saveBtn.disabled = true;
        const response = await window.AuthClient.fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(configData)
        });

        if (!response.ok) {
            const errorData = await response.json();
            const fallbackMsg = window.i18n ? window.i18n.t('messages.saveFailed') : '儲存失敗';
            throw new Error(errorData.detail || fallbackMsg);
        }

        const data = await response.json();
        configFormModalInstance.hide();
        if (isEdit) {
          const msg = window.i18n ? window.i18n.t('testRun.updateSuccess') : '更新成功';
          AppUtils.showSuccess(msg);
          await loadTestRunConfigs();
        } else {
          const msg = window.i18n ? window.i18n.t('testRun.createConfigSuccessSelectCases') : '建立成功，請選擇要加入的 Test Case';
          AppUtils.showSuccess(msg);
          // 進入 Test Case 選擇流程（直接開啟，取消時自動回滾）
          pendingCreate = true;
          createdItemsInSession = false;
          // 確保為全新建立流程，清空任何編輯殘留選取狀態
          modalMode = 'create';
          selectedCaseMap.clear();
          existingItemIdByCaseNumber.clear();
          openCaseSelectModal(data.id);
        }

    } catch (error) {
        AppUtils.showError(error.message);
    } finally {
        saveBtn.disabled = false;
    }
}

function showConfigDetails(configId) {
    const config = testRunConfigs.find(c => c.id === configId);
    if (!config) return;

    const modalElement = document.getElementById('configDetailModal');
    if (!configDetailModalInstance) {
        configDetailModalInstance = new bootstrap.Modal(modalElement);
    }
    
    document.getElementById('configDetailTitle').textContent = config.name;
    document.getElementById('configDetailContent').innerHTML = createConfigDetailContent(config);
    
    // 手動觸發翻譯處理動態插入的內容
    if (window.i18n && window.i18n.isReady()) {
        const detailContent = document.getElementById('configDetailContent');
        window.i18n.retranslate(detailContent);
    }
    
    const deleteBtn = document.getElementById('deleteConfigBtn');
    deleteBtn.setAttribute('data-config-id', configId);
    deleteBtn.onclick = handleDeleteConfig;

    const editBtn = document.getElementById('editConfigBtn');
    editBtn.setAttribute('data-config-id', configId);
    editBtn.onclick = handleEditConfig;
    
    configDetailModalInstance.show();
}

function handleEditConfig(event) {
    const configId = parseInt(event.currentTarget.getAttribute('data-config-id'));
    if (configDetailModalInstance) {
        configDetailModalInstance.hide();
    }
    setTimeout(() => {
        openConfigFormModal(configId);
    }, 150);
}

async function handleDeleteConfig(event) {
    const configId = event.currentTarget.getAttribute('data-config-id');
    const config = testRunConfigs.find(c => c.id === parseInt(configId));
    if (!config) return;
    // Show custom modal
    const modal = document.getElementById('deleteConfigModal');
    const msgEl = document.getElementById('deleteConfirmMessage');
    msgEl.textContent = window.i18n ? window.i18n.t('testRun.confirmDelete', { name: escapeHtml(config.name) }) : `您確定要刪除 Test Run 配置 "${escapeHtml(config.name)}" 嗎？此操作無法復原。`;
    const inst = bootstrap.Modal.getOrCreateInstance(modal);
    // Rebind confirm handler
    const btnOld = document.getElementById('confirmDeleteConfigBtn');
    const btnNew = btnOld.cloneNode(true);
    btnOld.parentNode.replaceChild(btnNew, btnOld);
    document.getElementById('confirmDeleteConfigBtn').addEventListener('click', async () => {
        try {
            const resp = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-configs/${configId}`, { method: 'DELETE' });
            if (resp.ok || resp.status === 204) {
                if (configDetailModalInstance) configDetailModalInstance.hide();
                inst.hide();
                const successMsg = window.i18n ? window.i18n.t('testRun.deleteSuccess', { name: config.name }) : `成功刪除 "${config.name}"`;
                AppUtils.showSuccess(successMsg);
                await loadTestRunConfigs();
            } else {
                let detail = '';
                try {
                    const text = await resp.text();
                    try { detail = JSON.parse(text).detail || text; } catch { detail = text; }
                } catch { detail = ''; }
                const fallbackMsg = window.i18n ? window.i18n.t('messages.deleteFailed') : '刪除失敗';
                throw new Error(detail || fallbackMsg);
            }
        } catch (error) {
            console.error('Error deleting Test Run configuration:', error);
            const errorMsg = window.i18n ? window.i18n.t('messages.deleteFailed') : '刪除失敗';
            AppUtils.showError(`${errorMsg}: ${error.message}`);
        }
    });
    if (window.i18n && window.i18n.isReady()) window.i18n.retranslate(modal);
    inst.show();
}

function createConfigDetailContent(config) {
    return `
        <div class="row">
            <div class="col-md-6">
                <h6 data-i18n="testRun.configBasicInfo">基本資訊</h6>
                <table class="table table-sm">
                    <tr><td data-i18n="testRun.configNameLabel">名稱</td><td>${escapeHtml(config.name)}</td></tr>
                    <tr><td data-i18n="testRun.testEnvironment">測試環境</td><td>${escapeHtml(config.test_environment || '')}</td></tr>
                    <tr><td data-i18n="testRun.buildNumber">建置版本</td><td>${escapeHtml(config.build_number || '')}</td></tr>
                    <tr><td data-i18n="testRun.configStatusLabel">狀態</td><td><span class="status-badge ${getStatusClass(config.status)}">${getStatusText(config.status)}</span></td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6 data-i18n="testRun.configStatsInfo">統計資訊</h6>
                <table class="table table-sm">
                    <tr><td data-i18n="testRun.configTotalCasesLabel">總測試案例</td><td>${config.total_test_cases}</td></tr>
                    <tr><td data-i18n="testRun.configExecutedLabel">已執行</td><td>${config.executed_cases}</td></tr>
                    <tr><td data-i18n="testRun.configExecutionRateLabel">執行率</td><td>${config.execution_rate.toFixed(1)}%</td></tr>
                    <tr><td data-i18n="testRun.configPassRateLabel">Pass Rate</td><td>${config.pass_rate.toFixed(1)}%</td></tr>
                    <tr><td data-i18n="testRun.configCreatedLabel">建立時間</td><td>${AppUtils.formatDate(config.created_at, 'datetime-tz')}</td></tr>
                </table>
            </div>
        </div>
        ${config.description ? `
            <div class="mt-3">
                <h6 data-i18n="common.description">描述</h6>
                <p class="text-muted">${escapeHtml(config.description)}</p>
            </div>
        ` : ''}
    `;
}

function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

function updatePageTitle() {
    const pageTitle = window.i18n ? window.i18n.t('testRun.management') : '測試執行管理';
    const siteTitle = window.i18n ? window.i18n.t('navigation.title') : 'Test Case Repository';
    document.title = `${pageTitle} - ${siteTitle} Web Tool`;
}

// Test Run entry function
function enterTestRun(configId) {
    const config = testRunConfigs.find(c => c.id === configId);
    if (!config) {
        console.error('Test Run configuration not found:', configId);
        AppUtils.showError(window.i18n ? window.i18n.t('testRun.notFound') : '找不到測試執行配置');
        return;
    }
    
    // 導向 Test Run 執行頁面
    window.location.href = `/test-run-execution?config_id=${configId}`;
}

document.addEventListener('i18nReady', updatePageTitle);
document.addEventListener('languageChanged', updatePageTitle);

// ---- Test Case 選擇流程 ----
let caseSelectModalInstance = null;
let currentSelectingConfigId = null;
let availableCases = [];
let selectedCaseMap = new Map(); // key: test_case_number, value: case object
let pendingCreate = false; // true only for newly created config awaiting items
let createdItemsInSession = false; // set true when items are created
let modalMode = 'create'; // 'create' | 'edit'
let existingItemIdByCaseNumber = new Map(); // for edit mode: case_number -> item_id

// Removed confirmation step; open modal directly and rely on hidden handler for rollback
function openCaseSelectModalWithConfirm(configId) {
  pendingCreate = true;
  createdItemsInSession = false;
  modalMode = 'create';
  openCaseSelectModal(configId);
}

function openCaseSelectModal(configId) {
  currentSelectingConfigId = configId;
  const modalEl = document.getElementById('caseSelectModal');
  if (!caseSelectModalInstance) caseSelectModalInstance = new bootstrap.Modal(modalEl);
  // reset
  if (modalMode === 'create') {
    selectedCaseMap.clear();
    existingItemIdByCaseNumber.clear();
  }
  document.getElementById('selectedCount').textContent = '0';
  document.getElementById('caseListBody').innerHTML = '';
  document.getElementById('caseSearchInput').value = '';
  document.getElementById('caseSelectInfo').textContent = '';
  // set modal title and confirm button text/handler per mode
  const titleSpan = modalEl.querySelector('.modal-title [data-i18n]');
  if (titleSpan) {
    if (modalMode === 'edit') {
      titleSpan.setAttribute('data-i18n', 'testRun.caseSelect.editTitle');
      titleSpan.textContent = (window.i18n && window.i18n.isReady()) ? window.i18n.t('testRun.caseSelect.editTitle') : '新增／修改 Test Case';
    } else {
      titleSpan.setAttribute('data-i18n', 'testRun.caseSelect.title');
      titleSpan.textContent = (window.i18n && window.i18n.isReady()) ? window.i18n.t('testRun.caseSelect.title') : '選擇要加入的 Test Case';
    }
  }
  const confirmBtn = document.getElementById('confirmCreateItemsBtn');
  const confirmTextSpan = confirmBtn.querySelector('span');
  if (modalMode === 'edit') {
    confirmTextSpan.setAttribute('data-i18n', 'common.update');
    confirmTextSpan.textContent = (window.i18n && window.i18n.isReady()) ? window.i18n.t('common.update') : '更新';
  } else {
    confirmTextSpan.setAttribute('data-i18n', 'common.create');
    confirmTextSpan.textContent = (window.i18n && window.i18n.isReady()) ? window.i18n.t('common.create') : '建立';
  }
  const newBtn = confirmBtn.cloneNode(true);
  confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
  document.getElementById('confirmCreateItemsBtn').addEventListener('click', async () => {
    if (modalMode === 'edit') {
      await saveEditedItems();
    } else {
      await createItemsFromSelection();
    }
  });
  caseSelectModalInstance.show();
  // ensure we bind a one-time hide handler for rollback if pending
  const modalDom = document.getElementById('caseSelectModal');
  // Remove previous listener if any by cloning (simple way to avoid multiple bindings)
  modalDom.addEventListener('hidden.bs.modal', async function onHidden() {
    // This will be called whenever modal hides. If pending and no items created, rollback
    if (pendingCreate && !createdItemsInSession && currentSelectingConfigId) {
      try {
        await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentSelectingConfigId}`, { method: 'DELETE' });
        const warnMsg = window.i18n ? window.i18n.t('testRun.configDeletedDueToCancel') : '已取消選擇，設定已刪除';
        AppUtils.showInfo(warnMsg);
        await loadTestRunConfigs();
      } catch (e) {
        AppUtils.showError((window.i18n ? window.i18n.t('messages.deleteFailed') : '刪除失敗') + `: ${e.message}`);
      } finally {
        pendingCreate = false;
        createdItemsInSession = false;
        currentSelectingConfigId = null;
      }
    } else {
      // Clear flags when modal hides in any case
      pendingCreate = false;
      createdItemsInSession = false;
      currentSelectingConfigId = null;
    }
    // remove this handler after execution
    modalDom.removeEventListener('hidden.bs.modal', onHidden);
  }, { once: true });
  // load first page
  loadTeamTestCases('');
  if (window.i18n && window.i18n.isReady()) window.i18n.retranslate(document.getElementById('caseSelectModal'));
  // bind search/clear once per open
  bindCaseSearchBarEvents();
}

// 在卡片上提供「編輯基本設定」
function editBasicSettings(configId) {
  // 檢查 Test Run 狀態，已完成或已歸檔的不允許編輯
  const config = testRunConfigs.find(c => c.id === configId);
  if (config && (config.status === 'completed' || config.status === 'archived')) {
    const completedEditMsg = window.i18n && window.i18n.isReady() 
      ? window.i18n.t('testRun.cannotEditCompleted')
      : '已完成或已歸檔的 Test Run 不可編輯';
    AppUtils.showWarning(completedEditMsg);
    return;
  }
  openConfigFormModal(configId);
}

// 在卡片上提供「編輯 Test Case」
async function editTestCases(configId) {
  // 檢查 Test Run 狀態，已完成的不允許編輯
  const config = testRunConfigs.find(c => c.id === configId);
  if (config && config.status === 'completed') {
    const completedEditMsg = window.i18n && window.i18n.isReady() 
      ? window.i18n.t('testRun.cannotEditCompleted')
      : '已完成的 Test Run 不可編輯 Test Case';
    AppUtils.showWarning(completedEditMsg);
    return;
  }
  
  try {
    modalMode = 'edit';
    pendingCreate = false;
    createdItemsInSession = false;
    currentSelectingConfigId = configId;
    // 讀取現有 items，預設勾選
    const resp = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-configs/${configId}/items?limit=1000`);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const items = await resp.json();
    selectedCaseMap.clear();
    existingItemIdByCaseNumber.clear();
    for (const it of items) {
      existingItemIdByCaseNumber.set(it.test_case_number, it.id);
      selectedCaseMap.set(it.test_case_number, { test_case_number: it.test_case_number, title: it.title, priority: it.priority });
    }
    openCaseSelectModal(configId);
  } catch (e) {
    AppUtils.showError((window.i18n ? window.i18n.t('messages.loadFailed') : '載入失敗') + `: ${e.message}`);
  }
}

async function loadTeamTestCases(search) {
  try {
    console.log('Loading test cases for team ID:', currentTeamId);
    const url = new URL(`/api/teams/${currentTeamId}/testcases/`, window.location.origin);
    if (search) url.searchParams.set('search', search);
    url.searchParams.set('limit', '200');
    console.log('API URL:', url.toString());
    
    const resp = await window.AuthClient.fetch(url);
    console.log('API Response Status:', resp.status);
    
    if (!resp.ok) {
      const errorText = await resp.text();
      console.log('API Error Response:', errorText);
      throw new Error(`HTTP ${resp.status}: ${errorText}`);
    }
    
    availableCases = await resp.json();
    console.log('Loaded test cases:', availableCases.length);
    // 若為編輯模式：用完整資料覆蓋已選取的項目（確保存檔可帶出完整欄位）
    if (modalMode === 'edit') {
      for (const c of availableCases) {
        if (selectedCaseMap.has(c.test_case_number)) {
          selectedCaseMap.set(c.test_case_number, c);
        }
      }
    }
    renderCaseList();
  } catch (e) {
    console.error('Load test cases error:', e);
    AppUtils.showError((window.i18n ? window.i18n.t('messages.loadFailed') : '載入失敗') + `: ${e.message}`);
  }
}

function renderCaseList() {
  const tbody = document.getElementById('caseListBody');
  const rows = availableCases.map(c => {
    const num = escapeHtml(c.test_case_number || '');
    const ttl = escapeHtml(c.title || '');
    const pri = escapeHtml(c.priority || '');
    const attCount = (c.attachments || []).length || 0;
    const checked = selectedCaseMap.has(c.test_case_number) ? 'checked' : '';
    return `
      <tr>
        <td><input type="checkbox" class="case-check" data-num="${num}" ${checked}></td>
        <td><code>${num}</code></td>
        <td>${ttl}</td>
        <td>${pri}</td>
        <td>${attCount}</td>
      </tr>`;
  }).join('');
  tbody.innerHTML = rows;
  wireCaseCheckHandlers();
  updateSelectedCount();
  if (window.i18n && window.i18n.isReady()) window.i18n.retranslate(document.getElementById('caseSelectModal'));
}

function wireCaseCheckHandlers() {
  document.querySelectorAll('.case-check').forEach(el => {
    el.addEventListener('change', (e) => {
      const num = e.target.getAttribute('data-num');
      if (e.target.checked) {
        const c = availableCases.find(x => x.test_case_number === num);
        if (c) selectedCaseMap.set(num, c);
      } else {
        selectedCaseMap.delete(num);
      }
      updateSelectedCount();
    });
  });
  const selectAll = document.getElementById('selectAllCases');
  selectAll.checked = false;
  selectAll.addEventListener('change', (e) => {
    if (e.target.checked) {
      availableCases.forEach(c => selectedCaseMap.set(c.test_case_number, c));
      document.querySelectorAll('.case-check').forEach(ch => ch.checked = true);
    } else {
      selectedCaseMap.clear();
      document.querySelectorAll('.case-check').forEach(ch => ch.checked = false);
    }
    updateSelectedCount();
  });
  // search handlers moved to bindCaseSearchBarEvents()
}

function bindCaseSearchBarEvents() {
  const searchBtn = document.getElementById('caseSearchBtn');
  const clearBtn = document.getElementById('caseClearBtn');
  const inputEl = document.getElementById('caseSearchInput');
  if (searchBtn) {
    searchBtn.onclick = () => {
      loadTeamTestCases(inputEl.value.trim());
    };
  }
  if (clearBtn) {
    clearBtn.onclick = () => {
      inputEl.value = '';
      clearBtn.classList.add('d-none');
      loadTeamTestCases('');
      inputEl.focus();
    };
  }
  if (inputEl) {
    inputEl.onkeydown = (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        loadTeamTestCases(inputEl.value.trim());
      }
    };
    // toggle clear button visibility on input
    inputEl.addEventListener('input', () => {
      if (clearBtn) {
        if (inputEl.value && inputEl.value.length > 0) {
          clearBtn.classList.remove('d-none');
        } else {
          clearBtn.classList.add('d-none');
        }
      }
    });
    // initialize visibility
    if (clearBtn) {
      if (inputEl.value && inputEl.value.length > 0) clearBtn.classList.remove('d-none');
      else clearBtn.classList.add('d-none');
    }
  }
}

function updateSelectedCount() {
  const count = selectedCaseMap.size;
  const selectedEl = document.getElementById('selectedCount');
  selectedEl.textContent = String(count);
  const info = document.getElementById('caseSelectInfo');
  if (window.i18n && count > 0) {
    info.textContent = window.i18n.t('testRun.caseSelect.selectedInfo', { count });
  } else {
    info.textContent = '';
  }
}

// 預設綁定為建立；開啟 modal 時會依模式改寫處理器
document.getElementById('confirmCreateItemsBtn').addEventListener('click', createItemsFromSelection);

async function createItemsFromSelection() {
  if (!currentSelectingConfigId) return;
  if (selectedCaseMap.size === 0) {
    const warn = window.i18n ? window.i18n.t('errors.pleaseSelectTestCases') : '請先選擇至少一筆 Test Case';
    AppUtils.showWarning ? AppUtils.showWarning(warn) : alert(warn);
    return;
  }
  const items = Array.from(selectedCaseMap.values()).map(c => ({
    test_case_number: c.test_case_number,
    title: c.title,
    priority: c.priority || 'Medium',
    precondition: c.precondition || null,
    steps: c.steps || null,
    expected_result: c.expected_result || null,
    assignee: c.assignee ? { id: c.assignee.id, name: c.assignee.name, en_name: c.assignee.en_name, email: c.assignee.email } : null,
    attachments: (c.attachments || []).map(a => ({ file_token: a.file_token, name: a.name, size: a.size, type: a.type })),
    user_story_map: c.user_story_map || [],
    tcg: c.tcg || [],
    parent_record: c.parent_record || [],
    raw_fields: c.raw_fields || null,
  }));

  try {
    const url = `/api/teams/${currentTeamId}/test-run-configs/${currentSelectingConfigId}/items`;
    const resp = await window.AuthClient.fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ items }) });
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const res = await resp.json();
    createdItemsInSession = true;
    pendingCreate = false;
    caseSelectModalInstance.hide();
    const msg = window.i18n ? window.i18n.t('testRun.itemsCreated', { count: res.created_count || items.length }) : `建立成功 (${res.created_count || items.length} 筆)`;
    AppUtils.showSuccess(msg);
    // 同步統計後刷新管理頁
    try { await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentSelectingConfigId}/sync`); } catch(e) {}
    await loadTestRunConfigs();
  } catch (e) {
    AppUtils.showError((window.i18n ? window.i18n.t('messages.saveFailed') : '建立失敗') + `: ${e.message}`);
  }
}

// 儲存「編輯 Test Case」的差異：新增選入、刪除取消勾選
async function saveEditedItems() {
  if (!currentSelectingConfigId) return;
  // 計算差異
  const selectedNumbers = new Set(Array.from(selectedCaseMap.keys()));
  const existingNumbers = new Set(Array.from(existingItemIdByCaseNumber.keys()));
  const toAdd = Array.from(selectedNumbers).filter(n => !existingNumbers.has(n));
  const toRemove = Array.from(existingNumbers).filter(n => !selectedNumbers.has(n));

  try {
    // 先新增
    if (toAdd.length > 0) {
      const items = toAdd.map(n => selectedCaseMap.get(n)).map(c => ({
        test_case_number: c.test_case_number,
        title: c.title,
        priority: c.priority || 'Medium',
        precondition: c.precondition || null,
        steps: c.steps || null,
        expected_result: c.expected_result || null,
        assignee: c.assignee ? { id: c.assignee.id, name: c.assignee.name, en_name: c.assignee.en_name, email: c.assignee.email } : null,
        attachments: (c.attachments || []).map(a => ({ file_token: a.file_token, name: a.name, size: a.size, type: a.type })),
        user_story_map: c.user_story_map || [],
        tcg: c.tcg || [],
        parent_record: c.parent_record || [],
        raw_fields: c.raw_fields || null,
      }));
      const url = `/api/teams/${currentTeamId}/test-run-configs/${currentSelectingConfigId}/items`;
      const resp = await window.AuthClient.fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ items }) });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      await resp.json();
    }
    // 再刪除（包含執行歷程刪除由後端處理）
    for (const n of toRemove) {
      const itemId = existingItemIdByCaseNumber.get(n);
      if (!itemId) continue;
      const url = `/api/teams/${currentTeamId}/test-run-configs/${currentSelectingConfigId}/items/${itemId}`;
      const resp = await window.AuthClient.fetch(url, { method: 'DELETE' });
      if (!resp.ok && resp.status !== 204) {
        // 若已不存在則忽略
        console.warn('Failed to delete item', itemId, 'status', resp.status);
      }
    }
    // 完成
    caseSelectModalInstance.hide();
    const msg = window.i18n ? window.i18n.t('testRun.itemsUpdated') : '已更新 Test Run 的 Test Case';
    AppUtils.showSuccess(msg);
    try { await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentSelectingConfigId}/sync`); } catch(e) {}
    await loadTestRunConfigs();
  } catch (e) {
    AppUtils.showError((window.i18n ? window.i18n.t('messages.saveFailed') : '儲存失敗') + `: ${e.message}`);
  }
}

// 卡片上的刪除按鈕（不進入詳情也可刪除）
function deleteTestRun(configId, name) {
  const modal = document.getElementById('deleteConfigModal');
  const msgEl = document.getElementById('deleteConfirmMessage');
  const safeName = escapeHtml(name || '');
  msgEl.textContent = window.i18n ? window.i18n.t('testRun.confirmDelete', { name: safeName }) : `您確定要刪除 Test Run 配置 "${safeName}" 嗎？此操作無法復原。`;
  const inst = bootstrap.Modal.getOrCreateInstance(modal);
  // Rebind confirm handler
  const btnOld = document.getElementById('confirmDeleteConfigBtn');
  const btnNew = btnOld.cloneNode(true);
  btnOld.parentNode.replaceChild(btnNew, btnOld);
  document.getElementById('confirmDeleteConfigBtn').addEventListener('click', async () => {
    try {
      const resp = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-configs/${configId}`, { method: 'DELETE' });
      if (resp.ok || resp.status === 204) {
        inst.hide();
        const successMsg = window.i18n ? window.i18n.t('testRun.deleteSuccess', { name: safeName }) : `成功刪除 "${safeName}"`;
        AppUtils.showSuccess(successMsg);
        await loadTestRunConfigs();
      } else {
        let detail = '';
        try {
          const text = await resp.text();
          try { detail = JSON.parse(text).detail || text; } catch { detail = text; }
        } catch { detail = ''; }
        const fallbackMsg = window.i18n ? window.i18n.t('messages.deleteFailed') : '刪除失敗';
        throw new Error(detail || fallbackMsg);
      }
    } catch (error) {
      const errorMsg = window.i18n ? window.i18n.t('messages.deleteFailed') : '刪除失敗';
      AppUtils.showError(`${errorMsg}: ${error.message}`);
    }
  });
  if (window.i18n && window.i18n.isReady()) window.i18n.retranslate(modal);
  inst.show();
}

// ===== TP 標籤管理功能 =====

// 存儲當前的 TP 票號列表
let currentTpTickets = [];

// TP 票號格式驗證函數
function validateTpTicketFormat(ticketNumber) {
    // TP 票號格式：TP-XXXXX（TP- 後接 1-10 位數字或字母）
    const tpTicketPattern = /^TP-[A-Z0-9]{1,10}$/i;
    return tpTicketPattern.test(ticketNumber.trim());
}

// 檢查重複票號
function isDuplicateTicket(ticketNumber) {
    return currentTpTickets.includes(ticketNumber.trim().toUpperCase());
}

// 新增 TP 票號標籤
function addTpTicket(ticketNumber) {
    const trimmedTicket = ticketNumber.trim().toUpperCase();
    
    // 驗證格式
    if (!validateTpTicketFormat(trimmedTicket)) {
        showTpInputError('TP 票號格式無效，請使用格式：TP-XXXXX');
        return false;
    }
    
    // 檢查重複
    if (isDuplicateTicket(trimmedTicket)) {
        showTpInputError('此 TP 票號已存在');
        return false;
    }
    
    // 添加到列表
    currentTpTickets.push(trimmedTicket);
    
    // 更新顯示
    renderTpTags();
    
    // 清空輸入欄位
    const inputElement = document.getElementById('relatedTpTicketsInput');
    if (inputElement) {
        inputElement.value = '';
        clearTpInputError();
    }
    
    return true;
}

// 移除 TP 票號標籤
function removeTpTicket(ticketNumber) {
    const index = currentTpTickets.indexOf(ticketNumber);
    if (index > -1) {
        currentTpTickets.splice(index, 1);
        renderTpTags();
    }
}

// 渲染 TP 標籤列表
function renderTpTags() {
    const tagsContainer = document.getElementById('tpTicketTags');
    const displayContainer = document.getElementById('tpTicketsDisplay');
    
    if (!tagsContainer || !displayContainer) return;
    
    // 如果沒有標籤，隱藏顯示區域
    if (currentTpTickets.length === 0) {
        displayContainer.style.display = 'none';
        tagsContainer.innerHTML = '';
        return;
    }
    
    // 顯示標籤區域
    displayContainer.style.display = 'block';
    
    // 生成標籤 HTML
    const tagsHtml = currentTpTickets.map(ticket => `
        <div class="tp-ticket-tag" data-ticket="${ticket}">
            <i class="fas fa-ticket-alt me-1"></i>
            <span>${ticket}</span>
            <button type="button" class="remove-btn" 
                    onclick="removeTpTicket('${ticket}')"
                    title="移除此票號"
                    aria-label="移除 ${ticket}">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `).join('');
    
    tagsContainer.innerHTML = tagsHtml;
    
    // 為所有 TP 標籤添加 hover 事件監聽器
    const ticketTags = tagsContainer.querySelectorAll('.tp-ticket-tag');
    ticketTags.forEach(tag => {
        const ticketNumber = tag.getAttribute('data-ticket');
        // 添加 hover 事件
        tag.addEventListener('mouseenter', (e) => showJiraPreview(e, ticketNumber));
        tag.addEventListener('mouseleave', hideJiraPreview);
        // 添加點擊跳轉事件
        tag.addEventListener('click', (e) => {
            // 如果點擊的是刪除按鈕，不執行跳轉
            if (e.target.closest('.remove-btn')) return;
            openJiraTicket(ticketNumber);
        });
    });
}

// 顯示輸入錯誤提示
function showTpInputError(message) {
    const inputElement = document.getElementById('relatedTpTicketsInput');
    if (!inputElement) return;
    
    // 移除現有的錯誤樣式
    clearTpInputError();
    
    // 添加錯誤樣式
    inputElement.classList.add('is-invalid');
    
    // 創建或更新錯誤訊息元素
    let errorElement = document.getElementById('tpTicketInputError');
    if (!errorElement) {
        errorElement = document.createElement('div');
        errorElement.id = 'tpTicketInputError';
        errorElement.className = 'invalid-feedback d-block';
        inputElement.parentNode.appendChild(errorElement);
    }
    
    errorElement.textContent = message;
    
    // 3秒後自動清除錯誤
    setTimeout(clearTpInputError, 3000);
}

// 清除輸入錯誤提示
function clearTpInputError() {
    const inputElement = document.getElementById('relatedTpTicketsInput');
    const errorElement = document.getElementById('tpTicketInputError');
    
    if (inputElement) {
        inputElement.classList.remove('is-invalid');
    }
    
    if (errorElement) {
        errorElement.remove();
    }
}

// 初始化 TP 標籤輸入功能
function initTpTicketInput() {
    const inputElement = document.getElementById('relatedTpTicketsInput');
    if (!inputElement) return;
    
    // Enter 鍵監聽
    inputElement.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const value = this.value.trim();
            if (value) {
                addTpTicket(value);
            }
        }
    });
    
    // 失去焦點時也可以添加標籤（可選）
    inputElement.addEventListener('blur', function() {
        const value = this.value.trim();
        if (value && validateTpTicketFormat(value) && !isDuplicateTicket(value)) {
            addTpTicket(value);
        }
    });
    
    // 清除錯誤樣式當用戶開始輸入
    inputElement.addEventListener('input', function() {
        if (this.classList.contains('is-invalid')) {
            clearTpInputError();
        }
    });
}

// 獲取當前 TP 票號列表（用於表單提交）
function getCurrentTpTickets() {
    return [...currentTpTickets]; // 返回副本避免意外修改
}

// 設置 TP 票號列表（用於編輯模式）
function setTpTickets(tickets) {
    currentTpTickets = Array.isArray(tickets) ? [...tickets] : [];
    renderTpTags();
}

// 清空所有 TP 票號
function clearAllTpTickets() {
    currentTpTickets = [];
    renderTpTags();
    clearTpInputError();
}

// === TP 票號 JIRA 預覽功能 ===

// JIRA 票號資料快取
const jiraDataCache = new Map();

// 創建或獲取 tooltip 元素
function getOrCreateJiraTooltip() {
    let tooltip = document.getElementById('jira-preview-tooltip');
    if (!tooltip) {
        tooltip = document.createElement('div');
        tooltip.id = 'jira-preview-tooltip';
        tooltip.className = 'jira-preview-tooltip';
        
        // 添加鼠標事件，讓用戶可以移動到 tooltip 上而不會消失
        tooltip.addEventListener('mouseenter', cancelHideTooltip);
        tooltip.addEventListener('mouseleave', hideJiraPreview);
        
        document.body.appendChild(tooltip);
    }
    return tooltip;
}

// 顯示 JIRA 預覽
async function showJiraPreview(event, ticketNumber) {
    const tooltip = getOrCreateJiraTooltip();
    const targetElement = event.currentTarget;
    
    // 設定 tooltip 位置（現在 positionTooltip 能正確處理隱藏元素）
    positionTooltip(tooltip, targetElement);
    
    // 顯示載入中狀態
    tooltip.innerHTML = `
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin me-2"></i>
            載入中...
        </div>
    `;
    tooltip.classList.add('show');
    
    try {
        // 檢查快取
        if (jiraDataCache.has(ticketNumber)) {
            const cachedData = jiraDataCache.get(ticketNumber);
            displayJiraData(tooltip, ticketNumber, cachedData);
            return;
        }
        
        // 呼叫 JIRA API
        const response = await window.AuthClient.fetch(`/api/jira/tp/${ticketNumber}/details`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        // 快取資料（5分鐘）
        jiraDataCache.set(ticketNumber, data);
        setTimeout(() => jiraDataCache.delete(ticketNumber), 5 * 60 * 1000);
        
        // 顯示資料
        displayJiraData(tooltip, ticketNumber, data);
        
    } catch (error) {
        console.error('載入 JIRA 資料失敗:', error);
        tooltip.innerHTML = `
            <div class="error-message">
                <i class="fas fa-exclamation-triangle me-2"></i>
                載入失敗，請稍後再試
            </div>
        `;
    }
}

// 隱藏 JIRA 預覽（延遲機制避免誤觸發）
let hideTooltipTimer = null;

function hideJiraPreview() {
    // 設定延遲隱藏，讓用戶有時間移動到 tooltip 上
    hideTooltipTimer = setTimeout(() => {
        const tooltip = document.getElementById('jira-preview-tooltip');
        if (tooltip) {
            tooltip.classList.remove('show');
        }
    }, 150); // 150ms 延遲
}

// 取消隱藏 tooltip（用戶移動到 tooltip 上時）
function cancelHideTooltip() {
    if (hideTooltipTimer) {
        clearTimeout(hideTooltipTimer);
        hideTooltipTimer = null;
    }
}

// 顯示 JIRA 資料
function displayJiraData(tooltip, ticketNumber, data) {
    // 安全地獲取狀態文字 - status 可能是物件或字串
    let statusText = 'unknown';
    if (data.status) {
        if (typeof data.status === 'object' && data.status.name) {
            statusText = data.status.name;
        } else if (typeof data.status === 'string') {
            statusText = data.status;
        }
    }
    
    const statusClass = getStatusClass(statusText);
    
    // 安全地獲取負責人資訊 - assignee 也可能是物件
    let assigneeDisplay = '未指派';
    if (data.assignee) {
        if (typeof data.assignee === 'object') {
            assigneeDisplay = data.assignee.display_name || data.assignee.displayName || '未指派';
        } else if (typeof data.assignee === 'string') {
            assigneeDisplay = data.assignee;
        }
    }
    
    tooltip.innerHTML = `
        <div class="tcg-tooltip-header">
            <div class="tcg-ticket-info">
                <span class="tcg-ticket-number">${ticketNumber}</span>
                <span class="tcg-ticket-status ${statusClass}">${statusText || 'Unknown'}</span>
            </div>
        </div>
        
        <div class="tcg-ticket-content">
            <div class="tcg-ticket-title">${data.summary || '無標題'}</div>
            
            <div class="tcg-ticket-meta">
                <div class="tcg-assignee">
                    <span class="tcg-label">負責人:</span>
                    <span class="tcg-value">${assigneeDisplay}</span>
                </div>
                ${data.priority ? `
                <div class="tcg-priority">
                    <span class="tcg-label">優先級:</span>
                    <span class="tcg-value">${typeof data.priority === 'object' ? (data.priority.name || '未設定') : data.priority}</span>
                </div>
                ` : ''}
            </div>
        </div>
        
        <div class="tcg-tooltip-footer">
            <a href="${data.url || '#'}" target="_blank" class="tcg-jira-link">
                <i class="fas fa-external-link-alt me-1"></i>
                在 JIRA 中檢視
            </a>
        </div>
    `;
}


// 定位 tooltip
function positionTooltip(tooltip, targetElement) {
    const targetRect = targetElement.getBoundingClientRect();
    
    // 臨時顯示 tooltip 以獲得正確尺寸
    const wasVisible = tooltip.classList.contains('show');
    if (!wasVisible) {
        tooltip.style.visibility = 'hidden';
        tooltip.style.opacity = '1';
        tooltip.classList.add('show');
    }
    
    const tooltipRect = tooltip.getBoundingClientRect();
    const windowWidth = window.innerWidth;
    const windowHeight = window.innerHeight;
    
    // 如果之前是隱藏的，恢復隱藏狀態
    if (!wasVisible) {
        tooltip.classList.remove('show');
        tooltip.style.visibility = '';
        tooltip.style.opacity = '';
    }
    
    // 預設放在目標元素下方
    let left = targetRect.left + (targetRect.width / 2) - (tooltipRect.width / 2);
    let top = targetRect.bottom + 8;
    
    // 調整水平位置避免超出視窗
    if (left < 8) {
        left = 8;
    } else if (left + tooltipRect.width > windowWidth - 8) {
        left = windowWidth - tooltipRect.width - 8;
    }
    
    // 調整垂直位置避免超出視窗
    if (top + tooltipRect.height > windowHeight - 8) {
        top = targetRect.top - tooltipRect.height - 8;
    }
    
    tooltip.style.left = `${left}px`;
    tooltip.style.top = `${top}px`;
}

// 開啟 JIRA 票號
function openJiraTicket(ticketNumber) {
    // 嘗試從快取獲取 URL，否則使用預設格式
    const cachedData = jiraDataCache.get(ticketNumber);
    if (cachedData && cachedData.url) {
        window.open(cachedData.url, '_blank');
        return;
    }
    
    // 使用 API 獲取正確的 JIRA URL
    window.AuthClient.fetch(`/api/jira/tp/${ticketNumber}/details`)
        .then(response => response.json())
        .then(data => {
            if (data.url) {
                window.open(data.url, '_blank');
            } else {
                console.error('無法獲取 JIRA URL');
            }
        })
        .catch(error => {
            console.error('開啟 JIRA 票號失敗:', error);
        });
}

// === T022 JIRA 整合工具函數 ===

// 獲取 TP 票號詳情
async function fetchTPDetails(ticketNumber) {
    try {
        // 檢查快取
        if (jiraDataCache.has(ticketNumber)) {
            return jiraDataCache.get(ticketNumber);
        }
        
        // 呼叫 JIRA API
        const response = await window.AuthClient.fetch(`/api/jira/tp/${ticketNumber}/details`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        // 快取資料（5分鐘）
        jiraDataCache.set(ticketNumber, data);
        setTimeout(() => jiraDataCache.delete(ticketNumber), 5 * 60 * 1000);
        
        return data;
        
    } catch (error) {
        console.error('獲取 JIRA 資料失敗:', error);
        throw error;
    }
}

// 顯示 TP 票號預覽（T022 兼容介面）
async function showTPPreview(element, ticketNumber) {
    // 創建兼容的 event 物件
    const fakeEvent = {
        currentTarget: element
    };
    
    // 使用現有的 showJiraPreview 函數
    return showJiraPreview(fakeEvent, ticketNumber);
}

// 開啟 JIRA 連結（T022 別名函數）
function openJiraLink(ticketNumber) {
    return openJiraTicket(ticketNumber);
}

// === Modal 表單驗證系統 ===

// 綜合表單驗證函數
function validateTestRunConfigForm() {
    const errors = [];
    
    // 1. 必填欄位驗證
    const configName = document.getElementById('configName').value.trim();
    if (!configName) {
        errors.push({
            field: 'configName',
            message: '測試執行配置名稱為必填欄位',
            type: 'required'
        });
    } else if (configName.length < 2) {
        errors.push({
            field: 'configName',
            message: '配置名稱至少需要2個字元',
            type: 'minLength'
        });
    } else if (configName.length > 100) {
        errors.push({
            field: 'configName',
            message: '配置名稱不能超過100個字元',
            type: 'maxLength'
        });
    }
    
    // 2. TP 票號綜合驗證
    const tpTickets = getCurrentTpTickets();
    const tpValidationResult = validateAllTpTickets(tpTickets);
    if (!tpValidationResult.isValid) {
        errors.push(...tpValidationResult.errors);
    }
    
    // 3. 可選欄位格式驗證
    const description = document.getElementById('configDescription').value.trim();
    if (description && description.length > 1000) {
        errors.push({
            field: 'configDescription',
            message: '描述不能超過1000個字元',
            type: 'maxLength'
        });
    }
    
    const testEnvironment = document.getElementById('testEnvironment').value.trim();
    if (testEnvironment && testEnvironment.length > 100) {
        errors.push({
            field: 'testEnvironment',
            message: '測試環境名稱不能超過100個字元',
            type: 'maxLength'
        });
    }
    
    const buildNumber = document.getElementById('buildNumber').value.trim();
    if (buildNumber && buildNumber.length > 100) {
        errors.push({
            field: 'buildNumber',
            message: '建置版本號不能超過100個字元',
            type: 'maxLength'
        });
    }
    
    return {
        isValid: errors.length === 0,
        errors: errors
    };
}

// 驗證所有 TP 票號
function validateAllTpTickets(tpTickets) {
    const errors = [];
    
    if (tpTickets.length > 100) {
        errors.push({
            field: 'tpTickets',
            message: 'TP 票號數量不能超過100個',
            type: 'maxCount'
        });
    }
    
    // 驗證每個票號格式
    const invalidTickets = [];
    const duplicateTickets = [];
    const ticketCounts = {};
    
    tpTickets.forEach(ticket => {
        // 格式驗證
        if (!validateTpTicketFormat(ticket)) {
            invalidTickets.push(ticket);
        }
        
        // 重複檢查
        if (ticketCounts[ticket]) {
            duplicateTickets.push(ticket);
        } else {
            ticketCounts[ticket] = 1;
        }
    });
    
    if (invalidTickets.length > 0) {
        errors.push({
            field: 'tpTickets',
            message: `以下 TP 票號格式無效：${invalidTickets.join(', ')}`,
            type: 'invalidFormat',
            details: invalidTickets
        });
    }
    
    if (duplicateTickets.length > 0) {
        errors.push({
            field: 'tpTickets',
            message: `發現重複的 TP 票號：${duplicateTickets.join(', ')}`,
            type: 'duplicate',
            details: duplicateTickets
        });
    }
    
    return {
        isValid: errors.length === 0,
        errors: errors
    };
}

// 顯示表單驗證錯誤
function showFormValidationError(validationResult) {
    if (validationResult.errors.length === 0) return;
    
    const firstError = validationResult.errors[0];
    
    // 清除所有現有的錯誤樣式
    clearAllFormErrors();
    
    // 根據錯誤類型處理
    if (firstError.field === 'tpTickets') {
        // TP 票號相關錯誤
        showTpInputError(firstError.message);
        const tpInput = document.getElementById('relatedTpTicketsInput');
        if (tpInput) tpInput.focus();
    } else {
        // 其他欄位錯誤
        const fieldElement = document.getElementById(firstError.field);
        if (fieldElement) {
            fieldElement.classList.add('is-invalid');
            fieldElement.focus();
            
            // 創建或更新錯誤訊息
            let errorElement = document.getElementById(`${firstError.field}Error`);
            if (!errorElement) {
                errorElement = document.createElement('div');
                errorElement.id = `${firstError.field}Error`;
                errorElement.className = 'invalid-feedback d-block';
                fieldElement.parentNode.appendChild(errorElement);
            }
            errorElement.textContent = firstError.message;
            
            // 自動清除錯誤（當用戶開始輸入時）
            const clearErrorHandler = () => {
                fieldElement.classList.remove('is-invalid');
                if (errorElement) errorElement.remove();
                fieldElement.removeEventListener('input', clearErrorHandler);
            };
            fieldElement.addEventListener('input', clearErrorHandler);
        }
    }
    
    // 顯示綜合錯誤訊息（如果有多個錯誤）
    if (validationResult.errors.length > 1) {
        const remainingErrors = validationResult.errors.length - 1;
        setTimeout(() => {
            const message = `發現 ${validationResult.errors.length} 個驗證錯誤，請檢查表單內容`;
            showNotification(message, 'warning');
        }, 100);
    }
}

// 清除所有表單錯誤樣式
function clearAllFormErrors() {
    // 清除一般欄位錯誤
    const errorFields = ['configName', 'configDescription', 'testEnvironment', 'buildNumber'];
    errorFields.forEach(fieldId => {
        const fieldElement = document.getElementById(fieldId);
        const errorElement = document.getElementById(`${fieldId}Error`);
        
        if (fieldElement) {
            fieldElement.classList.remove('is-invalid');
        }
        if (errorElement) {
            errorElement.remove();
        }
    });
    
    // 清除 TP 票號錯誤
    clearTpInputError();
}

// 顯示通知訊息
function showNotification(message, type = 'info') {
    // 簡單的通知實現，可以後續改進
    console.log(`[${type.toUpperCase()}] ${message}`);
    
    // 如果有現有的通知系統，可以在這裡整合
    // 目前使用 console.log 作為後備方案
}

// ===== 快速搜尋 TP 票號功能 (T024 + T027 快取優化) =====

// T027: 搜尋結果快取機制
class TPSearchCache {
    constructor(ttl = 5 * 60 * 1000) { // 5分鐘 TTL
        this.cache = new Map();
        this.ttl = ttl;
    }
    
    // 生成快取鍵
    generateKey(query, teamId, limit) {
        return `${query.toLowerCase()}_${teamId}_${limit}`;
    }
    
    // 獲取快取結果
    get(query, teamId, limit) {
        const key = this.generateKey(query, teamId, limit);
        const item = this.cache.get(key);
        
        if (!item) return null;
        
        // 檢查是否過期
        if (Date.now() - item.timestamp > this.ttl) {
            this.cache.delete(key);
            return null;
        }
        
        return item.data;
    }
    
    // 設定快取
    set(query, teamId, limit, data) {
        const key = this.generateKey(query, teamId, limit);
        this.cache.set(key, {
            data: data,
            timestamp: Date.now()
        });
        
        // 限制快取大小 (最多100個項目)
        if (this.cache.size > 100) {
            const firstKey = this.cache.keys().next().value;
            this.cache.delete(firstKey);
        }
    }
    
    // 清除過期快取
    cleanup() {
        const now = Date.now();
        for (const [key, item] of this.cache.entries()) {
            if (now - item.timestamp > this.ttl) {
                this.cache.delete(key);
            }
        }
    }
    
    // 清除所有快取
    clear() {
        this.cache.clear();
    }
}

// 全域搜尋快取實例
const tpSearchCache = new TPSearchCache();

// 定期清理過期快取
setInterval(() => tpSearchCache.cleanup(), 60000); // 每分鐘清理一次

// T028: 執行狀態處理函數 (與現有 UI 風格一致)
function getSearchResultStatusInfo(status, executionRate, passRate) {
    // 使用與主卡片相同的狀態樣式
    const statusClass = getStatusClass(status);
    const statusText = getStatusText(status);
    
    return {
        statusClass: statusClass,
        statusText: statusText,
        showProgress: status === 'active'
    };
}

function setupQuickSearch_TPTicket() {
    if (!document.getElementById('quickSearchTPOverlay')) {
        const overlay = document.createElement('div');
        overlay.id = 'quickSearchTPOverlay';
        overlay.style.cssText = 'position:fixed;inset:0;z-index:1060;display:none;background:rgba(0,0,0,0.35)';
        overlay.innerHTML = `
          <div class="position-fixed" style="top:34vh; left:50%; transform: translateX(-50%); width:min(800px, 95vw);"
            <div class="card shadow">
              <div class="card-body p-3">
                <input id="quickSearchTPInput" type="text" class="form-control form-control-lg" placeholder="${window.i18n ? window.i18n.t('tp.searchPlaceholder') : '搜尋 TP 票號...'}" autocomplete="off" />
                <div id="quickSearchTPResults" class="list-group list-group-flush" style="max-height:30vh; overflow-y:auto; overflow-x:hidden; padding: 0 4px;"></div>
              </div>
            </div>
          </div>`;
        document.body.appendChild(overlay);
        
        try {
            const applyPlaceholder = () => {
                const input = overlay.querySelector('#quickSearchTPInput');
                if (!input) return;
                if (window.i18n && window.i18n.isReady && window.i18n.isReady()) {
                    let text = window.i18n.t('tp.searchPlaceholder');
                    if (!text || text === 'tp.searchPlaceholder') {
                        text = '搜尋 TP 票號...';
                    }
                    input.placeholder = text;
                } else {
                    input.placeholder = '搜尋 TP 票號...';
                }
            };
            
            // 立即嘗試設置
            applyPlaceholder();
            
            // 語言切換時更新
            document.addEventListener('languageChanged', applyPlaceholder);
            
            // 如果翻譯系統還未準備好，監聽 i18nReady 事件
            if (!window.i18n || !window.i18n.isReady || !window.i18n.isReady()) {
                document.addEventListener('i18nReady', applyPlaceholder);
            }
        } catch (_) {}
        
        overlay.addEventListener('click', (e) => { 
            if(e.target === overlay) closeQuickSearchTP(); 
        });
    }

    // 鍵盤事件監聽器 - "/" 鍵觸發搜尋
    document.addEventListener('keydown', function(e) {
        const tag = (e.target && e.target.tagName || '').toLowerCase();
        const isTyping = ['input','textarea','select'].includes(tag) || (e.target && e.target.isContentEditable);
        if (!isTyping && e.key === '/' && !e.ctrlKey && !e.metaKey && !e.altKey) {
            e.preventDefault();
            openQuickSearchTP();
        }
    });
}

// 底部左側 TP 搜尋提示
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('quickSearchTPHint')) return;
    const hint = document.createElement('div');
    hint.id = 'quickSearchTPHint';
    hint.className = 'position-fixed';
    hint.style.cssText = 'left:12px; bottom:12px; z-index:1040; opacity:0.85; pointer-events:none;';
    const label = window.i18n && window.i18n.isReady() ? window.i18n.t('hotkeys.quickSearchTP') : '按 / 快速搜尋 TP 票號';
    hint.innerHTML = `<span class="badge bg-secondary-subtle text-secondary border" style="--bs-bg-opacity:.65;">${label}</span>`;
    document.body.appendChild(hint);
    
    // i18n 準備完成時也同步更新
    document.addEventListener('i18nReady', () => {
        const text = window.i18n ? window.i18n.t('hotkeys.quickSearchTP') : '按 / 快速搜尋 TP 票號';
        const badge = document.querySelector('#quickSearchTPHint .badge');
        if (badge) badge.textContent = text;
    });
    document.addEventListener('languageChanged', () => {
        const text = window.i18n ? window.i18n.t('hotkeys.quickSearchTP') : '按 / 快速搜尋 TP 票號';
        const badge = document.querySelector('#quickSearchTPHint .badge');
        if (badge) badge.textContent = text;
    });
});

// T030: Debounce 函數 - 延遲執行搜尋，減少 API 呼叫
function debounce(func, delay) {
    let timeoutId;
    return function (...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(this, args), delay);
    };
}

// T031: 關鍵字高亮顯示函數 - 在搜尋結果中高亮顯示匹配的關鍵字
function highlightSearchTerm(text, searchTerm) {
    if (!text || !searchTerm || searchTerm.trim().length === 0) {
        return escapeHtml(text || '');
    }
    
    const escapedText = escapeHtml(text);
    const escapedTerm = escapeHtml(searchTerm.trim());
    
    // 使用不區分大小寫的全局替換
    const regex = new RegExp(`(${escapedTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return escapedText.replace(regex, '<mark class="bg-warning bg-opacity-50 rounded px-1">$1</mark>');
}

// T032: 搜尋歷史記錄管理 - 使用 localStorage 儲存最近搜尋記錄
const tpSearchHistory = {
    key: 'tp_search_history',
    maxItems: 10,
    
    // 獲取搜尋歷史
    get() {
        try {
            const history = localStorage.getItem(this.key);
            return history ? JSON.parse(history) : [];
        } catch (e) {
            console.warn('無法讀取搜尋歷史:', e);
            return [];
        }
    },
    
    // 添加搜尋記錄
    add(searchTerm) {
        if (!searchTerm || searchTerm.trim().length === 0) return;
        
        const term = searchTerm.trim();
        let history = this.get();
        
        // 移除重複項目
        history = history.filter(item => item !== term);
        
        // 添加到開頭
        history.unshift(term);
        
        // 限制數量
        if (history.length > this.maxItems) {
            history = history.slice(0, this.maxItems);
        }
        
        try {
            localStorage.setItem(this.key, JSON.stringify(history));
        } catch (e) {
            console.warn('無法儲存搜尋歷史:', e);
        }
    },
    
    // 清空歷史
    clear() {
        try {
            localStorage.removeItem(this.key);
        } catch (e) {
            console.warn('無法清空搜尋歷史:', e);
        }
    }
};

// T032: 渲染搜尋歷史記錄
function renderSearchHistory(container) {
    const history = tpSearchHistory.get();
    if (history.length === 0) {
        container.innerHTML = `<div class="list-group-item text-center text-muted py-3 border-0">
            <small><i class="fas fa-history me-2"></i>${window.i18n ? window.i18n.t('search.noHistory') : '尚無搜尋歷史'}</small>
        </div>`;
        return;
    }
    
    container.innerHTML = history.map((term, idx) => `
        <button type="button" class="list-group-item list-group-item-action d-flex align-items-center py-2 ${idx===0?'active':''}" 
                data-search-term="${escapeHtml(term)}">
            <i class="fas fa-history text-muted me-3" style="width: 16px;"></i>
            <span class="flex-grow-1">${escapeHtml(term)}</span>
            <small class="text-muted">${window.i18n ? window.i18n.t('search.recent') : '最近'}</small>
        </button>
    `).join('');
    
    // 綁定點擊事件 - 點擊歷史記錄項目直接搜尋
    container.querySelectorAll('[data-search-term]').forEach(btn => {
        btn.addEventListener('click', () => {
            const term = btn.getAttribute('data-search-term');
            const input = document.getElementById('quickSearchTPInput');
            if (input && term) {
                input.value = term;
                input.dispatchEvent(new Event('input'));
            }
        });
    });
}

function openQuickSearchTP() {
    const overlay = document.getElementById('quickSearchTPOverlay');
    const input = document.getElementById('quickSearchTPInput');
    const results = document.getElementById('quickSearchTPResults');
    if (!overlay || !input || !results) return;
    
    overlay.style.display = 'block';
    input.value = '';
    results.innerHTML = '';
    input.focus();
    
    // T032: 初始顯示搜尋歷史記錄
    renderSearchHistory(results);

    const handleKey = (e) => {
        if (e.key === 'Escape') { 
            closeQuickSearchTP(); 
            return; 
        }
        if (e.key === 'Enter') {
            const active = results.querySelector('.active');
            if (active) { 
                active.click(); 
            }
        } else if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
            e.preventDefault();
            // T032: 同時處理搜尋結果和歷史記錄項目
            const items = Array.from(results.querySelectorAll('.quick-search-tp-item, .list-group-item-action'));
            if (items.length === 0) return;
            let idx = items.findIndex(li => li.classList.contains('active'));
            if (idx < 0) idx = 0;
            idx = (e.key === 'ArrowDown') ? Math.min(idx+1, items.length-1) : Math.max(idx-1, 0);
            items.forEach(li => li.classList.remove('active'));
            items[idx].classList.add('active');
            items[idx].scrollIntoView({ block:'nearest' });
        }
    };
    
    input.onkeydown = handleKey;
    
    // T030: 使用 debounce 優化搜尋，300ms 延遲減少 API 呼叫
    const debouncedSearch = debounce((query) => {
        quickSearchRenderTP(query, results);
    }, 300);
    
    input.oninput = () => {
        const query = input.value.trim();
        
        // T032: 如果查詢為空，顯示搜尋歷史記錄
        if (query.length === 0) {
            renderSearchHistory(results);
            return;
        }
        
        // 顯示搜尋中狀態（立即響應）
        if (query.length >= 1) {
            results.innerHTML = `<div class="list-group-item text-muted d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                ${window.i18n ? window.i18n.t('common.searching') : '搜尋中...'}
            </div>`;
        }
        
        // 延遲執行實際搜尋
        debouncedSearch(query);
    };
}

function closeQuickSearchTP() {
    const overlay = document.getElementById('quickSearchTPOverlay');
    if (overlay) overlay.style.display = 'none';
}

// T027: TP 票號搜尋結果渲染 (含快取優化)
function quickSearchRenderTP(query, container) {
    const q = (query || '').trim().toUpperCase();
    if (q.length === 0) {
        container.innerHTML = '';
        return;
    }
    
    const currentTeamId = AppUtils.getCurrentTeamId();
    if (!currentTeamId) {
        container.innerHTML = `<div class="list-group-item text-muted">${window.i18n ? window.i18n.t('errors.noTeamSelected') : '請先選擇團隊'}</div>`;
        return;
    }
    
    const limit = 20;
    
    // T027: 檢查快取
    const cachedResult = tpSearchCache.get(q, currentTeamId, limit);
    if (cachedResult) {
        console.log('使用快取搜尋結果:', q);
        renderSearchResults(cachedResult, container, q);
        return;
    }
    
    // 顯示載入中
    container.innerHTML = `<div class="list-group-item text-muted d-flex align-items-center">
        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
        ${window.i18n ? window.i18n.t('common.searching') : '搜尋中...'}
    </div>`;
    
    // T027: 呼叫 TP 搜尋 API (含快取儲存)
    window.AuthClient.fetch(`/api/test-run-configs/search/tp?q=${encodeURIComponent(q)}&team_id=${currentTeamId}&limit=${limit}`)
        .then(response => response.json())
        .then(data => {
            // 儲存到快取
            tpSearchCache.set(q, currentTeamId, limit, data);
            console.log('API 搜尋結果已快取:', q);
            renderSearchResults(data, container, q);
        })
        .catch(error => {
            console.error('TP 搜尋 API 錯誤:', error);
            container.innerHTML = `<div class="quick-search-tp-no-results text-danger">${window.i18n ? window.i18n.t('errors.searchFailed') : '搜尋失敗，請稍後再試'}</div>`;
        });
}

// T027 + T028: 快速搜尋結果渲染 (簡潔下拉選單風格)
function renderSearchResults(data, container, searchTerm = '') {
    if (!Array.isArray(data) || data.length === 0) {
        container.innerHTML = `<div class="list-group-item text-center text-muted py-3 border-0">
            <small><i class="fas fa-search me-2"></i>${window.i18n ? window.i18n.t('errors.noMatchingTPConfigs') : '沒有找到符合條件的 TP 票號配置'}</small>
        </div>`;
        return;
    }
    
    container.innerHTML = data.map((config, idx) => {
        // T028: 簡潔的狀態處理
        const statusInfo = getSearchResultStatusInfo(config.status, config.execution_rate, config.pass_rate);
        
        // TP 標籤 - 簡化顯示，保留互動功能 (T031: 加入高亮顯示)
        let tpDisplay = '';
        if (config.related_tp_tickets && Array.isArray(config.related_tp_tickets) && config.related_tp_tickets.length > 0) {
            const maxDisplay = 2;
            const visibleTickets = config.related_tp_tickets.slice(0, maxDisplay);
            const remainingCount = config.related_tp_tickets.length - maxDisplay;
            
            const tpTags = visibleTickets.map(ticket => 
                `<span class="text-secondary">${highlightSearchTerm(ticket, searchTerm)}</span>`
            ).join(', ');
            
            tpDisplay = tpTags;
            if (remainingCount > 0) {
                tpDisplay += ` <span class="text-muted">+${remainingCount}更多</span>`;
            }
        }
        
        // 環境資訊
        const envInfo = config.test_environment || '';
        const buildInfo = config.build_number || '';
        const envBuildDisplay = [envInfo, buildInfo].filter(Boolean).join(' • ');
            
        return `
        <button type="button" class="quick-search-tp-item py-3 px-4 w-100 text-start ${idx===0?'quick-search-active':''}" 
                data-config-id="${config.id}" data-search-term="${escapeHtml(searchTerm)}"
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1 min-width-0 pe-3">
                    <!-- 主標題 (T031: 加入高亮顯示) -->
                    <div class="d-flex align-items-center mb-1">
                        <i class="fas fa-play stats-icon me-2"></i>
                        <span class="fw-medium text-dark text-truncate" style="font-size: 1rem;">${highlightSearchTerm(config.name || '', searchTerm)}</span>
                        <span class="status-badge ${statusInfo.statusClass} ms-2 flex-shrink-0" 
                              style="font-size: 0.7rem; padding: 0.15rem 0.4rem;">${statusInfo.statusText}</span>
                    </div>
                    
                    <!-- 次要資訊 -->
                    <div class="small text-muted">
                        ${tpDisplay ? `<span class="me-3"><i class="fas fa-ticket-alt stats-icon"></i>${tpDisplay}</span>` : ''}
                        ${envBuildDisplay ? `<span class="me-3"><i class="fas fa-server stats-icon"></i>${escapeHtml(envBuildDisplay)}</span>` : ''}
                        <span><i class="fas fa-list-ul stats-icon"></i>${config.total_test_cases || 0} 案例</span>
                        ${statusInfo.showProgress ? ` • <i class="fas fa-clock stats-icon"></i> ${Math.round(config.execution_rate || 0)}% 執行` : ''}
                    </div>
                </div>
            </div>
        </button>`;
    }).join('');
    
    // 綁定點擊事件
    container.querySelectorAll('.quick-search-tp-item').forEach(btn => {
        btn.addEventListener('click', () => {
            const configId = btn.getAttribute('data-config-id');
            const searchTerm = btn.getAttribute('data-search-term');
            
            // T032: 只在用戶實際使用搜尋結果時才記錄歷史
            if (searchTerm && searchTerm.trim().length >= 2) {
                tpSearchHistory.add(searchTerm.trim());
            }
            
            closeQuickSearchTP();
            if (configId) {
                // 跳轉到 Test Run 執行頁面
const teamId = (typeof AppUtils.getCurrentTeamId === 'function') ? AppUtils.getCurrentTeamId() : (AppUtils.getCurrentTeam()?.id ?? '');
                const params = new URLSearchParams({ config_id: String(configId) });
                if (teamId) params.set('team_id', String(teamId));
                window.location.href = `/test-run-execution?${params.toString()}`;
            }
        });
    });
}

// 初始化快速搜尋功能
document.addEventListener('DOMContentLoaded', function() {
    setupQuickSearch_TPTicket();
});

// ===== 通知設定相關功能 =====
function initNotificationSettings() {
    const enabledEl = document.getElementById('notificationsEnabled');
    const sectionEl = document.getElementById('notificationGroupsSection');
    const searchBtn = document.getElementById('searchGroupsBtn');
    const searchInput = document.getElementById('notifyGroupsInput');

    if (!enabledEl || !sectionEl) return;

    const toggleSection = () => {
        if (enabledEl.checked) {
            sectionEl.style.display = '';
            sectionEl.classList.add('notification-groups-entering');
            requestAnimationFrame(() => {
                sectionEl.classList.remove('notification-groups-entering');
                sectionEl.classList.add('notification-groups-entered');
            });
        } else {
            sectionEl.classList.remove('notification-groups-entered');
            sectionEl.classList.add('notification-groups-exiting');
            setTimeout(() => {
                sectionEl.classList.remove('notification-groups-exiting');
                sectionEl.style.display = 'none';
            }, 150);
        }
    };

    enabledEl.onchange = toggleSection;
    toggleSection();

    if (searchBtn && searchInput) {
        searchBtn.onclick = () => performGroupSearch(searchInput.value.trim());
        searchInput.onkeydown = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                performGroupSearch(searchInput.value.trim());
            }
        };
    }
}

// ===== URL 工具：確保 team_id 反映在網址列（不重新載入頁面） =====
function ensureTeamIdInUrl_TRM(teamId) {
    try {
        const url = new URL(window.location.href);
        const before = url.searchParams.get('team_id');
        if (String(before || '') !== String(teamId)) {
            url.searchParams.set('team_id', teamId);
            history.replaceState(null, '', `${url.pathname}?${url.searchParams.toString()}`);
        }
    } catch (_) {}
}

function clearNotificationSettings() {
    const enabledEl = document.getElementById('notificationsEnabled');
    const sectionEl = document.getElementById('notificationGroupsSection');
    const resultsEl = document.getElementById('groupSearchResults');
    const tagsEl = document.getElementById('selectedGroupsTags');
    const countEl = document.getElementById('selectedGroupsCount');
    const displayEl = document.getElementById('selectedGroupsDisplay');
    const searchInput = document.getElementById('notifyGroupsInput');

    if (enabledEl) enabledEl.checked = false;
    if (sectionEl) sectionEl.style.display = 'none';
    if (resultsEl) resultsEl.style.display = 'none', resultsEl.innerHTML = '';
    if (tagsEl) tagsEl.innerHTML = '';
    if (countEl) countEl.textContent = '0';
    if (displayEl) displayEl.style.display = 'none';
    if (searchInput) searchInput.value = '';

    selectedNotifyGroups = [];
}

let selectedNotifyGroups = [];

function loadNotificationSettings(enabled, chatIds, chatNames) {
    const enabledEl = document.getElementById('notificationsEnabled');
    const sectionEl = document.getElementById('notificationGroupsSection');
    enabledEl.checked = !!enabled;
    if (enabled) {
        sectionEl.style.display = '';
    }
    selectedNotifyGroups = [];
    if (Array.isArray(chatIds)) {
        for (let i = 0; i < chatIds.length; i++) {
            const id = chatIds[i];
            const name = (Array.isArray(chatNames) && chatNames[i]) ? chatNames[i] : id;
            selectedNotifyGroups.push({ chat_id: id, name });
        }
    }
    renderSelectedGroups();
}

async function performGroupSearch(keyword) {
    const resultsEl = document.getElementById('groupSearchResults');
    resultsEl.style.display = '';
    resultsEl.innerHTML = `<div class="text-muted small"><i class="fas fa-spinner fa-spin me-2"></i>${window.i18n ? window.i18n.t('testRun.notifications.searchingGroups') : '搜尋群組中...'}</div>`;
    try {
        const url = new URL('/api/integrations/lark/groups', window.location.origin);
        if (keyword) url.searchParams.set('q', keyword);
        const resp = await window.AuthClient.fetch(url);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        if (!Array.isArray(data) || data.length === 0) {
            resultsEl.innerHTML = `<div class="text-muted small"><i class="fas fa-info-circle me-2"></i>${window.i18n ? window.i18n.t('testRun.notifications.noGroupsFound') : '找不到符合條件的群組'}</div>`;
            return;
        }
        resultsEl.innerHTML = data.map(g => renderGroupSearchItem(g)).join('');
        // 綁定點擊事件
        resultsEl.querySelectorAll('.group-search-item').forEach(el => {
            el.addEventListener('click', () => {
                const id = el.getAttribute('data-chat-id');
                const name = el.getAttribute('data-name');
                addSelectedGroup({ chat_id: id, name });
            });
        });
    } catch (e) {
        resultsEl.innerHTML = `<div class="text-danger small"><i class="fas fa-exclamation-triangle me-2"></i>${window.i18n ? window.i18n.t('testRun.notifications.searchError') : '搜尋群組失敗'}</div>`;
    }
}

function renderGroupSearchItem(group) {
    const id = escapeHtml(group.chat_id || '');
    const name = escapeHtml(group.name || id);
    return `
        <div class="group-search-item" data-chat-id="${id}" data-name="${name}">
            <i class="fas fa-users group-icon"></i>
            <span class="group-name">${name}</span>
            <code class="group-id">${id}</code>
        </div>
    `;
}

function addSelectedGroup(group) {
    if (!group || !group.chat_id) return;
    // 去重
    const exists = selectedNotifyGroups.some(g => g.chat_id === group.chat_id);
    if (exists) return;
    if (selectedNotifyGroups.length >= 100) {
        AppUtils.showWarning && AppUtils.showWarning(window.i18n ? window.i18n.t('testRun.notifications.maxGroupsReached') : '最多選擇 100 個群組');
        return;
    }
    selectedNotifyGroups.push({ chat_id: group.chat_id, name: group.name || group.chat_id });
    renderSelectedGroups();
}

function removeSelectedGroup(chatId) {
    selectedNotifyGroups = selectedNotifyGroups.filter(g => g.chat_id !== chatId);
    renderSelectedGroups();
}

function renderSelectedGroups() {
    const displayEl = document.getElementById('selectedGroupsDisplay');
    const tagsEl = document.getElementById('selectedGroupsTags');
    const countEl = document.getElementById('selectedGroupsCount');
    if (!tagsEl || !countEl || !displayEl) return;

    if (selectedNotifyGroups.length === 0) {
        displayEl.style.display = 'none';
        tagsEl.innerHTML = '';
        countEl.textContent = '0';
        return;
    }
    displayEl.style.display = '';
    countEl.textContent = String(selectedNotifyGroups.length);
    tagsEl.innerHTML = selectedNotifyGroups.map(g => renderSelectedGroupTag(g)).join('');
    // 綁定移除按鈕
    tagsEl.querySelectorAll('.group-remove-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-chat-id');
            removeSelectedGroup(id);
        });
    });
}

function renderSelectedGroupTag(group) {
    const id = escapeHtml(group.chat_id || '');
    const name = escapeHtml(group.name || id);
    return `
        <span class="selected-group-tag">
            <i class="fas fa-users"></i>${name}
            <button type="button" class="group-remove-btn" data-chat-id="${id}" title="${window.i18n ? window.i18n.t('testRun.notifications.removeGroup') : '移除群組'}"><i class="fas fa-times"></i></button>
        </span>
    `;
}

function getCurrentNotificationSettings() {
    const enabled = !!document.getElementById('notificationsEnabled')?.checked;
    const chatIds = selectedNotifyGroups.map(g => g.chat_id);
    const chatNames = selectedNotifyGroups.map(g => g.name || g.chat_id);
    return { enabled, chatIds, chatNames };
}

</script>
{% endblock %}
