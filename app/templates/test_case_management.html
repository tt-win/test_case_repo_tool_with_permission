{% extends "base.html" %}

{% block title %}測試案例管理 - Test Case Repository Web Tool{% endblock %}

{% block head %}
<!-- Markdown 編輯器相關資源 -->
<script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
<script>
// Configure marked to treat single newlines as <br> so previews show line breaks
if (window.marked && typeof window.marked.setOptions === 'function') {
    window.marked.setOptions({
        gfm: true,
        breaks: true
    });
}
</script>

<!-- 快速編輯樣式 -->
<style>
/* 限定本頁：關閉整頁滾動，只讓列表區域滾動 */
html, body { height: 100%; overflow: hidden; }
#testCasesPage { height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

.hover-editable {
    cursor: pointer;
    transition: background-color 0.2s;
}

.hover-editable:hover {
    background-color: rgba(0, 123, 255, 0.1);
}

.hover-edit-btn {
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
    min-width: 28px;
    min-height: 28px;
    padding: 2px 4px;
}

.hover-editable:hover .hover-edit-btn {
    opacity: 1 !important;
    pointer-events: auto;
}

.hover-editable .hover-edit-btn {
    display: block !important;
}

.quick-edit-input {
    border: 1px solid var(--tr-primary) !important;
    border-radius: 4px !important;
    padding: 0.25rem 0.5rem !important;
    font-size: 0.875rem !important;
    line-height: 1.5 !important;
    height: auto !important;
    min-height: 1.5rem !important;
    margin: 0 !important;
    box-sizing: border-box !important;
}

/* 確保表格行高度一致 */
#testCasesTable tbody tr {
    height: 2.5rem;
}

#testCasesTable tbody td {
    vertical-align: middle;
    height: 2.5rem;
}

/* Markdown 編輯器樣式 */
.markdown-global-toolbar {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    padding: 0.5rem;
    background-color: var(--tr-bg-sidebar);
    border: 1px solid var(--tr-border-light);
    border-radius: 0.375rem;
    margin-bottom: 1rem;
}

.markdown-field-container {
    margin-top: 0.5rem;
}

.markdown-field-container textarea {
    border-radius: 0.375rem;
}

.markdown-field-container .card {
    border-radius: 0.375rem;
    height: 100%;
}

.markdown-preview {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6;
}

.markdown-preview h1,
.markdown-preview h2,
.markdown-preview h3 {
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.markdown-preview h1 { font-size: 1.5rem; }
.markdown-preview h2 { font-size: 1.25rem; }
.markdown-preview h3 { font-size: 1.1rem; }

.markdown-preview ul,
.markdown-preview ol {
    padding-left: 1.5rem;
    margin-bottom: 1rem;
}

.markdown-preview code {
    background-color: var(--tr-bg-sidebar);
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
}

.markdown-preview a {
    color: var(--tr-primary);
    text-decoration: none;
}

.markdown-preview a:hover {
    text-decoration: underline;
}

/* 附件樣式 */
.attachment-item {
    background-color: var(--tr-bg-sidebar);
    transition: background-color 0.2s;
}

.attachment-item:hover {
    background-color: var(--tr-border-light);
}

/* (reverted) removed modal TCG custom styles */

/* Markdown 預覽區域：移除首尾多餘邊距，避免卡片內留下額外留白 */

/* 卡片與編輯容器對齊：確保卡片本身不產生額外外距 */
/* (revert) remove special markdown preview margin normalization */


/* 在顯示前先隱藏 modal 內容，避免進場時可見的滾動回頂彈跳感 */
.modal-preparing .modal-body {
    visibility: hidden;
}

/* 禁用任何平滑滾動，確保立即置頂 */
.scrollable-content {
    scroll-behavior: auto;
}

/* 精準收斂搜尋卡片的內邊距，避免上方留白過多 */
#searchFilterCard .card-body {
    padding-top: 0.25rem;   /* 再更緊：由 0.5rem 降為 0.25rem */
    padding-bottom: 0.5rem; /* 底部同步略收斂 */
}
#searchFilterCard .form-label {
    margin-bottom: 0.125rem; /* 再更緊：由 0.25rem 降為 0.125rem */
}

/* 同層級其他卡片一併收斂頂部空白 */
#batchToolbar .card-body,
#testCasesCard .card-body {
    padding-top: 0.5rem;
}

/* 讓列表容器可滾動（高度由 JS 計算設定）*/
#testCasesScroll {
    overflow-y: auto;
}

/* 讓標題列固定在列表容器頂部，不跟著內容滾動，並恢復底色與陰影層次 */
#testCasesScroll thead th {
    position: sticky;
    top: 0;
    z-index: 20; /* 確保蓋過內容列 */
    background-color: #f8f9fa; /* 與卡片/表頭風格一致 */
    border-bottom: 1px solid #dee2e6; /* 清楚的下邊界 */
}
#testCasesScroll thead tr {
    box-shadow: 0 2px 3px rgba(0,0,0,0.05); /* 輕微陰影強化層次 */
}

/* 大量新增 Modal 固定高度與卷動區域 */
#bulkCreateModal .modal-content { font-size: 0.9rem; }
#bulkCreateModal .modal-body { height: 65vh; overflow: hidden; }
#bulkCreateModal .bulk-left-scroll { max-height: 60vh; overflow: auto; padding-right: .25rem; }
#bulkCreateModal .bulk-preview-scroll { max-height: 60vh; overflow: auto; min-width: 26ch; max-width: 56ch; }
#bulkCreateModal #bulkPreview code { font-size: 0.875rem; }
/* 讓結構說明支援換行（以 \n 分行） */
#bulkCreateModal [data-i18n="testCase.bulk.structureHint"] { white-space: pre-line; }

/* 專門收斂 #searchInput 的父層（col-）之上緣空白：縮小該 row 的垂直 gutter */
#searchFilterCard .card-body .row.g-3 {
    --bs-gutter-y: 0.125rem; /* 再更緊：由 0.25rem 降為 0.125rem */
}


/* 分頁列外觀（定位由 .fixed-pagination-bar 控制） */
#testCasesPagination {
    background-color: transparent;
    border-top: none;
    padding-top: 0.25rem;
    padding-bottom: 0.25rem;
}

/* Modal 和 Batch TCG 標籤樣式 */
.tcg-tag {
    display: inline-block;
    background-color: #e3f2fd;
    color: #1976d2;
    padding: 2px 6px;
    margin: 1px 2px;
    border-radius: 10px;
    font-size: 0.7rem;
    font-weight: 500;
    border: 1px solid #bbdefb;
    white-space: nowrap;
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
}

.tcg-tags-container:hover {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.tcg-option:hover {
    background-color: #f8f9fa !important;
}

.tcg-option.active {
    background-color: #e3f2fd !important;
}

/* TCG 容器的響應式設計 */
.tcg-tags-container {
    word-wrap: break-word;
    overflow-wrap: break-word;
}

/* Modal 響應式設計 */
@media (max-width: 1500px) {
    #testCaseModal .modal-dialog {
        max-width: 90vw !important;
        width: 90vw !important;
    }
}

@media (max-width: 1200px) {
    #testCaseModal .modal-dialog {
        max-width: 95vw !important;
        width: 95vw !important;
    }
    
    #testCaseModal .col-md-5 {
        flex: 0 0 60%;
        max-width: 60%;
    }
    
    #testCaseModal .col-md-3 {
        flex: 0 0 40%;
        max-width: 40%;
    }
}

@media (max-width: 768px) {
    #testCaseModal .modal-dialog {
        max-width: 100vw !important;
        width: 100vw !important;
        height: 100vh !important;
        max-height: 100vh !important;
        margin: 0 !important;
        border-radius: 0 !important;
    }
    
    #testCaseModal .col-md-2,
    #testCaseModal .col-md-3,
    #testCaseModal .col-md-5 {
        flex: 0 0 100%;
        max-width: 100%;
        margin-bottom: 1rem;
    }
    
    .tcg-tags-container {
        max-height: 80px !important;
    }
}

</style>
{% endblock %}

{% block page_title_text %}
<span data-i18n="testCase.management">測試案例管理</span>
{% endblock %}

{% block page_subtitle_text %}
<span data-i18n="testCase.subtitle">管理測試案例，支援搜尋、過濾、編輯和批次操作</span>
{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2">
    <button type="button" class="btn btn-primary" id="addTestCaseBtn">
        <i class="fas fa-plus me-2"></i><span data-i18n="testCase.createTestCase">新增測試案例</span>
    </button>
    <button type="button" class="btn btn-outline-primary" id="openBulkCreateBtn">
        <i class="fas fa-layer-group me-2"></i><span data-i18n="testCase.bulk.bulkCreateMode">大量新增模式</span>
    </button>
    <button type="button" class="btn btn-secondary" id="refreshBtn">
        <i class="fas fa-sync-alt me-2"></i><span data-i18n="common.refresh">重新整理</span>
    </button>
    <a href="/" class="btn btn-outline-secondary">
        <i class="fas fa-home me-2"></i><span data-i18n="navigation.backToHome">回到首頁</span>
    </a>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid" id="testCasesPage">

    <!-- 載入進度條 -->
    <div id="loadingProgress" class="card mb-2" style="display: none;">
        <div class="card-body">
            <h5 class="card-title mb-3">
                <i class="fas fa-spinner fa-spin me-2"></i><span data-i18n="common.loading">載入中...</span>
            </h5>
            
            <!-- Test Case 載入進度 -->
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <small class="text-muted" data-i18n="testCase.loadingTestCases">載入測試案例</small>
                    <small class="text-muted" id="testCaseProgress">0%</small>
                </div>
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-primary" id="testCaseProgressBar" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- TCG 快取載入進度 -->
            <div class="mb-2">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <small class="text-muted" data-i18n="testCase.loadingTCG">載入 TCG 單號快取</small>
                    <small class="text-muted" id="tcgCacheProgress">0%</small>
                </div>
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-success" id="tcgCacheProgressBar" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 搜尋與篩選區 -->
    <div class="card mb-3" id="searchFilterCard" style="display: none;">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3 col-lg-2">
                    <label for="testCaseNumberSearch" class="form-label" data-i18n="testCase.testCaseNumber">Test Case Number</label>
                    <input type="text" class="form-control" id="testCaseNumberSearch" data-i18n-placeholder="testCase.testCaseNumberPlaceholder">
                </div>
                <div class="col-md-3 col-lg-2">
                    <label for="searchInput" class="form-label" data-i18n="common.search">關鍵字搜尋</label>
                    <input type="text" class="form-control" id="searchInput" data-i18n-placeholder="testCase.searchPlaceholder">
                </div>
                <div class="col-md-2 col-lg-1">
                    <label for="tcgFilter" class="form-label">TCG</label>
                    <input type="text" class="form-control" id="tcgFilter" data-i18n-placeholder="testCase.tcgFilterPlaceholder" data-i18n-placeholder-fallback="輸入 TCG 單號">
                </div>
                <div class="col-md-1 col-lg-1">
                    <label for="priorityFilter" class="form-label" data-i18n="testCase.priority">優先級</label>
                    <select class="form-select" id="priorityFilter">
                        <option value="" data-i18n="common.all">全部</option>
                        <option value="High" data-i18n="priority.high">High</option>
                        <option value="Medium" data-i18n="priority.medium">Medium</option>
                        <option value="Low" data-i18n="priority.low">Low</option>
                    </select>
                </div>
                <div class="col-md-3 col-lg-6 d-flex align-items-end justify-content-between flex-wrap">
                    <div class="d-flex align-items-center mb-2 mb-lg-0">
                        <button type="button" class="btn btn-primary me-2" id="applyFiltersBtn">
                            <i class="fas fa-filter me-2"></i><span data-i18n="common.apply">套用篩選</span>
                        </button>
                        <button type="button" class="btn btn-secondary" id="clearFiltersBtn">
                            <i class="fas fa-times me-2"></i><span data-i18n="common.clear">清除</span>
                        </button>
                    </div>
                    <!-- 批次操作工具列（與套用篩選同一排、靠右顯示） -->
                    <div id="batchInlineToolbar" class="d-none d-flex align-items-center gap-2 ms-lg-auto mb-2 mb-lg-0">
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="clearSelectionBtnTC"
                                data-i18n-title="common.clearSelection" title="清除選取">
                            <i class="fas fa-xmark"></i>
                        </button>
                        <span class="text-muted" id="selectedCountWrapper" data-i18n="testCase.selectedItems" data-i18n-params='{"count":0}'>
                            已選取 0 個項目
                        </span>
                        <button type="button" class="btn btn-primary btn-sm" id="batchModifyBtn">
                            <i class="fas fa-edit me-2"></i><span data-i18n="testCase.batchModify">批次修改</span>
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="batchCopyBtn">
                            <i class="fas fa-copy me-2"></i><span data-i18n="testCase.batchCopy.title">批次複製</span>
                        </button>
                        <button type="button" class="btn btn-danger btn-sm" id="batchDeleteBtn">
                            <i class="fas fa-trash me-2"></i><span data-i18n="testCase.batchDelete">批次刪除</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 測試案例表格 -->
    <div class="card" id="testCasesCard">
        <div class="card-body">
            <div class="table-responsive" id="testCasesScroll">
                <table class="table table-hover table-sm" id="testCasesTable">
                    <thead>
                        <tr style="height: 32px !important; line-height: 1.2;">
                            <th width="30" class="text-center" style="padding: 4px 8px !important; vertical-align: middle;">
                                <input type="checkbox" class="form-check-input" id="selectAllCheckbox">
                            </th>
                            <th id="th-tcm-number" class="sortable" width="220" style="padding: 4px 8px !important; vertical-align: middle; cursor: pointer;">
                                <span data-i18n="testCase.testCaseNumber">Test Case Number</span>
                                <span class="sort-indicator ms-1"></span>
                            </th>
                            <th id="th-tcm-title" class="sortable" style="padding: 4px 8px !important; vertical-align: middle; cursor: pointer;">
                                <span data-i18n="common.title">標題</span>
                                <span class="sort-indicator ms-1"></span>
                            </th>
                            <th id="th-tcm-tcg" class="sortable text-center" width="180" style="padding: 4px 8px !important; vertical-align: middle; cursor: pointer;">
                                <span>TCG</span>
                                <span class="sort-indicator ms-1"></span>
                            </th>
                            <th id="th-tcm-priority" class="sortable text-center" width="80" style="padding: 4px 8px !important; vertical-align: middle; cursor: pointer;">
                                <span data-i18n="testCase.priority">優先級</span>
                                <span class="sort-indicator ms-1"></span>
                            </th>
                            <th id="th-tcm-created" class="sortable text-center" width="100" style="padding: 4px 8px !important; vertical-align: middle; cursor: pointer;">
                                <span data-i18n="common.createDate">建立日期</span>
                                <span class="sort-indicator ms-1"></span>
                            </th>
                            <th id="th-tcm-updated" class="sortable text-center" width="100" style="padding: 4px 8px !important; vertical-align: middle; cursor: pointer;">
                                <span data-i18n="common.updateDate">更新日期</span>
                                <span class="sort-indicator ms-1"></span>
                            </th>
                            <th width="100" class="text-center" style="padding: 4px 8px !important; vertical-align: middle;" data-i18n="common.actions">操作</th>
                        </tr>
                    </thead>
                    <tbody id="testCasesTableBody">
                        <!-- 將由 JavaScript 動態載入 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 分頁控制 -->
    <nav aria-label="測試案例分頁" class="mt-3 fixed-pagination-bar" id="testCasesPagination">
        <ul class="pagination justify-content-center" id="pagination">
            <!-- 將由 JavaScript 動態載入 -->
        </ul>
    </nav>
</div>

<!-- 測試案例詳情/編輯 Modal -->
<div class="modal fade" id="testCaseModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog" style="max-width: 85vw; width: 1400px; height: 90vh; max-height: 90vh;">
        <div class="modal-content" style="height: 100%; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-clipboard-check me-2"></i>
                    <span id="testCaseModalTitle" data-i18n="testCase.createTestCase">新增測試案例</span>
                </h5>
                <div class="d-flex align-items-center gap-2">
                    <button type="button" class="btn btn-outline-primary btn-sm" id="copyTcmCaseLinkBtn">
                        <i class="fas fa-link me-1"></i><span data-i18n="common.copyLink">複製連結</span>
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="prevTestCaseBtn" data-i18n-title="testCase.previousTestCase">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="nextTestCaseBtn" data-i18n-title="testCase.nextTestCase">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body" style="flex: 1; overflow: hidden; padding: 0; display: flex; flex-direction: column;">
                <form id="testCaseForm" style="height: 100%; display: flex; flex-direction: column;">
                    <input type="hidden" id="testCaseId" name="id">
                    <input type="hidden" id="tcg" name="tcg">
                    
                    <!-- 固定區域：基本資訊 -->
                    <div class="fixed-section" style="flex-shrink: 0; padding: 1rem; border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                        <div class="row mb-3">
                            <div class="col-md-2">
                                <label for="testCaseNumber" class="form-label"><span data-i18n="testCase.testCaseNumber">Test Case Number</span> <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="testCaseNumber" name="test_case_number" required>
                            </div>
                            <div class="col-md-5">
                                <label for="title" class="form-label"><span data-i18n="form.testCaseTitle">測試案例標題</span> <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="title" name="title" required>
                            </div>
                            <div class="col-md-2">
                                <label for="priority" class="form-label"><span data-i18n="testCase.priority">Priority</span></label>
                                <select class="form-select" id="priority" name="priority">
                                    <option value="Medium" data-i18n="testCase.priorityMedium">Medium</option>
                                    <option value="High" data-i18n="testCase.priorityHigh">High</option>
                                    <option value="Low" data-i18n="testCase.priorityLow">Low</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="tcg" class="form-label d-flex align-items-center">
                                    TCG
                                    <button type="button" class="btn-icon-only" 
                                            title="檢視 JIRA Ticket 資訊" 
                                            data-i18n-title="tooltips.viewJiraInfo"
                                            onclick="showTCGPreviewForModal()"
                                            style="border: none; background: none; padding: 0; margin-left: 8px; color: #6c757d; cursor: pointer;">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </label>
                                <div class="tcg-tags-container" id="modalTcgContainer" 
                                     style="min-height: 32px; padding: 4px 8px; border: 1px solid #dee2e6; border-radius: 4px; background-color: #fff; cursor: text; display: flex; align-items: center; flex-wrap: wrap; gap: 4px; position: relative; max-height: 120px; overflow-y: auto;">
                                    <!-- TCG 標籤會顯示在這裡 -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 可滾動內容區域 -->
                    <div class="scrollable-content" style="flex: 1; overflow-y: auto; padding: 1rem;">
                        
                        <!-- 測試內容三個區域 -->
                        
                        <!-- 測試內容三個區域 - 統一網格佈局 -->
                        <div class="row">
                            <!-- Precondition 區域 -->
                            <div class="col-12 mb-4">
                                <div class="mb-3">
                                    <label for="precondition" class="form-label mb-0">
                                        <i class="fas fa-list-ul me-2"></i><span data-i18n="testCase.preconditions">Preconditions</span>
                                    </label>
                                </div>
                                <div class="markdown-field-container" id="precondition_container">
                                    <div class="row">
                                        <div class="col-12 d-none edit-column">
                                            <!-- 編輯框容器 -->
                                            <div class="form-control markdown-edit-container" style="padding: 0; height: 200px;">
                                                <!-- Markdown 工具列 -->
                                                <div class="markdown-toolbar px-2 py-1 border-bottom" data-target="precondition" style="background-color: #f8f9fa; height: 32px; display: flex; align-items: center;">
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="**" data-i18n-title="markdown.bold">
                                                            <i class="fas fa-bold"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="*" data-i18n-title="markdown.italic">
                                                            <i class="fas fa-italic"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="`" data-i18n-title="markdown.code">
                                                            <i class="fas fa-code"></i>
                                                        </button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="# " data-i18n-title="markdown.heading1">H1</button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="## " data-i18n-title="markdown.heading2">H2</button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="### " data-i18n-title="markdown.heading3">H3</button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="- " data-i18n-title="markdown.unorderedList">
                                                            <i class="fas fa-list-ul"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="1. " data-i18n-title="markdown.orderedList">
                                                            <i class="fas fa-list-ol"></i>
                                                        </button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="[text](url)" data-i18n-title="markdown.link">
                                                            <i class="fas fa-link"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="![alt](url)" data-i18n-title="markdown.image">
                                                            <i class="fas fa-image"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <textarea id="precondition" name="precondition" class="markdown-textarea" rows="4" 
                                                        data-i18n-placeholder="testCase.preconditionsPlaceholder" 
                                                        style="border: none; border-radius: 0; height: calc(100% - 32px); resize: none; outline: none; padding: 0.375rem 0.75rem; width: 100%; box-sizing: border-box; overflow-y: auto;"></textarea>
                                            </div>
                                        </div>
                                        <div class="col-12 preview-column">
                                            <div class="card" style="height: 200px;">
                                                <div class="card-body" style="height: calc(100% - 2rem); padding: 0.75rem;">
                                                    <div class="markdown-preview" data-target="precondition" style="height: 100%; overflow-y: auto; padding: 0.375rem;"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 測試步驟區域 -->
                            <div class="col-12 mb-4">
                                <label for="test_steps" class="form-label">
                                    <i class="fas fa-list-ol me-2"></i><span data-i18n="form.testSteps">測試步驟</span>
                                </label>
                                <div class="markdown-field-container" id="test_steps_container">
                                    <div class="row">
                                        <div class="col-12 d-none edit-column">
                                            <!-- 編輯框容器 -->
                                            <div class="form-control markdown-edit-container" style="padding: 0; height: 250px;">
                                                <!-- Markdown 工具列 -->
                                                <div class="markdown-toolbar px-2 py-1 border-bottom" data-target="test_steps" style="background-color: #f8f9fa; height: 32px; display: flex; align-items: center;">
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="**" data-i18n-title="markdown.bold">
                                                            <i class="fas fa-bold"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="*" data-i18n-title="markdown.italic">
                                                            <i class="fas fa-italic"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="`" data-i18n-title="markdown.code">
                                                            <i class="fas fa-code"></i>
                                                        </button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="# " data-i18n-title="markdown.heading1">H1</button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="## " data-i18n-title="markdown.heading2">H2</button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="### " data-i18n-title="markdown.heading3">H3</button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="- " data-i18n-title="markdown.unorderedList">
                                                            <i class="fas fa-list-ul"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="1. " data-i18n-title="markdown.orderedList">
                                                            <i class="fas fa-list-ol"></i>
                                                        </button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="[text](url)" data-i18n-title="markdown.link">
                                                            <i class="fas fa-link"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="![alt](url)" data-i18n-title="markdown.image">
                                                            <i class="fas fa-image"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <textarea id="test_steps" name="test_steps" class="markdown-textarea" rows="6" 
                                                        data-i18n-placeholder="testCase.stepsPlaceholder" 
                                                        style="border: none; border-radius: 0; height: calc(100% - 32px); resize: none; outline: none; padding: 0.375rem 0.75rem; width: 100%; box-sizing: border-box; overflow-y: auto;"></textarea>
                                            </div>
                                        </div>
                                        <div class="col-12 preview-column">
                                            <div class="card" style="height: 250px;">
                                                <div class="card-body" style="height: calc(100% - 2rem); padding: 0.75rem;">
                                                    <div class="markdown-preview" data-target="test_steps" style="height: 100%; overflow-y: auto; padding: 0.375rem;"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 預期結果區域 -->
                            <div class="col-12 mb-4">
                                <label for="expected_result" class="form-label">
                                    <i class="fas fa-check-circle me-2"></i><span data-i18n="form.expectedResults">預期結果</span>
                                </label>
                                <div class="markdown-field-container" id="expected_result_container">
                                    <div class="row">
                                        <div class="col-12 d-none edit-column">
                                            <!-- 編輯框容器 -->
                                            <div class="form-control markdown-edit-container" style="padding: 0; height: 200px;">
                                                <!-- Markdown 工具列 -->
                                                <div class="markdown-toolbar px-2 py-1 border-bottom" data-target="expected_result" style="background-color: #f8f9fa; height: 32px; display: flex; align-items: center;">
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="**" data-i18n-title="markdown.bold">
                                                            <i class="fas fa-bold"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="*" data-i18n-title="markdown.italic">
                                                            <i class="fas fa-italic"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="`" data-i18n-title="markdown.code">
                                                            <i class="fas fa-code"></i>
                                                        </button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="# " data-i18n-title="markdown.heading1">H1</button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="## " data-i18n-title="markdown.heading2">H2</button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="### " data-i18n-title="markdown.heading3">H3</button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="- " data-i18n-title="markdown.unorderedList">
                                                            <i class="fas fa-list-ul"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="1. " data-i18n-title="markdown.orderedList">
                                                            <i class="fas fa-list-ol"></i>
                                                        </button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="[text](url)" data-i18n-title="markdown.link">
                                                            <i class="fas fa-link"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="![alt](url)" data-i18n-title="markdown.image">
                                                            <i class="fas fa-image"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <textarea id="expected_result" name="expected_result" class="markdown-textarea" rows="4" 
                                                        data-i18n-placeholder="testCase.expectedResultsPlaceholder" 
                                                        style="border: none; border-radius: 0; height: calc(100% - 32px); resize: none; outline: none; padding: 0.375rem 0.75rem; width: 100%; box-sizing: border-box; overflow-y: auto;"></textarea>
                                            </div>
                                        </div>
                                        <div class="col-12 preview-column">
                                            <div class="card" style="height: 200px;">
                                                <div class="card-body" style="height: calc(100% - 2rem); padding: 0.75rem;">
                                                    <div class="markdown-preview" data-target="expected_result" style="height: 100%; overflow-y: auto; padding: 0.375rem;"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 附件區域 -->
                        <div class="mb-3">
                            <label for="attachmentUpload" class="form-label">
                                <i class="fas fa-paperclip me-2"></i><span data-i18n="form.attachments">附件</span>
                            </label>
                            <input type="file" class="form-control" id="attachmentUpload" multiple 
                                   accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.xls,.xlsx,.txt">
                            <div class="form-text" data-i18n="form.attachmentHint">支援圖片、PDF、Office 文件，單檔最大 10MB</div>
                            <div id="attachmentsList" class="mt-2">
                                <!-- 附件列表將由 JavaScript 動態載入 -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- 固定按鈕區域 -->
                    <div class="fixed-buttons" style="flex-shrink: 0; padding: 1rem; border-top: 1px solid #dee2e6; background: #ffffff;">
                        <div class="d-flex justify-content-between align-items-center">
                            <!-- 模式切換按鈕 -->
                            <div class="d-flex align-items-center gap-2">
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-secondary active" id="previewModeBtn">
                                        <i class="fas fa-eye me-1"></i><span data-i18n="form.browse">瀏覽</span>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="splitModeBtn">
                                        <i class="fas fa-edit me-1"></i><span data-i18n="form.editMode">編輯</span>
                                    </button>
                                </div>
                                <button type="button" class="btn btn-outline-info btn-sm" id="referenceTestCaseBtn" onclick="openReferenceTestCasePopup()">
                                    <i class="fas fa-search me-1"></i><span data-i18n="testCase.referenceTestCaseButton">參考測試案例</span>
                                </button>
                            </div>
                            <!-- 操作按鈕 -->
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                                <button type="button" class="btn btn-outline-success" id="cloneAndAddNextBtn" style="display: none;">
                                    <i class="fas fa-clone me-2"></i><span data-i18n="testCase.cloneAndAddNext">複製並新增下一筆</span>
                                </button>
                                <button type="button" class="btn btn-success" id="saveAndAddNextBtn" disabled style="display: none;">
                                    <i class="fas fa-plus me-2"></i><span data-i18n="form.saveAndNext">儲存並新增下一筆</span>
                                </button>
                                <button type="button" class="btn btn-primary" id="saveTestCaseBtn" disabled>
                                    <i class="fas fa-save me-2"></i><span data-i18n="common.save">儲存</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 批次修改模態框 -->
<div class="modal fade" id="testCaseBatchModifyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit text-primary me-2"></i>
                    <span data-i18n="testCase.batchModify">批次修改</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">
                    <span data-i18n="testCase.batchModifyDescription">將對選中的</span>
                    <strong id="testCaseBatchModifyCount">0</strong>
                    <span data-i18n="testCase.itemsApplyChanges">個測試案例套用以下變更：</span>
                </p>
                
                <!-- TCG 單號批次設定 -->
                <div class="mb-3">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="batchModifyTCG" checked>
                        <label class="form-check-label" for="batchModifyTCG">
                            <strong data-i18n="testCase.batchSetTCG">批次設定 TCG 單號</strong>
                        </label>
                    </div>
                    <div class="position-relative">
                        <!-- 顯示已選 TCG 的 tag 區塊，點擊可進入編輯 -->
                        <div id="batchTCGContainer" class="tcg-edit-area" data-i18n-title="tooltips.clickEditTcg" style="min-height: 32px; display: flex; align-items: center; gap: 6px; flex-wrap: wrap; cursor: pointer;"></div>
                        <!-- 隱藏欄位：儲存多選值，以逗號+空白串接，沿用既有提交流程 -->
                        <input type="hidden" id="batchTCGInput" value="">
                        <!-- Dropdown 區塊（與列表一致） -->
                        <div id="batchTCGDropdown" 
                             style="position: fixed; z-index: 1070; max-height: 220px; overflow-y: auto; display: none; background: white; border: 1px solid #ced4da; border-radius: 0.375rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                            <div class="p-2 text-muted small" data-i18n="testCase.tcgSearchHint">開始輸入以搜尋 TCG...</div>
                        </div>
                    </div>
                    <small class="text-muted" data-i18n="testCase.tcgClearHint">留空可清除 TCG 關聯</small>
                </div>
                
                <!-- 優先級批次設定 -->
                <div class="mb-3">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="batchModifyPriority">
                        <label class="form-check-label" for="batchModifyPriority">
                            <strong data-i18n="testCase.batchSetPriority">批次設定優先級</strong>
                        </label>
                    </div>
                    <select class="form-select" id="batchPrioritySelect" disabled>
                        <option value="" data-i18n="testCase.selectPriority">請選擇優先級</option>
                        <option value="High" data-i18n="testCase.priorityHigh">高</option>
                        <option value="Medium" data-i18n="testCase.priorityMedium">中</option>
                        <option value="Low" data-i18n="testCase.priorityLow">低</option>
                    </select>
                </div>
                
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    <span data-i18n="testCase.batchModifyNote">只會套用已勾選的項目，空白值將不會變更現有資料。</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-primary" id="confirmTestCaseBatchModifyBtn">
                    <i class="fas fa-edit me-2"></i><span data-i18n="testCase.confirmModify">確認修改</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 刪除確認 Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i><span data-i18n="form.deleteConfirmation">確認刪除</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning mb-3" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>警告：</strong><span data-i18n="form.deleteWarning">刪除操作無法復原，請謹慎確認</span>
                </div>
                <div id="deleteList">
                    <!-- 要刪除的項目列表 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash me-2"></i><span data-i18n="common.delete">確認刪除</span>
                </button>
            </div>
        </div>
    </div>
</div>


<!-- 批次複製 Modal -->
<div class="modal fade" id="testCaseBatchCopyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-copy me-2"></i>
                    <span data-i18n="testCase.batchCopy.title">批次複製</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 功能列 -->
                <div class="row g-3 align-items-end mb-3">
                    <div class="col-md-auto">
                        <div class="input-group">
                            <span class="input-group-text py-1" data-i18n="testCase.batchCopy.prefix">Prefix</span>
                            <input type="text" class="form-control form-control-sm flex-grow-0 w-auto" id="copyPrefixInput" placeholder="TCG-93178" style="max-width:16ch;" />
                            <button class="btn btn-outline-primary btn-sm" id="applyCopyPrefixBtn"><span data-i18n="testCase.batchCopy.apply">Apply</span></button>
                        </div>
                    </div>
                    <div class="col-md-auto">
                        <div class="input-group">
                            <span class="input-group-text py-1" data-i18n="testCase.batchCopy.middleCode">Middle Code</span>
                            <input type="text" class="form-control form-control-sm flex-grow-0 w-auto" id="copyMiddleInput" placeholder="010" style="max-width:6ch;" />
                            <button class="btn btn-outline-primary btn-sm" id="applyCopyMiddleBtn"><span data-i18n="testCase.batchCopy.apply">Apply</span></button>
                        </div>
                    </div>
                    <div class="col-md-auto">
                        <div class="input-group">
                            <span class="input-group-text py-1" data-i18n="testCase.batchCopy.suffixStart">Suffix (Start)</span>
                            <input type="text" class="form-control form-control-sm flex-grow-0 w-auto" id="copySuffixStartInput" placeholder="020" style="max-width:6ch;" />
                            <button class="btn btn-outline-primary btn-sm" id="applyCopySuffixBtn"><span data-i18n="testCase.batchCopy.apply">Apply</span></button>
                        </div>
                    </div>
                </div>
                
                <!-- 選取統計：移除顯示數量 -->

                <!-- 列表 -->
                <div class="table-responsive" style="max-height: 52vh; overflow: auto;">
                    <table class="table table-hover table-sm align-middle">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="width:40px;" class="text-center">
                                    <input type="checkbox" class="form-check-input" id="batchCopySelectAllTop">
                                </th>
                                <th style="width:220px;" data-i18n="testCase.testCaseNumber">Test Case Number</th>
                                <th style="width: 220px;" data-i18n="form.title">標題</th>
                            </tr>
                        </thead>
                        <tbody id="batchCopyTableBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-primary" id="saveBatchCopyBtn">
                    <i class="fas fa-save me-2"></i><span data-i18n="testCase.batchCopy.save">儲存</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 批次複製預覽 Modal -->
<div class="modal fade" id="batchCopyPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-list-check me-2"></i>
                    <span data-i18n="testCase.batchCopy.previewTitle">確認新增列表</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive" style="max-height: 400px;">
                    <table class="table table-hover table-sm">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="width: 40px;">#</th>
                                <th style="width: 200px;" data-i18n="testCase.testCaseNumber">測試案例編號</th>
                                <th data-i18n="form.title">標題</th>
                                <th style="width: 180px;" data-i18n="testCase.preconditions">前置條件</th>
                                <th style="width: 220px;" data-i18n="testCase.steps">測試步驟</th>
                                <th style="width: 220px;" data-i18n="testCase.expectedResults">預期結果</th>
                                <th style="width: 100px;" data-i18n="testCase.priority">優先級</th>
                            </tr>
                        </thead>
                        <tbody id="batchCopyPreviewList"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-primary" id="confirmBatchCopyBtn">
                    <i class="fas fa-check me-2"></i><span data-i18n="common.confirm">確認</span>
                </button>
            </div>
        </div>
    </div>
</div>


<!-- 大量新增 Test Case Modal (文字模式) -->
<div class="modal fade" id="bulkCreateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable modal-fullscreen-md-down" style="max-width: 90vw;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-layer-group me-2"></i>
                    <span data-i18n="testCase.bulkText.title">批次建立測試案例（文字模式）</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 說明文字 -->
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    <span data-i18n="testCase.bulkText.help">每行一筆資料，格式為「單號,標題」。單號可不連續。</span>
                    <div class="mt-2">
                        <a href="/static/samples/bulk_test_cases_sample.csv" class="link-dark text-decoration-underline" download data-i18n="testCase.bulkText.sampleLink">下載範例 CSV</a>
                    </div>
                </div>
                
                <!-- 文字輸入區 -->
                <div class="mb-3">
                    <textarea 
                        id="bulkTextInput" 
                        class="form-control font-monospace" 
                        rows="14" 
                        data-i18n-placeholder="testCase.bulkText.placeholder"
                        placeholder="TC-1001,登入驗證,\"確認測試帳號存在\",\"1. 開啟登入頁; 2. 輸入正確帳密\",\"顯示主控台\",High
TC-1002,錯誤密碼流程,,輸入錯誤密碼,顯示錯誤訊息,Low
TC-1003,API 健康檢查,\"服務已啟動\",\"發送 GET /health\",\"回傳 200\",Medium"></textarea>
                </div>
                
                <!-- 狀態列 -->
                <div class="d-flex justify-content-between align-items-center">
                    <div id="bulkTextStatus" class="text-muted small">
                        <!-- 動態顯示解析狀態 -->
                    </div>
                    <div id="bulkTextValidation" class="text-danger small">
                        <!-- 顯示驗證錯誤 -->
                    </div>
                </div>
                
                <!-- 進度條（建立時顯示） -->
                <div id="bulkProgress" style="display:none" class="mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <small class="text-muted" data-i18n="testCase.bulk.creating">建立中...</small>
                        <small class="text-muted" id="bulkProgressText">0/0</small>
                    </div>
                    <div class="progress" style="height:8px;">
                        <div class="progress-bar bg-primary" id="bulkProgressBar" style="width:0%"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="testCase.bulkTextButton.cancel">取消</button>
                <button type="button" class="btn btn-primary" id="startBulkCreateBtn">
                    <i class="fas fa-save me-2"></i><span data-i18n="testCase.bulkTextButton.save">儲存</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 預覽確認 Modal -->
<div class="modal fade" id="bulkPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable" style="max-width: 90vw;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-list-check me-2"></i>
                    <span data-i18n="testCase.bulkText.confirmTitle">確認新增列表</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted" id="bulkPreviewDesc">
                    <!-- 動態顯示數量 -->
                </p>
                <div class="table-responsive" style="max-height: 560px;">
                    <table class="table table-hover table-sm">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="width: 40px;">#</th>
                                <th style="width: 200px;" data-i18n="testCase.testCaseNumber">測試案例編號</th>
                                <th data-i18n="form.title">標題</th>
                                <th style="width: 180px;" data-i18n="testCase.preconditions">前置條件</th>
                                <th style="width: 220px;" data-i18n="testCase.steps">測試步驟</th>
                                <th style="width: 220px;" data-i18n="testCase.expectedResults">預期結果</th>
                                <th style="width: 280px; min-width: 21ch;" data-i18n="testCase.tcgColumn">TCG 單號</th>
                                <th style="width: 100px;" data-i18n="testCase.priority">優先級</th>
                            </tr>
                        </thead>
                        <tbody id="bulkPreviewList">
                            <!-- 動態產生預覽列表 -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="testCase.bulkTextButton.cancel">取消</button>
                <button type="button" class="btn btn-primary" id="confirmBulkCreateBtn">
                    <i class="fas fa-check me-2"></i><span data-i18n="testCase.bulkTextButton.confirm">確認新增</span>
                </button>
            </div>
        </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
// 與執行頁共用的 Test Case 詳細快取設定（localStorage）
const EXEC_TC_CACHE_PREFIX = 'tr_exec_tc_cache_v1';
const EXEC_TC_CACHE_TTL_MS = 60 * 60 * 1000; // 1 小時

function setExecCachedTestCase(testCaseNumber, data) {
    try {
        const teamId = getTeamIdForCache(false);
        if (!teamId) { console.debug('[CACHE] SKIP WRITE exec: no valid teamId', { testCaseNumber }); return; } // 沒有有效 teamId 就不寫入，避免污染
        console.debug('[CACHE] QUEUE WRITE exec', { teamId, testCaseNumber });
        // 非阻塞寫入 TRCache（IndexedDB + gzip）
        Promise.resolve().then(() => TRCache.setExecDetail(teamId, testCaseNumber, data)).catch(()=>{});
    } catch (_) {}
}

function removeExecCachedTestCase(testCaseNumber) {
    try {
        const teamId = getTeamIdForCache(false);
        if (!teamId || !testCaseNumber) return;
        Promise.resolve().then(() => TRCache.removeExecDetail(teamId, testCaseNumber)).catch(()=>{});
    } catch (_) {}
}

let testCases = [];
let filteredTestCases = [];
let selectedTestCases = new Set();
// Shift 連續多選錨點（Test Case Management）
let lastCaseCheckboxIndex = null;
let currentPage = 1;
let currentTestCaseIndex = -1; // 當前檢視測試案例在 filteredTestCases 中的索引
let pageSize = 50;
let markdownEditor = null;

// TCG 快取相關變數
let tcgCache = null;
let tcgCacheTimestamp = null;
const TCG_CACHE_KEY = 'tcg_cache';
const TCG_CACHE_TIMESTAMP_KEY = 'tcg_cache_timestamp';
const TCG_CACHE_EXPIRY = 24 * 60 * 60 * 1000; // 24小時過期

// ===== 排序狀態（TCM） =====
let tcmSortField = 'number'; // number|title|tcg|priority|created|updated
let tcmSortOrder = 'asc';    // asc|desc

// ===== 篩選器持久化（依 team 隔離） =====
const TCM_FILTERS_STORAGE_PREFIX = 'tcm_filters_v1';

const TEST_CASE_UPDATE_EVENT_KEY = 'testCaseUpdatedEvent';

function broadcastTestCaseUpdate(testCase, overrides = {}) {
    try {
        const teamId = getTeamIdForCache(true);
        if (!teamId || !testCase || !testCase.test_case_number) return;
        const priorityValue = (() => {
            if (!testCase.priority) return '';
            if (typeof testCase.priority === 'string') return testCase.priority;
            if (testCase.priority && typeof testCase.priority === 'object') {
                if (typeof testCase.priority.value === 'string') return testCase.priority.value;
                if (typeof testCase.priority.name === 'string') return testCase.priority.name;
            }
            return '';
        })();
        const payload = {
            teamId: String(teamId),
            test_case_number: testCase.test_case_number,
            title: testCase.title || '',
            priority: priorityValue,
            precondition: testCase.precondition || '',
            steps: testCase.steps || '',
            expected_result: testCase.expected_result || '',
            timestamp: Date.now(),
            ...overrides
        };
        localStorage.setItem(TEST_CASE_UPDATE_EVENT_KEY, JSON.stringify(payload));
    } catch (err) {
        console.debug('broadcastTestCaseUpdate skipped:', err);
    }
}

function getTcmFiltersStorageKey() {
    try {
        // 與快取相同邏輯取 teamId（優先 URL，再 AppUtils，再 sessionStorage 容錯）
        const teamId = getTeamIdForCache(false);
        return teamId ? `${TCM_FILTERS_STORAGE_PREFIX}:${String(teamId)}` : null;
    } catch (_) { return null; }
}

function saveTcmFiltersToStorage(filters) {
    try {
        const key = getTcmFiltersStorageKey();
        if (!key) return;
        const payload = {
            testCaseNumberSearch: String(filters.testCaseNumberSearch || ''),
            searchInput: String(filters.searchInput || ''),
            tcgFilter: String(filters.tcgFilter || ''),
            priorityFilter: String(filters.priorityFilter || ''),
            ts: Date.now()
        };
        localStorage.setItem(key, JSON.stringify(payload));
    } catch (_) {}
}

function loadTcmFiltersFromStorage() {
    try {
        const key = getTcmFiltersStorageKey();
        if (!key) return null;
        const raw = localStorage.getItem(key);
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (!obj || typeof obj !== 'object') return null;
        return {
            testCaseNumberSearch: obj.testCaseNumberSearch || '',
            searchInput: obj.searchInput || '',
            tcgFilter: obj.tcgFilter || '',
            priorityFilter: obj.priorityFilter || ''
        };
    } catch (_) { return null; }
}

function clearTcmFiltersInStorage() {
    try {
        const key = getTcmFiltersStorageKey();
        if (!key) return;
        localStorage.removeItem(key);
    } catch (_) {}
}

function restoreTcmFiltersToUI() {
    const saved = loadTcmFiltersFromStorage();
    if (!saved) return false;
    try {
        const elNum = document.getElementById('testCaseNumberSearch');
        const elSearch = document.getElementById('searchInput');
        const elTCG = document.getElementById('tcgFilter');
        const elPri = document.getElementById('priorityFilter');
        if (elNum) elNum.value = saved.testCaseNumberSearch || '';
        if (elSearch) elSearch.value = saved.searchInput || '';
        if (elTCG) elTCG.value = saved.tcgFilter || '';
        if (elPri) elPri.value = saved.priorityFilter || '';
        updateFilterStatus();
        // 同步到記憶體中的目前過濾器
        tcmCurrentFilters.testCaseNumberSearch = saved.testCaseNumberSearch || '';
        tcmCurrentFilters.searchInput = saved.searchInput || '';
        tcmCurrentFilters.tcgFilter = saved.tcgFilter || '';
        tcmCurrentFilters.priorityFilter = saved.priorityFilter || '';
        return (saved.testCaseNumberSearch || saved.searchInput || saved.tcgFilter || saved.priorityFilter) ? true : false;
    } catch (_) { return false; }
}

// 目前過濾器（常駐於記憶體，不依賴 UI）
let tcmCurrentFilters = { testCaseNumberSearch: '', searchInput: '', tcgFilter: '', priorityFilter: '' };

function computeFilteredTestCases(list) {
    try {
        const numKW = String(tcmCurrentFilters.testCaseNumberSearch || '').toLowerCase();
        const kw = String(tcmCurrentFilters.searchInput || '').toLowerCase();
        const tcgKW = String(tcmCurrentFilters.tcgFilter || '').toLowerCase();
        const pri = String(tcmCurrentFilters.priorityFilter || '');
        const res = (list || []).filter(testCase => {
            // Test Case Number 或 TCG（綜合）搜尋
            const matchNum = !numKW ||
                (testCase.test_case_number && String(testCase.test_case_number).toLowerCase().includes(numKW)) ||
                (testCase.tcg && testCase.tcg.some(tcgItem => {
                    const tcgText = (tcgItem && (tcgItem.text || tcgItem)) || '';
                    return String(tcgText).toLowerCase().includes(numKW);
                }));
            // 專用 TCG 單號過濾器（精確針對 TCG 欄位）
            const matchTCG = !tcgKW || (testCase.tcg && testCase.tcg.some(tcgItem => {
                // 支援 text 與 text_arr
                const texts = [];
                if (tcgItem && Array.isArray(tcgItem.text_arr) && tcgItem.text_arr.length) {
                    texts.push(...tcgItem.text_arr);
                }
                if (tcgItem && tcgItem.text) {
                    texts.push(tcgItem.text);
                }
                return texts.some(t => String(t || '').toLowerCase().includes(tcgKW));
            }));
            // 標題/描述關鍵字
            const matchSearch = !kw ||
                (testCase.title && String(testCase.title).toLowerCase().includes(kw)) ||
                (testCase.description && String(testCase.description).toLowerCase().includes(kw));
            // 優先級
            const matchPri = !pri || testCase.priority === pri;
            return matchNum && matchTCG && matchSearch && matchPri;
        });
        return res;
    } catch (_) { return Array.isArray(list) ? list.slice() : []; }
}

function applyCurrentFiltersAndRender() {
    try {
        filteredTestCases = computeFilteredTestCases(testCases);
        currentPage = 1;
        renderTestCasesTable();
        updatePagination();
        updateFilterStatus();
    } catch (_) {
        // 回退：顯示全量
        filteredTestCases = Array.isArray(testCases) ? testCases.slice() : [];
        currentPage = 1;
        renderTestCasesTable();
        updatePagination();
        updateFilterStatus();
    }
}

function setTcmSort(field) {
    if (tcmSortField === field) {
        tcmSortOrder = (tcmSortOrder === 'asc') ? 'desc' : 'asc';
    } else {
        tcmSortField = field;
        tcmSortOrder = 'asc';
    }
    renderTestCasesTable();
}

function updateTcmSortIndicators() {
    try {
        const map = {
            number: document.querySelector('#th-tcm-number .sort-indicator'),
            title: document.querySelector('#th-tcm-title .sort-indicator'),
            tcg: document.querySelector('#th-tcm-tcg .sort-indicator'),
            priority: document.querySelector('#th-tcm-priority .sort-indicator'),
            created: document.querySelector('#th-tcm-created .sort-indicator'),
            updated: document.querySelector('#th-tcm-updated .sort-indicator')
        };
        Object.values(map).forEach(el => { if (el) el.textContent = ''; });
        const target = map[tcmSortField];
        if (target) target.textContent = (tcmSortOrder === 'asc') ? '▲' : '▼';
    } catch (_) {}
}

// 強制同步篩選欄位的 placeholder（防止極端情境未翻譯）
function updateTcmPlaceholders() {
    try {
        if (!window.i18n || !window.i18n.isReady()) return;
        const elNum = document.getElementById('testCaseNumberSearch');
        const elSearch = document.getElementById('searchInput');
        const elTCG = document.getElementById('tcgFilter');
        if (elNum) elNum.setAttribute('placeholder', window.i18n.t('testCase.testCaseNumberPlaceholder', {}, elNum.getAttribute('data-i18n-placeholder-fallback') || ''));
        if (elSearch) elSearch.setAttribute('placeholder', window.i18n.t('testCase.searchPlaceholder', {}, elSearch.getAttribute('data-i18n-placeholder-fallback') || ''));
        if (elTCG) elTCG.setAttribute('placeholder', window.i18n.t('testCase.tcgFilterPlaceholder', {}, elTCG.getAttribute('data-i18n-placeholder-fallback') || ''));
    } catch (_) {}
}

function sortFilteredTestCases() {
    const priRank = v => ({ High: 3, Medium: 2, Low: 1 }[v] || 0);
    const parseNumberSegments = str => {
        try {
            if (!str) return [];
            const ms = String(str).match(/\d+/g);
            return ms ? ms.map(s => parseInt(s, 10)) : [];
        } catch (_) { return []; }
    };
    const compareByNumericParts = (aStr, bStr) => {
        const aSeg = parseNumberSegments(aStr);
        const bSeg = parseNumberSegments(bStr);
        const len = Math.min(aSeg.length, bSeg.length);
        for (let i = 0; i < len; i++) {
            if (aSeg[i] !== bSeg[i]) return aSeg[i] - bSeg[i];
        }
        return aSeg.length - bSeg.length;
    };
    const getFirstTCGNumber = tc => {
        try {
            if (!tc || !tc.tcg || !tc.tcg.length) return '';
            for (const r of tc.tcg) {
                if (r && Array.isArray(r.text_arr) && r.text_arr.length) return r.text_arr[0];
                if (r && r.text) return r.text;
            }
            return '';
        } catch (_) { return ''; }
    };
    const cmp = (a, b) => {
        let av = '', bv = '';
        switch (tcmSortField) {
            case 'number':
                av = a.test_case_number || '';
                bv = b.test_case_number || '';
                return compareByNumericParts(av, bv);
            case 'title':
                av = (a.title || '').toLowerCase();
                bv = (b.title || '').toLowerCase();
                return av.localeCompare(bv);
            case 'tcg':
                av = getFirstTCGNumber(a);
                bv = getFirstTCGNumber(b);
                return compareByNumericParts(av, bv);
            case 'priority':
                return priRank(a.priority) - priRank(b.priority);
            case 'created':
                return new Date(a.created_at || 0) - new Date(b.created_at || 0);
            case 'updated':
                return new Date(a.updated_at || 0) - new Date(b.updated_at || 0);
            default:
                return 0;
        }
    };
    try {
        filteredTestCases.sort((a, b) => {
            const r = cmp(a, b);
            return tcmSortOrder === 'asc' ? r : -r;
        });
    } catch (_) {}
}

// ===== 統一快取管理模組 =====
const TEST_CASES_CACHE_KEY = 'test_cases_list_cache_v1';
const TEST_CASES_CACHE_TTL = 60 * 60 * 1000; // 1小時

// 取得用於快取的 teamId：
// - 先取 AppUtils.getCurrentTeam().id
// - 再取 URL 查詢參數 team_id/teamId/team
// - 最後可選用 sessionStorage('lastTeamId') 作為容錯
// strict=true: 無法解析就回傳 null（不讀不寫）
function getTeamIdForCache(strict = true) {
    // 1) 以 URL 為權威（使用者導航後最準確）
    try {
        const p = new URLSearchParams(window.location.search);
        const id = p.get('team_id') || p.get('teamId') || p.get('team');
        if (id) {
            try { sessionStorage.setItem('lastTeamId', String(id)); } catch (_) {}
            return String(id);
        }
    } catch (_) {}
    // 2) 次選 AppUtils（有時初始化較慢或不同步）
    try {
        if (typeof AppUtils !== 'undefined' && AppUtils.getCurrentTeam) {
            const t = AppUtils.getCurrentTeam();
            if (t && t.id) {
                try { sessionStorage.setItem('lastTeamId', String(t.id)); } catch (_) {}
                return String(t.id);
            }
        }
    } catch (_) {}
    // 3) 非嚴格模式時，退回上一個已知值
    if (!strict) {
        try {
            const last = sessionStorage.getItem('lastTeamId');
            if (last) return String(last);
        } catch (_) {}
    }
    return null;
}

function getTestCasesCache(teamIdOverride = null) {
    try {
        const teamId = teamIdOverride ? String(teamIdOverride) : getTeamIdForCache(true);
        if (!teamId) return null; // 無有效 teamId，避免讀取共享或錯誤快取
        const cacheKey = `${TEST_CASES_CACHE_KEY}:${teamId}`;
        const cached = localStorage.getItem(cacheKey);
        if (cached) {
            const data = JSON.parse(cached);
            if (data && data.timestamp && data.testCases && Array.isArray(data.testCases)) {
                const age = Date.now() - data.timestamp;
                if (age < TEST_CASES_CACHE_TTL) {
                    console.log(`使用快取的測試案例清單 (${data.testCases.length} 筆，${Math.round(age/1000)}秒前)`);
                    console.debug('[CACHE] HIT list', { teamId, cacheKey, ageMs: age, count: data.testCases.length });
                    return data.testCases;
                }
                console.debug('[CACHE] MISS list: expired', { teamId, cacheKey, ageMs: age });
            }
            else { console.debug('[CACHE] MISS list: malformed cache payload', { teamId, cacheKey }); }
        }
        else { console.debug('[CACHE] MISS list: not found', { teamId, cacheKey }); }
    } catch (error) {
        console.debug('讀取測試案例快取失敗:', error);
    }
    return null;
}

function setTestCasesCache(testCases, teamIdOverride = null) {
    try {
        const teamId = teamIdOverride ? String(teamIdOverride) : getTeamIdForCache(true);
        if (!teamId) { console.debug('[CACHE] SKIP WRITE list: no valid teamId', { count: Array.isArray(testCases) ? testCases.length : 0 }); return; }
        const cacheKey = `${TEST_CASES_CACHE_KEY}:${teamId}`;
        const cacheData = { timestamp: Date.now(), testCases: testCases || [] };

        const trySet = (dataObj) => {
            localStorage.setItem(cacheKey, JSON.stringify(dataObj));
        };

        let wrote = false;
        try {
            trySet(cacheData);
            wrote = true;
        } catch (err) {
            if (err && (err.name === 'QuotaExceededError' || err.code === 22)) {
                console.warn('[CACHE] WRITE list failed: quota exceeded. Trying compact payload...', { teamId, cacheKey });
                // 1) 建立精簡版 payload（只保留列表需要欄位）
                const compactCases = (testCases || []).map(tc => ({
                    record_id: tc.record_id,
                    test_case_number: tc.test_case_number,
                    title: tc.title,
                    priority: tc.priority,
                    created_at: tc.created_at,
                    updated_at: tc.updated_at,
                    // 精簡 TCG 結構，保留必要顯示資訊
                    tcg: Array.isArray(tc.tcg) ? tc.tcg.map(r => ({
                        text: r && r.text ? r.text : undefined,
                        text_arr: r && Array.isArray(r.text_arr) ? r.text_arr.slice(0, 3) : undefined
                    })) : []
                }));
                const compactData = { timestamp: Date.now(), testCases: compactCases };
                try {
                    trySet(compactData);
                    wrote = true;
                    console.warn('[CACHE] WRITE list using compact payload succeeded', { teamId, count: compactCases.length });
                } catch (err2) {
                    if (err2 && (err2.name === 'QuotaExceededError' || err2.code === 22)) {
                        console.warn('[CACHE] Compact payload still exceeds quota. Trying to shrink list size...', { teamId });
                        // 2) 逐步縮減筆數直到可以寫入或降到 0
                        let low = 0;
                        let high = compactCases.length;
                        let best = -1;
                        while (low <= high) {
                            const mid = Math.floor((low + high) / 2);
                            const sliceData = { timestamp: Date.now(), testCases: compactCases.slice(0, mid) };
                            try {
                                trySet(sliceData);
                                best = mid;
                                low = mid + 1; // 試更大
                            } catch (e3) {
                                if (e3 && (e3.name === 'QuotaExceededError' || e3.code === 22)) {
                                    high = mid - 1; // 試更小
                                } else {
                                    throw e3;
                                }
                            }
                        }
                        if (best >= 0) {
                            wrote = true;
                            console.warn('[CACHE] WRITE list succeeded after shrinking', { teamId, writtenCount: best });
                        } else {
                            console.warn('[CACHE] WRITE list failed even after shrinking. Skipping persistent cache.', { teamId });
                        }
                    } else {
                        console.debug('儲存測試案例快取失敗:', err2);
                    }
                }
            } else {
                console.debug('儲存測試案例快取失敗:', err);
            }
        }

        if (wrote) {
            console.log(`測試案例清單已快取 (${(testCases && testCases.length) || 0} 筆)`);
            console.debug('[CACHE] WRITE list', { teamId, cacheKey, count: testCases ? testCases.length : 0 });
        }
        // 同時更新個別快取
        if (testCases && Array.isArray(testCases)) {
            testCases.forEach(tc => {
                if (tc.test_case_number) setExecCachedTestCase(tc.test_case_number, tc);
            });
        }
    } catch (error) {
        console.debug('儲存測試案例快取失敗:', error);
    }
}

function clearTestCasesCache() {
    try {
        const teamId = getTeamIdForCache(true);
        if (!teamId) { console.debug('[CACHE] SKIP CLEAR list: no valid teamId'); return; }
        const cacheKey = `${TEST_CASES_CACHE_KEY}:${teamId}`;
        // 清除列表快取
        localStorage.removeItem(cacheKey);
        // 清除所有相關的個別快取
        const keys = Object.keys(localStorage);
        keys.forEach(key => {
            if (key.startsWith(EXEC_TC_CACHE_PREFIX) && key.includes(`:${teamId}:`)) {
                localStorage.removeItem(key);
            }
        });
        console.log('測試案例快取已清除');
    } catch (error) {
        console.debug('清除測試案例快取失敗:', error);
    }
}

function updateTestCaseInCache(testCase) {
    try {
        const teamId = getTeamIdForCache(true);
        if (!teamId) { console.debug('[CACHE] SKIP UPDATE list: no valid teamId', { testCase: testCase && testCase.test_case_number }); return; }
        const cacheKey = `${TEST_CASES_CACHE_KEY}:${teamId}`;
        const cached = localStorage.getItem(cacheKey);
        if (cached) {
            const data = JSON.parse(cached);
            if (data && data.testCases && Array.isArray(data.testCases)) {
                const index = data.testCases.findIndex(tc => tc.record_id === testCase.record_id);
                if (index >= 0) {
                    data.testCases[index] = testCase;
                    localStorage.setItem(cacheKey, JSON.stringify(data));
                    console.log(`測試案例快取已更新: ${testCase.test_case_number}`);
                    console.debug('[CACHE] UPDATE list item', { teamId, cacheKey, testCase: testCase.test_case_number });
                }
                else { console.debug('[CACHE] UPDATE skipped: record not found in cache list', { teamId, recordId: testCase.record_id }); }
            }
            else { console.debug('[CACHE] UPDATE skipped: malformed cache payload', { teamId }); }
        }
        else { console.debug('[CACHE] UPDATE skipped: list cache not found', { teamId }); }
        if (testCase.test_case_number) setExecCachedTestCase(testCase.test_case_number, testCase);
        broadcastTestCaseUpdate(testCase);
    } catch (error) {
        console.debug('更新測試案例快取失敗:', error);
    }
}

function removeTestCaseFromCache(recordId, fallbackTestCase = null) {
    try {
        const teamId = getTeamIdForCache(true);
        if (!teamId) { console.debug('[CACHE] SKIP REMOVE list: no valid teamId', { recordId }); return; }
        const cacheKey = `${TEST_CASES_CACHE_KEY}:${teamId}`;
        const cached = localStorage.getItem(cacheKey);
        if (cached) {
            const data = JSON.parse(cached);
            if (data && data.testCases && Array.isArray(data.testCases)) {
                const removedTestCase = data.testCases.find(tc => tc.record_id === recordId);
                data.testCases = data.testCases.filter(tc => tc.record_id !== recordId);
                localStorage.setItem(cacheKey, JSON.stringify(data));
                let payloadCase = removedTestCase || fallbackTestCase || null;
                if (payloadCase && payloadCase.test_case_number) {
                    removeExecCachedTestCase(payloadCase.test_case_number);
                    broadcastTestCaseUpdate(payloadCase, { deleted: true });
                }
                console.log(`測試案例已從快取移除: ${recordId}`);
                console.debug('[CACHE] REMOVE list item', { teamId, cacheKey, recordId });
            }
            else { console.debug('[CACHE] REMOVE skipped: malformed cache payload', { teamId }); }
        }
        else {
            const payloadCase = fallbackTestCase || null;
            if (payloadCase && payloadCase.test_case_number) {
                removeExecCachedTestCase(payloadCase.test_case_number);
                broadcastTestCaseUpdate(payloadCase, { deleted: true });
            }
            console.debug('[CACHE] REMOVE skipped: list cache not found', { teamId, recordId });
        }
    } catch (error) {
        console.debug('從快取移除測試案例失敗:', error);
    }
}

function addTestCaseToCache(testCase) {
    try {
        const teamId = getTeamIdForCache(true);
        if (!teamId) { console.debug('[CACHE] SKIP ADD list: no valid teamId', { testCase: testCase && testCase.test_case_number }); return; }
        const cacheKey = `${TEST_CASES_CACHE_KEY}:${teamId}`;
        const cached = localStorage.getItem(cacheKey);
        if (cached) {
            const data = JSON.parse(cached);
            if (data && data.testCases && Array.isArray(data.testCases)) {
                const exists = data.testCases.some(tc => tc.record_id === testCase.record_id);
                if (!exists) {
                    data.testCases.push(testCase);
                    localStorage.setItem(cacheKey, JSON.stringify(data));
                    console.log(`新測試案例已加入快取: ${testCase.test_case_number}`);
                    console.debug('[CACHE] ADD list item', { teamId, cacheKey, testCase: testCase.test_case_number });
                }
                else { console.debug('[CACHE] ADD skipped: already exists', { teamId, recordId: testCase.record_id }); }
            }
            else { console.debug('[CACHE] ADD skipped: malformed cache payload', { teamId }); }
        }
        else { console.debug('[CACHE] ADD skipped: list cache not found (will be created on next full set)', { teamId }); }
        if (testCase.test_case_number) setExecCachedTestCase(testCase.test_case_number, testCase);
        broadcastTestCaseUpdate(testCase);
    } catch (error) {
        console.debug('加入測試案例到快取失敗:', error);
    }
}

document.addEventListener('DOMContentLoaded', async function() {
    // 監聽全域 team 變更事件，隨時更新 URL 的 team_id
    try {
        window.addEventListener('teamChanged', function(e) {
            const newTeam = e && e.detail && e.detail.team;
            if (newTeam && newTeam.id) {
                ensureTeamIdInUrl_TCM(newTeam.id);
                try { sessionStorage.setItem('lastTeamId', String(newTeam.id)); } catch (_) {}
                // 切換 team 後：依新 team 的儲存狀態還原（若無儲存則等同清空），並重新渲染
                try {
                    // 嘗試載入該 team 的列表資料（若已載入則僅套用 UI 與篩選）
                    // 先重置 UI 欄位，再依新 team 的儲存覆蓋
                    const elNum = document.getElementById('testCaseNumberSearch');
                    const elSearch = document.getElementById('searchInput');
                    const elPri = document.getElementById('priorityFilter');
                    if (elNum) elNum.value = '';
                    if (elSearch) elSearch.value = '';
                    if (elPri) elPri.value = '';
                    updateFilterStatus();
                    // 還原新 team 的持久化條件（若有）並同步到記憶體
                    restoreTcmFiltersToUI();
                    // 依記憶體中的過濾器立即渲染（不清除快取、不重打 API）
                    filteredTestCases = computeFilteredTestCases(testCases);
                    currentPage = 1;
                    renderTestCasesTable();
                    updatePagination();
                    updateFilterStatus();
                } catch (_) {}
            }
        });
    } catch (_) {}
    try {
        // 先處理 URL 的 team_id，確保後續載入不會因為未選擇團隊而中止
        const urlParams = new URLSearchParams(window.location.search);
        const teamIdParam = urlParams.get('team_id');
        // 嘗試立即更新 placeholder（若 i18n 已就緒）
        updateTcmPlaceholders();
        const mode = urlParams.get('mode') || 'preview';
            const teamId = parseInt(teamIdParam);
            if (!isNaN(teamId)) {
                AppUtils.setCurrentTeam({ id: teamId, name: 'From Test Run' });
            }
        // 確保網址列包含 team_id（不重新載入頁面）
        try {
            const cur = AppUtils.getCurrentTeam && AppUtils.getCurrentTeam();
            if (cur && cur.id) ensureTeamIdInUrl_TCM(cur.id);
        } catch (_) {}
    } catch (_) {}

const urlParams = new URLSearchParams(window.location.search);
    const minimal = urlParams.get('minimal') === '1' || urlParams.get('editor') === '1';
    const tcNumber = urlParams.get('tc') || urlParams.get('test_case_number');
    const mode = urlParams.get('mode') || 'preview';
    const openReference = urlParams.get('ref') === '1' || urlParams.get('ref') === 'true';

    if (minimal && tcNumber) {
        // 最小模式：不載入列表，直接開啟指定測試案例
        try {
            // 綁定事件（包含儲存按鈕）
            bindEvents();
            initializeMarkdownEditor();
            // 隱藏列表與搜尋區塊
            const page = document.getElementById('testCasesPage');
            if (page) {
                const searchCard = document.getElementById('searchFilterCard');
                const tableCard = document.querySelector('#testCasesTable')?.closest('.card');
                if (searchCard) searchCard.style.display = 'none';
                if (tableCard) tableCard.style.display = 'none';
            }
            // 套用最小模式樣式：隱藏頁首/頁尾與背景容器
            try {
                document.body.classList.add('minimal-mode');
                if (!document.getElementById('minimal-mode-style')) {
                    const style = document.createElement('style');
                    style.id = 'minimal-mode-style';
                    style.textContent = `
                        .minimal-mode .app-header, .minimal-mode .app-footer { display: none !important; }
                        .minimal-mode #testCasesPage, .minimal-mode #searchFilterCard, .minimal-mode #loadingProgress, .minimal-mode #testCasesPagination { display: none !important; }
                        body.minimal-mode { overflow: hidden; }
                    `;
                    document.head.appendChild(style);
                }
            } catch (_) {}

            // 直接從 API 抓此測試案例
            const currentTeam = AppUtils.getCurrentTeam();
            if (!currentTeam || !currentTeam.id) throw new Error('請先選擇團隊');
            const resp = await window.AuthClient.fetch(`/api/teams/${currentTeam.id}/testcases/?search=${encodeURIComponent(tcNumber)}&limit=1`);
            if (!resp.ok) throw new Error('載入測試案例失敗');
            const arr = await resp.json();
            const target = Array.isArray(arr) ? arr.find(tc => tc.test_case_number === tcNumber) : null;
            if (target) {
                // 設定最小模式旗標，供顯示 Modal 時使用無背板
                window.__MINIMAL_MODE__ = true;
                showTestCaseModal(target);
                if (mode === 'edit' || mode === 'split') {
                    // 切換為可編輯模式（若可行）
                    try { setEditorMode('split'); } catch (_) {}
                }
            } else {
                showError(window.i18n ? window.i18n.t('errors.testCaseNotFound', {}, '找不到指定的測試案例') : '找不到指定的測試案例');
            }
        } catch (e) {
            console.error('最小模式開啟測試案例失敗:', e);
            // 回退到完整載入
            await initTestCaseManagement();
            bindEvents();
            initializeMarkdownEditor();
        }
    } else {
        // 原本完整流程
        await initTestCaseManagement();
        bindEvents();
        initializeMarkdownEditor();
        // 初始化列表高度（等待初始排版完成）
        setTimeout(adjustTestCasesScrollHeight, 0);
        try {
            if (tcNumber) {
                const openAfterLoad = async () => {
                    if (!Array.isArray(testCases) || testCases.length === 0) {
                        await loadTestCases(false);
                    }
                    const target = testCases.find(tc => (tc.test_case_number === tcNumber) || (tc.record_id === tcNumber));
                    if (target) {
                        showTestCaseModal(target);
                    }
                };
                setTimeout(openAfterLoad, 0);
            }
        } catch (_) {}

        // 若指定 ref=1，載入完成後開啟參考測試案例彈窗
        if (openReference) {
            setTimeout(() => {
                try { openReferenceTestCasePopup(); } catch (e) { console.debug('openReferenceTestCasePopup error:', e); }
            }, 0);
        }
    }
    
    // 添加Modal TCG容器的事件委託（與列表一致）
    document.addEventListener('click', function(e) {
        if (e.target.closest('#modalTcgContainer')) {
            editModalTCG();
        }
    });
});

// Modal TCG 編輯器（與列表一致的體驗）
let currentModalTCGEditor = null;
let modalTCGSearchTimeout = null;
let modalTCGSelected = [];

async function editModalTCG() {
    const container = document.getElementById('modalTcgContainer');
    if (!container) return;
    
    // 如果已經有編輯器在運行，先關閉
    if (currentModalTCGEditor) {
        await finishModalTCGEdit();
    }
    
    // 獲取當前 TCG
    const currentTCGs = Array.isArray(modalTCGSelected) ? [...modalTCGSelected] : [];
    
    // 設置編輯器狀態
    currentModalTCGEditor = {
        container: container,
        originalTCGs: [...currentTCGs],
        currentTCGs: [...currentTCGs],
        originalContent: container.innerHTML,
        mode: 'search'
    };
    
    // 直接進入搜尋模式
    startModalTCGSearch();
}

async function startModalTCGSearch() {
    if (!currentModalTCGEditor) return;
    
    const { container, currentTCGs } = currentModalTCGEditor;
    
    // 直接顯示搜尋框 - 隱藏原標籤
    const searchHtml = `
        <div class="tcg-search-container position-relative" style="min-height: 32px; height: 32px; display: flex; align-items: center; overflow: hidden;">
            <input type="text" class="form-control form-control-sm tcg-search-input" 
                   data-i18n-placeholder="testCase.tcgPlaceholder" autocomplete="off" 
                   onkeydown="handleModalTCGSearchKeydown(event)" 
                   oninput="handleModalTCGSearchInput(event)"
                   onclick="event.stopPropagation()"
                   style="height: 28px; width: 100%; font-size: 0.75rem; padding: 0.125rem 0.375rem; border: 1px solid #dee2e6; box-shadow: none; outline: none;">
            <div class="tcg-dropdown" 
                 style="position: fixed; z-index: 1050; max-height: 300px; overflow-y: auto; display: none; background: white; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div class="p-2 text-muted small">開始輸入以搜尋 TCG...</div>
            </div>
        </div>
    `;
    
    container.innerHTML = searchHtml;
    container.classList.add('editing');
    
    // 更新全域狀態
    modalTCGSelected = [...currentTCGs];
    
    // 聚焦搜尋框並立即載入選項
    const searchInput = container.querySelector('.tcg-search-input');
    searchInput.focus();
    
    // 立即載入 TCG 選項並顯示下拉選單
    await searchModalTCGOptions('');
    const dropdown = container.querySelector('.tcg-dropdown');
    if (dropdown) {
        // 計算輸入框的位置
        const rect = searchInput.getBoundingClientRect();
        
        // 設定 fixed 定位的座標
        dropdown.style.top = (rect.bottom + window.scrollY) + 'px';
        dropdown.style.left = rect.left + 'px';
        dropdown.style.width = Math.max(300, rect.width) + 'px';
        dropdown.style.display = 'block';
    }
    
    // 添加點擊外部結束編輯的監聽器
    setTimeout(() => {
        document.addEventListener('click', handleModalTCGOutsideClick, true);
    }, 100);
}

function handleModalTCGOutsideClick(event) {
    if (!currentModalTCGEditor) return;
    
    const { container } = currentModalTCGEditor;
    
    // 檢查點擊是否在編輯區域外
    const dropdown = container.querySelector('.tcg-dropdown');
    if (!container.contains(event.target) && (!dropdown || !dropdown.contains(event.target))) {
        finishModalTCGEdit();
    }
}

async function finishModalTCGEdit() {
    if (!currentModalTCGEditor) return;
    
    const { container, currentTCGs } = currentModalTCGEditor;
    
    // 移除全域點擊監聽器
    document.removeEventListener('click', handleModalTCGOutsideClick, true);
    
    // 立即更新 UI 顯示
    container.classList.remove('editing');
    renderModalTCGDisplay();
    
    // 更新隱藏 input 值
    const hidden = document.getElementById('tcg');
    if (hidden) hidden.value = modalTCGSelected.join(', ');
    
    // 清除編輯器狀態
    currentModalTCGEditor = null;
}

function renderModalTCGDisplay() {
    const container = document.getElementById('modalTcgContainer');
    if (!container) return;
    
    if (!Array.isArray(modalTCGSelected) || modalTCGSelected.length === 0) {
        // 清除後留白，但保留點擊事件
        container.innerHTML = '<span class="text-muted" style="font-size: 0.875rem;">點擊選擇 TCG 單號</span>';
    } else {
        // 顯示 TCG 標籤，保留點擊事件
        const tcgHtml = modalTCGSelected.map(tcg => 
            `<span class="tcg-tag">${tcg}</span>`
        ).join('');
        container.innerHTML = tcgHtml;
    }
}

// 兼容新的函數名
function updateModalTCGDisplay() {
    renderModalTCGDisplay();
}

function handleModalTCGSearchInput(event) {
    clearTimeout(modalTCGSearchTimeout);
    modalTCGSearchTimeout = setTimeout(async () => {
        await searchModalTCGOptions(event.target.value);
    }, 300);
}

function handleModalTCGSearchKeydown(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        finishModalTCGEdit();
    } else if (event.key === 'Escape') {
        event.preventDefault();
        // 取消變更
        if (currentModalTCGEditor) {
            modalTCGSelected = [...currentModalTCGEditor.originalTCGs];
        }
        finishModalTCGEdit();
    }
}

async function searchModalTCGOptions(keyword) {
    if (!currentModalTCGEditor) return;
    
    const dropdown = currentModalTCGEditor.container.querySelector('.tcg-dropdown');
    if (!dropdown) return;
    
    try {
        console.log('搜尋 Modal TCG:', keyword);
        
        // 優先使用快取
        let results = [];
        if (tcgCache) {
            results = searchTCGFromCache(keyword, 20);
            console.log('從快取取得 Modal TCG 搜尋結果:', results.length, '筆');
        } else {
            // 如果沒有快取，使用 API
            const response = await window.AuthClient.fetch(`/api/tcg/search?keyword=${encodeURIComponent(keyword)}&limit=20`);
            if (!response.ok) {
                console.error('Modal TCG 搜尋失敗:', response.status, response.statusText);
                throw new Error(`搜尋 TCG 失敗: ${response.status}`);
            }
            const data = await response.json();
            results = data.results;
            console.log('從 API 取得 Modal TCG 搜尋結果:', results.length, '筆');
        }
        
        // 始終顯示清除選項作為第一項
        let dropdownHtml = `
            <div class="tcg-option p-2 border-bottom" 
                  onclick="event.stopPropagation(); clearModalTCGValue()" 
                  style="cursor: pointer; border-bottom: 1px solid #f8f9fa; background-color: #fff3cd;" 
                  onmouseover="this.style.backgroundColor='#ffeaa7'" 
                  onmouseout="this.style.backgroundColor='#fff3cd'">
                <div class="fw-medium text-warning">
                    <i class="fas fa-times me-2"></i>清除 TCG 單號
                </div>
            </div>
        `;
        
        if (results.length === 0) {
            dropdownHtml += '<div class="p-2 text-muted small">沒有找到其他結果</div>';
        } else {
            dropdownHtml += results.map(tcg => {
                const selected = modalTCGSelected && modalTCGSelected.includes(tcg.tcg_number);
                return `
                <div class="tcg-option p-2 border-bottom d-flex justify-content-between align-items-center" 
                      onclick="event.stopPropagation(); selectModalTCGOption('${tcg.tcg_number}')" 
                      style="cursor: pointer; border-bottom: 1px solid #f8f9fa; padding: 0.25rem 0.75rem;" 
                      onmouseover="this.style.backgroundColor='#f8f9fa'" 
                      onmouseout="this.style.backgroundColor='white'">
                    <div class="fw-medium">${tcg.tcg_number}</div>
                    ${selected ? '<i class="fas fa-check text-success"></i>' : ''}
                </div>`;
            }).join('');
        }
        
        dropdown.innerHTML = dropdownHtml;
        
        // 更新位置並顯示
        const searchInput = currentModalTCGEditor.container.querySelector('.tcg-search-input');
        if (searchInput) {
            const rect = searchInput.getBoundingClientRect();
            dropdown.style.top = (rect.bottom + window.scrollY) + 'px';
            dropdown.style.left = rect.left + 'px';
            dropdown.style.width = Math.max(300, rect.width) + 'px';
        }
        dropdown.style.display = 'block';
        
    } catch (error) {
        console.error('搜尋 Modal TCG 失敗:', error);
        const searchFailedMessage = window.i18n ? window.i18n.t('errors.searchFailed') : '搜尋失敗';
        dropdown.innerHTML = `<div class="p-2 text-danger small">${searchFailedMessage}</div>`;
        
        // 更新位置並顯示
        const searchInput = currentModalTCGEditor.container.querySelector('.tcg-search-input');
        if (searchInput) {
            const rect = searchInput.getBoundingClientRect();
            dropdown.style.top = (rect.bottom + window.scrollY) + 'px';
            dropdown.style.left = rect.left + 'px';
            dropdown.style.width = Math.max(300, rect.width) + 'px';
        }
        dropdown.style.display = 'block';
    }
}

function selectModalTCGOption(tcgNumber) {
    if (!currentModalTCGEditor) return;
    
    // 多選切換：存在則移除，不存在則加入
    const idx = modalTCGSelected.indexOf(tcgNumber);
    if (idx >= 0) {
        modalTCGSelected.splice(idx, 1);
    } else {
        modalTCGSelected.push(tcgNumber);
    }
    
    // 重新渲染下拉，反映選取狀態（不結束編輯）
    const inputEl = currentModalTCGEditor.container.querySelector('.tcg-search-input');
    const kw = inputEl ? inputEl.value : '';
    searchModalTCGOptions(kw || '');
}

function clearModalTCGValue() {
    if (!currentModalTCGEditor) return;
    
    // 清空 TCG 值
    modalTCGSelected = [];
    
    // 立即完成編輯
    finishModalTCGEdit();
}

// TCG 快取管理函數
async function loadTCGCacheFromStorage() {
    try {
        const cached = await TRCache.getTCG(TCG_CACHE_EXPIRY);
        if (cached && Array.isArray(cached.data)) {
            tcgCache = cached.data;
            tcgCacheTimestamp = cached.ts || Date.now();
            console.log(`載入 TCG 快取 (IndexedDB): ${tcgCache.length} 筆記錄`);
            return true;
        }
    } catch (error) {
        console.error('載入 TCG 快取失敗:', error);
    }
    return false;
}

async function saveTCGCacheToStorage() {
    // 僅保存必要欄位，並以 TRCache（IndexedDB + gzip）存放
    const compact = Array.isArray(tcgCache)
        ? tcgCache.map(item => ({ tcg_number: item.tcg_number, title: item.title }))
        : [];
    await TRCache.setTCG(compact);
    adjustTestCasesScrollHeight();
}


function shouldUpdateTCGCache() {
    // 檢查是否需要更新快取
    if (!tcgCache) return true; // 沒有快取
    if (tcgCacheTimestamp && (Date.now() - tcgCacheTimestamp) > TCG_CACHE_EXPIRY) return true; // 過期
    return false;
}

async function loadTCGCache(updateProgress = null) {
    try {
        if (updateProgress) updateProgress(0, '開始載入 TCG 單號...');
        
        if (updateProgress) updateProgress(30, '從本地資料庫載入...');
        
        // 一次性從本地 SQLite 載入所有資料（極快）
        const response = await window.AuthClient.fetch('/api/tcg/search?keyword=&limit=50000');
        if (!response.ok) {
            throw new Error(`載入 TCG 失敗: ${response.status} ${response.statusText}`);
        }
        
        if (updateProgress) updateProgress(70, '解析 TCG 資料...');
        
        const data = await response.json();
        tcgCache = data.results || [];
        tcgCacheTimestamp = Date.now();
        
        if (updateProgress) updateProgress(90, '儲存快取...');
        await saveTCGCacheToStorage();
        
        if (updateProgress) {
            const tcgCompletedMsg = window.i18n ? window.i18n.t('loading.completedWithCount', {count: tcgCache.length}) : `載入完成 (${tcgCache.length} 筆)`;
            updateProgress(100, tcgCompletedMsg);
        }
        
        console.log(`TCG 快取更新完成: ${tcgCache.length} 筆記錄`);
        return true;
        
    } catch (error) {
        console.error('載入 TCG 快取失敗:', error);
        if (updateProgress) {
            updateProgress(0, '載入失敗: ' + error.message);
        }
        return false;
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function searchTCGFromCache(keyword, limit = 20) {
    if (!tcgCache) return [];
    
    if (!keyword || keyword.trim() === '') {
        return tcgCache.slice(0, limit);
    }
    
    const lowerKeyword = keyword.toLowerCase();
    return tcgCache.filter(tcg => 
        tcg.tcg_number.toLowerCase().includes(lowerKeyword) ||
        tcg.title.toLowerCase().includes(lowerKeyword)
    ).slice(0, limit);
}

async function initTestCaseManagement() {
    // 顯示進度條
    showLoadingProgress();
    
    try {
        // 載入 TCG 快取 (如果需要)
        const hasCachedTCG = await loadTCGCacheFromStorage();
        if (!hasCachedTCG || shouldUpdateTCGCache()) {
            await loadTCGCache((progress, message) => {
                updateTCGCacheProgress(progress, message);
            });
        } else {
            updateTCGCacheProgress(100, `使用快取 (${tcgCache.length} 筆)`);
        }
        
        // 載入測試案例
        await loadTestCases(false, (progress, message) => {
            updateTestCaseProgress(progress, message);
        });
        
    } catch (error) {
        console.error('初始化失敗:', error);
    } finally {
        // 隱藏進度條
        hideLoadingProgress();
        // 初始化篩選狀態
        updateFilterStatus();
        // 還原持久化過濾條件到 UI 與記憶體（實際套用延至列表載入完成時）
        try { restoreTcmFiltersToUI(); } catch (_) {}
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// 進度條控制函數
function showLoadingProgress() {
    const progressDiv = document.getElementById('loadingProgress');
    if (progressDiv) {
        progressDiv.style.display = 'block';
    }
    
    // 隱藏搜尋與篩選區和表格
    const searchCard = document.getElementById('searchFilterCard');
    const tableCard = document.querySelector('#testCasesTable').closest('.card');
    if (searchCard) searchCard.style.display = 'none';
    if (tableCard) tableCard.style.display = 'none';
}

function hideLoadingProgress() {
    const progressDiv = document.getElementById('loadingProgress');
    if (progressDiv) {
        progressDiv.style.display = 'none';
    }
    
    // 顯示搜尋與篩選區和表格
    const searchCard = document.getElementById('searchFilterCard');
    const tableCard = document.querySelector('#testCasesTable').closest('.card');
    if (searchCard) searchCard.style.display = 'block';
    if (tableCard) tableCard.style.display = 'block';
    // 顯示後調整列表高度
    adjustTestCasesScrollHeight();
}


function updateTestCaseProgress(progress, message = '') {
    const progressBar = document.getElementById('testCaseProgressBar');
    const progressText = document.getElementById('testCaseProgress');
    
    if (progressBar) {
        progressBar.style.width = progress + '%';
    }
    if (progressText) {
        progressText.textContent = `${Math.round(progress)}%${message ? ' - ' + message : ''}`;
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function updateTCGCacheProgress(progress, message = '') {
    const progressBar = document.getElementById('tcgCacheProgressBar');
    const progressText = document.getElementById('tcgCacheProgress');
    
    if (progressBar) {
        progressBar.style.width = progress + '%';
    }
    if (progressText) {
        progressText.textContent = `${Math.round(progress)}%${message ? ' - ' + message : ''}`;
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}


// 在載入列表後重新套用（或還原並套用）持久化的過濾條件
function reapplyPersistedFiltersIfAny() {
    try {
        const uiHasFilters = !!hasAnyFilters();
        const saved = loadTcmFiltersFromStorage();
        const savedHasFilters = !!(saved && (saved.testCaseNumberSearch || saved.searchInput || saved.tcgFilter || saved.priorityFilter));
        if (uiHasFilters) {
            // 以目前 UI 為準直接套用
            applyFilters();
        } else if (savedHasFilters) {
            // UI 無條件但有持久化條件，先還原 UI 再套用
            if (restoreTcmFiltersToUI()) {
                applyFilters();
            }
        } else {
            // 都沒有條件，維持全部列表與狀態
            updateFilterStatus();
        }
    } catch (_) {}
}

async function loadTestCases(showLoadingBlock = true, updateProgress = null, forceRefresh = false) {
    try {
        if (updateProgress) updateProgress(0, '開始載入測試案例...');
        
        // 獲取當前選擇的團隊
        const currentTeam = AppUtils.getCurrentTeam();
        if (!currentTeam || !currentTeam.id) {
            throw new Error('請先選擇團隊');
        }
        const teamIdForLoad = String(currentTeam.id);
        
        // 非強制刷新時先檢查快取
        if (!forceRefresh) {
            const cachedTestCases = getTestCasesCache(teamIdForLoad);
            if (cachedTestCases) {
                if (updateProgress) updateProgress(90, '使用快取資料...');
                
                testCases = cachedTestCases;
                console.debug('[CACHE] LOAD list from cache', { teamId: teamIdForLoad, count: testCases.length });
                
                // 預設按 Test Case Number 升冪排序
                testCases.sort((a, b) => {
                    const aNumber = a.test_case_number || '';
                    const bNumber = b.test_case_number || '';
                    return aNumber.localeCompare(bNumber);
                });
                
                // 依目前記憶體中的過濾器計算顯示清單
                applyCurrentFiltersAndRender();
                
                const completedMsg = window.i18n ? 
                    window.i18n.t('loading.completedWithCount', {count: testCases.length}) + ' (快取)' : 
                    `載入完成 (${testCases.length} 筆，快取)`;
                if (updateProgress) updateProgress(100, completedMsg);
                
                return; // 使用快取，直接返回
            }
            console.debug('[CACHE] BYPASS: no cache hit for list', { teamId: teamIdForLoad });
        } else {
            console.debug('[CACHE] BYPASS: forceRefresh=true, skip cache', { teamId: teamIdForLoad });
        }
        
        if (showLoadingBlock) {
            showLoadingState();
        }
        
        // 提供 fallback 參數確保即使 i18n 未完全載入也有正確顯示
        const connectingMsg = window.i18n ? window.i18n.t('loading.connecting', {}, '連接伺服器...') : '連接伺服器...';
        if (updateProgress) updateProgress(30, connectingMsg);
        
        const response = await window.AuthClient.fetch(`/api/teams/${teamIdForLoad}/testcases/?load_all=true`);
        if (!response.ok) {
            throw new Error(`載入測試案例失敗: ${response.status} ${response.statusText}`);
        }
        
        if (updateProgress) updateProgress(60, '解析資料...');
        
        testCases = await response.json();
        
        // 儲存到快取
        if (updateProgress) updateProgress(70, '更新快取...');
        setTestCasesCache(testCases, teamIdForLoad);
        
        if (updateProgress) updateProgress(80, '處理資料...');
        
        // 預設按 Test Case Number 升冪排序
        testCases.sort((a, b) => {
            const aNumber = a.test_case_number || '';
            const bNumber = b.test_case_number || '';
            return aNumber.localeCompare(bNumber);
        });
        
        // 依目前記憶體中的過濾器計算顯示清單
        if (updateProgress) updateProgress(95, '渲染表格...');
        
        applyCurrentFiltersAndRender();
        if (showLoadingBlock) {
            hideLoadingState();
        }
        
        const completedMsg = window.i18n ? window.i18n.t('loading.completedWithCount', {count: testCases.length}) : `載入完成 (${testCases.length} 筆)`;
        if (updateProgress) updateProgress(100, completedMsg);
        
    } catch (error) {
        console.error('載入測試案例失敗:', error);
        const message = window.i18n ? window.i18n.t('errors.loadTestCasesFailed') : '載入測試案例失敗';
        showError(message + '：' + error.message);
        if (showLoadingBlock) {
            hideLoadingState();
        }
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

async function refreshTestCases() {
    const refreshBtn = document.getElementById('refreshBtn');
    const originalHTML = refreshBtn.innerHTML;
    
    // 檢查是否有搜尋條件
    const hasFilters = hasAnyFilters();
    
    // 顯示載入動畫在按鈕內
    refreshBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status"></span>${window.i18n ? window.i18n.t('common.refresh') : '重新載入'}${hasFilters ? (window.i18n ? ' & ' + window.i18n.t('common.filter') : ' & 篩選') : ''}`;
    refreshBtn.disabled = true;
    
    try {
        // 清除所有快取，強制從伺服器重新載入
        clearTestCasesCache();
        
        // 調用 loadTestCases，強制刷新且不顯示載入區塊
        await loadTestCases(false, null, true);
        
        // 重新載入後，自動套用當前的搜尋條件
        if (hasFilters) {
            applyFilters();
            // 提示使用者已保持篩選條件
            AppUtils.showSuccess(window.i18n ? window.i18n.t('messages.dataReloadedWithFilters') : '資料已重新載入，篩選條件已保持');
        } else {
            AppUtils.showSuccess(window.i18n ? window.i18n.t('messages.dataReloaded') : '資料已重新載入');
        }
        
    } finally {
        // 恢復按鈕原始狀態
        refreshBtn.innerHTML = originalHTML;
        refreshBtn.disabled = false;
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// 檢查是否有任何篩選條件的輔助函數
function hasAnyFilters() {
    const testCaseNumberSearch = document.getElementById('testCaseNumberSearch').value.trim();
    const search = document.getElementById('searchInput').value.trim();
    const tcg = (document.getElementById('tcgFilter')?.value || '').trim();
    const priority = document.getElementById('priorityFilter').value;
    
    return testCaseNumberSearch || search || tcg || priority;
}

function renderTestCasesTable() {
    const tbody = document.getElementById('testCasesTableBody');
    // 依目前排序設定排序並更新指示
    sortFilteredTestCases();
    updateTcmSortIndicators();
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = startIndex + pageSize;
    const pageTestCases = filteredTestCases.slice(startIndex, endIndex);
    
    if (pageTestCases.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center py-4">
                    <i class="fas fa-search fa-2x text-muted mb-2"></i>
                    <div class="text-muted" data-i18n="errors.noMatchingTestCases">沒有找到符合條件的測試案例</div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = pageTestCases.map(testCase => `
        <tr>
            <td class="align-middle text-center">
                <input type="checkbox" class="form-check-input test-case-checkbox" 
                       value="${testCase.record_id}" ${selectedTestCases.has(testCase.record_id) ? 'checked' : ''}>
            </td>
            <td class="align-middle position-relative hover-editable" data-field="test_case_number" data-record-id="${testCase.record_id}">
                <div style="padding-right: 45px;">
                    <code class="small">${testCase.test_case_number || testCase.record_id}</code>
                </div>
                <button type="button" class="btn btn-sm btn-edit position-absolute hover-edit-btn" 
                        style="top: 50%; right: 5px; transform: translateY(-50%); z-index: 10;" 
                        onclick="quickEdit('${testCase.record_id}', 'test_case_number')" data-i18n-title="tooltips.quickEdit">
                    <i class="fas fa-edit"></i>
                </button>
            </td>
            <td class="align-middle position-relative hover-editable" data-field="title" data-record-id="${testCase.record_id}">
                <div class="d-flex align-items-center" style="padding-right: 45px;">
                    <div style="flex-grow: 1; min-width: 0;">
                        <div class="fw-medium text-truncate" title="${testCase.title}">${testCase.title}</div>
                        <div class="small text-muted text-truncate">
                            ${testCase.description ? testCase.description.substring(0, 60) + '...' : ''}
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-edit position-absolute hover-edit-btn" 
                        style="top: 50%; right: 5px; transform: translateY(-50%); z-index: 10;" 
                        onclick="quickEdit('${testCase.record_id}', 'title')" data-i18n-title="tooltips.quickEdit">
                    <i class="fas fa-edit"></i>
                </button>
            </td>
            <td class="align-middle text-center position-relative" data-field="tcg" data-record-id="${testCase.record_id}" style="max-width: 180px;">
                <div class="tcg-edit-area" onclick="editTCG('${testCase.record_id}')" data-i18n-title="tooltips.clickEditTcg" 
                     style="display: flex; flex-wrap: wrap; gap: 2px; justify-content: center; align-items: center; min-height: 24px; padding: 2px; cursor: pointer;">
                    ${getTCGTags(testCase)}
                </div>
            </td>
            <td class="align-middle text-center">
                <span class="badge ${getPriorityBadgeClass(testCase.priority)}">${getPriorityText(testCase.priority)}</span>
            </td>
            <td class="align-middle text-center">
                <div class="small text-muted text-nowrap">
                    ${formatDate(testCase.created_at, 'date')}
                </div>
            </td>
            <td class="align-middle text-center">
                <div class="small text-muted text-nowrap">
                    ${formatDate(testCase.updated_at, 'date')}
                </div>
            </td>
            <td class="align-middle text-center" style="width: 100px;">
                <div class="test-case-actions d-flex justify-content-center gap-2">
                    <button type="button" class="btn btn-sm btn-view" 
                            onclick="viewTestCase('${testCase.record_id}')" data-i18n-title="tooltips.viewEdit">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" 
                            onclick="copyTestCase('${testCase.record_id}')" title="${(window.i18n && window.i18n.isReady()) ? window.i18n.t('common.copy') : '複製'}">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-danger" 
                            onclick="deleteTestCase('${testCase.record_id}')" data-i18n-title="tooltips.delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
    
    // 重新應用翻譯到新生成的表格內容
    if (window.i18n && window.i18n.isReady()) {
        window.i18n.retranslate(tbody);
    }
    
    // 渲染後調整列表可視高度
    adjustTestCasesScrollHeight();
}


function bindEvents() {
    // 新增按鈕
    document.getElementById('addTestCaseBtn').addEventListener('click', () => showTestCaseModal());
    // 監聽大量新增欄位變更以更新預覽
    // 移除舊的前綴/末尾輸入監聽；改由 renderPrefixes 中的 oninput 觸發
    
    // 重新載入按鈕
    document.getElementById('refreshBtn').addEventListener('click', refreshTestCases);

    // Modal TCG 事件已在 DOMContentLoaded 中統一處理
    // 避免重複繫定

    // 批次複製按鈕
    const batchCopyBtn = document.getElementById('batchCopyBtn');
    if (batchCopyBtn) batchCopyBtn.addEventListener('click', openTestCaseBatchCopyModal);
    
    // 搜尋與篩選
    document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
    document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);

    // 表頭排序點擊事件
    const hNum = document.getElementById('th-tcm-number');
    const hTitle = document.getElementById('th-tcm-title');
    const hTcg = document.getElementById('th-tcm-tcg');
    const hPri = document.getElementById('th-tcm-priority');
    const hCreated = document.getElementById('th-tcm-created');
    const hUpdated = document.getElementById('th-tcm-updated');
    if (hNum) hNum.addEventListener('click', () => setTcmSort('number'));
    if (hTitle) hTitle.addEventListener('click', () => setTcmSort('title'));
    if (hTcg) hTcg.addEventListener('click', () => setTcmSort('tcg'));
    if (hPri) hPri.addEventListener('click', () => setTcmSort('priority'));
    if (hCreated) hCreated.addEventListener('click', () => setTcmSort('created'));
    if (hUpdated) hUpdated.addEventListener('click', () => setTcmSort('updated'));
    
    // 搜尋欄位 Enter 鍵支援
    document.getElementById('testCaseNumberSearch').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            applyFilters();
        }
    });
    document.getElementById('searchInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            applyFilters();
        }
    });
    
    // 批次操作
    document.getElementById('selectAllCheckbox').addEventListener('change', toggleSelectAll);
    const batchModifyBtn = document.getElementById('batchModifyBtn');
    if (batchModifyBtn) batchModifyBtn.addEventListener('click', openTestCaseBatchModifyModal);
    const batchDeleteBtn = document.getElementById('batchDeleteBtn');
    if (batchDeleteBtn) batchDeleteBtn.addEventListener('click', batchDeleteTestCases);
    const clearSelectionBtnTC = document.getElementById('clearSelectionBtnTC');
    if (clearSelectionBtnTC) clearSelectionBtnTC.addEventListener('click', deselectAll);
    
    // 上一隻/下一隻測試案例按鈕
    document.getElementById('prevTestCaseBtn').addEventListener('click', showPrevTestCase);
    document.getElementById('nextTestCaseBtn').addEventListener('click', showNextTestCase);
    
    // 參考測試案例按鈕 - 使用內聯 onclick，不需要特別繫定
    // 因為 HTML 中已經有 onclick="openReferenceTestCasePopup()"
    
    // 批次修改模態框事件綁定
    const batchModifyPriorityCheckbox = document.getElementById('batchModifyPriority');
    const batchPrioritySelect = document.getElementById('batchPrioritySelect');
    if (batchModifyPriorityCheckbox && batchPrioritySelect) {
        batchModifyPriorityCheckbox.addEventListener('change', function() {
            batchPrioritySelect.disabled = !this.checked;
            if (!this.checked) {
                batchPrioritySelect.value = '';
            }
        });
    }
    
    const confirmBatchModifyBtn = document.getElementById('confirmTestCaseBatchModifyBtn');
    if (confirmBatchModifyBtn) {
        confirmBatchModifyBtn.addEventListener('click', performTestCaseBatchModify);
    }
    
    // 監聽表格內的複選框變化
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('test-case-checkbox')) {
            const recordId = e.target.value;
            if (e.target.checked) {
                selectedTestCases.add(recordId);
            } else {
                selectedTestCases.delete(recordId);
            }
            updateBatchToolbar();
        }
    });

    // 支援 Shift-點選 連續多選（同頁範圍）
    document.addEventListener('click', function(e) {
        const cb = e.target;
        if (!cb.classList || !cb.classList.contains('test-case-checkbox')) return;
        const checkboxes = Array.from(document.querySelectorAll('.test-case-checkbox'));
        const currentIndex = checkboxes.indexOf(cb);
        if (currentIndex === -1) return;

        if (e.shiftKey && lastCaseCheckboxIndex !== null && lastCaseCheckboxIndex !== -1) {
            const start = Math.min(lastCaseCheckboxIndex, currentIndex);
            const end = Math.max(lastCaseCheckboxIndex, currentIndex);
            const shouldCheck = cb.checked;
            for (let i = start; i <= end; i++) {
                const c = checkboxes[i];
                if (c.checked !== shouldCheck) c.checked = shouldCheck;
                const id = c.value; // record_id 為字串
                if (shouldCheck) selectedTestCases.add(id); else selectedTestCases.delete(id);
            }
            updateBatchToolbar();
        }
        // 更新錨點
        lastCaseCheckboxIndex = currentIndex;
    });
    
    // 大量新增模式（文字輸入）
    const openBulkBtn = document.getElementById('openBulkCreateBtn');
    if (openBulkBtn) openBulkBtn.addEventListener('click', openBulkCreateModal);
    const startBulkBtn = document.getElementById('startBulkCreateBtn');
    if (startBulkBtn) startBulkBtn.addEventListener('click', startBulkTextCreate);
    const confirmBulkBtn = document.getElementById('confirmBulkCreateBtn');
    if (confirmBulkBtn) confirmBulkBtn.addEventListener('click', confirmBulkTextCreate);
    
    // 文字輸入區鍵盤快捷鍵支援
    const bulkTextInput = document.getElementById('bulkTextInput');
    if (bulkTextInput) {
        bulkTextInput.addEventListener('keydown', function(e) {
            // Ctrl+Enter 或 Cmd+Enter 觸發儲存
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                startBulkTextCreate();
            }
        });
    }
    
    // 儲存按鈕
    document.getElementById('saveTestCaseBtn').addEventListener('click', saveTestCase);
    
    // 儲存並新增下一筆按鈕
    document.getElementById('saveAndAddNextBtn').addEventListener('click', saveAndAddNext);
    
    // 複製並新增下一筆按鈕
    document.getElementById('cloneAndAddNextBtn').addEventListener('click', showCloneSelector);
    // 啟用「/」快速搜尋
    setupQuickSearch_TCM();

    // 批次複製 Modal 內部事件
    bindBatchCopyModalEvents();
}

// ===== 批次複製（Batch Copy） =====
let batchCopyModalInstance = null;
let batchCopyPreviewModalInstance = null;
let batchCopyItems = []; // { source_record_id, original_number, original_title, new_number, new_title, selected, conflict, errors }
let lastBatchCopyCheckboxIndex = null;

function openTestCaseBatchCopyModal() {
    try {
        const selectedIds = Array.from(selectedTestCases || []);
        if (!selectedIds.length) {
            const msg = window.i18n ? window.i18n.t('errors.pleaseSelectTestCases') : '請至少選擇一個測試案例';
            AppUtils.showError(msg);
            return;
        }
        // 準備資料來源
        const map = new Map((testCases || []).map(tc => [tc.record_id, tc]));
        batchCopyItems = selectedIds
            .map(id => map.get(id))
            .filter(Boolean)
            .map(tc => ({
                source_record_id: tc.record_id,
                original_number: tc.test_case_number || '',
                original_title: tc.title || '',
                new_number: tc.test_case_number || '',
                new_title: tc.title || '',
                selected: false,
                conflict: false,
                errors: {}
            }));

        // 開啟 Modal
        const el = document.getElementById('testCaseBatchCopyModal');
        if (!batchCopyModalInstance) batchCopyModalInstance = new bootstrap.Modal(el);
        renderBatchCopyTable();
        if (window.i18n && window.i18n.isReady()) window.i18n.retranslate(el);
        batchCopyModalInstance.show();
    } catch (e) {
        console.error('openTestCaseBatchCopyModal error:', e);
        AppUtils.showError('開啟批次複製失敗');
    }
}

function bindBatchCopyModalEvents() {
    const selectAllTop = document.getElementById('batchCopySelectAllTop');
    if (selectAllTop) selectAllTop.addEventListener('change', () => {
        const checked = !!selectAllTop.checked;
        batchCopyItems.forEach(item => item.selected = checked);
        renderBatchCopyTable();
    });

    // 表頭 checkbox 控制全選

    // 套用 Prefix
    const applyPrefixBtn = document.getElementById('applyCopyPrefixBtn');
    if (applyPrefixBtn) applyPrefixBtn.addEventListener('click', () => {
        const input = document.getElementById('copyPrefixInput');
        const prefix = (input.value || '').trim();
        const reg = /^[A-Za-z0-9]+-[0-9]+$/;
        if (!reg.test(prefix)) { AppUtils.showError(window.i18n ? window.i18n.t('errors.prefixFormatInvalid') : 'Prefix 格式不正確'); return; }
        const targets = getBatchCopySelectedIndexes();
        if (!targets.length) { AppUtils.showError(window.i18n ? window.i18n.t('errors.batchCopyNoSelection') : '請先選擇要套用的項目'); return; }
        targets.forEach(idx => {
            const parts = (batchCopyItems[idx].new_number || '').split('.');
            if (parts.length === 3) {
                parts[0] = prefix;
                batchCopyItems[idx].new_number = parts.join('.');
                batchCopyItems[idx].conflict = false;
                batchCopyItems[idx].errors = {};
            }
        });
        renderBatchCopyTable();
    });

    // 套用 Middle
    const applyMiddleBtn = document.getElementById('applyCopyMiddleBtn');
    if (applyMiddleBtn) applyMiddleBtn.addEventListener('click', () => {
        const val = (document.getElementById('copyMiddleInput').value || '').trim();
        if (!/^\d{3}$/.test(val) || parseInt(val,10) < 1 || parseInt(val,10) > 999) {
            AppUtils.showError(window.i18n ? window.i18n.t('errors.middleInvalid') : 'Middle 必須為 001～999 的三位數'); return;
        }
        const targets = getBatchCopySelectedIndexes();
        if (!targets.length) { AppUtils.showError(window.i18n ? window.i18n.t('errors.batchCopyNoSelection') : '請先選擇要套用的項目'); return; }
        targets.forEach(idx => {
            const parts = (batchCopyItems[idx].new_number || '').split('.');
            if (parts.length === 3) {
                parts[1] = val;
                batchCopyItems[idx].new_number = parts.join('.');
                batchCopyItems[idx].conflict = false;
                batchCopyItems[idx].errors = {};
            }
        });
        renderBatchCopyTable();
    });

    // 套用 Suffix 起始（依 10 遞增）
    const applySuffixBtn = document.getElementById('applyCopySuffixBtn');
    if (applySuffixBtn) applySuffixBtn.addEventListener('click', () => {
        const startStr = (document.getElementById('copySuffixStartInput').value || '').trim();
        if (!/^\d{3}$/.test(startStr)) { AppUtils.showError(window.i18n ? window.i18n.t('errors.suffixInvalid') : 'Suffix 起始需為 000～990 的三位數'); return; }
        const start = parseInt(startStr,10);
        if (start < 0 || start > 990) { AppUtils.showError(window.i18n ? window.i18n.t('errors.suffixInvalid') : 'Suffix 起始需為 000～990 的三位數'); return; }
        const targets = getBatchCopySelectedIndexes();
        if (!targets.length) { AppUtils.showError(window.i18n ? window.i18n.t('errors.batchCopyNoSelection') : '請先選擇要套用的項目'); return; }
        const need = targets.length;
        const last = start + (need - 1) * 10;
        if (last > 990) { AppUtils.showError(window.i18n ? window.i18n.t('errors.suffixOutOfRange') : '末尾單號超出 990，無法套用'); return; }
        targets.forEach((idx, i) => {
            const suf = String(start + i*10).padStart(3,'0');
            const parts = (batchCopyItems[idx].new_number || '').split('.');
            if (parts.length === 3) {
                parts[2] = suf;
                batchCopyItems[idx].new_number = parts.join('.');
                batchCopyItems[idx].conflict = false;
                batchCopyItems[idx].errors = {};
            }
        });
        renderBatchCopyTable();
    });

    // Save：先檢查重複，通過則開預覽
    const saveBtn = document.getElementById('saveBatchCopyBtn');
    if (saveBtn) saveBtn.addEventListener('click', onSaveBatchCopy);

    const confirmBtn = document.getElementById('confirmBatchCopyBtn');
    if (confirmBtn) confirmBtn.addEventListener('click', confirmBatchCopyRequest);
}

function getBatchCopySelectedIndexes() {
    const res = [];
    batchCopyItems.forEach((it, idx) => { if (it.selected) res.push(idx); });
    return res;
}


function renderBatchCopyTable() {
    const tbody = document.getElementById('batchCopyTableBody');
    if (!tbody) return;
    tbody.innerHTML = batchCopyItems.map((it, idx) => `
        <tr class="${it.conflict ? 'table-danger' : ''}">
            <td class="text-center">
                <input type="checkbox" class="form-check-input batch-copy-checkbox" data-idx="${idx}" ${it.selected ? 'checked' : ''}>
            </td>
            <td>
                <div class="d-flex align-items-center gap-2">
                    <input type="text" class="form-control form-control-sm" value="${escapeHtml(it.new_number)}" data-idx="${idx}" data-field="number" />
                </div>
                ${it.errors.number ? `<div class="text-danger small">${escapeHtml(it.errors.number)}</div>` : ''}
            </td>
            <td>
                <input type="text" class="form-control form-control-sm" value="${escapeHtml(it.new_title)}" data-idx="${idx}" data-field="title" />
            </td>
        </tr>
    `).join('');

    // 事件繫結
    tbody.querySelectorAll('.batch-copy-checkbox').forEach(cb => {
        cb.addEventListener('click', (e) => {
            const checkboxes = Array.from(tbody.querySelectorAll('.batch-copy-checkbox'));
            const currentIndex = checkboxes.indexOf(e.target);
            const idx = parseInt(e.target.getAttribute('data-idx'), 10);
            const checked = e.target.checked;
            if (e.shiftKey && lastBatchCopyCheckboxIndex !== null && lastBatchCopyCheckboxIndex !== -1) {
                const start = Math.min(lastBatchCopyCheckboxIndex, currentIndex);
                const end = Math.max(lastBatchCopyCheckboxIndex, currentIndex);
                for (let i = start; i <= end; i++) {
                    const c = checkboxes[i];
                    const idxx = parseInt(c.getAttribute('data-idx'),10);
                    c.checked = checked;
                    batchCopyItems[idxx].selected = checked;
                }
            } else {
                batchCopyItems[idx].selected = checked;
            }
            lastBatchCopyCheckboxIndex = currentIndex;
        });
    });

    tbody.querySelectorAll('input[data-field="number"]').forEach(inp => {
        inp.addEventListener('input', (e) => {
            const idx = parseInt(e.target.getAttribute('data-idx'),10);
            batchCopyItems[idx].new_number = e.target.value.trim();
            // 內部重複即時標示
            markInternalDuplicates();
        });
    });
    tbody.querySelectorAll('input[data-field="title"]').forEach(inp => {
        inp.addEventListener('input', (e) => {
            const idx = parseInt(e.target.getAttribute('data-idx'),10);
            batchCopyItems[idx].new_title = e.target.value;
        });
    });
}

function validateFullNumberForBatch(num) {
    const parts = (num || '').split('.');
    if (parts.length !== 3) return window.i18n ? window.i18n.t('errors.fullNumberFormat') : '格式須為 Prefix.Middle.Suffix';
    const [prefix, middle, suffix] = parts;
    if (!/^[A-Za-z0-9]+-[0-9]+$/.test(prefix)) return window.i18n ? window.i18n.t('errors.prefixFormatInvalid') : 'Prefix 格式不正確';
    if (!/^\d{3}$/.test(middle) || parseInt(middle,10) < 1 || parseInt(middle,10) > 999) return window.i18n ? window.i18n.t('errors.middleInvalid') : 'Middle 必須為 001～999';
    if (!/^\d{3}$/.test(suffix) || parseInt(suffix,10) < 0 || parseInt(suffix,10) > 990) return window.i18n ? window.i18n.t('errors.suffixInvalid') : 'Suffix 必須為 000～990';
    return '';
}

function markInternalDuplicates() {
    const seen = new Map();
    batchCopyItems.forEach((it, idx) => {
        it.conflict = false;
        if (it.new_number) {
            const arr = seen.get(it.new_number) || [];
            arr.push(idx);
            seen.set(it.new_number, arr);
        }
    });
    for (const [k, arr] of seen.entries()) {
        if (arr.length > 1) arr.forEach(i => batchCopyItems[i].conflict = true);
    }
}

function onSaveBatchCopy() {
    // 內部重複
    markInternalDuplicates();
    if (batchCopyItems.some(it => it.conflict)) {
        AppUtils.showError(window.i18n ? window.i18n.t('errors.duplicateInternal') : '清單內有重複的 Case Number');
        renderBatchCopyTable();
        return;
    }
    // 外部重複（以目前快取資料檢查）
    const existing = new Set((testCases || []).map(tc => tc.test_case_number).filter(Boolean));
    const externalDup = [];
    batchCopyItems.forEach(it => { if (existing.has(it.new_number)) externalDup.push(it.new_number); });
    if (externalDup.length) {
        AppUtils.showError((window.i18n ? window.i18n.t('errors.duplicateExternal', {numbers: externalDup.join(', ')}) : `與既有 Case Number 衝突：${externalDup.join(', ')}`));
        batchCopyItems.forEach(it => { if (externalDup.includes(it.new_number)) it.conflict = true; });
        renderBatchCopyTable();
        return;
    }

    // 預覽
    const list = document.getElementById('batchCopyPreviewList');
    if (list) {
        list.innerHTML = batchCopyItems.map((it, i) => `
            <tr>
                <td>${i+1}</td>
                <td><code>${escapeHtml(it.new_number)}</code></td>
                <td>${escapeHtml(it.new_title)}</td>
            </tr>
        `).join('');
    }
    const el = document.getElementById('batchCopyPreviewModal');
    if (!batchCopyPreviewModalInstance) batchCopyPreviewModalInstance = new bootstrap.Modal(el);
    if (window.i18n && window.i18n.isReady()) window.i18n.retranslate(el);
    batchCopyPreviewModalInstance.show();
}

async function confirmBatchCopyRequest() {
    try {
        const currentTeam = AppUtils.getCurrentTeam();
        if (!currentTeam || !currentTeam.id) throw new Error('請先選擇團隊');

        const btn = document.getElementById('confirmBatchCopyBtn');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${window.i18n ? window.i18n.t('messages.saving') : '儲存中...'}`;

        const payload = {
            items: batchCopyItems.map(it => ({
                source_record_id: it.source_record_id,
                test_case_number: it.new_number,
                title: it.new_title
            }))
        };
        const resp = await window.AuthClient.fetch(`/api/teams/${currentTeam.id}/testcases/bulk_clone`, {
            method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
        });
        const data = await resp.json();
        // 關閉預覽
        if (batchCopyPreviewModalInstance) batchCopyPreviewModalInstance.hide();

        if (!resp.ok || !data || data.success === false) {
            if (data && Array.isArray(data.duplicates) && data.duplicates.length) {
                // 標記外部衝突
                const setDup = new Set(data.duplicates);
                batchCopyItems.forEach(it => { if (setDup.has(it.new_number)) it.conflict = true; });
                AppUtils.showError((window.i18n ? window.i18n.t('errors.duplicateExternal', {numbers: data.duplicates.join(', ')}) : `與既有 Case Number 衝突：${data.duplicates.join(', ')}`));
                // 回到編輯
                if (batchCopyModalInstance) batchCopyModalInstance.show();
                renderBatchCopyTable();
                return;
            }
            const msg = (data && data.errors && data.errors.join('; ')) || (resp.statusText || '建立失敗');
            AppUtils.showError(msg);
            // 回到編輯
            if (batchCopyModalInstance) batchCopyModalInstance.show();
            return;
        }

        // 成功
        AppUtils.showSuccess(window.i18n ? window.i18n.t('messages.batchCopySuccess', {count: data.created_count || payload.items.length}) : `已成功複製 ${data.created_count || payload.items.length} 筆測試案例`);
        if (batchCopyModalInstance) batchCopyModalInstance.hide();
        // 刷新列表
        clearTestCasesCache();
        await loadTestCases(false, null, true);

        // 清除主列表的選取
        try {
            if (selectedTestCases && typeof selectedTestCases.clear === 'function') {
                selectedTestCases.clear();
            }
            const selectAll = document.getElementById('selectAllCheckbox');
            if (selectAll) selectAll.checked = false;
            if (typeof updateBatchToolbar === 'function') updateBatchToolbar();
        } catch (_) {}
    } catch (e) {
        console.error('confirmBatchCopyRequest error:', e);
        AppUtils.showError('批次複製失敗');
        if (batchCopyModalInstance) batchCopyModalInstance.show();
    } finally {
        const btn = document.getElementById('confirmBatchCopyBtn');
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = `<i class="fas fa-check me-2"></i>${window.i18n ? window.i18n.t('common.confirm') : '確認'}`;
        }
    }
}

// ===== 大量新增模式（文字輸入） =====
let bulkModalInstance = null;
let bulkPreviewModalInstance = null;
let bulkTextParsedItems = []; // 已解析的項目

function normalizeBulkTcgNumbers(rawValue) {
    const result = {
        tcgNumbers: [],
        invalidTokens: []
    };

    if (!rawValue) {
        return result;
    }

    const parts = rawValue
        .split('|')
        .map(part => part.trim())
        .filter(Boolean);

    if (!parts.length) {
        return result;
    }

    const seen = new Set();

    for (const part of parts) {
        const normalized = normalizeSingleTcg(part);
        if (!normalized) {
            result.invalidTokens.push(part);
            continue;
        }
        if (!seen.has(normalized)) {
            seen.add(normalized);
            result.tcgNumbers.push(normalized);
        }
    }

    return result;
}

function normalizeSingleTcg(input) {
    if (!input) return null;

    const upper = String(input).trim().toUpperCase().replace(/\s+/g, '');
    if (!upper) return null;

    let digits = '';

    if (/^TCG-?\d+$/.test(upper)) {
        digits = upper.replace(/^TCG-?/, '');
    } else if (/^\d+$/.test(upper)) {
        digits = upper;
    } else {
        return null;
    }

    if (!digits) return null;

    return `TCG-${digits}`;
}
const BULK_PRIORITY_ALLOWED = ['High', 'Medium', 'Low'];

function parseCsvLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
            if (inQuotes && line[i + 1] === '"') {
                current += '"';
                i++; // skip escaped quote
            } else {
                inQuotes = !inQuotes;
            }
        } else if (char === ',' && !inQuotes) {
            result.push(current.trim());
            current = '';
        } else {
            current += char;
        }
    }
    result.push(current.trim());
    return result;
}

function normalizePriority(value) {
    if (!value) return 'Medium';
    const trimmed = value.trim();
    if (!trimmed) return 'Medium';
    const matched = BULK_PRIORITY_ALLOWED.find(opt => opt.toLowerCase() === trimmed.toLowerCase());
    return matched || null;
}

function truncateText(text, maxLength = 80) {
    if (!text) return '';
    const value = text.trim();
    if (value.length <= maxLength) return value;
    return `${value.slice(0, maxLength - 1)}…`;
}

function openBulkCreateModal() {
    resetBulkTextState();
    const modalEl = document.getElementById('bulkCreateModal');
    if (!bulkModalInstance) bulkModalInstance = new bootstrap.Modal(modalEl);
    if (window.i18n && window.i18n.isReady()) window.i18n.retranslate(modalEl);
    bulkModalInstance.show();
    
    // 聚焦到 textarea
    setTimeout(() => {
        const textarea = document.getElementById('bulkTextInput');
        if (textarea) textarea.focus();
    }, 150);
}

function resetBulkTextState() {
    // 清除文字輸入區內容
    const textarea = document.getElementById('bulkTextInput');
    if (textarea) textarea.value = '';
    
    // 清除狀態顯示
    const statusEl = document.getElementById('bulkTextStatus');
    const validationEl = document.getElementById('bulkTextValidation');
    if (statusEl) statusEl.textContent = '';
    if (validationEl) validationEl.textContent = '';
    
    // 隱藏進度條
    hideBulkProgress();
    
    // 重設解析結果
    bulkTextParsedItems = [];
}

/**
 * 解析文字輸入的 CSV 格式資料
 * @param {string} rawText - 原始文字輸入
 * @returns {object} - { items: [{line, case_no, title, tcg_numbers}], errors: [{line, code, message, raw}], duplicates: [{case_no, lines}] }
 */
function parseBulkText(rawText) {
    const normalizedText = rawText.replace(/\r\n?/g, '\n');
    const lines = normalizedText.split('\n').map((line, index) => ({
        line: index + 1,
        raw: line,
        content: line.trim()
    }));

    const items = [];
    const errors = [];
    const caseNumbers = new Map(); // case_no -> [line numbers]

    for (const lineObj of lines) {
        const { line, raw, content } = lineObj;

        if (!content) continue;

        let cleanContent = content;
        if (cleanContent.startsWith('(Conflict)')) {
            cleanContent = cleanContent.replace(/^\(Conflict\)\s*/, '').trim();
        }

        const columns = parseCsvLine(cleanContent);

        if (columns.length < 2) {
            errors.push({
                line,
                code: 'not_enough_columns',
                message: window.i18n ? window.i18n.t('testCase.bulkText.notEnoughColumns') : '格式需包含至少「單號,標題」兩欄',
                raw
            });
            continue;
        }

        if (columns.length > 7) {
            errors.push({
                line,
                code: 'too_many_columns',
                message: window.i18n ? window.i18n.t('testCase.bulkText.tooManyColumns') : '欄位數量過多，請確認格式',
                raw
            });
            continue;
        }

        while (columns.length < 7) {
            columns.push('');
        }

        const [caseNoRaw, titleRaw, preconditionRaw, stepsRaw, expectedRaw, tcgRaw, priorityRaw] = columns;

        const case_no = (caseNoRaw || '').trim();
        const title = (titleRaw || '').trim();
        const precondition = (preconditionRaw || '').trim();
        const steps = (stepsRaw || '').trim();
        const expected_result = (expectedRaw || '').trim();
        const normalizedPriority = normalizePriority(priorityRaw);
        const tcgInput = (tcgRaw || '').trim();

        if (!case_no) {
            errors.push({
                line,
                code: 'empty_case_no',
                message: window.i18n ? window.i18n.t('testCase.bulkText.emptyCaseNo') : '單號不可為空',
                raw
            });
            continue;
        }

        if (!title) {
            errors.push({
                line,
                code: 'empty_title',
                message: window.i18n ? window.i18n.t('testCase.bulkText.emptyTitle') : '標題不可為空',
                raw
            });
            continue;
        }

        if (priorityRaw && !normalizedPriority) {
            errors.push({
                line,
                code: 'invalid_priority',
                message: window.i18n ? window.i18n.t('testCase.bulkText.invalidPriority') : '優先級僅支援 High / Medium / Low',
                raw
            });
            continue;
        }

        const { tcgNumbers, invalidTokens } = normalizeBulkTcgNumbers(tcgInput);
        if (invalidTokens.length > 0) {
            const invalidMessage = window.i18n ?
                window.i18n.t('testCase.bulkText.invalidTcg', { numbers: invalidTokens.join(' | ') }) :
                `TCG 單號格式錯誤：${invalidTokens.join(' | ')}`;
            errors.push({
                line,
                code: 'invalid_tcg',
                message: invalidMessage,
                raw
            });
            continue;
        }

        if (!caseNumbers.has(case_no)) {
            caseNumbers.set(case_no, []);
        }
        caseNumbers.get(case_no).push(line);

        items.push({
            line,
            case_no,
            title,
            precondition,
            steps,
            expected_result,
            priority: normalizedPriority || 'Medium',
            tcg_numbers: tcgNumbers
        });
    }

    const duplicates = [];
    for (const [case_no, occupiedLines] of caseNumbers) {
        if (occupiedLines.length > 1) {
            duplicates.push({ case_no, lines: occupiedLines });
        }
    }

    return { items, errors, duplicates };
}

/**
 * 更新狀態顯示
 */
function updateBulkTextStatus(parseResult) {
    const statusEl = document.getElementById('bulkTextStatus');
    const validationEl = document.getElementById('bulkTextValidation');
    
    if (!statusEl || !validationEl) return;
    
    const { items, errors, duplicates } = parseResult;
    
    // 顯示基本統計
    if (items.length > 0 || errors.length > 0) {
        const statusText = window.i18n ? 
            window.i18n.t('testCase.bulkText.statusText', { valid: items.length, errors: errors.length }) :
            `已解析 ${items.length} 筆，${errors.length} 筆錯誤`;
        statusEl.textContent = statusText;
    } else {
        statusEl.textContent = '';
    }
    
    // 顯示錯誤訊息
    if (errors.length > 0 || duplicates.length > 0) {
        const messages = [];
        if (errors.length > 0) {
            const errorMsg = window.i18n ?
                window.i18n.t('testCase.bulkText.validationErrors', { count: errors.length }) :
                `${errors.length} 行格式錯誤`;
            messages.push(errorMsg);
        }
        if (duplicates.length > 0) {
            const dupCount = duplicates.reduce((sum, d) => sum + d.lines.length, 0);
            const dupMsg = window.i18n ?
                window.i18n.t('testCase.bulkText.validationDuplicates', { count: dupCount }) :
                `${dupCount} 筆重複單號`;
            messages.push(dupMsg);
        }
        validationEl.textContent = messages.join(' / ');
        validationEl.className = 'text-danger small';
    } else {
        validationEl.textContent = '';
        validationEl.className = 'text-muted small';
    }
}

/**
 * 在編輯器中標記衝突的行
 */
function annotateConflictsInEditor(conflicts) {
    const textarea = document.getElementById('bulkTextInput');
    if (!textarea || !conflicts.length) return;
    
    const lines = textarea.value.split('\n');
    const conflictNumbers = new Set(conflicts);
    
    // 先移除所有現有的 (Conflict) 標記
    const cleanedLines = lines.map(line => 
        line.replace(/^\(Conflict\)\s*/, '')
    );
    
    // 重新加上衝突標記
    const annotatedLines = cleanedLines.map(line => {
        if (!line.trim()) return line;
        
        const columns = parseCsvLine(line.trim());
        if (!columns.length) return line;
        const case_no = (columns[0] || '').trim();
        if (conflictNumbers.has(case_no)) {
            return `(Conflict) ${line}`;
        }
        return line;
    });
    
    textarea.value = annotatedLines.join('\n');
}

/**
 * 開始文字模式批次建立
 */
async function startBulkTextCreate() {
    const textarea = document.getElementById('bulkTextInput');
    if (!textarea) return;
    
    const rawText = textarea.value.trim();
    if (!rawText) {
        const emptyMessage = window.i18n ? window.i18n.t('testCase.bulkTextToast.emptyInput') : '請輸入資料';
        AppUtils.showWarning(emptyMessage);
        return;
    }
    
    // 解析輸入
    const parseResult = parseBulkText(rawText);
    updateBulkTextStatus(parseResult);
    
    const { items, errors, duplicates } = parseResult;
    
    // 檢查格式錯誤
    if (errors.length > 0) {
        const message = window.i18n ? 
            window.i18n.t('testCase.bulkTextToast.invalid', { count: errors.length }) :
            `有 ${errors.length} 行格式錯誤，請修正後再試。`;
        AppUtils.showError(message);
        return;
    }
    
    // 檢查輸入內部重複
    if (duplicates.length > 0) {
        const message = window.i18n ? 
            window.i18n.t('testCase.bulkTextToast.duplicateInInput') :
            '輸入中有重複的單號';
        AppUtils.showError(message);
        return;
    }
    
    if (items.length === 0) {
        const noItemsMessage = window.i18n ? window.i18n.t('testCase.bulkTextToast.noValidItems') : '沒有有效的資料可以建立';
        AppUtils.showWarning(noItemsMessage);
        return;
    }
    
    // 檢查與資料庫的衝突
    try {
        const conflicts = await checkBulkConflicts(items.map(item => item.case_no));
        
        if (conflicts.length > 0) {
            // 標記衝突的行
            annotateConflictsInEditor(conflicts);
            
            const message = window.i18n ? 
                window.i18n.t('testCase.bulkTextToast.conflict', { count: conflicts.length }) :
                `發現單號衝突，共 ${conflicts.length} 筆。已在文字前加上「(Conflict)」標記。`;
            AppUtils.showWarning(message);
            return;
        }
        
        // 無衝突，顯示預覽
        bulkTextParsedItems = items;
        showBulkPreviewModal(items);
        
    } catch (error) {
        console.error('Check conflicts failed:', error);
        const message = window.i18n ? 
            window.i18n.t('testCase.bulkTextToast.networkError') :
            '網路錯誤，請稍後再試';
        AppUtils.showError(message);
    }
}

/**
 * 檢查與資料庫的衝突
 */
async function checkBulkConflicts(caseNumbers) {
    const currentTeam = AppUtils.getCurrentTeam();
    if (!currentTeam || !currentTeam.id) {
        throw new Error('請先選擇團隊');
    }
    
    // 簡化版：直接檢查現有 testCases 陣列
    const existing = new Set(testCases.map(tc => tc.test_case_number).filter(Boolean));
    return caseNumbers.filter(caseNo => existing.has(caseNo));
}

/**
 * 顯示預覽對話框
 */
function showBulkPreviewModal(items) {
    const modalEl = document.getElementById('bulkPreviewModal');
    const descEl = document.getElementById('bulkPreviewDesc');
    const listEl = document.getElementById('bulkPreviewList');
    
    if (!modalEl || !descEl || !listEl) return;
    
    // 設定描述
        const descText = window.i18n ? 
        window.i18n.t('testCase.bulkText.confirmDesc', { count: items.length }) :
        `將新增以下 ${items.length} 筆測試案例：`;
    descEl.textContent = descText;
    
    // 渲染列表
    listEl.innerHTML = items.map((item, index) => {
        const prioritySuffix = (item.priority || 'Medium');
        const priorityLabel = window.i18n ? window.i18n.t(`testCase.priority${prioritySuffix}`, {}, prioritySuffix) : prioritySuffix;
        const title = item.title || '';
        const precondition = item.precondition || '';
        const steps = item.steps || '';
        const expected = item.expected_result || '';
        const tcgDisplay = (item.tcg_numbers || []).join(', ');
        return `
        <tr>
            <td>${index + 1}</td>
            <td><code>${escapeHtml(item.case_no)}</code></td>
            <td style="width: 220px;" title="${escapeHtml(title)}">${escapeHtml(truncateText(title))}</td>
            <td title="${escapeHtml(precondition)}">${escapeHtml(truncateText(precondition))}</td>
            <td title="${escapeHtml(steps)}">${escapeHtml(truncateText(steps))}</td>
            <td title="${escapeHtml(expected)}">${escapeHtml(truncateText(expected))}</td>
            <td style="width: 280px; min-width: 21ch;" title="${escapeHtml(tcgDisplay)}">${escapeHtml(truncateText(tcgDisplay, 120))}</td>
            <td>${escapeHtml(priorityLabel)}</td>
        </tr>
        `;
    }).join('');
    
    // 顯示 Modal
    if (!bulkPreviewModalInstance) {
        bulkPreviewModalInstance = new bootstrap.Modal(modalEl);
    }
    
    if (window.i18n && window.i18n.isReady()) {
        window.i18n.retranslate(modalEl);
    }
    
    bulkPreviewModalInstance.show();
}

/**
 * 確認建立批次測試案例
 */
async function confirmBulkTextCreate() {
    if (!bulkTextParsedItems.length) {
        AppUtils.showError('沒有項目可以建立');
        return;
    }
    
    const currentTeam = AppUtils.getCurrentTeam();
    if (!currentTeam || !currentTeam.id) {
        AppUtils.showError('請先選擇團隊');
        return;
    }
    
    // 顯示進度條
    showBulkProgress(bulkTextParsedItems.length);
    
    // 更新按鈕狀態
    const confirmBtn = document.getElementById('confirmBulkCreateBtn');
    const originalHtml = confirmBtn ? confirmBtn.innerHTML : '';
    
    if (confirmBtn) {
        confirmBtn.disabled = true;
        const creatingText = window.i18n ? window.i18n.t('testCase.bulk.creating') : '建立中...';
        confirmBtn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${creatingText}`;
    }
    
    try {
        const items = bulkTextParsedItems.map(item => ({
            test_case_number: item.case_no,
            title: item.title,
            precondition: item.precondition || null,
            steps: item.steps || null,
            expected_result: item.expected_result || null,
            priority: item.priority || 'Medium',
            tcg_numbers: Array.isArray(item.tcg_numbers) ? item.tcg_numbers : []
        }));
        
        const response = await window.AuthClient.fetch(`/api/teams/${currentTeam.id}/testcases/bulk_create`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items })
        });
        
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            // 檢查是否有新的衝突
            if (data.duplicates && data.duplicates.length > 0) {
                // 關閉預覽對話框，回到編輯模式
                if (bulkPreviewModalInstance) {
                    bulkPreviewModalInstance.hide();
                }
                
                // 標記衝突
                annotateConflictsInEditor(data.duplicates);
                
                const message = window.i18n ? 
                    window.i18n.t('testCase.bulkTextToast.conflict', { count: data.duplicates.length }) :
                    `發現單號衝突，共 ${data.duplicates.length} 筆。已在文字前加上「(Conflict)」標記。`;
                AppUtils.showWarning(message);
                return;
            }
            
            const errorMsg = (data.errors && data.errors.join('; ')) || response.statusText || '未知錯誤';
            throw new Error(errorMsg);
        }
        
        // 成功建立
        updateBulkProgress(bulkTextParsedItems.length, bulkTextParsedItems.length);
        
        const message = window.i18n ? 
            window.i18n.t('testCase.bulkTextToast.success', { count: data.created_count || bulkTextParsedItems.length }) :
            `已成功新增 ${data.created_count || bulkTextParsedItems.length} 筆測試案例`;
        AppUtils.showSuccess(message);
        
        // 關閉所有 Modal
        if (bulkPreviewModalInstance) bulkPreviewModalInstance.hide();
        if (bulkModalInstance) bulkModalInstance.hide();
        
        // 清除快取並強制重新載入測試案例列表，確保顯示最新新增資料
        clearTestCasesCache();
        await loadTestCases(false, null, true);
        
    } catch (error) {
        console.error('Bulk create failed:', error);
        const message = error.message || '建立失敗';
        AppUtils.showError(message);
        
    } finally {
        // 恢復按鈕狀態
        if (confirmBtn) {
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = originalHtml;
        }
        hideBulkProgress();
    }
}

// 簡單的 HTML 轉義，供動態模板使用
function escapeHtml(text) {
    if (text === undefined || text === null) return '';
    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
    return String(text).replace(/[&<>"']/g, (m) => map[m]);
}

function showBulkProgress(total) {
    document.getElementById('bulkProgress').style.display = 'block';
    updateBulkProgress(0, total);
}
function hideBulkProgress() {
    document.getElementById('bulkProgress').style.display = 'none';
}
function updateBulkProgress(done, total) {
    const pct = total > 0 ? Math.round((done / total) * 100) : 0;
    document.getElementById('bulkProgressText').textContent = `${done}/${total}`;
    document.getElementById('bulkProgressBar').style.width = `${pct}%`;
}

// 舊的 startBulkCreate 函式已移除，使用 startBulkTextCreate 取代

// 複製 Test Case：開啟與「新增/編輯」相同的 Modal，預填欄位
function copyTestCase(id) {
    const source = testCases.find(tc => tc.record_id === id);
    if (!source) return;
    // 標記為複製模式，供 showTestCaseModal 判斷隱藏「儲存並新增下一筆」
    try {
        const modal = document.getElementById('testCaseModal');
        if (modal && modal.dataset) modal.dataset.copyMode = '1';
    } catch (_) {}
    // 先以新增模式打開，確保狀態正確（不帶 record_id，附件清空，按鈕狀態正確）
    showTestCaseModal(null);

    // 設定 Modal 標題為「複製測試案例」
    const modalTitle = document.getElementById('testCaseModalTitle');
    if (modalTitle) {
        const copyText = window.i18n ? window.i18n.t('common.copy') : '複製';
        const baseTitle = window.i18n ? window.i18n.t('testCase.createTestCase') : '新增測試案例';
        modalTitle.textContent = `${copyText} ${baseTitle}`;
    }

    // 預填欄位（編號留空，避免重複；標題前綴「複製 - 」）
    const copyWord = window.i18n ? window.i18n.t('common.copy') : '複製';
    document.getElementById('testCaseId').value = '';
    document.getElementById('title').value = `${copyWord} - ${source.title || ''}`;
    document.getElementById('testCaseNumber').value = '';
    document.getElementById('priority').value = source.priority || 'Medium';

    // 保留來源 TCG 單號（單一或多個以逗號分隔的字串）
    const tcgValue = source.tcg ? source.tcg.map(t => t.text || t).join(', ') : '';
    document.getElementById('tcg').value = tcgValue;

    document.getElementById('precondition').value = source.precondition || '';
    document.getElementById('test_steps').value = source.steps || '';
    document.getElementById('expected_result').value = source.expected_result || '';

    // 更新 Markdown 預覽
    try {
        markdownFields.forEach(fieldId => updateMarkdownPreview(fieldId));
    } catch (_) {}

    // 新增模式下的按鈕狀態
    const saveBtn = document.getElementById('saveTestCaseBtn');
    const saveAndAddNextBtn = document.getElementById('saveAndAddNextBtn');
    if (saveBtn) saveBtn.disabled = false;
    if (saveAndAddNextBtn) {
        // 複製模式：不提供「儲存並新增下一筆」
        saveAndAddNextBtn.disabled = true;
        saveAndAddNextBtn.style.display = 'none';
    }

    // 編輯器模式採用 split（與新增一致）
    try { setEditorMode('split'); } catch (_) {}
}

// 顯示複製選擇器：在 Modal 中選擇要複製的測試案例
function showCloneSelector() {
    if (testCases.length === 0) {
        const message = window.i18n ? window.i18n.t('errors.noTestCasesAvailable') : '沒有可用的測試案例';
        AppUtils.showError(message);
        return;
    }
    
    // 創建動態 modal 來選擇測試案例
    const modalId = 'cloneSelectorModal';
    const existingModal = document.getElementById(modalId);
    if (existingModal) {
        existingModal.remove();
    }
    
    // 創建選擇器 modal HTML
    const modalHtml = `
        <div class="modal fade" id="${modalId}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-clone me-2"></i>
                            ${window.i18n ? window.i18n.t('testCase.cloneAndAddNext') : '複製並新增下一筆'}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">${window.i18n ? window.i18n.t('testCase.selectSourceTestCase') : '選擇要複製的測試案例'}</label>
                            <select class="form-select" id="cloneSourceSelect">
                                <option value="">${window.i18n ? window.i18n.t('common.pleaseSelect') : '請選擇...'}</option>
                                ${testCases.map(tc => 
                                    `<option value="${tc.record_id}">${tc.test_case_number || 'N/A'} - ${tc.title || 'No Title'}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            ${window.i18n ? window.i18n.t('common.cancel') : '取消'}
                        </button>
                        <button type="button" class="btn btn-primary" id="confirmCloneBtn">
                            <i class="fas fa-check me-2"></i>
                            ${window.i18n ? window.i18n.t('common.confirm') : '確認'}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // 將 modal 添加到頁面
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // 初始化 modal
    const cloneSelectorModal = new bootstrap.Modal(document.getElementById(modalId));
    
    // 綁定確認按鈕事件
    document.getElementById('confirmCloneBtn').addEventListener('click', function() {
        const selectedId = document.getElementById('cloneSourceSelect').value;
        if (!selectedId) {
            AppUtils.showError(window.i18n ? window.i18n.t('errors.pleaseSelectTestCase') : '請選擇測試案例');
            return;
        }
        
        // 檢查是否有未儲存的變更
        if (hasUnsavedChanges()) {
            // 關閉選擇器 modal 先
            cloneSelectorModal.hide();
            
            // 顯示儲存確認對話框
            const confirmTitle = window.i18n ? window.i18n.t('common.confirm') : '確認';
            const confirmMessage = window.i18n ? window.i18n.t('testCase.unsavedChangesPrompt') : '您有未儲存的變更，是否要先儲存？';
            const saveAndContinue = window.i18n ? window.i18n.t('testCase.saveAndContinue') : '儲存並繼續';
            const continueWithoutSave = window.i18n ? window.i18n.t('testCase.continueWithoutSave') : '不儲存直接繼續';
            const cancelAction = window.i18n ? window.i18n.t('common.cancel') : '取消';
            
            const confirmModalHtml = `
                <div class="modal fade" id="saveConfirmModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                                    ${confirmTitle}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>${confirmMessage}</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${cancelAction}</button>
                                <button type="button" class="btn btn-outline-danger" id="continueWithoutSaveBtn">${continueWithoutSave}</button>
                                <button type="button" class="btn btn-primary" id="saveAndContinueBtn">
                                    <i class="fas fa-save me-2"></i>${saveAndContinue}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 移除舊的確認 modal
            const existingConfirmModal = document.getElementById('saveConfirmModal');
            if (existingConfirmModal) {
                existingConfirmModal.remove();
            }
            
            // 添加確認 modal
            document.body.insertAdjacentHTML('beforeend', confirmModalHtml);
            const saveConfirmModal = new bootstrap.Modal(document.getElementById('saveConfirmModal'));
            saveConfirmModal.show();
            
            // 綁定按鈕事件
            document.getElementById('saveAndContinueBtn').addEventListener('click', async function() {
                saveConfirmModal.hide();
                
                // 嘗試儲存當前表單
                try {
                    const saveBtn = document.getElementById('saveTestCaseBtn');
                    if (saveBtn) {
                        saveBtn.click();
                        
                        // 等待儲存完成，然後執行複製
                        setTimeout(() => {
                            executeCloneAction(selectedId);
                        }, 500);
                    }
                } catch (error) {
                    console.error('儲存失敗:', error);
                    AppUtils.showError(window.i18n ? window.i18n.t('errors.saveFailed') : '儲存失敗');
                }
            });
            
            document.getElementById('continueWithoutSaveBtn').addEventListener('click', function() {
                saveConfirmModal.hide();
                executeCloneAction(selectedId);
            });
            
        } else {
            // 沒有未儲存變更，直接執行複製
            executeCloneAction(selectedId);
        }
    });
    
    // 執行複製操作的共用函數
    function executeCloneAction(selectedId) {
        // 關閉選擇器 modal（如果還開著）
        if (cloneSelectorModal) {
            cloneSelectorModal.hide();
        }
        
        // 關閉當前測試案例 modal
        const testCaseModal = document.getElementById('testCaseModal');
        const testCaseModalInstance = bootstrap.Modal.getInstance(testCaseModal);
        if (testCaseModalInstance) {
            testCaseModalInstance.hide();
        }
        
        // 延遲執行複製，確保 modal 完全關閉
        setTimeout(() => {
            cloneAndAddNext(selectedId);
        }, 300);
    }
    
    // Modal 關閉後清理
    document.getElementById(modalId).addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
    
    // 顯示 modal
    cloneSelectorModal.show();
}

// 複製並新增下一筆 Test Case：基於 copyTestCase 邏輯，但保持「儲存並新增下一筆」功能
function cloneAndAddNext(id) {
    const source = testCases.find(tc => tc.record_id === id);
    if (!source) return;
    
    // 先以新增模式打開，確保狀態正確（不帶 record_id，附件清空，按鈕狀態正確）
    showTestCaseModal(null);

    // 設定 Modal 標題為「複製並新增下一筆測試案例」
    const modalTitle = document.getElementById('testCaseModalTitle');
    if (modalTitle) {
        const cloneText = window.i18n ? window.i18n.t('testCase.cloneAndAddNext') : '複製並新增下一筆';
        const baseTitle = window.i18n ? window.i18n.t('testCase.testCase') : '測試案例';
        modalTitle.textContent = `${cloneText} ${baseTitle}`;
    }

    // 預填欄位（編號自動遞增，標題保持原樣）
    document.getElementById('testCaseId').value = '';
    document.getElementById('title').value = source.title || '';
    
    // 自動生成下一個測試案例編號
    const nextNumber = generateNextTestCaseNumber(source.test_case_number);
    document.getElementById('testCaseNumber').value = nextNumber;
    
    document.getElementById('priority').value = source.priority || 'MEDIUM';

    // 保留來源 TCG 單號（單一或多個以逗號分隔的字串）
    const tcgValue = source.tcg ? source.tcg.map(t => t.text || t).join(', ') : '';
    const tcgDisplay = document.getElementById('tcg');
    if (tcgDisplay) tcgDisplay.value = tcgValue;

    document.getElementById('precondition').value = source.precondition || '';
    document.getElementById('test_steps').value = source.steps || '';
    document.getElementById('expected_result').value = source.expected_result || '';

    // 更新 Markdown 預覽
    try {
        const markdownFields = ['precondition', 'test_steps', 'expected_result'];
        markdownFields.forEach(fieldId => updateMarkdownPreview(fieldId));
    } catch (_) {}

    // 新增模式下的按鈕狀態（保持「儲存並新增下一筆」可用）
    const saveBtn = document.getElementById('saveTestCaseBtn');
    const saveAndAddNextBtn = document.getElementById('saveAndAddNextBtn');
    if (saveBtn) saveBtn.disabled = false;
    if (saveAndAddNextBtn) {
        // 與一般新增模式相同，保持「儲存並新增下一筆」可用
        saveAndAddNextBtn.disabled = false;
        saveAndAddNextBtn.style.display = 'inline-block';
        // 重置按鈕文字為正常狀態
        const saveAndNextText = window.i18n ? window.i18n.t('form.saveAndNext') : '儲存並新增下一筆';
        saveAndAddNextBtn.innerHTML = `<i class=\"fas fa-plus me-2\"></i>${saveAndNextText}`;
    }

    // 編輯器模式採用 split（與新增一致）
    try { setEditorMode('split'); } catch (_) {}
}

// 生成下一個測試案例編號的輔助函數
function generateNextTestCaseNumber(currentNumber) {
    if (!currentNumber) return '';
    
    // 嘗試匹配常見的測試案例編號格式
    const patterns = [
        /^([A-Z]+)(\d+)$/,           // TC001, TEST123
        /^([A-Z]+)-(\d+)$/,         // TC-001, TEST-123
        /^([A-Z]+)_(\d+)$/,         // TC_001, TEST_123
        /^(\d+)$/,                  // 001, 123
        /^([A-Z\d]+)\.(\d+)$/,      // TC.001, V1.123
    ];
    
    for (let pattern of patterns) {
        const match = currentNumber.match(pattern);
        if (match) {
            const prefix = match[1] || '';
            const number = parseInt(match[2] || match[1]);
            const nextNum = number + 1;
            
            // 保持原有的數字位數（零填充）
            const originalNumStr = match[2] || match[1];
            const paddedNext = nextNum.toString().padStart(originalNumStr.length, '0');
            
            if (pattern.source.includes('-')) {
                return `${prefix}-${paddedNext}`;
            } else if (pattern.source.includes('_')) {
                return `${prefix}_${paddedNext}`;
            } else if (pattern.source.includes('\\.')) {
                return `${prefix}.${paddedNext}`;
            } else if (prefix) {
                return `${prefix}${paddedNext}`;
            } else {
                return paddedNext;
            }
        }
    }
    
    // 如果沒有匹配到任何模式，返回原編號 + "_NEXT"
    return currentNumber + '_NEXT';
}

let originalFormData = {}; // 存儲原始表單資料
let isFormChanged = false; // 追蹤表單是否有變更
let testCaseModalInstance = null; // 全域 Modal 實例

function showTestCaseModal(testCase = null) {
    const modal = document.getElementById('testCaseModal');
    const title = document.getElementById('testCaseModalTitle');
    const form = document.getElementById('testCaseForm');
    const saveBtn = document.getElementById('saveTestCaseBtn');
    const saveAndAddNextBtn = document.getElementById('saveAndAddNextBtn');
    const isCopyMode = (modal && modal.dataset && modal.dataset.copyMode === '1');
    
    // 重設表單和狀態
    form.reset();
    isFormChanged = false;
    saveBtn.disabled = false; // 儲存按鈕始終啟用
    
    // 每次開啟 modal 重置暫存上傳 id（避免跨記錄汙染）
    currentTempUploadId = null;

    if (testCase) {
        // 編輯現有測試案例時，初始化附件資料
        if (Array.isArray(testCase.attachments) && testCase.attachments.length > 0) {
            uploadedAttachments = testCase.attachments.map(att => ({
                file_token: att.file_token,
                name: att.name,
                size: att.size,
                type: att.type || 'application/octet-stream',
                url: att.url || '',
                stored_name: att.file_token || att.stored_name || att.name || ''
            }));
        } else {
            uploadedAttachments = [];
        }
    } else {
        // 新增測試案例時，重設附件資料
        uploadedAttachments = [];
    }
    
    if (testCase) {
        // 找到當前測試案例在 filteredTestCases 中的索引
        currentTestCaseIndex = filteredTestCases.findIndex(tc => tc.record_id === testCase.record_id);
        updateNavigationButtons();
        title.textContent = window.i18n ? window.i18n.t('testCase.viewTestCase') : '檢視測試案例';
        
        // 填入資料
        document.getElementById('testCaseId').value = testCase.record_id;
        
        // 設定 modal 的 recordId dataset 供刪除附件使用
        modal.dataset.recordId = testCase.record_id;
        document.getElementById('title').value = testCase.title || '';
        document.getElementById('testCaseNumber').value = testCase.test_case_number || '';
        document.getElementById('priority').value = testCase.priority || 'Medium';
        const tcgValue = testCase.tcg ? testCase.tcg.map(t => t.text || t).join(', ') : '';
        document.getElementById('tcg').value = tcgValue;
        
        // 初始化 Modal TCG 多選顯示
        modalTCGSelected = testCase.tcg ? testCase.tcg.map(t => t.text || t) : [];
        renderModalTCGDisplay();
        document.getElementById('precondition').value = testCase.precondition || '';
        document.getElementById('test_steps').value = testCase.steps || '';
        document.getElementById('expected_result').value = testCase.expected_result || '';
        
        // 渲染附件列表（若列表資料沒有附件，補打一筆詳情以取得附件）
        renderAttachmentsList();
        try {
            const currentTeam = AppUtils.getCurrentTeam();
            if (currentTeam && currentTeam.id && (!Array.isArray(testCase.attachments) || testCase.attachments.length === 0)) {
                window.AuthClient.fetch(`/api/teams/${currentTeam.id}/testcases/${encodeURIComponent(testCase.record_id)}`)
                    .then(r => r.ok ? r.json() : null)
                    .then(data => {
                        if (data && Array.isArray(data.attachments)) {
                            uploadedAttachments = data.attachments.map(att => ({
                                file_token: att.file_token,
                                name: att.name,
                                size: att.size,
                                type: att.type || 'application/octet-stream',
                                url: att.url || '',
                                stored_name: att.file_token || att.stored_name || att.name || ''
                            }));
                            renderAttachmentsList();
                        }
                    })
                    .catch(() => {});
            }
        } catch (_) {}
        
        // 儲存原始資料用於比較
        originalFormData = {
            title: testCase.title || '',
            test_case_number: testCase.test_case_number || '',
            priority: testCase.priority || 'Medium',
            tcg: testCase.tcg ? testCase.tcg.map(t => t.text || t).join(', ') : '',
            precondition: testCase.precondition || '',
            steps: testCase.steps || '',
            expected_result: testCase.expected_result || ''
        };
        
        // 初始化 Markdown 預覽內容
        markdownFields.forEach(fieldId => {
            updateMarkdownPreview(fieldId);
        });
        
        // 檢視模式下預設為預覽模式
        setEditorMode('preview');
        
        // 隱藏「儲存並新增下一筆」按鈕（編輯模式不需要）
        saveAndAddNextBtn.style.display = 'none';
        
        // 隱藏「複製並新增下一筆」按鈕（編輯模式不需要）
        const cloneAndAddNextBtn = document.getElementById('cloneAndAddNextBtn');
        if (cloneAndAddNextBtn) cloneAndAddNextBtn.style.display = 'none';
        
    } else {
        title.textContent = window.i18n ? window.i18n.t('testCase.createTestCase') : '新增測試案例';
        
        // 清空所有表單欄位
        document.getElementById('testCaseId').value = '';
        document.getElementById('title').value = '';
        document.getElementById('testCaseNumber').value = '';
        document.getElementById('priority').value = 'Medium';
        document.getElementById('tcg').value = '';
        document.getElementById('precondition').value = '';
        document.getElementById('test_steps').value = '';
        document.getElementById('expected_result').value = '';
        
        // 清空 Modal TCG 多選顯示
        modalTCGSelected = [];
        renderModalTCGDisplay();
        
        // 清除 modal 的 recordId dataset
        modal.dataset.recordId = '';
        
        originalFormData = {};
        saveBtn.disabled = false; // 儲存按鈕始終啟用
        // 獲取「複製並新增下一筆」按鈕
        const cloneAndAddNextBtn = document.getElementById('cloneAndAddNextBtn');
        
        if (isCopyMode) {
            // 複製模式移除「儲存並新增下一筆」
            saveAndAddNextBtn.disabled = true;
            saveAndAddNextBtn.style.display = 'none';
            // 複製模式也隱藏「複製並新增下一筆」按鈕
            if (cloneAndAddNextBtn) cloneAndAddNextBtn.style.display = 'none';
        } else {
            saveAndAddNextBtn.disabled = false; // 新增模式下「儲存並新增下一筆」按鈕啟用
            saveAndAddNextBtn.style.display = 'inline-block'; // 顯示「儲存並新增下一筆」按鈕
            // 重置按鈕文字為正常狀態
            const saveAndNextText = window.i18n ? window.i18n.t('form.saveAndNext') : '儲存並新增下一筆';
            saveAndAddNextBtn.innerHTML = `<i class="fas fa-plus me-2"></i>${saveAndNextText}`;
            // 新增模式顯示「複製並新增下一筆」按鈕
            if (cloneAndAddNextBtn) cloneAndAddNextBtn.style.display = 'inline-block';
        }
        currentTestCaseIndex = -1;
        updateNavigationButtons();
        
        // 渲染附件列表（新增模式下為空）
        renderAttachmentsList();
        
        // 清空所有 Markdown 預覽內容
        markdownFields.forEach(fieldId => {
            const previewElement = document.querySelector(`.markdown-preview[data-target="${fieldId}"]`);
            if (previewElement) {
                const previewPlaceholder = window.i18n ? window.i18n.t('errors.previewPlaceholder') : '預覽內容會在這裡顯示';
                previewElement.innerHTML = `<p class="text-muted">${previewPlaceholder}</p>`;
            }
        });
        
        // 新增模式下預設為編輯模式
        setEditorMode('split');
    }
    
    // 啟用所有欄位（檢視/編輯合一）
    form.querySelectorAll('input, textarea, select').forEach(el => el.disabled = false);
    
    // 綁定變更監聽器
    bindFormChangeListeners();
    
    // 在顯示 modal 前，確保所有滾動位置都在頂部
    // 這樣做可以避免 modal 顯示時的跳動效果
    resetModalScrollPositions(modal);
    
    // 只創建一次 Modal 實例，避免 backdrop 累積
    if (!testCaseModalInstance) {
        const modalOptions = window.__MINIMAL_MODE__ ? { backdrop: false, keyboard: true, focus: true } : undefined;
        testCaseModalInstance = new bootstrap.Modal(modal, modalOptions);
        
        // 只綁定一次事件監聽器
        // 顯示前立即重置滾動，並暫時隱藏內容避免進場彈跳
        modal.addEventListener('show.bs.modal', function() {
            modal.classList.add('modal-preparing');
            resetModalScrollPositions(modal);
        });
        // 顯示後完成高度計算，再解除隱藏（整體觀感無彈跳）
        modal.addEventListener('shown.bs.modal', function() {
            calculateDynamicHeights();
            resetModalScrollPositions(modal);
            modal.classList.remove('modal-preparing');
            // 綁定鍵盤左右鍵支援（僅檢視狀態觸發）
            document.addEventListener('keydown', handleTestCaseModalKeydown);
        });
        // 關閉時移除鍵盤事件監聽
        modal.addEventListener('hidden.bs.modal', function() {
            document.removeEventListener('keydown', handleTestCaseModalKeydown);
            // 離開時重置 copyMode 標記
            try { modal.dataset.copyMode = '0'; } catch (_) {}
            // 最小模式：在 Modal 關閉後一併關閉彈出視窗
            if (window.__MINIMAL_MODE__) {
                try { window.close(); } catch (e) {}
            }
        });

        // 最小模式：點擊關閉按鈕時一併關閉彈出視窗
        if (window.__MINIMAL_MODE__) {
            const closeBtn = modal.querySelector('.btn-close');
            if (closeBtn && !closeBtn._closeWindowBound) {
                closeBtn.addEventListener('click', function() {
                    setTimeout(function(){ try { window.close(); } catch (e) {} }, 0);
                });
                closeBtn._closeWindowBound = true;
            }
        }
    }
    
    // 綁定複製連結按鈕（使用當前測試案例/表單值）
    try {
        const btn = document.getElementById('copyTcmCaseLinkBtn');
        if (btn) {
            btn.onclick = () => {
                const teamId = getCurrentTeamId_TCM();
                // 優先從 testCase 物件，其次從表單欄位讀取
                const tcNumber = (testCase && testCase.test_case_number) || document.getElementById('testCaseNumber')?.value || '';
                const url = buildTcmUrl(teamId, tcNumber);
                if (window.AppUtils && typeof AppUtils.showCopyModal === 'function') {
                    AppUtils.showCopyModal(url);
                } else {
                    // 最簡回退
                    const promptLabel = (window.i18n && typeof window.i18n.t === 'function')
                        ? window.i18n.t('copyModal.prompt', {}, '請手動複製此連結：')
                        : '請手動複製此連結：';
                    window.prompt(promptLabel, url);
                }
            };
        }
    } catch (_) {}

    testCaseModalInstance.show();
    
    // 確保按鈕狀態正確（解決可能的時序問題）
    setTimeout(() => {
        const saveBtn = document.getElementById('saveTestCaseBtn');
        const saveAndAddNextBtn = document.getElementById('saveAndAddNextBtn');
        if (saveBtn) saveBtn.disabled = false;
        if (saveAndAddNextBtn && saveAndAddNextBtn.style.display !== 'none') {
            saveAndAddNextBtn.disabled = false;
        }
    }, 50);
}

// 鍵盤支援：在檢視 Test Case Modal 時使用左右鍵切換
function handleTestCaseModalKeydown(e) {
    try {
        const modal = document.getElementById('testCaseModal');
        if (!modal || !modal.classList.contains('show')) return;
        // 避免在輸入元件或可編輯區域觸發
        const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
        const isEditable = e.target && (e.target.isContentEditable || tag === 'input' || tag === 'textarea' || tag === 'select');
        if (isEditable) return;
        // 編輯模式時不觸發
        if (typeof currentEditorMode !== 'undefined' && currentEditorMode !== 'preview') return;
        if (e.key === 'ArrowLeft') {
            e.preventDefault();
            showPrevTestCase();
        } else if (e.key === 'ArrowRight') {
            e.preventDefault();
            showNextTestCase();
        }
    } catch (_) {}
}

function viewTestCase(id) {
    const testCase = testCases.find(tc => tc.record_id === id);
    if (testCase) {
        showTestCaseModal(testCase);
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// 表單變更監聽器
function bindFormChangeListeners() {
    const form = document.getElementById('testCaseForm');
    const saveBtn = document.getElementById('saveTestCaseBtn');
    const saveAndAddNextBtn = document.getElementById('saveAndAddNextBtn');
    
    // 為所有表單欄位綁定變更事件
    form.querySelectorAll('input, textarea, select').forEach(element => {
        element.addEventListener('input', checkFormChanges);
        element.addEventListener('change', checkFormChanges);
    });
}

// 檢查表單是否有變更
function checkFormChanges() {
    const form = document.getElementById('testCaseForm');
    const saveBtn = document.getElementById('saveTestCaseBtn');
    const saveAndAddNextBtn = document.getElementById('saveAndAddNextBtn');
    const formData = new FormData(form);
    
    // 儲存按鈕始終保持啟用狀態
    saveBtn.disabled = false;
    saveAndAddNextBtn.disabled = false;
    
    // 檢查新增模式
    if (!document.getElementById('testCaseId').value) {
        // 新增模式：所有儲存按鈕都保持啟用
        return;
    }
    
    // 編輯模式：比較與原始資料的差異（僅用於追蹤，不影響按鈕狀態）
    let hasChanges = false;
    
    for (const [key, value] of Object.entries(originalFormData)) {
        const currentValue = formData.get(key) || '';
        if (currentValue !== value) {
            hasChanges = true;
            break;
        }
    }
    
    isFormChanged = hasChanges;
    // 編輯模式下不再禁用儲存按鈕
}

// 檢查是否有未儲存的變更
function hasUnsavedChanges() {
    const form = document.getElementById('testCaseForm');
    if (!form) return false;
    
    const testCaseId = document.getElementById('testCaseId').value;
    
    // 新增模式：檢查是否有輸入任何內容
    if (!testCaseId) {
        const formData = new FormData(form);
        const title = formData.get('title') || '';
        const testCaseNumber = formData.get('test_case_number') || '';
        const steps = formData.get('steps') || '';
        const expectedResults = formData.get('expected_results') || '';
        
        // 如果任何欄位有內容，就認為有變更
        return title.trim() || testCaseNumber.trim() || steps.trim() || expectedResults.trim();
    }
    
    // 編輯模式：比較與原始資料的差異
    const formData = new FormData(form);
    for (const [key, value] of Object.entries(originalFormData)) {
        const currentValue = formData.get(key) || '';
        if (currentValue !== value) {
            return true;
        }
    }
    
    return false;
}

function deleteTestCase(id) {
    const testCase = testCases.find(tc => tc.record_id === id);
    if (!testCase) return;
    
    // 設置刪除確認 Modal 的內容
    const deleteList = document.getElementById('deleteList');
    deleteList.innerHTML = `
        <div class="mb-3">
            <p class="mb-2">確定要刪除以下測試案例嗎？</p>
            <div class="border rounded p-3 bg-light">
                <strong class="text-primary">${testCase.test_case_number || testCase.record_id}: ${testCase.title}</strong>
            </div>
        </div>
    `;
    
    // 顯示刪除確認 Modal
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    deleteModal.show();
    
    // 設置確認刪除的處理
    document.getElementById('confirmDeleteBtn').onclick = async function() {
        try {
            // 獲取當前團隊
            const currentTeam = AppUtils.getCurrentTeam();
            if (!currentTeam || !currentTeam.id) {
                throw new Error('請先選擇團隊');
            }
            
            // 發送刪除請求
            const response = await window.AuthClient.fetch(`/api/teams/${currentTeam.id}/testcases/${id}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || '刪除失敗');
            }
            
            // 關閉 Modal
            deleteModal.hide();
            
            // 從本地陣列移除已刪除的項目
            testCases = testCases.filter(tc => tc.record_id !== id);
            // 依目前過濾器重新渲染
            applyCurrentFiltersAndRender();

            // 從快取中移除
            removeTestCaseFromCache(id, testCase);
            
            // 重新渲染表格和分頁
            renderTestCasesTable();
            updatePagination();
            
            // 用 toast 通知成功
            AppUtils.showSuccess(window.i18n ? window.i18n.t('messages.testCaseDeleted') : '測試案例刪除成功');
            
        } catch (error) {
            console.error('刪除測試案例失敗:', error);
            const message = window.i18n ? window.i18n.t('errors.deleteFailed') : '刪除失敗';
            showError(message + '：' + error.message);
        }
    };
}

async function saveTestCase() {
    const form = document.getElementById('testCaseForm');
    const formData = new FormData(form);
    
    const testCaseData = {
        title: formData.get('title'),
        test_case_number: formData.get('test_case_number'),
        priority: formData.get('priority'),
        precondition: document.getElementById('precondition').value,
        steps: document.getElementById('test_steps').value,
        expected_result: document.getElementById('expected_result').value,
        tcg: document.getElementById('tcg').value  // 從隱藏欄位取得 TCG（由 Modal 多選系統維護）
        // 注意：不再包含 attachments，因為附件現在是立即附加到記錄的
    };

    // 若存在暫存上傳，帶入 temp_upload_id 讓後端在建立/更新後搬移到正式資料夾
    if (currentTempUploadId) {
        testCaseData.temp_upload_id = currentTempUploadId;
    }
    
    // 除錯：檢查 test_steps 是否被正確收集
    const testStepsElement = document.getElementById('test_steps');
    console.log('test_steps element:', testStepsElement);
    console.log('test_steps element value:', testStepsElement ? testStepsElement.value : 'element not found');
    console.log('FormData test_steps:', formData.get('test_steps'));
    console.log('All form entries:');
    for (let [key, value] of formData.entries()) {
        console.log(`  ${key}: ${value}`);
    }
    console.log('testCaseData:', testCaseData);
    
    // 表單驗證
    if (!testCaseData.title) {
        showError(window.i18n ? window.i18n.t('errors.testCaseTitleRequired') : '請填寫測試案例標題');
        return;
    }
    if (!testCaseData.test_case_number || !testCaseData.test_case_number.trim()) {
        showError(window.i18n ? window.i18n.t('errors.testCaseNumberRequired') : '請填寫測試案例編號');
        return;
    }
    
    // 檢查測試案例編號唯一性
    if (testCaseData.test_case_number) {
        const currentTestCaseId = document.getElementById('testCaseId').value;
        const isDuplicate = testCases.some(tc => 
            tc.test_case_number === testCaseData.test_case_number &&
            tc.record_id !== currentTestCaseId // 排除當前編輯的記錄
        );
        
        if (isDuplicate) {
            const errorMessage = window.i18n ? 
                window.i18n.t('errors.testCaseNumberDuplicate', {number: testCaseData.test_case_number}, `測試案例編號 '${testCaseData.test_case_number}' 已存在，請使用其他編號`) :
                `測試案例編號 '${testCaseData.test_case_number}' 已存在，請使用其他編號`;
            showError(errorMessage);
            return;
        }
    }
    
    // 獲取當前選擇的團隊
    const currentTeam = AppUtils.getCurrentTeam();
    if (!currentTeam || !currentTeam.id) {
        showError(window.i18n ? window.i18n.t('errors.pleaseSelectTeam') : '請先選擇團隊');
        return;
    }
    
    const testCaseId = document.getElementById('testCaseId').value;
    
    // 不關閉 Modal，保持編輯窗開啟以支持快速編輯
    // 重置變更狀態並禁用儲存按鈕
    isFormChanged = false;
    const saveBtn = document.getElementById('saveTestCaseBtn');
    saveBtn.disabled = true;
    const savingText = window.i18n ? window.i18n.t('messages.saving') : '儲存中...';
    saveBtn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${savingText}`;
    
    // 顯示儲存中訊息
    const savingMessage = testCaseId ? 
        (window.i18n ? window.i18n.t('messages.testCaseSaving') : '測試案例更新中...') : 
        (window.i18n ? window.i18n.t('messages.testCaseSaving') : '測試案例新增中...');
    showSuccess(savingMessage);
    
    // 背景處理儲存
    setTimeout(async () => {
        try {
            let response;
            
            if (testCaseId) {
                // 更新現有測試案例
                response = await window.AuthClient.fetch(`/api/teams/${currentTeam.id}/testcases/${testCaseId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testCaseData)
                });
            } else {
                // 新增測試案例
                // 建立 API 不支援 tcg 字串（僅 update 支援），避免 422 將其移除
                const tcgNumberForCreate = testCaseData.tcg ? String(testCaseData.tcg).trim() : '';
                try { delete testCaseData.tcg; } catch (_) {}
                response = await window.AuthClient.fetch(`/api/teams/${currentTeam.id}/testcases/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testCaseData)
                });
            }
            
            if (!response.ok) {
                let msg = '儲存失敗';
                try {
                    const errorData = await response.json();
                    if (errorData && errorData.detail) {
                        if (Array.isArray(errorData.detail)) {
                            msg = errorData.detail.map(d => d.msg || d.detail || JSON.stringify(d)).join('; ');
                        } else if (typeof errorData.detail === 'string') {
                            msg = errorData.detail;
                        } else {
                            msg = JSON.stringify(errorData.detail);
                        }
                    }
                } catch (_) {}
                throw new Error(msg);
            }
            
            // 如果是新增測試案例，需要取得新的記錄ID並轉為編輯模式
            if (!testCaseId) {
                const newTestCase = await response.json();
                if (newTestCase && newTestCase.record_id) {
                    document.getElementById('testCaseId').value = newTestCase.record_id;
                    document.getElementById('testCaseModalTitle').textContent = window.i18n ? window.i18n.t('testCase.viewTestCase') : '檢視測試案例';

                    // 如果使用者有輸入 TCG，於建立後立即更新一次（後端支援字串）
                    try {
                        const tcgInputEl = document.getElementById('tcg');
                        const tcgStr = (tcgInputEl && tcgInputEl.value) ? tcgInputEl.value.trim() : '';
                        if (tcgStr) {
                            await window.AuthClient.fetch(`/api/teams/${currentTeam.id}/testcases/${newTestCase.record_id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ tcg: tcgStr })
                            });
                        }
                    } catch (e) {
                        console.warn('建立後更新 TCG 失敗（將繼續流程）:', e);
                    }
                }
            }
            
            // 更新快取而非重新載入全部資料
            // testCaseId 已在函數開頭宣告，這裡直接使用
            if (testCaseId) {
                // 更新現有測試案例 - 先取得最新資料
                try {
                    const response = await window.AuthClient.fetch(`/api/teams/${currentTeam.id}/testcases/${testCaseId}`);
                    if (response.ok) {
                        const updatedTestCase = await response.json();
                        
                        // 更新本地列表
                        const index = testCases.findIndex(tc => tc.record_id === testCaseId);
                        if (index >= 0) {
                            testCases[index] = updatedTestCase;
                            applyCurrentFiltersAndRender();
                        }
                        
                        // 更新快取
                        updateTestCaseInCache(updatedTestCase);
                        
                        // 同步更新執行頁快取：若編號變更則移除舊快取
                        const oldNumber = (originalFormData && originalFormData.test_case_number) ? originalFormData.test_case_number : null;
                        const newNumber = updatedTestCase.test_case_number;
                        if (oldNumber && oldNumber !== newNumber) {
                            removeExecCachedTestCase(oldNumber);
                        }
                    } else {
                        // 單筆更新失敗，降級為重新載入全部資料
                        await loadTestCases(false, null, true);
                    }
                } catch (error) {
                    console.debug('快取更新失敗，降級為重新載入:', error);
                    await loadTestCases(false, null, true);
                }
            } else {
                // 新增測試案例 - 重新載入以取得完整列表（含新記錄）
                await loadTestCases(false, null, true);
            }
            
            // 恢復儲存按鈕狀態
            const saveBtn = document.getElementById('saveTestCaseBtn');
            saveBtn.disabled = false; // 儲存按鈕始終啟用
            const saveText = window.i18n ? window.i18n.t('common.save') : '儲存';
            saveBtn.innerHTML = `<i class="fas fa-save me-2"></i>${saveText}`;
            
            // 如果是編輯模式，更新 originalFormData 以反映當前保存的狀態
            if (testCaseId) {
                const form = document.getElementById('testCaseForm');
                const currentFormData = new FormData(form);
                originalFormData = {
                    title: currentFormData.get('title') || '',
                    test_case_number: currentFormData.get('test_case_number') || '',
                    priority: currentFormData.get('priority') || 'Medium',
                    tcg: document.getElementById('tcg') ? document.getElementById('tcg').value : '',
                    precondition: document.getElementById('precondition') ? document.getElementById('precondition').value : '',
                    steps: document.getElementById('test_steps') ? document.getElementById('test_steps').value : '',
                    expected_result: document.getElementById('expected_result') ? document.getElementById('expected_result').value : ''
                };
            }
            
            // 成功後清空暫存上傳識別碼（避免影響下一次操作）
            currentTempUploadId = null;

            // 更新成功訊息
            const completedMessage = testCaseId ? 
                (window.i18n ? window.i18n.t('messages.testCaseUpdated') : '測試案例更新完成') : 
                (window.i18n ? window.i18n.t('messages.testCaseCreated') : '測試案例新增完成');
            showSuccess(completedMessage);
            
        } catch (error) {
            console.error('儲存測試案例失敗:', error);
            
            // 恢復儲存按鈕狀態
            const saveBtn = document.getElementById('saveTestCaseBtn');
            saveBtn.disabled = false;
            const saveText = window.i18n ? window.i18n.t('common.save') : '儲存';
            saveBtn.innerHTML = `<i class="fas fa-save me-2"></i>${saveText}`;
            
            const saveFailedMessage = window.i18n ? window.i18n.t('errors.saveFailed') : '儲存失敗';
            showError(saveFailedMessage + '：' + error.message);
        }
    }, 100); // 100ms 延遲確保 UI 響應
}

// 儲存並新增下一筆測試案例
async function saveAndAddNext() {
    const form = document.getElementById('testCaseForm');
    const formData = new FormData(form);
    
    const testCaseData = {
        title: formData.get('title'),
        test_case_number: formData.get('test_case_number'),
        priority: formData.get('priority'),
        precondition: document.getElementById('precondition').value,
        steps: document.getElementById('test_steps').value,
        expected_result: document.getElementById('expected_result').value,
        // 直接取用 tcg 的字串（單號或多號逗號分隔），建立後再以 PUT 更新
        tcg: document.getElementById('tcg').value
    };

    // 若存在暫存上傳，帶入 temp_upload_id
    if (currentTempUploadId) {
        testCaseData.temp_upload_id = currentTempUploadId;
    }
    
    // 表單驗證
    if (!testCaseData.title) {
        showError(window.i18n ? window.i18n.t('errors.testCaseTitleRequired') : '請填寫測試案例標題');
        return;
    }
    if (!testCaseData.test_case_number || !testCaseData.test_case_number.trim()) {
        showError(window.i18n ? window.i18n.t('errors.testCaseNumberRequired') : '請填寫測試案例編號');
        return;
    }
    
    // 檢查測試案例編號唯一性（新增模式不需要排除任何記錄）
    if (testCaseData.test_case_number) {
        const isDuplicate = testCases.some(tc => 
            tc.test_case_number === testCaseData.test_case_number
        );
        
        if (isDuplicate) {
            const errorMessage = window.i18n ? 
                window.i18n.t('errors.testCaseNumberDuplicate', {number: testCaseData.test_case_number}, `測試案例編號 '${testCaseData.test_case_number}' 已存在，請使用其他編號`) :
                `測試案例編號 '${testCaseData.test_case_number}' 已存在，請使用其他編號`;
            showError(errorMessage);
            return;
        }
    }
    
    // 獲取當前選擇的團隊
    const currentTeam = AppUtils.getCurrentTeam();
    if (!currentTeam || !currentTeam.id) {
        showError(window.i18n ? window.i18n.t('errors.pleaseSelectTeam') : '請先選擇團隊');
        return;
    }
    
    // 禁用按鈕並顯示載入狀態
    const saveBtn = document.getElementById('saveTestCaseBtn');
    const saveAndAddNextBtn = document.getElementById('saveAndAddNextBtn');
    saveBtn.disabled = true;
    saveAndAddNextBtn.disabled = true;
    const savingText = window.i18n ? window.i18n.t('messages.saving') : '儲存中...';
    saveAndAddNextBtn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${savingText}`;
    
    showSuccess(window.i18n ? window.i18n.t('messages.testCaseSaving') : '測試案例新增中...');
    
    try {
        // 新增測試案例
        // 建立 API 不支援 tcg 字串（僅 update 支援），避免 422 將其移除
        const tcgNumberForCreate = testCaseData.tcg ? String(testCaseData.tcg).trim() : '';
        try { delete testCaseData.tcg; } catch (_) {}
        const response = await window.AuthClient.fetch(`/api/teams/${currentTeam.id}/testcases/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(testCaseData)
        });
        
        if (!response.ok) {
            let msg = '儲存失敗';
            try {
                const errorData = await response.json();
                if (errorData && errorData.detail) {
                    if (Array.isArray(errorData.detail)) {
                        msg = errorData.detail.map(d => d.msg || d.detail || JSON.stringify(d)).join('; ');
                    } else if (typeof errorData.detail === 'string') {
                        msg = errorData.detail;
                    } else {
                        msg = JSON.stringify(errorData.detail);
                    }
                }
            } catch (_) {}
            throw new Error(msg);
        }
        
        // 取得新建記錄資訊以便更新 TCG（若有）
        let createdRecordId = null;
        try {
            const createdJson = await response.json();
            createdRecordId = createdJson && createdJson.record_id ? createdJson.record_id : null;
        } catch (_) {}

        // 若有 TCG 輸入，建立完成後立即更新 TCG（以字串）
        if (createdRecordId && tcgNumberForCreate) {
            try {
                await window.AuthClient.fetch(`/api/teams/${currentTeam.id}/testcases/${createdRecordId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tcg: tcgNumberForCreate })
                });
            } catch (e) {
                console.warn('建立後更新 TCG 失敗（將繼續流程）:', e);
            }
        }

        // 重新載入測試案例以取得新建立的記錄
        await loadTestCases(false, null, true);

        // 將新建的案例寫入執行頁快取
        try {
            const created = testCases.find(tc => tc.test_case_number === testCaseData.test_case_number);
            if (created && created.test_case_number) {
                // 新記錄會在 setTestCasesCache 中自動更新，這裡確保執行頁快取一致
                setExecCachedTestCase(created.test_case_number, created);
            }
        } catch (e) { console.debug('set exec cache (create) skipped:', e); }
        
        showSuccess(window.i18n ? window.i18n.t('messages.testCaseCreatedNext') : '測試案例新增完成，準備下一筆');
        
        // 保存當前資料用於產生下一筆
        const currentNumber = testCaseData.test_case_number;
        const currentTitle = testCaseData.title;
        const currentPrecondition = testCaseData.precondition;
        const currentSteps = testCaseData.steps;
        const currentExpectedResult = testCaseData.expected_result;
        // 重要：在重置表單前先暫存當前 TCG 單號（建立時不傳，建立後會用於 PUT）
        const currentTCG = (typeof tcgNumberForCreate === 'string' && tcgNumberForCreate.trim()) ? tcgNumberForCreate.trim() : '';
        
        // 成功新增後清空暫存上傳識別碼
        currentTempUploadId = null;
        // 重置表單為新增下一筆狀態
        showTestCaseModal(null); // 呼叫新增模式，會自動清空所有欄位並設定為編輯模式
        
        // 產生下一筆的預填資料
        const nextNumber = generateNextTestCaseNumber(currentNumber);
        const titlePrefix = extractTitlePrefix(currentTitle);
        
        // 設定預填值
        setTimeout(() => {
            if (nextNumber !== currentNumber) {
                document.getElementById('testCaseNumber').value = nextNumber;
            }
            if (titlePrefix) {
                document.getElementById('title').value = titlePrefix;
            }
            // 保留 Precondition, Steps, Expected Results
            if (currentPrecondition) {
                document.getElementById('precondition').value = currentPrecondition;
            }
            if (currentSteps) {
                document.getElementById('test_steps').value = currentSteps;
            }
            if (currentExpectedResult) {
                document.getElementById('expected_result').value = currentExpectedResult;
            }
            // 保留相同 TCG 單號
            const tcgDisplayNext = document.getElementById('tcg');
            if (tcgDisplayNext) {
                tcgDisplayNext.value = currentTCG || '';
            }
            // 同步更新多選標籤狀態，確保 UI 與隱藏欄位一致
            if (typeof currentTCG === 'string' && currentTCG.trim()) {
                modalTCGSelected = currentTCG.split(',').map(t => t.trim()).filter(Boolean);
            } else {
                modalTCGSelected = [];
            }
            renderModalTCGDisplay();
        }, 100);

    } catch (error) {
        console.error('儲存測試案例失敗:', error);
        
        // 恢復按鈕狀態
        saveBtn.disabled = false;
        saveAndAddNextBtn.disabled = false;
        const saveAndNextText = window.i18n ? window.i18n.t('testCase.saveAndNext') : '儲存並新增下一筆';
        saveAndAddNextBtn.innerHTML = `<i class="fas fa-plus me-2"></i>${saveAndNextText}`;
        
        const saveFailedMessage = window.i18n ? window.i18n.t('errors.saveFailed') : '儲存失敗';
        showError(saveFailedMessage + '：' + error.message);
    }
}

// 工具函數
function generateNextTestCaseNumber(currentNumber) {
    // 解析格式：TCG-93178.020.050
    const match = currentNumber.match(/^(.+\.)(\d+)$/);
    if (match) {
        const prefix = match[1];  // TCG-93178.020.
        const lastNumber = parseInt(match[2]);  // 050 → 50
        const nextNumber = (lastNumber + 10).toString().padStart(3, '0');  // 060
        return prefix + nextNumber;
    }
    return currentNumber;  // 無法解析則返回原值
}

function extractTitlePrefix(title) {
    // 找到最後一個 hyphen 並保留前面部分
    const lastHyphenIndex = title.lastIndexOf(' - ');
    if (lastHyphenIndex > 0) {
        return title.substring(0, lastHyphenIndex + 3);  // 保留 " - "
    }
    return '';  // 沒有 hyphen 則返回空字串
}

function getStatusBadgeClass(status) {
    const classes = {
        'Draft': 'bg-secondary',
        'Review': 'bg-warning',
        'Active': 'bg-success',
        'Deprecated': 'bg-danger'
    };
    return classes[status] || 'bg-secondary';
}

function getStatusText(status) {
    const texts = {
        'Draft': '草稿',
        'Review': '待審核',
        'Active': '啟用',
        'Deprecated': '廢棄'
    };
    return texts[status] || status;
}

function getPriorityBadgeClass(priority) {
    const classes = {
        'High': 'bg-danger',
        'Medium': 'bg-warning',
        'Low': 'bg-info'
    };
    return classes[priority] || 'bg-secondary';
}

function getPriorityText(priority) {
    return priority || '';
}

function getTCGDisplay(testCase) {
    if (!testCase.tcg || testCase.tcg.length === 0) {
        return '-';
    }
    
    // 提取所有 TCG 顯示文字
    const tcgNumbers = [];
    for (const tcgRecord of testCase.tcg) {
        if (tcgRecord.text) {
            tcgNumbers.push(tcgRecord.text);
        } else if (tcgRecord.text_arr && tcgRecord.text_arr.length > 0) {
            tcgNumbers.push(...tcgRecord.text_arr);
        }
    }
    
    return tcgNumbers.length > 0 ? tcgNumbers.join(', ') : '-';
}

function getTCGTags(testCase) {
    if (!testCase.tcg || testCase.tcg.length === 0) {
        return '';
    }
    
    // 提取所有 TCG 顯示文字
    const tcgNumbers = [];
    for (const tcgRecord of testCase.tcg) {
        if (tcgRecord.text) {
            tcgNumbers.push(tcgRecord.text);
        } else if (tcgRecord.text_arr && tcgRecord.text_arr.length > 0) {
            tcgNumbers.push(...tcgRecord.text_arr);
        }
    }
    
    if (tcgNumbers.length === 0) {
        return '';
    }
    
    // 創建柔和的 tag
    return tcgNumbers.map(tcg => 
        `<span class="tcg-tag">${tcg}</span>`
    ).join('');
}

function applyFilters() {
    const testCaseNumberSearchEl = document.getElementById('testCaseNumberSearch');
    const searchEl = document.getElementById('searchInput');
    const tcgEl = document.getElementById('tcgFilter');
    const priorityEl = document.getElementById('priorityFilter');

    // 更新記憶體中的過濾器
    tcmCurrentFilters.testCaseNumberSearch = testCaseNumberSearchEl ? (testCaseNumberSearchEl.value || '') : '';
    tcmCurrentFilters.searchInput = searchEl ? (searchEl.value || '') : '';
    tcmCurrentFilters.tcgFilter = tcgEl ? (tcgEl.value || '') : '';
    tcmCurrentFilters.priorityFilter = priorityEl ? (priorityEl.value || '') : '';

    // 保存到持久化儲存（依 team 隔離）
    saveTcmFiltersToStorage({
        testCaseNumberSearch: tcmCurrentFilters.testCaseNumberSearch,
        searchInput: tcmCurrentFilters.searchInput,
        tcgFilter: tcmCurrentFilters.tcgFilter,
        priorityFilter: tcmCurrentFilters.priorityFilter
    });

    // 依記憶體過濾器重新計算
    filteredTestCases = computeFilteredTestCases(testCases);
    
    currentPage = 1;
    renderTestCasesTable();
    updatePagination();
    updateFilterStatus();
}

function clearFilters() {
    const elNum = document.getElementById('testCaseNumberSearch');
    const elSearch = document.getElementById('searchInput');
    const elTCG = document.getElementById('tcgFilter');
    const elPri = document.getElementById('priorityFilter');
    if (elNum) elNum.value = '';
    if (elSearch) elSearch.value = '';
    if (elTCG) elTCG.value = '';
    if (elPri) elPri.value = '';

    // 清除此 team 的持久化篩選
    clearTcmFiltersInStorage();

    // 重置記憶體過濾器
    tcmCurrentFilters = { testCaseNumberSearch: '', searchInput: '', tcgFilter: '', priorityFilter: '' };
    
    filteredTestCases = [...testCases];
    currentPage = 1;
    renderTestCasesTable();
    updatePagination();
    updateFilterStatus();
}

function updateFilterStatus() {
    const applyBtn = document.getElementById('applyFiltersBtn');
    const clearBtn = document.getElementById('clearFiltersBtn');
    
    // 檢查是否有任何篩選條件
    const hasFilters = hasAnyFilters();
    
    if (hasFilters) {
        // 有篩選條件時，更新按鈕樣式和文字
        const filteredText = window.i18n ? window.i18n.t('common.filtered', {count: filteredTestCases.length}) : `已篩選 (${filteredTestCases.length})`;
        applyBtn.innerHTML = '<i class="fas fa-filter me-2"></i>' + filteredText;
        applyBtn.className = 'btn btn-success me-2';
        clearBtn.style.display = 'inline-block';
    } else {
        // 無篩選條件時，恢復原始樣式
        const applyFilterText = window.i18n ? window.i18n.t('common.applyFilter') : '套用篩選';
        applyBtn.innerHTML = '<i class="fas fa-filter me-2"></i>' + applyFilterText;
        applyBtn.className = 'btn btn-primary me-2';
        clearBtn.style.display = testCases.length === filteredTestCases.length ? 'none' : 'inline-block';
    }
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAllCheckbox').checked;
    const checkboxes = document.querySelectorAll('.test-case-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll;
        const id = checkbox.value; // record_id 是字串，勿轉數字
        if (selectAll) {
            selectedTestCases.add(id);
        } else {
            selectedTestCases.delete(id);
        }
    });
    
    updateBatchToolbar();
    // 重置 Shift 多選錨點
    lastCaseCheckboxIndex = null;
}

function updateBatchToolbar() {
    const toolbar = document.getElementById('batchInlineToolbar');
    if (!toolbar) return;
    
    const selectedCount = selectedTestCases ? selectedTestCases.size : 0;
    
    // 更新選中數量顯示
    const countWrapper = document.getElementById('selectedCountWrapper');
    if (countWrapper) {
        // 更新 data-i18n-params
        countWrapper.setAttribute('data-i18n-params', JSON.stringify({count: selectedCount}));
        
        // 如果 i18n 已載入，重新翻譯此元素
        if (window.i18n && window.i18n.updateElement) {
            window.i18n.updateElement(countWrapper);
        } else {
            // 如果 i18n 還未載入或無法更新，手動更新內容
            const currentLang = localStorage.getItem('preferredLanguage') || 'zh-TW';
            if (currentLang === 'zh-TW') {
                countWrapper.textContent = `已選取 ${selectedCount} 個項目`;
            } else {
                countWrapper.textContent = `${selectedCount} items selected`;
            }
        }
    }
    
    // 顯示/隱藏工具列
    if (selectedCount > 0) {
        toolbar.classList.remove('d-none');
    } else {
        toolbar.classList.add('d-none');
    }
    
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function deselectAll() {
    selectedTestCases.clear();
    document.querySelectorAll('.test-case-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('selectAllCheckbox').checked = false;
    updateBatchToolbar();
    lastCaseCheckboxIndex = null;
}

function batchEditTestCases() {
    if (selectedTestCases.size === 0) {
        showError(window.i18n ? window.i18n.t('errors.pleaseSelectTestCase') : '請先選擇要編輯的測試案例');
        return;
    }
    // TODO: 實現批次編輯功能
    const msg = window.i18n ? window.i18n.t('messages.operationNotImplemented') : '批次編輯功能開發中...';
    alert(msg);
}

// 批次修改相關函數
function openTestCaseBatchModifyModal() {
    if (selectedTestCases.size === 0) {
        const msg = window.i18n ? window.i18n.t('errors.pleaseSelectForModify') : '請先選擇要修改的測試案例';
        AppUtils.showError(msg);
        return;
    }
    
    // 更新選中項目數量顯示
    document.getElementById('testCaseBatchModifyCount').textContent = selectedTestCases.size;
    
    // 重置表單
    document.getElementById('batchModifyTCG').checked = true;
    document.getElementById('batchTCGInput').value = '';
    document.getElementById('batchModifyPriority').checked = false;
    document.getElementById('batchPrioritySelect').value = '';
    document.getElementById('batchPrioritySelect').disabled = true;
    
    // 初始化批次 TCG 編輯器
    initializeBatchTCGEditor();
    
    // 顯示模態框
    const modal = new bootstrap.Modal(document.getElementById('testCaseBatchModifyModal'));
    modal.show();
    
    // 模態框顯示後確保 TCG 容器正確顯示
    setTimeout(() => {
        const container = document.getElementById('batchTCGContainer');
        if (container) {
            container.style.border = '1px solid #ced4da';
            container.style.borderRadius = '0.375rem';
            container.style.padding = '0.375rem';
            container.style.backgroundColor = '#ffffff';
            container.style.cursor = 'pointer';
            container.setAttribute('title', '點擊編輯 TCG 單號');
            
            // 新增一個提示文字當沒有選擇時
            if (batchTCGSelected.length === 0) {
                container.innerHTML = '<span class="text-muted small">點擊此處選擇 TCG 單號...</span>';
            }
            
            // **關鍵修正**：重新綁定點擊事件，因為 innerHTML 會清除事件監聽器
            container.removeEventListener('click', openBatchTCGEditor); // 移除舊的（如果有）
            container.addEventListener('click', openBatchTCGEditor); // 重新綁定
        }
        
        // 綁定模態框關閉事件
        const modal = document.getElementById('testCaseBatchModifyModal');
        if (modal) {
            modal.addEventListener('hidden.bs.modal', function() {
                // 清理 TCG 編輯器狀態
                if (batchTCGEditing) {
                    finishBatchTCGEdit();
                }
                // 隱藏下拉選單
                const dropdown = document.getElementById('batchTCGDropdown');
                if (dropdown) {
                    dropdown.style.display = 'none';
                }
            }, { once: true });
        }
    }, 100);
}

// 批次修改 TCG 多選顯示與搜尋（與列表一致）
let batchTCGSearchTimeout;
let batchTCGEditing = false;
let batchTCGSelected = [];

// 初始化批次 TCG 編輯器
function initializeBatchTCGEditor() {
    console.log('Initializing batch TCG editor...'); // 調試用
    // 重置狀態
    batchTCGSelected = [];
    batchTCGEditing = false;
    
    // 清理任何存在的監聽器
    document.removeEventListener('click', handleBatchTCGOutsideClick, true);
    
    // 重置顯示
    renderBatchTCGDisplay();
    
    // 確保點擊事件正確綁定
    const container = document.getElementById('batchTCGContainer');
    if (container) {
        container.removeEventListener('click', openBatchTCGEditor);
        container.addEventListener('click', openBatchTCGEditor);
        console.log('Batch TCG container click event bound'); // 調試用
    } else {
        console.error('Batch TCG container not found!'); // 調試用
    }
}

function renderBatchTCGDisplay() {
    const container = document.getElementById('batchTCGContainer');
    if (!container) return;
    
    if (!Array.isArray(batchTCGSelected) || batchTCGSelected.length === 0) {
        // 顯示提示文字當沒有選擇時
        container.innerHTML = '<span class="text-muted small">點擊此處選擇 TCG 單號...</span>';
        // 重新綁定點擊事件（因為 innerHTML 會清除事件）
        container.removeEventListener('click', openBatchTCGEditor);
        container.addEventListener('click', openBatchTCGEditor);
        return;
    }
    
    const tags = batchTCGSelected.map(t => `<span class="tcg-tag">${t}</span>`).join(' ');
    container.innerHTML = tags;
    // 重新綁定點擊事件（因為 innerHTML 會清除事件）
    container.removeEventListener('click', openBatchTCGEditor);
    container.addEventListener('click', openBatchTCGEditor);
}

function openBatchTCGEditor() {
    console.log('openBatchTCGEditor called'); // 調試用
    const container = document.getElementById('batchTCGContainer');
    if (!container) {
        console.error('Batch TCG container not found!'); // 調試用
        return;
    }
    if (batchTCGEditing) {
        console.log('Already editing, skipping...'); // 調試用
        return;
    }
    batchTCGEditing = true;
    // 建立與列表一致的搜尋輸入與下拉
    const searchHtml = `
        <div class="tcg-search-container position-relative" style="min-height: 32px; height: 32px; display: flex; align-items: center; overflow: hidden;">
            <input type="text" class="form-control form-control-sm tcg-search-input" 
                   data-i18n-placeholder="testCase.tcgPlaceholder" autocomplete="off" 
                   onkeydown="handleBatchTCGSearchKeydown(event)" 
                   oninput="handleBatchTCGSearchInput(event)"
                   onclick="event.stopPropagation()"
                   style="height: 28px; width: 100%; font-size: 0.75rem; padding: 0.125rem 0.375rem; border: 1px solid #dee2e6; box-shadow: none; outline: none;">
        </div>`;
    container.innerHTML = searchHtml;
    const input = container.querySelector('.tcg-search-input');
    input.focus();
    // 立刻調整 dropdown 位置並顯示
    positionBatchTCGDropdown();
    searchBatchTCGOptions('');
    // 監聽外部點擊以結束編輯
    setTimeout(() => { document.addEventListener('click', handleBatchTCGOutsideClick, true); }, 50);
}

function positionBatchTCGDropdown() {
    try {
        const host = document.getElementById('batchTCGContainer');
        const dropdown = document.getElementById('batchTCGDropdown');
        if (!host || !dropdown) return;
        const rect = host.getBoundingClientRect();
        // 使用 fixed 定位，相對於 viewport 準確定位
        dropdown.style.position = 'fixed';
        dropdown.style.top = (rect.bottom + 2) + 'px';
        dropdown.style.left = rect.left + 'px';
        dropdown.style.width = rect.width + 'px';
        dropdown.style.maxHeight = '220px';
        dropdown.style.overflowY = 'auto';
        dropdown.style.zIndex = '1070'; // 提高 z-index 確保在 modal 之上
        dropdown.style.display = 'block';
    } catch(_){}
}

function handleBatchTCGOutsideClick(e) {
    const container = document.getElementById('batchTCGContainer');
    const dropdown = document.getElementById('batchTCGDropdown');
    if (!container) return;
    const insideContainer = container.contains(e.target);
    const insideDropdown = dropdown && dropdown.contains(e.target);
    if (!insideContainer && !insideDropdown) {
        // 點擊在外部：結束編輯並收起下拉
        if (dropdown) dropdown.style.display = 'none';
        finishBatchTCGEdit();
    }
}

function finishBatchTCGEdit() {
    document.removeEventListener('click', handleBatchTCGOutsideClick, true);
    batchTCGEditing = false;
    // 回寫隱藏 input 值（逗號+空白）
    const hidden = document.getElementById('batchTCGInput');
    if (hidden) hidden.value = batchTCGSelected.join(', ');
    // 收起下拉
    const dropdown = document.getElementById('batchTCGDropdown');
    if (dropdown) dropdown.style.display = 'none';
    renderBatchTCGDisplay();
}

function handleBatchTCGSearchInput(event) {
    clearTimeout(batchTCGSearchTimeout);
    const raw = String(event.target.value || '').trim();
    // 取最後一段作為搜尋鍵，避免多值逗號影響查詢
    const parts = raw.replace(/\n/g, ',').split(',').map(s => s.trim()).filter(Boolean);
    const keyword = parts.length ? parts[parts.length - 1] : '';
    batchTCGSearchTimeout = setTimeout(async () => { await searchBatchTCGOptions(keyword); }, 150);
}

function handleBatchTCGSearchKeydown(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        finishBatchTCGEdit();
    } else if (event.key === 'Escape') {
        event.preventDefault();
        // 取消變更：不做特別處理，直接結束編輯
        finishBatchTCGEdit();
    }
}

async function searchBatchTCGOptions(keyword) {
    const dropdown = document.getElementById('batchTCGDropdown');
    if (!dropdown) return;
    
    try {
        const currentTeam = AppUtils.getCurrentTeam();
        if (!currentTeam || !currentTeam.id) {
            const selectTeamText = window.i18n ? window.i18n.t('errors.pleaseSelectTeam', {}, '請先選擇團隊') : '請先選擇團隊';
            dropdown.innerHTML = `<div class="p-2 text-danger small">${selectTeamText}</div>`;
            dropdown.style.display = 'block';
            return;
        }
        // 搜尋 API：允許空字串（顯示熱門/全部）
        const response = await window.AuthClient.fetch(`/api/tcg/search?keyword=${encodeURIComponent(keyword || '')}&limit=20`);
        const data = await response.json();
        if (response.ok && data.results) {
            updateBatchTCGDropdown(data.results);
        } else {
            const searchFailedText = window.i18n ? window.i18n.t('errors.searchFailed', {}, '搜尋失敗') : '搜尋失敗';
            dropdown.innerHTML = `<div class="p-2 text-muted">${searchFailedText}</div>`;
            dropdown.style.display = 'block';
        }
    } catch (error) {
        console.error('TCG 搜尋錯誤:', error);
        const searchFailedText = window.i18n ? window.i18n.t('errors.searchFailed', {}, '搜尋失敗') : '搜尋失敗';
        dropdown.innerHTML = `<div class="p-2 text-muted">${searchFailedText}</div>`;
        dropdown.style.display = 'block';
    }
}

function updateBatchTCGDropdown(results) {
    // 防止點擊下拉內部觸發外部關閉
    const dropdownEl = document.getElementById('batchTCGDropdown');
    if (dropdownEl && !dropdownEl.__boundStop) {
        // 使用冒泡階段阻止事件往外層傳遞，避免影響外部點擊處理
        dropdownEl.addEventListener('mousedown', function(e){ e.stopPropagation(); }, false);
        dropdownEl.addEventListener('click', function(e){ e.stopPropagation(); }, false);
        dropdownEl.__boundStop = true;
    }
    positionBatchTCGDropdown();
    const dropdown = document.getElementById('batchTCGDropdown');
    if (!dropdown) return;
    
    let html = '';
    // 清除選取選項
    html += `
        <div class="tcg-option p-2 border-bottom" 
             onclick="event.stopPropagation(); clearBatchTCG()" 
             style="cursor: pointer; border-bottom: 1px solid #f8f9fa; background-color: #fff3cd;" 
             onmouseover="this.style.backgroundColor='#ffeaa7'" 
             onmouseout="this.style.backgroundColor='#fff3cd'">
          <div class="fw-medium text-warning">
            <i class="fas fa-times me-2"></i>清除 TCG 單號
          </div>
        </div>`;
    
    if (!Array.isArray(results) || results.length === 0) {
        html += '<div class="p-2 text-muted">無符合的結果</div>';
        dropdown.innerHTML = html;
        dropdown.style.display = 'block';
        return;
    }

    html += results.map((tcg, index) => {
        const selected = Array.isArray(batchTCGSelected) && batchTCGSelected.includes(tcg.tcg_number);
        return `
            <div class="tcg-option p-2 border-bottom d-flex justify-content-between align-items-center" 
                 data-tcg-number="${tcg.tcg_number}"
                 onclick="event.stopPropagation(); toggleBatchTCG('${tcg.tcg_number}')"
                 onmouseenter="highlightBatchTCGOption(${index})"
                 style="cursor: pointer; border-bottom: 1px solid #eee; transition: background-color 0.15s;">
                <div class="fw-medium">${tcg.tcg_number}</div>
                ${selected ? '<i class="fas fa-check text-success"></i>' : ''}
            </div>`;
    }).join('');

    dropdown.innerHTML = html;
    dropdown.style.display = 'block';

    // 添加 CSS 樣式到 dropdown
    const style = `
        <style id="batchTCGDropdownStyle">
        .tcg-option:hover, .tcg-option.active {
            background-color: #f8f9fa !important;
        }
        .tcg-option.active {
            background-color: #e3f2fd !important;
        }
        </style>
    `;
    if (!document.getElementById('batchTCGDropdownStyle')) {
        document.head.insertAdjacentHTML('beforeend', style);
    }
}

function handleBatchTCGKeydown(event) {
    const dropdown = document.getElementById('batchTCGDropdown');
    if (!dropdown || dropdown.style.display === 'none') return;
    
    const options = dropdown.querySelectorAll('.tcg-option');
    let currentIndex = -1;
    
    // 找到當前選中的項目
    options.forEach((option, index) => {
        if (option.classList.contains('active')) {
            currentIndex = index;
        }
    });
    
    switch (event.key) {
        case 'ArrowDown':
            event.preventDefault();
            const nextIndex = Math.min(currentIndex + 1, options.length - 1);
            highlightBatchTCGOption(nextIndex);
            break;
        case 'ArrowUp':
            event.preventDefault();
            const prevIndex = Math.max(currentIndex - 1, 0);
            highlightBatchTCGOption(prevIndex);
            break;
        case 'Enter':
            event.preventDefault();
            if (currentIndex >= 0 && options[currentIndex]) {
                const tcgNumber = options[currentIndex].getAttribute('data-tcg-number');
                if (tcgNumber) {
                    selectBatchTCG(tcgNumber);
                }
            }
            break;
        case 'Escape':
            event.preventDefault();
            hideBatchTCGDropdown();
            break;
    }
}

function highlightBatchTCGOption(index) {
    const dropdown = document.getElementById('batchTCGDropdown');
    if (!dropdown) return;
    
    const options = dropdown.querySelectorAll('.tcg-option');
    options.forEach((option, i) => {
        if (i === index) {
            option.classList.add('active');
            option.scrollIntoView({ block: 'nearest' });
        } else {
            option.classList.remove('active');
        }
    });
}

function toggleBatchTCG(tcgNumber) {
    if (!Array.isArray(batchTCGSelected)) batchTCGSelected = [];
    const idx = batchTCGSelected.indexOf(tcgNumber);
    if (idx >= 0) batchTCGSelected.splice(idx, 1); else batchTCGSelected.push(tcgNumber);

    // 同步隱藏欄位，確保按下「確認修改」時可以讀到最新選擇
    const hidden = document.getElementById('batchTCGInput');
    if (hidden) hidden.value = batchTCGSelected.join(', ');
    
    // 編輯狀態下不要重繪容器，避免將搜尋輸入框移除導致後續無法點擊
    if (!batchTCGEditing) {
        renderBatchTCGDisplay();
    }
    
    // 重新搜尋並更新下拉選單，但不先清空避免閃爍
    const inputEl = document.querySelector('#batchTCGContainer .tcg-search-input');
    const kw = inputEl ? inputEl.value : '';
    searchBatchTCGOptions(kw || '');
}

function clearBatchTCG() {
    batchTCGSelected = [];
    // 同步隱藏欄位
    const hidden = document.getElementById('batchTCGInput');
    if (hidden) hidden.value = '';
    
    if (!batchTCGEditing) {
        renderBatchTCGDisplay();
    }
    const inputEl = document.querySelector('#batchTCGContainer .tcg-search-input');
    const kw = inputEl ? inputEl.value : '';
    searchBatchTCGOptions(kw || '');
}

function showBatchTCGDropdown() {
    const input = document.getElementById('batchTCGInput');
    const dropdown = document.getElementById('batchTCGDropdown');
    
    if (input.value.trim().length >= 2) {
        handleBatchTCGSearch(input);
    } else {
        dropdown.innerHTML = '<div class="p-2 text-muted small" data-i18n="testCase.tcgSearchHint">開始輸入以搜尋 TCG...</div>';
        
        // 重新應用翻譯到新生成的內容
        if (window.i18n && window.i18n.isReady()) {
            window.i18n.retranslate(dropdown);
        }
        
        dropdown.style.display = 'block';
    }
}

function hideBatchTCGDropdown() {
    setTimeout(() => {
        const dropdown = document.getElementById('batchTCGDropdown');
        if (dropdown) {
            dropdown.style.display = 'none';
        }
    }, 200);
}

// 鍵盤選取支援（Enter 使用的函式）
function selectBatchTCG(tcgNumber) {
    // 與點擊效果一致
    toggleBatchTCG(tcgNumber);
}

// 立即更新本地測試案例資料
function updateLocalTestCasesAfterBatchModify(selectedIds, updateData) {
    // 更新本地 testCases 陣列
    testCases.forEach(testCase => {
        if (selectedIds.includes(testCase.record_id)) {
            // 更新 TCG
            if (updateData.tcg !== undefined) {
                if (updateData.tcg === '') {
                    // 清空 TCG
                    testCase.tcg = [];
                } else if (Array.isArray(updateData.tcg)) {
                    testCase.tcg = updateData.tcg.map(n => ({ text: n, text_arr: [n], display_text: n, type: 'text' }));
                } else {
                    // 單一值
                    testCase.tcg = [{ text: updateData.tcg, text_arr: [updateData.tcg], display_text: updateData.tcg, type: 'text' }];
                }
            }
            
            // 更新優先級
            if (updateData.priority !== undefined) {
                testCase.priority = updateData.priority;
            }
        }
    });
    
    // 更新篩選後的陣列
    filteredTestCases.forEach(testCase => {
        if (selectedIds.includes(testCase.record_id)) {
            // 更新 TCG
            if (updateData.tcg !== undefined) {
                if (updateData.tcg === '') {
                    testCase.tcg = [];
                } else if (Array.isArray(updateData.tcg)) {
                    testCase.tcg = updateData.tcg.map(n => ({ text: n, text_arr: [n], display_text: n, type: 'text' }));
                } else {
                    testCase.tcg = [{ text: updateData.tcg, text_arr: [updateData.tcg], display_text: updateData.tcg, type: 'text' }];
                }
            }
            
            // 更新優先級
            if (updateData.priority !== undefined) {
                testCase.priority = updateData.priority;
            }
        }
    });
    
    // 立即依目前過濾器重新渲染
    applyCurrentFiltersAndRender();
}

async function performTestCaseBatchModify() {
    const modifyTCG = document.getElementById('batchModifyTCG').checked;
    const modifyPriority = document.getElementById('batchModifyPriority').checked;
    
    if (!modifyTCG && !modifyPriority) {
        const msg = window.i18n ? window.i18n.t('errors.selectModifyFields') : '請至少選擇一個要修改的欄位';
        AppUtils.showError(msg);
        return;
    }
    
    const selectedIds = Array.from(selectedTestCases);
    const updateData = {};
    
    // 收集要修改的資料
    if (modifyTCG) {
        const raw = document.getElementById('batchTCGInput').value || '';
        const parts = raw.replace(/\n/g, ',').replace(/\s+/g, ',').split(',').map(s => s.trim()).filter(Boolean);
        if (parts.length === 0) {
            updateData.tcg = '';
        } else if (parts.length === 1) {
            updateData.tcg = parts[0];
        } else {
            updateData.tcg = parts;
        }
    }
    
    if (modifyPriority) {
        const priorityValue = document.getElementById('batchPrioritySelect').value;
        if (!priorityValue) {
            const msg = window.i18n ? window.i18n.t('errors.selectPriorityValue') : '請選擇優先級';
            AppUtils.showError(msg);
            return;
        }
        updateData.priority = priorityValue;
    }
    
    try {
        // 獲取當前團隊
        const currentTeam = AppUtils.getCurrentTeam();
        if (!currentTeam || !currentTeam.id) {
            const msg = window.i18n ? window.i18n.t('errors.pleaseSelectTeam') : '請先選擇團隊';
            AppUtils.showError(msg);
            return;
        }
        
        // 顯示載入狀態
        const confirmBtn = document.getElementById('confirmTestCaseBatchModifyBtn');
        const originalBtnText = confirmBtn.innerHTML;
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>修改中...';
        
        // 呼叫後端 API - 需要先擴展 API 支援更多欄位
        let success = true;
        let errorMessages = [];
        
        // 分別處理 TCG 和 Priority（因為現有 API 只支援個別處理）
        if (modifyTCG) {
            const response = await window.AuthClient.fetch(`/api/teams/${currentTeam.id}/testcases/batch`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    operation: 'update_tcg',
                    record_ids: selectedIds,
                    update_data: { tcg: updateData.tcg }
                })
            });
            
            const result = await response.json();
            if (!result.success) {
                success = false;
                errorMessages.push(...(result.error_messages || ['TCG 更新失敗']));
            }
        }
        
        if (modifyPriority) {
            const response = await window.AuthClient.fetch(`/api/teams/${currentTeam.id}/testcases/batch`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    operation: 'update_priority',
                    record_ids: selectedIds,
                    update_data: { priority: updateData.priority }
                })
            });
            
            const result = await response.json();
            if (!result.success) {
                success = false;
                errorMessages.push(...(result.error_messages || ['優先級更新失敗']));
            }
        }
        
        // 恢復按鈕狀態
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = originalBtnText;
        
        if (success) {
            // 關閉模態框
            const modal = bootstrap.Modal.getInstance(document.getElementById('testCaseBatchModifyModal'));
            if (modal) modal.hide();
            
            // 立即更新本地資料顯示（不顯示載入動畫）
            updateLocalTestCasesAfterBatchModify(selectedIds, updateData);
            
            // 清除選擇
            deselectAll();
            
            const successMsg = window.i18n ? 
                window.i18n.t('messages.batchModifySuccess', { count: selectedIds.length }) : 
                `成功修改 ${selectedIds.length} 個測試案例`;
            AppUtils.showSuccess(successMsg);
            
            // 背景重新同步資料（強制刷新快取）
            setTimeout(async () => {
                try {
                    clearTestCasesCache(); // 清除快取確保資料同步
                    await loadTestCases(false, null, true); // 強制從伺服器重新載入
                } catch (error) {
                    console.warn('背景同步資料失敗:', error);
                }
            }, 1000);
            
        } else {
            const errorMsg = window.i18n ? window.i18n.t('errors.batchModifyFailed') : '批次修改失敗';
            AppUtils.showError(errorMsg + ': ' + errorMessages.join(', '));
        }
        
    } catch (error) {
        console.error('批次修改錯誤:', error);
        
        // 恢復按鈕狀態
        const confirmBtn = document.getElementById('confirmTestCaseBatchModifyBtn');
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = '<i class="fas fa-edit me-2"></i><span data-i18n="testCase.confirmModify">確認修改</span>';
        
        // 重新應用翻譯到按鈕內容
        if (window.i18n && window.i18n.isReady()) {
            window.i18n.retranslate(confirmBtn);
        }
        
        const errorMsg = window.i18n ? window.i18n.t('errors.batchModifyFailed') : '批次修改失敗';
        AppUtils.showError(errorMsg + ': ' + error.message);
    }
}

function batchDeleteTestCases() {
    if (selectedTestCases.size === 0) {
        showError(window.i18n ? window.i18n.t('errors.pleaseSelectForDelete') : '請先選擇要刪除的測試案例');
        return;
    }
    
    // 獲取選中的測試案例
    const selectedIds = Array.from(selectedTestCases);
    const selectedCases = testCases.filter(tc => selectedIds.includes(tc.record_id));
    
    // 設置批次刪除確認 Modal 的內容
    const deleteList = document.getElementById('deleteList');
    deleteList.innerHTML = `
        <div class="mb-3">
            <p class="mb-2">確定要刪除以下 ${selectedCases.length} 個測試案例嗎？</p>
            <div class="border rounded p-3 bg-light" style="max-height: 300px; overflow-y: auto;">
                ${selectedCases.map(tc => `
                    <div class="mb-2">
                        <strong class="text-primary">${tc.test_case_number || tc.record_id}: ${tc.title}</strong>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    // 顯示刪除確認 Modal
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    deleteModal.show();
    
    // 設置確認刪除的處理
    document.getElementById('confirmDeleteBtn').onclick = async function() {
        try {
            // 獲取當前團隊
            const currentTeam = AppUtils.getCurrentTeam();
            if (!currentTeam || !currentTeam.id) {
                throw new Error('請先選擇團隊');
            }
            
            // 發送批次刪除請求
            const response = await window.AuthClient.fetch(`/api/teams/${currentTeam.id}/testcases/batch`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    operation: 'delete',
                    record_ids: selectedIds
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || '批次刪除失敗');
            }
            
            // 關閉 Modal
            deleteModal.hide();
            
            // 清除選擇
            deselectAll();
            
            // 從本地陣列移除已刪除的項目（背景處理，不顯示載入動畫）
            const deletedIds = Array.from(selectedIds);
            testCases = testCases.filter(tc => !deletedIds.includes(tc.record_id));
            filteredTestCases = filteredTestCases.filter(tc => !deletedIds.includes(tc.record_id));
            
            // 重新渲染表格和分頁
            renderTestCasesTable();
            updatePagination();
            
            // 用 toast 通知成功
            const batchDeleteMessage = window.i18n ? 
                window.i18n.t('messages.batchDeleteSuccess', {count: selectedCases.length}) : 
                `成功刪除 ${selectedCases.length} 個測試案例`;
            AppUtils.showSuccess(batchDeleteMessage);
            
        } catch (error) {
            console.error('批次刪除測試案例失敗:', error);
            const batchDeleteFailedMessage = window.i18n ? window.i18n.t('errors.batchDeleteFailed') : '批次刪除失敗';
            showError(batchDeleteFailedMessage + '：' + error.message);
        }
    };
}

function showLoadingState() {
    const tbody = document.getElementById('testCasesTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="8" class="text-center" style="padding-top: 4rem; padding-bottom: 4rem; padding-left: 1rem; padding-right: 1rem;">
                <div class="spinner-border text-primary" role="status" style="width: 2.5rem; height: 2.5rem;">
                    <span class="visually-hidden">載入中...</span>
                </div>
                <div class="mt-2 text-muted fs-6">載入測試案例中...</div>
            </td>
        </tr>
    `;
}

function hideLoadingState() {
    // hideLoadingState 現在由 renderTestCasesTable 來處理
}

function updatePagination() {
    const pagination = document.getElementById('pagination');
    const totalPages = Math.ceil(filteredTestCases.length / pageSize);
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        // 分頁內容清空後也需要重新計算列表高度，以避免 sticky 分頁高度變化造成重疊
        if (typeof adjustTestCasesScrollHeight === 'function') {
            adjustTestCasesScrollHeight();
        }
        return;
    }
    
    let paginationHtml = '';
    
    // 上一頁
    const previousText = window.i18n ? window.i18n.t('pagination.previousPage') : '上一頁';
    paginationHtml += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">${previousText}</a>
        </li>
    `;
    
    // 頁碼
    for (let i = 1; i <= totalPages; i++) {
        if (i === currentPage) {
            paginationHtml += `<li class="page-item active"><a class="page-link" href="#">${i}</a></li>`;
        } else if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${i})">${i}</a></li>`;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            paginationHtml += `<li class="page-item disabled"><a class="page-link" href="#">...</a></li>`;
        }
    }
    
    // 下一頁
    const nextText = window.i18n ? window.i18n.t('pagination.nextPage') : '下一頁';
    paginationHtml += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">${nextText}</a>
        </li>
    `;
    
    pagination.innerHTML = paginationHtml;
    
    // 重新應用翻譯到新生成的分頁內容
    if (window.i18n && window.i18n.isReady()) {
        window.i18n.retranslate(pagination);
    }
    
    // 分頁內容更新後，重新計算列表高度，避免與分頁重疊
    if (typeof adjustTestCasesScrollHeight === 'function') {
        adjustTestCasesScrollHeight();
    }
}

function changePage(page) {
    const totalPages = Math.ceil(filteredTestCases.length / pageSize);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        renderTestCasesTable();
        updatePagination();
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// ===== 快速搜尋（Test Case Management） =====
function setupQuickSearch_TCM() {
    if (!document.getElementById('quickSearchOverlay')) {
        const overlay = document.createElement('div');
        overlay.id = 'quickSearchOverlay';
        overlay.style.cssText = 'position:fixed;inset:0;z-index:1060;display:none;background:rgba(0,0,0,0.35)';
        overlay.innerHTML = `
          <div class="position-fixed" style="top:34vh; left:50%; transform: translateX(-50%); width:min(720px, 92vw);">
            <div class="card shadow">
              <div class="card-body p-2">
                <input id=\"quickSearchInput\" type=\"text\" class=\"form-control form-control-lg\" placeholder=\"${window.i18n ? window.i18n.t('testCase.searchPlaceholder') : '搜尋測試案例...'}\" autocomplete=\"off\" />
                <div id=\"quickSearchResults\" class=\"list-group list-group-flush\" style=\"max-height:30vh; overflow:auto;\"></div>
              </div>
            </div>
          </div>`;
        document.body.appendChild(overlay);
        try {
            const input = overlay.querySelector('#quickSearchInput');
            if (input && window.i18n && window.i18n.isReady()) {
                input.placeholder = window.i18n.t('testCase.searchPlaceholder');
            }
            document.addEventListener('languageChanged', () => {
                if (input && window.i18n && window.i18n.isReady()) {
                    input.placeholder = window.i18n.t('testCase.searchPlaceholder');
                }
            });
        } catch (_) {}
        overlay.addEventListener('click', (e)=>{ if(e.target===overlay) closeQuickSearch(); });
    }

    document.addEventListener('keydown', function(e){
        const tag = (e.target && e.target.tagName || '').toLowerCase();
        const isTyping = ['input','textarea','select'].includes(tag) || (e.target && e.target.isContentEditable);
        if (!isTyping && e.key === '/' && !e.ctrlKey && !e.metaKey && !e.altKey) {
            e.preventDefault();
            openQuickSearch_TCM();
        }
    });
}

// 底部左側提示
document.addEventListener('DOMContentLoaded', function(){
    if (document.getElementById('quickSearchHint')) return;
    const hint = document.createElement('div');
    hint.id = 'quickSearchHint';
    hint.className = 'position-fixed';
    hint.style.cssText = 'left:12px; bottom:12px; z-index:1040; opacity:0.85; pointer-events:none;';
    const label = window.i18n && window.i18n.isReady() ? window.i18n.t('hotkeys.quickSearch') : '按 / 開啟快速搜尋';
    hint.innerHTML = `<span class="badge bg-secondary-subtle text-secondary border" style="--bs-bg-opacity:.65;">${label}</span>`;
    document.body.appendChild(hint);
    // i18n 準備完成時也同步更新
    document.addEventListener('i18nReady', () => {
        const text = window.i18n ? window.i18n.t('hotkeys.quickSearch') : '按 / 開啟快速搜尋';
        const badge = document.querySelector('#quickSearchHint .badge');
        if (badge) badge.textContent = text;
    });
    document.addEventListener('languageChanged', () => {
        const text = window.i18n ? window.i18n.t('hotkeys.quickSearch') : '按 / 開啟快速搜尋';
        const badge = document.querySelector('#quickSearchHint .badge');
        if (badge) badge.textContent = text;
    });
});

function openQuickSearch_TCM() {
    const overlay = document.getElementById('quickSearchOverlay');
    const input = document.getElementById('quickSearchInput');
    const results = document.getElementById('quickSearchResults');
    if (!overlay || !input || !results) return;
    overlay.style.display = 'block';
    input.value = '';
    results.innerHTML = '';
    input.focus();

    const handleKey = (e) => {
        if (e.key === 'Escape') { closeQuickSearch(); return; }
        if (e.key === 'Enter') {
            const active = results.querySelector('.active');
            if (active) { active.click(); }
        } else if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
            e.preventDefault();
            const items = Array.from(results.querySelectorAll('.list-group-item'));
            if (items.length === 0) return;
            let idx = items.findIndex(li => li.classList.contains('active'));
            if (idx < 0) idx = 0;
            idx = (e.key === 'ArrowDown') ? Math.min(idx+1, items.length-1) : Math.max(idx-1, 0);
            items.forEach(li => li.classList.remove('active'));
            items[idx].classList.add('active');
            items[idx].scrollIntoView({ block:'nearest' });
        }
    };
    input.onkeydown = handleKey;
    input.oninput = () => quickSearchRender_TCM(input.value, results);
}

function closeQuickSearch() {
    const overlay = document.getElementById('quickSearchOverlay');
    if (overlay) overlay.style.display = 'none';
}

function quickSearchRender_TCM(query, container) {
    const q = (query || '').trim().toLowerCase();
    let matches = [];
    if (q.length > 0) {
        matches = (testCases || []).filter(tc => {
            const num = (tc.test_case_number || '').toLowerCase();
            const title = (tc.title || '').toLowerCase();
            return num.includes(q) || title.includes(q);
        }).slice(0, 100);
    }
    if (matches.length === 0) {
        container.innerHTML = `<div class=\"list-group-item text-muted\">${window.i18n ? window.i18n.t('errors.noMatchingTestCases') : '沒有找到符合條件的測試案例'}</div>`;
        return;
    }
    container.innerHTML = matches.map((tc, idx) => `
      <button type=\"button\" class=\"list-group-item list-group-item-action ${idx===0?'active':''}\" data-id=\"${tc.record_id}\">\n        <div class=\"d-flex justify-content-between align-items-center\">\n          <code class=\"small me-2\">${escapeHtml(tc.test_case_number || '')}</code>\n          <span class=\"text-truncate\">${escapeHtml(tc.title || '')}</span>\n        </div>\n      </button>`).join('');
    container.querySelectorAll('.list-group-item').forEach(btn => {
        btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-id');
            closeQuickSearch();
            if (id) viewTestCase(id);
        });
    });
}

// 快速編輯功能
function quickEdit(recordId, field) {
    const testCase = testCases.find(tc => tc.record_id === recordId);
    if (!testCase) return;
    
    const cell = document.querySelector(`[data-record-id="${recordId}"][data-field="${field}"]`);
    if (!cell) return;
    
    // 獲取當前值
    const currentValue = testCase[field] || '';
    
    // 建立輸入框
    const input = document.createElement('input');
    input.type = 'text';
    input.value = currentValue;
    input.className = 'form-control quick-edit-input';
    input.style.width = '100%';
    input.style.height = 'auto';
    input.style.minHeight = '1.5rem';
    input.style.lineHeight = '1.5';
    input.style.fontSize = '0.875rem';
    input.style.padding = '0.25rem 0.5rem';
    input.style.border = '1px solid #007bff';
    input.style.borderRadius = '4px';
    input.style.margin = '0';
    
    // 儲存原始內容
    const originalContent = cell.innerHTML;
    
    // 替換內容
    cell.innerHTML = '';
    cell.appendChild(input);
    input.focus();
    input.select();
    
    // 處理儲存
    const saveEdit = async () => {
        const newValue = input.value.trim();
        
        if (newValue === currentValue) {
            // 值沒有變更，恢復原始內容
            cell.innerHTML = originalContent;
            return;
        }
        
        // 立即更新本地資料和 UI
        testCase[field] = newValue;
        cell.innerHTML = originalContent; // 先恢復原始結構
        
        // 立即重新渲染表格以顯示新值
        renderTestCasesTable();
        
        // 在背景處理儲存
        try {
            // 獲取當前團隊
            const currentTeam = AppUtils.getCurrentTeam();
            if (!currentTeam || !currentTeam.id) {
                throw new Error('請先選擇團隊');
            }
            
            // 構建更新資料
            const updateData = {};
            updateData[field] = newValue;
            
            // 背景發送更新請求，不等待響應
            window.AuthClient.fetch(`/api/teams/${currentTeam.id}/testcases/${recordId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updateData)
            }).then(async response => {
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || '更新失敗');
                }
                // 成功後顯示提示，但不重新渲染（已經渲染過了）
                const fieldName = field === 'test_case_number' ? 'Test Case Number' : 
                    (window.i18n ? window.i18n.t('common.title') : '標題');
                const updateSuccessMessage = window.i18n ? window.i18n.t('messages.fieldUpdated') : '更新成功';
                showSuccess(`${fieldName} ${updateSuccessMessage}`);
            }).catch(error => {
                console.error('快速編輯失敗:', error);
                const updateFailedMessage = window.i18n ? window.i18n.t('errors.updateFailed') : '更新失敗';
                showError(updateFailedMessage + '：' + error.message);
                
                // 如果儲存失敗，恢復原值並重新渲染
                testCase[field] = currentValue;
                renderTestCasesTable();
            });
            
        } catch (error) {
            console.error('快速編輯失敗:', error);
            const updateFailedMessage = window.i18n ? window.i18n.t('errors.updateFailed') : '更新失敗';
            showError(updateFailedMessage + '：' + error.message);
            
            // 恢復原值並重新渲染
            testCase[field] = currentValue;
            renderTestCasesTable();
        }
    };
    
    // 處理取消
    const cancelEdit = () => {
        cell.innerHTML = originalContent;
    };
    
    // 綁定事件
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            saveEdit();
        } else if (e.key === 'Escape') {
            e.preventDefault();
            cancelEdit();
        }
    });
    
    input.addEventListener('blur', saveEdit);
}

// TCG 編輯功能 - 簡化直接編輯
let currentTCGEditor = null;

async function editTCG(recordId) {
    const testCase = testCases.find(tc => tc.record_id === recordId);
    if (!testCase) return;
    
    const cell = document.querySelector(`[data-record-id="${recordId}"][data-field="tcg"]`);
    if (!cell) return;
    
    // 如果已經有編輯器在運行，先關閉
    if (currentTCGEditor && currentTCGEditor.recordId !== recordId) {
        await finishTCGEdit();
    }
    
    // 獲取當前 TCG
    const currentTCGs = [];
    for (const tcgRecord of testCase.tcg || []) {
        if (tcgRecord.text_arr && tcgRecord.text_arr.length > 0) {
            currentTCGs.push(...tcgRecord.text_arr);
        } else if (tcgRecord.text) {
            currentTCGs.push(tcgRecord.text);
        }
    }
    
    // 設置編輯器狀態
    currentTCGEditor = {
        recordId: recordId,
        cell: cell,
        originalTCGs: [...currentTCGs],
        currentTCGs: [...currentTCGs],
        originalContent: cell.innerHTML,
        mode: 'search'
    };
    
    // 直接進入搜尋模式
    startTCGSearch();
}

async function startTCGSearch() {
    if (!currentTCGEditor) return;
    
    const { cell, currentTCGs, recordId } = currentTCGEditor;
    
    // 直接顯示搜尋框 - 隱藏原標籤
    const searchHtml = `
        <div class="tcg-search-container position-relative" style="min-height: 32px; height: 32px; display: flex; align-items: center; overflow: hidden;">
            <input type="text" class="form-control form-control-sm tcg-search-input" 
                   data-i18n-placeholder="testCase.tcgPlaceholder" autocomplete="off" 
                   onkeydown="handleTCGSearchKeydown(event)" 
                   oninput="handleTCGSearchInput(event)"
                   onclick="event.stopPropagation()"
                   style="height: 28px; width: 100%; font-size: 0.75rem; padding: 0.125rem 0.375rem; border: 1px solid #dee2e6; box-shadow: none; outline: none;">
            <div class="tcg-dropdown" 
                 style="display: none;">
                <div class="p-2 text-muted small">開始輸入以搜尋 TCG...</div>
            </div>
        </div>
    `;
    
    cell.innerHTML = searchHtml;
    cell.classList.add('editing');
    
    // 聚焦搜尋框並立即載入選項
    const searchInput = cell.querySelector('.tcg-search-input');
    searchInput.focus();
    
    // 立即載入 TCG 選項並顯示下拉選單
    await searchTCGOptions('');
    const dropdown = cell.querySelector('.tcg-dropdown');
    if (dropdown) {
        // 計算輸入框的位置
        const searchInput = cell.querySelector('.tcg-search-input');
        const rect = searchInput.getBoundingClientRect();
        
        // 設定 fixed 定位的座標
        dropdown.style.top = (rect.bottom + window.scrollY) + 'px';
        dropdown.style.left = rect.left + 'px';
        dropdown.style.width = Math.max(300, rect.width) + 'px';
        dropdown.style.display = 'block';
    }
    
    // 添加點擊外部結束編輯的監聽器
    setTimeout(() => {
        document.addEventListener('click', handleTCGOutsideClick, true);
    }, 100);
}

function handleTCGOutsideClick(event) {
    if (!currentTCGEditor) return;
    
    const { cell } = currentTCGEditor;
    
    // 檢查點擊是否在編輯區域外
    if (!cell.contains(event.target)) {
        finishTCGEdit();
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

async function finishTCGEdit() {
    if (!currentTCGEditor) return;
    
    const { recordId, currentTCGs, originalTCGs, cell } = currentTCGEditor;
    
    // 移除全域點擊監聽器
    document.removeEventListener('click', handleTCGOutsideClick, true);
    
    // 檢查是否有變更
    const hasChanges = JSON.stringify(currentTCGs.sort()) !== JSON.stringify(originalTCGs.sort());
    
    // 立即更新 UI 顯示
    cell.classList.remove('editing');
    updateTCGCellDisplay(cell, currentTCGs);
    
    // 清除編輯器狀態
    currentTCGEditor = null;
    
    // 如果有變更，在背景處理儲存
    if (hasChanges) {
        // 非同步背景儲存，不等待完成
        saveTCGChanges(recordId, currentTCGs).catch(error => {
            console.error('TCG 儲存失敗:', error);
            // 如果儲存失敗，可以考慮顯示錯誤訊息或恢復原值
        });
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function updateTCGCellDisplay(cell, tcgNumbers) {
    // 更新單個 TCG 欄位的顯示，不重新渲染整個表格
    const recordId = cell.getAttribute('data-record-id');
    
    if (tcgNumbers.length === 0) {
        // 清除後留白，但保留點擊事件
        cell.innerHTML = `<div class="tcg-edit-area" onclick="editTCG('${recordId}')" data-i18n-title="tooltips.clickEditTcg"></div>`;
    } else {
        // 顯示 TCG 標籤，保留點擊事件
        const tcgHtml = tcgNumbers.map(tcg => 
            `<span class="tcg-tag">${tcg}</span>`
        ).join('');
        cell.innerHTML = `<div class="tcg-edit-area" onclick="editTCG('${recordId}')" data-i18n-title="tooltips.clickEditTcg">${tcgHtml}</div>`;
    }
    
    // 重新應用翻譯到新生成的內容
    if (window.i18n && window.i18n.isReady()) {
        window.i18n.retranslate(cell);
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function restoreTCGDisplay() {
    if (!currentTCGEditor) return;
    
    const { cell } = currentTCGEditor;
    cell.classList.remove('editing');
    renderTestCasesTable(); // 重新渲染以恢復正常顯示
}


let tcgSearchTimeout;

function handleTCGSearchInput(event) {
    clearTimeout(tcgSearchTimeout);
    tcgSearchTimeout = setTimeout(async () => {
        await searchTCGOptions(event.target.value);
    }, 300);
}

function handleTCGSearchKeydown(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        finishTCGEdit();
    } else if (event.key === 'Escape') {
        event.preventDefault();
        // 取消變更
        if (currentTCGEditor) {
            currentTCGEditor.currentTCGs = [...currentTCGEditor.originalTCGs];
        }
        finishTCGEdit();
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

async function searchTCGOptions(keyword) {
    if (!currentTCGEditor) return;
    
    const dropdown = currentTCGEditor.cell.querySelector('.tcg-dropdown');
    if (!dropdown) return;
    
    try {
        console.log('搜尋 TCG:', keyword);
        
        // 優先使用快取
        let results = [];
        if (tcgCache) {
            results = searchTCGFromCache(keyword, 20);
            console.log('從快取取得 TCG 搜尋結果:', results.length, '筆');
        } else {
            // 如果沒有快取，使用 API
            const response = await window.AuthClient.fetch(`/api/tcg/search?keyword=${encodeURIComponent(keyword)}&limit=20`);
            if (!response.ok) {
                console.error('TCG 搜尋失敗:', response.status, response.statusText);
                throw new Error(`搜尋 TCG 失敗: ${response.status}`);
            }
            const data = await response.json();
            results = data.results;
            console.log('從 API 取得 TCG 搜尋結果:', results.length, '筆');
        }
        
        // 始終顯示清除選項作為第一項
        let dropdownHtml = `
            <div class="tcg-option p-2 border-bottom" 
                  onclick="event.stopPropagation(); clearTCGValue()" 
                  style="cursor: pointer; border-bottom: 1px solid #f8f9fa; background-color: #fff3cd;" 
                  onmouseover="this.style.backgroundColor='#ffeaa7'" 
                  onmouseout="this.style.backgroundColor='#fff3cd'">
                <div class="fw-medium text-warning">
                    <i class="fas fa-times me-2"></i>清除 TCG 單號
                </div>
            </div>
        `;
        
        if (results.length === 0) {
            dropdownHtml += '<div class="p-2 text-muted small">沒有找到其他結果</div>';
        } else {
            dropdownHtml += results.map(tcg => {
                const selected = currentTCGEditor.currentTCGs && currentTCGEditor.currentTCGs.includes(tcg.tcg_number);
                return `
                <div class="tcg-option p-2 border-bottom d-flex justify-content-between align-items-center" 
                      onclick="event.stopPropagation(); selectTCGOption('${tcg.tcg_number}')" 
                      style="cursor: pointer; border-bottom: 1px solid #f8f9fa; padding: 0.25rem 0.75rem;" 
                      onmouseover="this.style.backgroundColor='#f8f9fa'" 
                      onmouseout="this.style.backgroundColor='white'">
                    <div class="fw-medium">${tcg.tcg_number}</div>
                    ${selected ? '<i class="fas fa-check text-success"></i>' : ''}
                </div>`;
            }).join('');
        }
        
        dropdown.innerHTML = dropdownHtml;
        
        // 更新位置並顯示
        const searchInput = currentTCGEditor.cell.querySelector('.tcg-search-input');
        if (searchInput) {
            const rect = searchInput.getBoundingClientRect();
            dropdown.style.top = (rect.bottom + window.scrollY) + 'px';
            dropdown.style.left = rect.left + 'px';
            dropdown.style.width = Math.max(300, rect.width) + 'px';
        }
        dropdown.style.display = 'block';
        
    } catch (error) {
        console.error('搜尋 TCG 失敗:', error);
        const searchFailedMessage = window.i18n ? window.i18n.t('errors.searchFailed') : '搜尋失敗';
        dropdown.innerHTML = `<div class="p-2 text-danger small">${searchFailedMessage}</div>`;
        
        // 更新位置並顯示
        const searchInput = currentTCGEditor.cell.querySelector('.tcg-search-input');
        if (searchInput) {
            const rect = searchInput.getBoundingClientRect();
            dropdown.style.top = (rect.bottom + window.scrollY) + 'px';
            dropdown.style.left = rect.left + 'px';
            dropdown.style.width = Math.max(300, rect.width) + 'px';
        }
        dropdown.style.display = 'block';
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function selectTCGOption(tcgNumber) {
    if (!currentTCGEditor) return;
    
    // 多選切換：存在則移除，不存在則加入
    const idx = currentTCGEditor.currentTCGs.indexOf(tcgNumber);
    if (idx >= 0) {
        currentTCGEditor.currentTCGs.splice(idx, 1);
    } else {
        currentTCGEditor.currentTCGs.push(tcgNumber);
    }
    
    // 重新渲染下拉，反映選取狀態（不結束編輯）
    const inputEl = currentTCGEditor.cell.querySelector('.tcg-search-input');
    const kw = inputEl ? inputEl.value : '';
    searchTCGOptions(kw || '');
}

function clearTCGValue() {
    if (!currentTCGEditor) return;
    
    // 清空 TCG 值
    currentTCGEditor.currentTCGs = [];
    
    // 立即完成編輯並儲存
    finishTCGEdit();
}

async function fetchTCGRecordByNumber(tcgNumber) {
    try {
        // 從 TCG API 獲取對應的記錄資訊
        const response = await window.AuthClient.fetch(`/api/tcg/search?keyword=${encodeURIComponent(tcgNumber)}&limit=1`);
        if (!response.ok) {
            return null;
        }
        
        const data = await response.json();
        if (data.results && data.results.length > 0) {
            const tcg = data.results[0];
            // 找到完全匹配的 TCG
            if (tcg.tcg_number === tcgNumber) {
                return {
                    record_id: tcg.record_id || `tcg_${tcg.tcg_number}`,
                    table_id: 'tblcK6eF3yQCuwwl', // TCG 表格 ID
                    tcg_number: tcg.tcg_number,
                    title: tcg.title
                };
            }
        }
        
        // 如果找不到對應記錄，創建一個模擬記錄
        return {
            record_id: `tcg_${tcgNumber}`,
            table_id: 'tblcK6eF3yQCuwwl', // TCG 表格 ID
            tcg_number: tcgNumber,
            title: tcgNumber
        };
    } catch (error) {
        console.error('查詢 TCG 記錄失敗:', error);
        // 返回模擬記錄以保持功能運作
        return {
            record_id: `tcg_${tcgNumber}`,
            table_id: 'tblcK6eF3yQCuwwl', // TCG 表格 ID
            tcg_number: tcgNumber,
            title: tcgNumber
        };
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

async function saveTCGChanges(recordId, tcgNumbers) {
    try {
        // 獲取當前團隊
        const currentTeam = AppUtils.getCurrentTeam();
        if (!currentTeam || !currentTeam.id) {
            throw new Error('請先選擇團隊');
        }
        
        // 將 TCG 編號轉換為 LarkRecord 格式
        const tcgRecords = [];
        for (const tcgNum of tcgNumbers) {
            // 使用 TCG 轉換器查詢對應的記錄 ID
            const tcgRecord = await fetchTCGRecordByNumber(tcgNum);
            if (tcgRecord) {
                tcgRecords.push({
                    record_ids: [tcgRecord.record_id],
                    text: tcgNum,
                    text_arr: [tcgNum],
                    table_id: tcgRecord.table_id || '',
                    type: 'record'
                });
            }
        }
        
        // 構建更新資料
        const updateData = {
            tcg: tcgRecords
        };
        
        // 發送更新請求
        const response = await window.AuthClient.fetch(`/api/teams/${currentTeam.id}/testcases/${recordId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(updateData)
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || '更新失敗');
        }
        
        // 更新本地資料
        const testCase = testCases.find(tc => tc.record_id === recordId);
        if (testCase) {
            testCase.tcg = tcgRecords;
        }
        
        // 重新渲染表格
        renderTestCasesTable();
        
        showSuccess(window.i18n ? window.i18n.t('messages.tcgUpdated') : 'TCG 更新成功');
        
    } catch (error) {
        console.error('更新 TCG 失敗:', error);
        const updateFailedMessage = window.i18n ? window.i18n.t('errors.updateFailed') : '更新失敗';
        showError(updateFailedMessage + '：' + error.message);
        
        // 恢復原始內容
        restoreTCGDisplay();
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}


// 通用工具函數
function showSuccess(message) {
    if (AppUtils && AppUtils.showSuccess) {
        AppUtils.showSuccess(message);
    } else {
        alert(message);
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function showError(message) {
    if (AppUtils && AppUtils.showError) {
        AppUtils.showError(message);
    } else {
        alert(message);
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function formatDate(dateString, format) {
    if (AppUtils && AppUtils.formatDate) {
        return AppUtils.formatDate(dateString, format);
    } else {
        // 備用方案：使用瀏覽器的預設 locale，符合地區標準格式
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return '';
        const browserLocale = navigator.language || navigator.userLanguage || 'en-US';
        
        if (format === 'date') {
            return date.toLocaleDateString(browserLocale);
        } else if (format === 'datetime') {
            return date.toLocaleString(browserLocale);
        } else if (format === 'time') {
            return date.toLocaleTimeString(browserLocale);
        }
        
        return date.toLocaleDateString(browserLocale);
    }
}

// Markdown 編輯器功能
let currentEditorMode = 'preview'; // 預設為預覽模式
let markdownPreviewTimeout;
let activeTextarea = null; // 當前焦點的 textarea

// 支援 Markdown 的欄位
const markdownFields = ['precondition', 'test_steps', 'expected_result'];

// 生成 Markdown 工具列 HTML
function generateMarkdownToolbar(targetFieldId) {
    return `
        <div class="markdown-toolbar px-2 py-1 border-bottom" data-target="${targetFieldId}" style="background-color: #f8f9fa; height: 32px; display: flex; align-items: center;">
            <div class="btn-group btn-group-sm me-1" role="group">
                <button type="button" class="btn btn-outline-secondary btn-xs" data-md="**" data-i18n-title="markdown.bold">
                    <i class="fas fa-bold"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-xs" data-md="*" data-i18n-title="markdown.italic">
                    <i class="fas fa-italic"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-xs" data-md="\`" data-i18n-title="markdown.code">
                    <i class="fas fa-code"></i>
                </button>
            </div>
            <div class="btn-group btn-group-sm me-1" role="group">
                <button type="button" class="btn btn-outline-secondary btn-xs" data-md="# " data-i18n-title="markdown.heading1">H1</button>
                <button type="button" class="btn btn-outline-secondary btn-xs" data-md="## " data-i18n-title="markdown.heading2">H2</button>
                <button type="button" class="btn btn-outline-secondary btn-xs" data-md="### " data-i18n-title="markdown.heading3">H3</button>
            </div>
            <div class="btn-group btn-group-sm me-1" role="group">
                <button type="button" class="btn btn-outline-secondary btn-xs" data-md="- " data-i18n-title="markdown.unorderedList">
                    <i class="fas fa-list-ul"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-xs" data-md="1. " data-i18n-title="markdown.orderedList">
                    <i class="fas fa-list-ol"></i>
                </button>
            </div>
            <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-secondary btn-xs" data-md="[text](url)" data-i18n-title="markdown.link">
                    <i class="fas fa-link"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-xs" data-md="![alt](url)" data-i18n-title="markdown.image">
                    <i class="fas fa-image"></i>
                </button>
            </div>
            <button type="button" class="btn btn-outline-info btn-xs markdown-help-btn" data-i18n-title="tooltips.markdownHelp" style="margin-left: 8px;" onclick="window.open('https://www.markdownguide.org/cheat-sheet/', '_blank')">
                <i class="fas fa-question-circle"></i>
            </button>
        </div>
    `;
}

// 生成完整的 Markdown 編輯器容器
function generateMarkdownEditor(fieldId, fieldName, placeholder, rows = 6, height = '200px') {
    return `
        <div class="row">
            <div class="col-12 d-none edit-column">
                <!-- 編輯框容器 -->
                <div class="form-control markdown-edit-container" style="padding: 0; height: ${height};">
                    ${generateMarkdownToolbar(fieldId)}
                    <textarea id="${fieldId}" name="${fieldName}" class="markdown-textarea" rows="${rows}" 
                              placeholder="${placeholder}" style="border: none; border-radius: 0; height: calc(100% - 32px); resize: none; outline: none; padding: 0.375rem 0.75rem; width: 100%; box-sizing: border-box; overflow-y: auto;"></textarea>
                </div>
            </div>
            <div class="col-12 preview-column">
                <div class="markdown-preview-container" style="height: ${height};">
                    <div class="markdown-preview" id="${fieldId}Preview" style="padding: 8px; height: 100%; overflow-y: auto; background: #f8f9fa; border: 1px solid #ced4da; border-radius: 0.375rem;">
                        <p class="text-muted">預覽內容會在這裡顯示</p>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// 初始化所有 Markdown 編輯器
function initializeAllMarkdownEditors() {
    // 編輯器配置
    const editorConfigs = [
        {
            fieldId: 'precondition',
            fieldName: 'precondition',
            placeholder: '請描述測試前置條件...',
            height: '200px'
        },
        {
            fieldId: 'test_steps',
            fieldName: 'test_steps',
            placeholder: '請描述詳細的測試步驟...',
            height: '250px'
        },
        {
            fieldId: 'expected_result',
            fieldName: 'expected_result',
            placeholder: '請描述預期的測試結果...',
            height: '200px'
        }
    ];
    
    // 為每個編輯器生成 HTML 並替換現有內容
    editorConfigs.forEach(config => {
        const container = document.getElementById(config.fieldId + '_container');
        if (container) {
            container.innerHTML = generateMarkdownEditor(
                config.fieldId,
                config.fieldName,
                config.placeholder,
                6,
                config.height
            ).trim();
        }
    });
    
    // 重新綁定事件
    bindMarkdownEvents();
}

// 綁定 Markdown 事件
function bindMarkdownEvents() {
    // Markdown 工具列按鈕 (個別工具列)
    document.querySelectorAll('.markdown-toolbar button[data-md]').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const toolbar = e.currentTarget.closest('.markdown-toolbar');
            const targetFieldId = toolbar.getAttribute('data-target');
            const mdSyntax = e.currentTarget.getAttribute('data-md');
            insertMarkdownToField(targetFieldId, mdSyntax);
        });
    });
    
    // 為所有 Markdown 欄位添加事件監聽
    markdownFields.forEach(fieldId => {
        const textarea = document.getElementById(fieldId);
        if (textarea) {
            // 焦點事件：記住當前活動的 textarea
            textarea.addEventListener('focus', () => {
                activeTextarea = textarea;
            });
            
            // 輸入事件：更新預覽
            textarea.addEventListener('input', () => {
                if (currentEditorMode !== 'edit') {
                    clearTimeout(markdownPreviewTimeout);
                    markdownPreviewTimeout = setTimeout(() => {
                        updateMarkdownPreview(fieldId);
                    }, 300);
                }
            });

            // 追蹤輸入法組字狀態（IME），避免 Enter 造成內容重複
            textarea._isIMEComposing = false;
            textarea.addEventListener('compositionstart', () => { textarea._isIMEComposing = true; });
            textarea.addEventListener('compositionend', () => { textarea._isIMEComposing = false; });

            // 按下 Enter 時自動新增下一項（列表狀態）
            textarea.addEventListener('keydown', (e) => {
                // Shift+Enter 保持預設換行
                if (e.key !== 'Enter' || e.shiftKey) return;
                // 若正在使用輸入法組字（中文/日文等），讓瀏覽器處理（避免複製上一項內容）
                if (e.isComposing || e.keyCode === 229 || textarea._isIMEComposing) return;
                const handled = handleMarkdownListEnter(e, textarea);
                if (handled) {
                    // 由我們處理插入，阻止預設行為
                    e.preventDefault();
                }
            });
        }
    });
    
}

// 在列表行中按下 Enter 自動建立下一個項目
function handleMarkdownListEnter(event, textarea) {
    if (!textarea) return false;
    // 僅處理插入點（無選取範圍）情況
    if (textarea.selectionStart !== textarea.selectionEnd) return false;

    const value = textarea.value;
    const pos = textarea.selectionStart;

    // 取得當前行的起訖與文本
    const lineStart = value.lastIndexOf('\n', pos - 1) + 1; // 若找不到回傳 -1，加 1 後變 0
    const nextNewline = value.indexOf('\n', pos);
    const lineEnd = nextNewline === -1 ? value.length : nextNewline;
    const lineText = value.slice(lineStart, lineEnd);

    // 偵測無序與有序清單項目前綴
    const unorderedMatch = lineText.match(/^(\s*)([-*+])\s+/);
    const orderedMatch = lineText.match(/^(\s*)(\d+)\.\s+/);

    if (!unorderedMatch && !orderedMatch) {
        return false; // 非清單行，交給瀏覽器預設行為
    }

    let nextMarker = '';
    if (unorderedMatch) {
        const indent = unorderedMatch[1] || '';
        const bullet = unorderedMatch[2]; // -, *, +
        nextMarker = `${indent}${bullet} `;
    } else if (orderedMatch) {
        const indent = orderedMatch[1] || '';
        const num = parseInt(orderedMatch[2], 10) || 1;
        nextMarker = `${indent}${num + 1}. `;
    }

    // 插入換行與下一個標記，並將游標置於新項目之後
    const before = value.slice(0, pos);
    const after = value.slice(pos);
    const insertion = `\n${nextMarker}`;
    textarea.value = before + insertion + after;

    const newCaret = pos + insertion.length;
    textarea.setSelectionRange(newCaret, newCaret);
    textarea.focus();

    // 觸發 input 事件以更新預覽
    textarea.dispatchEvent(new Event('input'));
    return true;
}

// 安全地添加幫助按鈕到現有工具列
function addHelpButtonsToToolbars() {
    markdownFields.forEach(fieldId => {
        const toolbar = document.querySelector(`.markdown-toolbar[data-target="${fieldId}"]`);
        if (toolbar && !toolbar.querySelector('.markdown-help-btn')) {
            const helpButton = document.createElement('button');
            helpButton.type = 'button';
            helpButton.className = 'btn btn-outline-info btn-xs markdown-help-btn';
            helpButton.setAttribute('data-i18n-title', 'markdown.help');
            helpButton.title = 'Markdown 語法說明'; // fallback
            helpButton.style.marginLeft = '8px';
            helpButton.onclick = () => window.open('https://www.markdownguide.org/cheat-sheet/', '_blank');
            helpButton.innerHTML = '<i class="fas fa-question-circle"></i>';
            toolbar.appendChild(helpButton);
            
            // 手動觸發翻譯
            if (window.i18n && window.i18n.isReady()) {
                const translatedTitle = window.i18n.t('markdown.help');
                if (translatedTitle && translatedTitle !== 'markdown.help') {
                    helpButton.title = translatedTitle;
                }
            }
        }
    });
}

// 初始化 Markdown 編輯器
function initializeMarkdownEditor() {
    // 模式切換按鈕
    document.getElementById('previewModeBtn').addEventListener('click', () => setEditorMode('preview'));
    document.getElementById('splitModeBtn').addEventListener('click', () => setEditorMode('split'));
    
    // 綁定 Markdown 事件
    bindMarkdownEvents();
    
    // 安全地添加幫助按鈕
    addHelpButtonsToToolbars();
    
    // 附件上傳功能
    const attachmentUpload = document.getElementById('attachmentUpload');
    if (attachmentUpload) {
        attachmentUpload.addEventListener('change', handleAttachmentUpload);
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// 設置編輯器模式
function setEditorMode(mode) {
    currentEditorMode = mode;
    
    // 更新按鈕狀態
    document.querySelectorAll('#previewModeBtn, #splitModeBtn').forEach(btn => {
        btn.classList.remove('active', 'btn-secondary');
        btn.classList.add('btn-outline-secondary');
    });
    const activeBtn = document.getElementById(mode + 'ModeBtn');
    if (activeBtn) {
        activeBtn.classList.remove('btn-outline-secondary');
        activeBtn.classList.add('btn-secondary', 'active');
    }
    
    // 為所有 Markdown 欄位設置模式
    markdownFields.forEach(fieldId => {
        const container = document.querySelector(`#${fieldId}`).closest('.markdown-field-container');
        if (!container) return;
        
        const editColumn = container.querySelector('.edit-column');
        const previewColumn = container.querySelector('.preview-column');
        
        // 重置類別
        editColumn.className = 'edit-column';
        previewColumn.className = 'preview-column';
        
        switch (mode) {
            case 'edit':
                editColumn.className = 'col-12 edit-column';
                previewColumn.className = 'col-12 d-none preview-column';
                break;
            case 'preview':
                editColumn.className = 'col-12 d-none edit-column';
                previewColumn.className = 'col-12 preview-column';
                updateMarkdownPreview(fieldId);
                break;
            case 'split':
                editColumn.className = 'col-6 edit-column';
                previewColumn.className = 'col-6 preview-column';
                updateMarkdownPreview(fieldId);
                break;
        }
    });
    
    // 控制個別工具列顯示
    markdownFields.forEach(fieldId => {
        const toolbar = document.querySelector(`.markdown-toolbar[data-target="${fieldId}"]`);
        if (toolbar) {
            toolbar.style.display = mode === 'preview' ? 'none' : 'block';
        }
    });
}

// 插入 Markdown 語法到指定欄位
function insertMarkdownToField(fieldId, syntax) {
    const textarea = document.getElementById(fieldId);
    if (!textarea) return;
    
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    
    let insertText = '';
    let cursorOffset = 0;
    
    if (syntax === '**' || syntax === '*' || syntax === '`') {
        insertText = syntax + selectedText + syntax;
        cursorOffset = syntax.length;
    } else if (syntax.startsWith('#')) {
        insertText = syntax + selectedText;
        cursorOffset = syntax.length;
    } else if (syntax === '- ' || syntax === '1. ') {
        const lines = selectedText.split('\n');
        if (lines.length === 1 && lines[0] === '') {
            insertText = syntax;
            cursorOffset = syntax.length;
        } else {
            insertText = lines.map((line, index) => {
                if (syntax === '1. ') {
                    return `${index + 1}. ${line}`;
                } else {
                    return `- ${line}`;
                }
            }).join('\n');
            cursorOffset = 0;
        }
    } else if (syntax === '[text](url)') {
        insertText = selectedText ? `[${selectedText}](url)` : '[text](url)';
        cursorOffset = selectedText ? insertText.length - 4 : 1;
    } else if (syntax === '![alt](url)') {
        insertText = selectedText ? `![${selectedText}](url)` : '![alt](url)';
        cursorOffset = selectedText ? insertText.length - 4 : 2;
    }
    
    // 替換選中的文字
    textarea.value = textarea.value.substring(0, start) + insertText + textarea.value.substring(end);
    
    // 設置光標位置
    if (selectedText) {
        textarea.setSelectionRange(start + cursorOffset, start + insertText.length - (syntax === '**' || syntax === '*' || syntax === '`' ? syntax.length : 0));
    } else {
        textarea.setSelectionRange(start + cursorOffset, start + cursorOffset);
    }
    
    textarea.focus();
    
    // 觸發變更事件
    textarea.dispatchEvent(new Event('input'));
}

// 插入 Markdown 語法到活動欄位 (保留向後兼容)
function insertMarkdownToActiveField(syntax) {
    const textarea = activeTextarea || document.getElementById('test_steps'); // 預設使用 test_steps
    if (!textarea) return;
    
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    
    let insertText = '';
    let cursorOffset = 0;
    
    if (syntax === '**' || syntax === '*' || syntax === '`') {
        insertText = syntax + selectedText + syntax;
        cursorOffset = syntax.length;
    } else if (syntax.startsWith('#')) {
        insertText = syntax + selectedText;
        cursorOffset = syntax.length;
    } else if (syntax === '- ' || syntax === '1. ') {
        const lines = selectedText.split('\n');
        if (lines.length === 1 && lines[0] === '') {
            insertText = syntax;
            cursorOffset = syntax.length;
        } else {
            insertText = lines.map((line, index) => {
                if (syntax === '1. ') {
                    return `${index + 1}. ${line}`;
                } else {
                    return `- ${line}`;
                }
            }).join('\n');
            cursorOffset = 0;
        }
    } else if (syntax === '[text](url)') {
        insertText = selectedText ? `[${selectedText}](url)` : '[text](url)';
        cursorOffset = selectedText ? insertText.length - 4 : 1;
    } else if (syntax === '![alt](url)') {
        insertText = selectedText ? `![${selectedText}](url)` : '![alt](url)';
        cursorOffset = selectedText ? insertText.length - 4 : 2;
    }
    
    // 替換選中的文字
    textarea.value = textarea.value.substring(0, start) + insertText + textarea.value.substring(end);
    
    // 設置光標位置
    if (selectedText) {
        textarea.setSelectionRange(start + cursorOffset, start + insertText.length - (syntax === '**' || syntax === '*' || syntax === '`' ? syntax.length : 0));
    } else {
        textarea.setSelectionRange(start + cursorOffset, start + cursorOffset);
    }
    
    textarea.focus();
    
    // 觸發變更事件
    textarea.dispatchEvent(new Event('input'));
}

// 更新特定欄位的 Markdown 預覽
function updateMarkdownPreview(fieldId) {
    if (fieldId) {
        // 更新特定欄位
        updateSingleFieldPreview(fieldId);
    } else {
        // 更新所有欄位
        markdownFields.forEach(id => updateSingleFieldPreview(id));
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// 更新單一欄位的預覽
function updateSingleFieldPreview(fieldId) {
    const textarea = document.getElementById(fieldId);
    const previewDiv = document.querySelector(`.markdown-preview[data-target="${fieldId}"]`);
    
    if (!textarea || !previewDiv) return;
    
    const content = textarea.value;
    
    if (typeof marked !== 'undefined') {
        try {
            previewDiv.innerHTML = marked.parse(content);
        } catch (error) {
            const markdownErrorMessage = window.i18n ? window.i18n.t('errors.markdownParseError') : 'Markdown 解析錯誤';
            previewDiv.innerHTML = `<p class="text-muted">${markdownErrorMessage}</p>`;
        }
    } else {
        // 簡單的 Markdown 轉換
        let html = content
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/`(.*?)`/g, '<code>$1</code>')
            .replace(/^# (.*$)/gim, '<h1>$1</h1>')
            .replace(/^## (.*$)/gim, '<h2>$1</h2>')
            .replace(/^### (.*$)/gim, '<h3>$1</h3>')
            .replace(/^\- (.*$)/gim, '<li>$1</li>')
            .replace(/^\d+\. (.*$)/gim, '<li>$1</li>')
            .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
            .replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" style="max-width: 100%; height: auto;">')
            .replace(/\n/g, '<br>');
        
        const previewPlaceholder = window.i18n ? window.i18n.t('messages.previewDisplayHere') : '預覽將在此顯示...';
        previewDiv.innerHTML = html || `<p class="text-muted">${previewPlaceholder}</p>`;
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// 附件管理功能
// 全域變數來儲存上傳的附件
let uploadedAttachments = [];
// 新增：用於新增/更新尚未有正式記錄時，暫存上傳的識別碼
let currentTempUploadId = null;

function handleAttachmentUpload(event) {
    const files = event.target.files;
    if (!files || files.length === 0) return;
    
    // 驗證檔案
    for (let file of files) {
        if (file.size > 10 * 1024 * 1024) { // 10MB 限制
            const errorMessage = window.i18n ? 
                window.i18n.t('errors.fileSizeLimitExceeded', {fileName: file.name}, `檔案 "${file.name}" 超過10MB大小限制`) :
                `檔案 "${file.name}" 超過10MB大小限制`;
            showError(errorMessage);
            return;
        }
    }
    
    // 顯示上傳中狀態
    const attachmentsList = document.getElementById('attachmentsList');
    const uploadingHtml = Array.from(files).map(file => `
        <div class="attachment-item d-flex align-items-center justify-content-between p-2 border rounded mb-2">
            <div class="d-flex align-items-center">
                <i class="fas fa-file me-2 text-muted"></i>
                <span>${file.name}</span>
                <small class="text-muted ms-2">(${formatFileSize(file.size)})</small>
            </div>
            <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">上傳中...</span>
            </div>
        </div>
    `).join('');
    
    attachmentsList.innerHTML = uploadingHtml;
    
    // 實際上傳檔案到伺服器
    uploadFilesToServer(Array.from(files));
}

async function uploadFilesToServer(files) {
    const currentTeam = AppUtils.getCurrentTeam();
    if (!currentTeam || !currentTeam.id) {
        showError(window.i18n ? window.i18n.t('errors.pleaseSelectTeam') : '請先選擇團隊');
        return;
    }
    
    const attachmentsList = document.getElementById('attachmentsList');
    const uploadedFiles = [];
    let totalFiles = files.length;
    let completedFiles = 0;
    
    try {
        // 顯示上傳進度區域
        attachmentsList.innerHTML = `
            <div class="upload-progress-container mb-3 p-3 border rounded bg-light">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-medium">正在上傳附件...</span>
                    <span class="text-muted">${completedFiles}/${totalFiles}</span>
                </div>
                <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <div class="mt-2">
                    <small class="text-muted">請稍等，正在處理您的檔案</small>
                </div>
            </div>
        `;
        
        const progressBar = attachmentsList.querySelector('.progress-bar');
        const progressText = attachmentsList.querySelector('span.text-muted');
        
        const isEditingExisting = !!(document.getElementById('testCaseId') && document.getElementById('testCaseId').value);
        const rid = getCurrentRecordId();
        const tcNumberEl2 = document.getElementById('testCaseNumber');
        const tcn = tcNumberEl2 && tcNumberEl2.value ? tcNumberEl2.value.trim() : '';

        if (isEditingExisting) {
            // 舊邏輯：已存在的記錄，直接附加到該記錄
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const statusText = attachmentsList.querySelector('.mt-2 small');
                const uploadingMessage = window.i18n ? window.i18n.t('messages.uploadingFile') : '正在上傳';
                statusText.textContent = `${uploadingMessage}: ${file.name}`;
                try {
                    const currentRecordKey = getCurrentRecordKeyForUpload();
                    if (!currentRecordKey) throw new Error('請先填寫 Test Case Number 再上傳附件');
                    const fd = new FormData();
                    fd.append('files', file);
                    const isNumericId = /^\d+$/.test(String(currentRecordKey));
                    const url = isNumericId
                        ? `/api/teams/${currentTeam.id}/testcases/${encodeURIComponent(currentRecordKey)}/attachments`
                        : `/api/teams/${currentTeam.id}/testcases/by-number/${encodeURIComponent(currentRecordKey)}/attachments`;
                    const response = await window.AuthClient.fetch(url, { method: 'POST', body: fd });
                    if (response.ok) {
                        const result = await response.json();
                        const statusText = attachmentsList.querySelector('.mt-2 small');
                        const attachingMessage = window.i18n ? window.i18n.t('messages.attachingFile') : '正在附加';
                        statusText.textContent = `${attachingMessage}: ${file.name}`;
                        const meta = Array.isArray(result.files) ? result.files.find(m => m.name === file.name || (m.stored_name && m.stored_name.includes(file.name))) : null;
                        const metaEntry = meta || { name: file.name, size: file.size, type: file.type || 'application/octet-stream' };
                        uploadedFiles.push(metaEntry);
                        let testCaseIndex = -1;
                        if (rid) testCaseIndex = testCases.findIndex(tc => tc.record_id === rid);
                        if (testCaseIndex === -1 && tcn) testCaseIndex = testCases.findIndex(tc => tc.test_case_number === tcn);
                        if (testCaseIndex !== -1) {
                            if (!testCases[testCaseIndex].attachments) testCases[testCaseIndex].attachments = [];
                            testCases[testCaseIndex].attachments.push(metaEntry);
                        }
                        let filteredIndex = -1;
                        if (rid) filteredIndex = filteredTestCases.findIndex(tc => tc.record_id === rid);
                        if (filteredIndex === -1 && tcn) filteredIndex = filteredTestCases.findIndex(tc => tc.test_case_number === tcn);
                        if (filteredIndex !== -1) {
                            if (!filteredTestCases[filteredIndex].attachments) filteredTestCases[filteredIndex].attachments = [];
                            filteredTestCases[filteredIndex].attachments.push(metaEntry);
                        }
                        completedFiles++;
                        const progress = (completedFiles / totalFiles) * 100;
                        if (progressBar) progressBar.style.width = progress + '%';
                        if (progressText) progressText.textContent = `${completedFiles}/${totalFiles}`;
                    } else {
                        let errorText = '上傳失敗';
                        try { const err = await response.json(); errorText = err.detail || errorText; } catch (_e) {}
                        throw new Error(`${errorText}`);
                    }
                } catch (fileError) {
                    console.error(`上傳檔案 ${file.name} 失敗:`, fileError);
                    const uploadFailedMessage = window.i18n ? window.i18n.t('errors.uploadFailed') : '上傳失敗';
                    showError(`${uploadFailedMessage} "${file.name}": ${fileError.message}`);
                }
            }
        } else {
            // 新邏輯：新增模式，先暫存上傳，待建立/更新成功後由後端搬移到正式位置
            const fd = new FormData();
            for (let i = 0; i < files.length; i++) {
                fd.append('files', files[i]);
            }
            if (currentTempUploadId) fd.append('temp_upload_id', currentTempUploadId);
            const response = await window.AuthClient.fetch(`/api/teams/${currentTeam.id}/testcases/staging/upload`, { method: 'POST', body: fd });
            if (!response.ok) {
                let errorText = '上傳失敗';
                try { const err = await response.json(); errorText = err.detail || errorText; } catch (_e) {}
                throw new Error(errorText);
            }
            const result = await response.json();
            currentTempUploadId = result.temp_upload_id || currentTempUploadId;
            const newFiles = Array.isArray(result.files) ? result.files.map(m => ({
                name: m.name,
                stored_name: m.stored_name || m.name,
                size: m.size || 0,
                type: m.type || 'application/octet-stream',
                url: m.url || m.tmp_url || '',
            })) : [];
            uploadedFiles.push(...newFiles);
            completedFiles = totalFiles; // 暫存上傳為一次性批次
            const progress = (completedFiles / totalFiles) * 100;
            if (progressBar) progressBar.style.width = progress + '%';
            if (progressText) progressText.textContent = `${completedFiles}/${totalFiles}`;
        }
        
        // 將上傳成功的檔案加到全域變數
        uploadedAttachments = uploadedAttachments.concat(uploadedFiles);
        
        // 更新附件列表顯示
        renderAttachmentsList();
        
        if (uploadedFiles.length > 0) {
            const attachmentsUploadedMessage = window.i18n ? 
                window.i18n.t('messages.attachmentsUploaded', {count: uploadedFiles.length}) : 
                `成功上傳並附加 ${uploadedFiles.length} 個附件`;
            showSuccess(attachmentsUploadedMessage);
            // 注意：現在不需要觸發表單變更檢查，因為附件已經立即附加到記錄
        }
        
    } catch (error) {
        console.error('上傳附件過程發生錯誤:', error);
        const uploadAttachmentFailedMessage = window.i18n ? window.i18n.t('errors.uploadAttachmentFailed') : '上傳附件失敗';
        showError(uploadAttachmentFailedMessage + '：' + error.message);
        
        // 上傳失敗時顯示錯誤狀態
        attachmentsList.innerHTML = `
            <div class="alert alert-danger d-flex align-items-center">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <div>附件上傳失敗，請重試</div>
            </div>
        `;
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function renderAttachmentsList() {
    const attachmentsList = document.getElementById('attachmentsList');
    if (!uploadedAttachments || uploadedAttachments.length === 0) {
        const noAttachmentsMessage = window.i18n ? window.i18n.t('errors.noAttachments') : '尚無附件';
        attachmentsList.innerHTML = `<p class="text-muted small mb-0">${noAttachmentsMessage}</p>`;
        return;
    }
    
    const attachmentsHtml = uploadedAttachments.map((attachment, index) => {
        const stored = attachment.stored_name || attachment.file_token || attachment.name;
        const link = attachment.url ? `<a href="${attachment.url}" target="_blank" class="text-decoration-none me-2"><i class=\"fas fa-link\"></i></a>` : '';
        return `
        <div class="attachment-item d-flex align-items-center justify-content-between p-2 border rounded mb-2 bg-light">
            <div class="d-flex align-items-center">
                <i class="fas fa-file me-2 text-primary"></i>
                <div>
                    <div class="fw-medium">${attachment.name}</div>
                    <div class="small text-muted">${formatFileSize(attachment.size || 0)}</div>
                </div>
            </div>
            <div>
                ${link}
                <button type="button" class="btn btn-sm btn-outline-danger" 
                        onclick="removeAttachment('${stored}', '${attachment.name}', ${index})" data-i18n-title="tooltips.removeAttachment">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>`;
    }).join('');
    
    attachmentsList.innerHTML = `
        <div class="attachments-header mb-2">
            <h6 class="mb-0 text-secondary">${window.i18n ? window.i18n.t('form.uploadedAttachments') : '已上傳的附件'} (${uploadedAttachments.length})</h6>
        </div>
        ${attachmentsHtml}
    `;
}

function removeAttachment(index) {
    uploadedAttachments.splice(index, 1);
    renderAttachmentsList();
    checkFormChanges(); // 觸發表單變更檢查
}

// 格式化檔案大小
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// 下載附件
function downloadAttachment(storedName) {
    try {
        const currentTeam = AppUtils.getCurrentTeam();
        const tcNumberEl = document.getElementById('testCaseNumber');
        if (!currentTeam || !currentTeam.id || !tcNumberEl || !tcNumberEl.value) {
            showError('無法判定附件路徑');
            return;
        }
        const url = `/attachments/test-cases/${encodeURIComponent(currentTeam.id)}/${encodeURIComponent(tcNumberEl.value.trim())}/${encodeURIComponent(storedName)}`;
        window.open(url, '_blank');
    } catch (e) {
        console.error('downloadAttachment error:', e);
    }
}

// 移除附件
async function removeAttachment(fileToken, filename, index) {
    const confirmMessage = window.i18n ? 
        window.i18n.t('confirm.deleteAttachment', {filename: filename}) : 
        `確定要刪除附件 "${filename}" 嗎？`;
    if (confirm(confirmMessage)) {
        try {
            console.log(`正在刪除附件: ${filename}...`);
            
            // 取得當前記錄的 ID
            const currentRecordId = getCurrentRecordId();
            if (!currentRecordId) {
                throw new Error('無法取得當前記錄 ID');
            }
            
            // 呼叫後端 API 刪除附件
            const currentTeam = AppUtils.getCurrentTeam();
            if (!currentTeam || !currentTeam.id) {
                throw new Error('請先選擇團隊');
            }
            const response = await window.AuthClient.fetch(`/api/teams/${currentTeam.id}/testcases/${currentRecordId}/attachments/${encodeURIComponent(filename)}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || '刪除附件失敗');
            }
            
            const result = await response.json();
            
            if (result.success) {
                // 從本地陣列中移除
                uploadedAttachments.splice(index, 1);
                
                // 同時更新原始 testCases 資料中的附件資訊
                const currentRecordId = getCurrentRecordId();
                if (currentRecordId) {
                    // 更新 testCases 陣列中對應記錄的附件
                    const testCaseIndex = testCases.findIndex(tc => tc.record_id === currentRecordId);
                    if (testCaseIndex !== -1) {
                        if (!testCases[testCaseIndex].attachments) {
                            testCases[testCaseIndex].attachments = [];
                        }
                        // 從原始資料中移除該附件
                        testCases[testCaseIndex].attachments = testCases[testCaseIndex].attachments.filter(
att => (att.stored_name !== filename && att.name !== filename)
                        );
                    }
                    
                    // 同時更新 filteredTestCases 中的資料
                    const filteredIndex = filteredTestCases.findIndex(tc => tc.record_id === currentRecordId);
                    if (filteredIndex !== -1) {
                        if (!filteredTestCases[filteredIndex].attachments) {
                            filteredTestCases[filteredIndex].attachments = [];
                        }
                        filteredTestCases[filteredIndex].attachments = filteredTestCases[filteredIndex].attachments.filter(
att => (att.stored_name !== filename && att.name !== filename)
                        );
                    }
                }
                
                // 重新渲染附件列表
                renderAttachmentsList();
                const attachmentDeletedMessage = window.i18n ? 
                    window.i18n.t('messages.attachmentDeleted') : '已成功刪除附件';
                showSuccess(`${attachmentDeletedMessage}: ${filename}`);
            } else {
                throw new Error(result.message || '刪除附件失敗');
            }
            
        } catch (error) {
            console.error('刪除附件錯誤:', error);
            const attachmentDeleteFailedMessage = window.i18n ? window.i18n.t('errors.attachmentDeleteFailed') : '刪除附件失敗';
            showError(`${attachmentDeleteFailedMessage}: ${error.message}`);
        }
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// 重置 modal 內所有滾動位置的輔助函數
function resetModalScrollPositions(modal) {
    // 立即重置主要滾動容器
    const modalBody = modal.querySelector('.modal-body');
    if (modalBody) {
        modalBody.scrollTop = 0;
    }
    
    const scrollableContent = modal.querySelector('.scrollable-content');
    if (scrollableContent) {
        scrollableContent.scrollTop = 0;
    }
    
    // 重置所有 textarea 和其他可滾動元素
    const textareas = modal.querySelectorAll('textarea');
    textareas.forEach(textarea => {
        textarea.scrollTop = 0;
    });
    
    // 重置所有 markdown 預覽區域
    const markdownPreviews = modal.querySelectorAll('.markdown-preview');
    markdownPreviews.forEach(preview => {
        preview.scrollTop = 0;
    });
    
    // 重置任何其他可能的滾動容器
    const scrollableElements = modal.querySelectorAll('[style*="overflow-y: auto"], .overflow-auto');
    scrollableElements.forEach(el => {
        el.scrollTop = 0;
    });
}

// 取得當前記錄 ID 的輔助函數
function getCurrentRecordId() {
    // 從 modal 或其他地方取得當前記錄的 ID（可能是 lark_record_id 或本地 id）
    const modal = document.getElementById('testCaseModal');
    if (modal && modal.dataset.recordId) {
        return modal.dataset.recordId;
    }
    const recordIdElement = document.querySelector('[data-record-id]');
    if (recordIdElement) {
        return recordIdElement.dataset.recordId;
    }
    return null;
}

// 供附件上傳使用的記錄識別：一律使用測試案例編號（與後端規則一致）
function getCurrentRecordKeyForUpload() {
    // 首選：若當前記錄有本地 id（record_id 為純數字），就用本地 id
    try {
        const modal = document.getElementById('testCaseModal');
        const rid = modal && modal.dataset ? modal.dataset.recordId : null;
        if (rid && /^\d+$/.test(String(rid))) {
            return rid;
        }
    } catch (_) {}
    // 次選：使用 Test Case Number（後端兼容）
    const tcNumberEl = document.getElementById('testCaseNumber');
    const val = tcNumberEl && tcNumberEl.value ? tcNumberEl.value.trim() : '';
    return val || null;
}

// 舊的 Modal TCG 編輯功能已移除，使用新的統一實作

// 舊的 Modal TCG 相關函數已移除

// 新的 type-to-search 支援函數
function handleTCGSearch(input) {
    const keyword = input.value.trim();
    const dropdown = document.getElementById('modalTCGDropdown');
    
    if (!dropdown) return;
    
    if (keyword.length < 1) {
        // 顯示熱門 TCG
        showPopularTCG();
        return;
    }
    
    // 搜尋 TCG
    const results = searchTCGFromCache(keyword, 10);
    updateTCGDropdown(results);
    showTCGDropdown();
}

function showTCGDropdown() {
    const dropdown = document.getElementById('modalTCGDropdown');
    if (!dropdown) return;
    
    dropdown.style.display = 'block';
    
    // 如果沒有內容，顯示熱門 TCG
    if (dropdown.innerHTML.trim() === '') {
        showPopularTCG();
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function hideTCGDropdown() {
    // 延遲隱藏，允許點擊選項
    setTimeout(() => {
        const dropdown = document.getElementById('modalTCGDropdown');
        if (dropdown) {
            dropdown.style.display = 'none';
        }
    }, 150);
}

function showPopularTCG() {
    const results = searchTCGFromCache('', 10); // 取前 10 個
    updateTCGDropdown(results);
}

function updateTCGDropdown(results) {
    const dropdown = document.getElementById('modalTCGDropdown');
    if (!dropdown) return;
    
    if (results.length === 0) {
        const noTcgMatchesMessage = window.i18n ? window.i18n.t('errors.noTcgMatches') : '找不到匹配的 TCG';
        dropdown.innerHTML = `<div class="p-2 text-muted">${noTcgMatchesMessage}</div>`;
        return;
    }
    
    const html = results.map(tcg => `
        <div class="dropdown-item-custom p-2 border-bottom" 
             onclick="selectTCG('${tcg.tcg_number}', '${tcg.title || ''}')" 
             style="cursor: pointer; transition: background-color 0.2s;"
             onmouseover="this.style.backgroundColor='#f8f9fa'"
             onmouseout="this.style.backgroundColor='white'">
            <div class="fw-bold">${tcg.tcg_number}</div>
        </div>
    `).join('');
    
    dropdown.innerHTML = html;
}

function selectTCG(tcgNumber, title) {
    const tcgInput = document.getElementById('tcg');
    
    if (tcgInput) {
        tcgInput.value = tcgNumber;
    }
    
    hideTCGDropdown();
    checkFormChanges();
}

// 計算動態高度
function calculateDynamicHeights() {
    const modal = document.getElementById('testCaseModal');
    const modalContent = modal.querySelector('.modal-content');
    const fixedSection = modal.querySelector('.fixed-section');
    const fixedButtons = modal.querySelector('.fixed-buttons');
    const scrollableContent = modal.querySelector('.scrollable-content');
    
    // 取得視窗高度
    const viewportHeight = window.innerHeight;
    
    // 設定模態框高度為視窗高度的 90%
    const modalHeight = Math.floor(viewportHeight * 0.9);
    const modalDialog = modal.querySelector('.modal-dialog');
    modalDialog.style.height = modalHeight + 'px';
    modalDialog.style.maxHeight = modalHeight + 'px';
    
    // 等待DOM更新後計算
    setTimeout(() => {
        // 計算固定區域高度
        const modalHeader = modal.querySelector('.modal-header');
        const headerHeight = modalHeader ? modalHeader.offsetHeight : 0;
        const fixedSectionHeight = fixedSection ? fixedSection.offsetHeight : 0;
        const fixedButtonsHeight = fixedButtons ? fixedButtons.offsetHeight : 0;
        
        // 計算可滾動內容區域的可用高度
        const availableHeight = modalHeight - headerHeight - fixedSectionHeight - fixedButtonsHeight - 2; // 2px for borders
        
        if (scrollableContent) {
            scrollableContent.style.height = availableHeight + 'px';
            scrollableContent.style.maxHeight = availableHeight + 'px';
        }
        
        // 根據可用空間決定是否需要滾動
        if (scrollableContent) {
            const contentHeight = scrollableContent.scrollHeight;
            if (contentHeight <= availableHeight) {
                // 內容夠小，不需要滾動
                scrollableContent.style.overflowY = 'hidden';
            } else {
                // 內容太大，需要滾動
                scrollableContent.style.overflowY = 'auto';
            }
        }
    }, 100);
}

// 監聽視窗大小變化
window.addEventListener('resize', function() {
    const modal = document.getElementById('testCaseModal');
    if (modal && modal.classList.contains('show')) {
        calculateDynamicHeights();
    }
    // 視窗尺寸改變時，調整列表高度
    adjustTestCasesScrollHeight();
});

// 當 i18n 準備就緒或語言變更時，強制刷新 placeholder
try {
    document.addEventListener('i18nReady', function(){ updateTcmPlaceholders(); });
    document.addEventListener('languageChanged', function(){ updateTcmPlaceholders(); });
} catch (_) {}

// 更新導航按鈕狀態
function updateNavigationButtons() {
    const prevBtn = document.getElementById('prevTestCaseBtn');
    const nextBtn = document.getElementById('nextTestCaseBtn');
    
    if (currentTestCaseIndex === -1 || filteredTestCases.length <= 1) {
        // 新增模式或只有一筆資料時，隱藏導航按鈕
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
    } else {
        prevBtn.style.display = 'inline-block';
        nextBtn.style.display = 'inline-block';
        
        // 第一筆時，上一隻按鈕反灰
        if (currentTestCaseIndex === 0) {
            prevBtn.disabled = true;
            prevBtn.classList.add('disabled');
        } else {
            prevBtn.disabled = false;
            prevBtn.classList.remove('disabled');
        }
        
        // 最後一筆時，下一隻按鈕反灰
        if (currentTestCaseIndex === filteredTestCases.length - 1) {
            nextBtn.disabled = true;
            nextBtn.classList.add('disabled');
        } else {
            nextBtn.disabled = false;
            nextBtn.classList.remove('disabled');
        }
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// 顯示上一隻測試案例
function showPrevTestCase() {
    if (currentTestCaseIndex > 0) {
        const prevTestCase = filteredTestCases[currentTestCaseIndex - 1];
        showTestCaseModal(prevTestCase);
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// 只讓 Test Case 列表區域可滾動：依據可視高度調整列表容器高度
function adjustTestCasesScrollHeight() {
    try {
        const scrollBox = document.getElementById('testCasesScroll');
        if (!scrollBox) return;
        const nav = document.getElementById('testCasesPagination');
        const ul = document.getElementById('pagination');
        const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
        const rect = scrollBox.getBoundingClientRect();
        const top = rect.top; // 距離視窗頂部
        const paginationHeight = (nav ? nav.getBoundingClientRect().height : (ul ? ul.getBoundingClientRect().height : 0));
        const gap = 16; // 與下方的間距緩衝
        let available = viewportHeight - top - paginationHeight - gap;
        if (available < 200) available = 200; // 設置最小高度
        scrollBox.style.maxHeight = available + 'px';
        scrollBox.style.height = available + 'px';
        scrollBox.style.overflowY = 'auto';
        // 避免 sticky 分頁覆蓋列表最後一行，預留底部內距
        scrollBox.style.paddingBottom = (paginationHeight + gap) + 'px';
    } catch (e) {
        console.warn('adjustTestCasesScrollHeight failed:', e);
    }
}

// 顯示下一隻測試案例
function showNextTestCase() {
    if (currentTestCaseIndex < filteredTestCases.length - 1) {
        const nextTestCase = filteredTestCases[currentTestCaseIndex + 1];
        showTestCaseModal(nextTestCase);
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// 更新頁面標題翻譯
function updatePageTitle() {
    const pageTitle = window.i18n ? window.i18n.t('testCase.management') : '測試案例管理';
    const siteTitle = window.i18n ? window.i18n.t('navigation.title') : 'Test Case Repository';
    document.title = `${pageTitle} - ${siteTitle} Web Tool`;
}

// ===== 深連結與剪貼簿工具（TCM） =====
function getCurrentTeamId_TCM() {
    try {
        const cur = AppUtils.getCurrentTeam && AppUtils.getCurrentTeam();
        if (cur && cur.id) return cur.id;
    } catch (_) {}
    const p = new URLSearchParams(window.location.search);
    const t = p.get('team_id') || p.get('teamId') || p.get('team');
    return t ? parseInt(t) : undefined;
}

function buildTcmUrl(teamId, tcNumber) {
    const origin = window.location.origin;
    const params = new URLSearchParams();
    if (teamId) params.set('team_id', teamId);
    if (tcNumber) params.set('tc', tcNumber);
    return `${origin}/test-case-management?${params.toString()}`;
}

function safeCopyToClipboard_TCM(text, onSuccess, onError) {
    if (navigator && navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
        navigator.clipboard.writeText(text).then(() => { if (onSuccess) onSuccess(); }).catch(err => {
            try {
                const temp = document.createElement('input');
                temp.value = text;
                document.body.appendChild(temp);
                temp.select();
                document.execCommand('copy');
                document.body.removeChild(temp);
                if (onSuccess) onSuccess();
            } catch (e) { if (onError) onError(e); }
        });
    } else {
        try {
            const temp = document.createElement('input');
            temp.value = text;
            document.body.appendChild(temp);
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
            if (onSuccess) onSuccess();
        } catch (e) { if (onError) onError(e); }
    }
}

function ensureTeamIdInUrl_TCM(teamId) {
    try {
        const url = new URL(window.location.href);
        const before = url.searchParams.get('team_id');
        if (String(before || '') !== String(teamId)) {
            url.searchParams.set('team_id', teamId);
            history.replaceState(null, '', `${url.pathname}?${url.searchParams.toString()}`);
        }
    } catch (_) {}
}

// 監聽 i18n 初始化和語言變更事件
document.addEventListener('i18nReady', updatePageTitle);
document.addEventListener('languageChanged', updatePageTitle);

// ===== TCG Hover Tooltip 功能 =====

// TCG tooltip 相關變數
let currentTooltip = null;
let tooltipTimeout = null;
let currentHoveredElement = null;
let isHoveringTooltip = false;
let isInitialized = false;

// 建立 TCG tooltip 元素
function createTCGTTooltip() {
    // 如果已經存在，先移除
    const existingTooltip = document.getElementById('tcg-tooltip');
    if (existingTooltip) {
        existingTooltip.remove();
    }

    const tooltip = document.createElement('div');
    tooltip.id = 'tcg-tooltip';
    tooltip.className = 'tcg-tooltip';
    tooltip.style.cssText = `
        position: fixed;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        padding: 12px;
        max-width: 300px;
        z-index: 1080;
        display: none;
        font-size: 0.875rem;
        pointer-events: auto;
    `;

    document.body.appendChild(tooltip);
    return tooltip;
}

// 顯示 TCG tooltip
async function showTCGTTooltip(tcgNumber, element) {
    // 如果正在載入其他 tooltip，先取消
    if (tooltipTimeout) {
        clearTimeout(tooltipTimeout);
        tooltipTimeout = null;
    }

    // 設定當前 hover 元素
    currentHoveredElement = element;

    // 建立/取得 tooltip 元素
    const tooltip = createTCGTTooltip();

    // 設定載入狀態
    tooltip.innerHTML = `
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span>載入中...</span>
        </div>
    `;

    // 顯示 tooltip
    tooltip.style.display = 'block';

    // 定位 tooltip
    positionTooltip(tooltip, element);

    try {
        // 從 JIRA 取得 ticket 資訊
        const ticketData = await fetchJIRATicketInfo(tcgNumber);

        // 檢查是否還在同一個元素上
        if (currentHoveredElement !== element) {
            return; // 用戶已經移開，不顯示結果
        }

        if (ticketData) {
            console.log('準備顯示 ticket 資料:', ticketData); // 除錯用
            // 顯示 ticket 資訊
            tooltip.innerHTML = formatTicketTooltip(tcgNumber, ticketData);
            console.log('Tooltip HTML 已設定'); // 除錯用
        } else {
            // 顯示錯誤訊息
            tooltip.innerHTML = `
                <div class="text-muted small">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    無法取得 ${tcgNumber} 的資訊
                </div>
            `;
        }
    } catch (error) {
        console.error('TCG tooltip 載入失敗:', error);

        // 檢查是否還在同一個元素上
        if (currentHoveredElement !== element) {
            return;
        }

        tooltip.innerHTML = `
            <div class="text-danger small">
                <i class="fas fa-times-circle me-1"></i>
                載入失敗
            </div>
        `;
    }

    // 重新定位 (內容改變後)
    if (currentHoveredElement === element) {
        positionTooltip(tooltip, element);
    }
}

// 隱藏 TCG tooltip
function hideTCGTTooltip(immediate = false) {
    // 清除之前的 timeout
    if (tooltipTimeout) {
        clearTimeout(tooltipTimeout);
        tooltipTimeout = null;
    }

    // 如果正在 hover tooltip，不隱藏
    if (isHoveringTooltip && !immediate) {
        return;
    }

    const hideTooltip = () => {
        const tooltip = document.getElementById('tcg-tooltip');
        if (tooltip) {
            tooltip.style.display = 'none';
        }
        currentHoveredElement = null;
    };

    if (immediate) {
        hideTooltip();
    } else {
        // 延遲隱藏，允許滑鼠移動到 tooltip 上
        tooltipTimeout = setTimeout(hideTooltip, 200);
    }
}

// 從 JIRA 取得 ticket 資訊
async function fetchJIRATicketInfo(tcgNumber) {
    try {
        // 使用 API 端點取得 ticket 資訊
        const response = await window.AuthClient.fetch(`/api/jira/ticket/${tcgNumber}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            console.log('JIRA API 回應資料:', data); // 除錯用
            return data;
        } else if (response.status === 404) {
            // Ticket 不存在
            console.log('Ticket 不存在:', tcgNumber);
            return null;
        } else {
            // 其他錯誤
            console.error('JIRA API 錯誤:', response.status, response.statusText);
            return null;
        }
    } catch (error) {
        console.error('取得 JIRA ticket 資訊失敗:', error);
        return null;
    }
}

// 格式化 ticket tooltip 內容
function formatTicketTooltip(tcgNumber, ticketData) {
    // API 回應格式：資料直接在根層級
    const summary = ticketData.summary || '無標題';
    const status = ticketData.status?.name || '未知狀態';
    const assignee = ticketData.assignee?.displayName || '未指派';
    const created = ticketData.created || '';
    const updated = ticketData.updated || '';

    // 格式化建立時間
    let createdDate = '未知';
    if (created) {
        try {
            const date = new Date(created);
            createdDate = date.toLocaleDateString('zh-TW');
        } catch (e) {
            console.warn('日期解析錯誤:', e);
        }
    }

    // 格式化更新時間
    let updatedDate = '';
    if (updated) {
        try {
            const date = new Date(updated);
            updatedDate = date.toLocaleDateString('zh-TW');
        } catch (e) {
            console.warn('更新日期解析錯誤:', e);
        }
    }

    // 取得翻譯文字
    const statusLabel = window.i18n ? window.i18n.t('common.status') : '狀態';
    const assigneeLabel = window.i18n ? window.i18n.t('common.assignee') : '執行者';

    // 日期標籤：使用翻譯系統
    const createdLabel = window.i18n ? window.i18n.t('common.createDate') : '建立';
    const updatedLabel = window.i18n ? window.i18n.t('common.updateDate') : '更新';
    const noDataText = window.i18n ? window.i18n.t('common.noDescription') : '無';

    // 組合 JIRA URL
    const jiraUrl = ticketData.url || `https://jira.example.com/browse/${tcgNumber}`;
    
    return `
        <div class="tcg-tooltip-content">
            <div class="mb-2">
                <div class="fw-bold">
                    <a href="${jiraUrl}" target="_blank" class="text-primary text-decoration-none" style="cursor: pointer;">
                        ${tcgNumber}
                        <i class="fas fa-external-link-alt ms-1" style="font-size: 0.8em;"></i>
                    </a>
                </div>
                <div class="small text-muted mb-2" style="word-break: break-word; line-height: 1.3;">${summary}</div>
            </div>
            <div class="row g-2">
                <div class="col-6">
                    <div class="small">
                        <i class="fas fa-tasks me-1"></i>
                        <strong>${statusLabel}:</strong>
                    </div>
                    <div class="small text-muted">${status}</div>
                </div>
                <div class="col-6">
                    <div class="small">
                        <i class="fas fa-user me-1"></i>
                        <strong>${assigneeLabel}:</strong>
                    </div>
                    <div class="small text-muted" style="word-break: break-word;">${assignee}</div>
                </div>
                <div class="col-6">
                    <div class="small">
                        <i class="fas fa-calendar me-1"></i>
                        <strong>${createdLabel}:</strong>
                    </div>
                    <div class="small text-muted">${createdDate}</div>
                </div>
                <div class="col-6">
                    <div class="small">
                        <i class="fas fa-clock me-1"></i>
                        <strong>${updatedLabel}:</strong>
                    </div>
                    <div class="small text-muted">${updatedDate || noDataText}</div>
                </div>
            </div>
        </div>
    `;
}

// 定位 tooltip
function positionTooltip(tooltip, element) {
    const rect = element.getBoundingClientRect();
    const tooltipRect = tooltip.getBoundingClientRect();

    // 預設位置：元素上方
    let top = rect.top - tooltipRect.height - 8;
    let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);

    // 如果上方空間不足，顯示在元素下方
    if (top < 8) {
        top = rect.bottom + 8;
    }

    // 確保不超出視窗邊界
    if (left < 8) {
        left = 8;
    } else if (left + tooltipRect.width > window.innerWidth - 8) {
        left = window.innerWidth - tooltipRect.width - 8;
    }

    tooltip.style.top = top + 'px';
    tooltip.style.left = left + 'px';
}

// 初始化 TCG hover 功能
function initializeTCGHover() {
    // 防止重複初始化
    if (isInitialized) {
        return;
    }
    isInitialized = true;

    // TCG tag hover 事件處理
    document.addEventListener('mouseover', function(e) {
        // 檢查是否是 TCG tag 或其子元素
        const tcgTag = e.target.closest('.tcg-tag');
        if (tcgTag) {
            const tcgNumber = tcgTag.textContent.trim();
            if (tcgNumber && !isHoveringTooltip) {
                showTCGTTooltip(tcgNumber, tcgTag);
            }
        }

        // 檢查是否移到 tooltip 上
        if (e.target.closest('#tcg-tooltip')) {
            isHoveringTooltip = true;
            if (tooltipTimeout) {
                clearTimeout(tooltipTimeout);
                tooltipTimeout = null;
            }
        }
    });

    document.addEventListener('mouseout', function(e) {
        // 檢查是否離開 TCG tag
        const tcgTag = e.target.closest('.tcg-tag');
        if (tcgTag && !e.relatedTarget?.closest('.tcg-tag')) {
            // 確保沒有移到其他 TCG tag 上
            setTimeout(() => {
                if (!isHoveringTooltip && !document.querySelector('.tcg-tag:hover')) {
                    hideTCGTTooltip();
                }
            }, 50);
        }

        // 檢查是否離開 tooltip
        if (e.target.closest('#tcg-tooltip') && !e.relatedTarget?.closest('#tcg-tooltip')) {
            isHoveringTooltip = false;
            // 延遲檢查是否需要隱藏 tooltip
            setTimeout(() => {
                if (!isHoveringTooltip && !document.querySelector('.tcg-tag:hover')) {
                    hideTCGTTooltip();
                }
            }, 100);
        }
    });

    // 點擊其他地方時隱藏 tooltip
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.tcg-tag') && !e.target.closest('#tcg-tooltip')) {
            hideTCGTTooltip(true);
        }
    });

    console.log('TCG hover tooltip initialized');
}

// 清理函數
function cleanupTCGHover() {
    const tooltip = document.getElementById('tcg-tooltip');
    if (tooltip) {
        tooltip.remove();
    }

    if (tooltipTimeout) {
        clearTimeout(tooltipTimeout);
        tooltipTimeout = null;
    }

    currentHoveredElement = null;
    isHoveringTooltip = false;
}

// Modal 中的 TCG 預覽函數 - 獨立實現
async function showTCGPreviewForModal() {
    console.log('showTCGPreviewForModal called'); // 調試用
    
    const tcgInput = document.getElementById('tcg');
    if (!tcgInput || !tcgInput.value.trim()) {
        alert(window.i18n ? window.i18n.t('errors.noTCGNumber') : '請先輸入 TCG 編號');
        return;
    }
    
    const tcgNumber = tcgInput.value.trim();
    console.log('TCG Number:', tcgNumber); // 調試用
    
    // 移除現有的 tooltip（如果有的話）
    const existingTooltip = document.getElementById('modal-jira-tooltip');
    if (existingTooltip) {
        existingTooltip.remove();
    }
    
    // 創建新的 tooltip
    const tooltip = document.createElement('div');
    tooltip.id = 'modal-jira-tooltip';
    tooltip.style.cssText = `
        position: fixed;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        padding: 12px;
        max-width: 300px;
        z-index: 1080;
        display: block;
        font-size: 0.875rem;
        pointer-events: auto;
    `;

    // 設定載入狀態
    tooltip.innerHTML = `
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span>載入中...</span>
        </div>
    `;

    document.body.appendChild(tooltip);
    
    // 定位 tooltip
    const rect = tcgInput.getBoundingClientRect();
    let top = rect.top - tooltip.offsetHeight - 8;
    let left = rect.left + (rect.width / 2) - (tooltip.offsetWidth / 2);
    
    // 確保不超出視窗邊界
    if (top < 8) {
        top = rect.bottom + 8;
    }
    if (left < 8) {
        left = 8;
    } else if (left + tooltip.offsetWidth > window.innerWidth - 8) {
        left = window.innerWidth - tooltip.offsetWidth - 8;
    }
    
    tooltip.style.top = top + 'px';
    tooltip.style.left = left + 'px';

    try {
        // 從 JIRA 取得 ticket 資訊
        const response = await window.AuthClient.fetch(`/api/jira/ticket/${tcgNumber}`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
            const ticketData = await response.json();
            console.log('JIRA 資料:', ticketData); // 調試用
            
            // 格式化 tooltip 內容
            const summary = ticketData.summary || '無標題';
            const status = ticketData.status?.name || '未知狀態';
            const assignee = ticketData.assignee?.displayName || '未指派';
            const created = ticketData.created || '';
            const updated = ticketData.updated || '';

            // 格式化日期
            let createdDate = '未知';
            let updatedDate = '';
            if (created) {
                try {
                    createdDate = new Date(created).toLocaleDateString('zh-TW');
                } catch (e) {}
            }
            if (updated) {
                try {
                    updatedDate = new Date(updated).toLocaleDateString('zh-TW');
                } catch (e) {}
            }

            const jiraUrl = ticketData.url || `https://jira.example.com/browse/${tcgNumber}`;
            
            tooltip.innerHTML = `
                <div class="jira-tooltip-content">
                    <div class="mb-2">
                        <div class="fw-bold">
                            <a href="${jiraUrl}" target="_blank" class="text-primary text-decoration-none" style="cursor: pointer;">
                                ${tcgNumber}
                                <i class="fas fa-external-link-alt ms-1" style="font-size: 0.8em;"></i>
                            </a>
                        </div>
                        <div class="small text-muted mb-2" style="word-break: break-word; line-height: 1.3;">${summary}</div>
                    </div>
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="small">
                                <i class="fas fa-tasks me-1"></i>
                                <strong>狀態:</strong>
                            </div>
                            <div class="small text-muted">${status}</div>
                        </div>
                        <div class="col-6">
                            <div class="small">
                                <i class="fas fa-user me-1"></i>
                                <strong>執行者:</strong>
                            </div>
                            <div class="small text-muted" style="word-break: break-word;">${assignee}</div>
                        </div>
                        <div class="col-6">
                            <div class="small">
                                <i class="fas fa-calendar me-1"></i>
                                <strong>建立:</strong>
                            </div>
                            <div class="small text-muted">${createdDate}</div>
                        </div>
                        <div class="col-6">
                            <div class="small">
                                <i class="fas fa-clock me-1"></i>
                                <strong>更新:</strong>
                            </div>
                            <div class="small text-muted">${updatedDate || '無'}</div>
                        </div>
                    </div>
                </div>
            `;
        } else {
            tooltip.innerHTML = `
                <div class="text-muted small">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    無法取得 ${tcgNumber} 的資訊
                </div>
            `;
        }
    } catch (error) {
        console.error('JIRA 請求失敗:', error);
        tooltip.innerHTML = `
            <div class="text-danger small">
                <i class="fas fa-times-circle me-1"></i>
                載入失敗
            </div>
        `;
    }
    
    // 點擊其他地方關閉
    const closeHandler = function(e) {
        if (!tooltip.contains(e.target) && e.target !== tcgInput) {
            tooltip.remove();
            document.removeEventListener('click', closeHandler);
        }
    };
    
    setTimeout(() => {
        document.addEventListener('click', closeHandler);
    }, 100);
    
    // 自動隱藏
    setTimeout(() => {
        if (tooltip && tooltip.parentNode) {
            tooltip.remove();
            document.removeEventListener('click', closeHandler);
        }
    }, 8000);
}

// 頁面載入完成後初始化
document.addEventListener('DOMContentLoaded', function() {
    initializeTCGHover();
});

// 頁面卸載時清理
window.addEventListener('beforeunload', function() {
    cleanupTCGHover();
});

// 動態內容更新時重新初始化
document.addEventListener('dynamicContentLoaded', function() {
    // 重新初始化，但不清理由有的事件監聽器
    const tooltip = document.getElementById('tcg-tooltip');
    if (tooltip) {
        tooltip.remove();
    }
    currentHoveredElement = null;
    isHoveringTooltip = false;
});

    document.addEventListener('mouseout', function(e) {
        if (e.target.classList.contains('tcg-tag')) {
            hideTCGTTooltip();
        }
    });

    // 當滑鼠移到 tooltip 上時，不要隱藏
    document.addEventListener('mouseover', function(e) {
        if (e.target.closest('#tcg-tooltip')) {
            if (tooltipTimeout) {
                clearTimeout(tooltipTimeout);
                tooltipTimeout = null;
            }
        }
    });

    // 當滑鼠離開 tooltip 時，隱藏
    document.addEventListener('mouseout', function(e) {
        if (e.target.closest('#tcg-tooltip')) {
            hideTCGTTooltip();
        }
    });

// 頁面載入完成後初始化
document.addEventListener('DOMContentLoaded', function() {
    initializeTCGHover();
});

// 動態內容更新時重新初始化
document.addEventListener('dynamicContentLoaded', function() {
    initializeTCGHover();
});

// ===== 參考測試案例功能 (彈窗版本) =====
function openReferenceTestCasePopup() {
    try {
        const currentTeam = AppUtils.getCurrentTeam();
        if (!currentTeam || !currentTeam.id) {
            const teamErrorMsg = window.i18n ? 
                window.i18n.t('errors.noTeamSelected', {}, '請先選擇團隊') : 
                '請先選擇團隊';
            showError(teamErrorMsg);
            return;
        }
        
        const popupUrl = `/test-case-reference?team_id=${currentTeam.id}`;
        const popupFeatures = 'width=1400,height=900,scrollbars=yes,resizable=yes,menubar=no,toolbar=no,location=no,status=no';
        const popupWindow = window.open(popupUrl, 'referenceTestCase', popupFeatures);
        
        if (!popupWindow) {
            const popupErrorMsg = window.i18n ? 
                window.i18n.t('errors.popupBlocked', {}, '彈窗被阻擋，請允許彈窗後再試') : 
                '彈窗被阻擋，請允許彈窗後再試';
            showError(popupErrorMsg);
            return;
        }
        
        // 焦點到彈窗
        if (popupWindow.focus) {
            popupWindow.focus();
        }
        
    } catch (error) {
        console.error('開啟參考測試案例彈窗失敗:', error);
        const openErrorMsg = window.i18n ? 
            window.i18n.t('testCase.referenceTestCaseError', {}, '開啟參考測試案例失敗') : 
            '開啟參考測試案例失敗';
        showError(openErrorMsg + ': ' + error.message);
    }
}
</script>
{% endblock %}
