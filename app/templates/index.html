{% extends "base.html" %}

{% block title %}首頁 - Test Case Repository Web Tool{% endblock %}

<!-- 覆寫頁面標題 -->
{% block page_title_text %}<span data-i18n="navigation.title">Test Case Repository</span>{% endblock %}
{% block page_subtitle_text %}<span data-i18n="navigation.subtitle">選擇團隊開始管理測試案例</span>{% endblock %}
{% block page_actions %}
<a href="/team-management" class="btn btn-outline-primary">
    <i class="fas fa-cog me-2"></i><span data-i18n="navigation.teamSettings">團隊設定</span>
</a>
{% endblock %}

{% block content %}
<div class="container-fluid">

    <!-- 載入狀態 -->
    <div id="loading-state" class="text-center py-5" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden" data-i18n="common.loading">載入中...</span>
        </div>
        <div class="mt-3 text-muted" data-i18n="messages.loadingTeams">載入團隊資料中...</div>
    </div>

    <!-- 團隊列表區域 -->
    <div id="teams-section">
        <!-- 將由 JavaScript 動態載入 -->
    </div>

    <!-- 無團隊時的提示區域 -->
    <div id="no-teams-section" style="display: none;">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-4">
                <div class="card text-center add-team-card" onclick="goToTeamManagement()" style="cursor: pointer;">
                    <div class="card-body py-5">
                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 64px; height: 64px; font-size: 24px;">
                            <i class="fas fa-plus"></i>
                        </div>
                        <h5 class="text-primary mb-2" data-i18n="team.createFirstTeam">新增第一個團隊</h5>
                        <p class="text-muted small mb-0" data-i18n="team.createFirstTeamHint">
                            建立團隊並設定 Lark 資料來源
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 有團隊時的列表區域 -->
    <div id="teams-list" style="display: none;">
        <div class="row" id="teams-container">
            <!-- 團隊卡片和新增團隊卡片將在此處動態生成 -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let teams = [];

document.addEventListener('DOMContentLoaded', function() {
    loadTeams();
});

async function loadTeams() {
    try {
        showLoading();
        
        const response = await fetch('/api/teams/');
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        teams = await response.json();
        renderTeams();
        
    } catch (error) {
        console.error('載入團隊失敗:', error);
        const errorMsg = window.i18n ? window.i18n.t('messages.loadFailed') : '載入失敗';
        AppUtils.showError(errorMsg + '：' + error.message);
        showNoTeams();
    } finally {
        hideLoading();
    }
}

function renderTeams() {
    if (!teams || teams.length === 0) {
        showNoTeams();
        return;
    }
    
    showTeamsList();
    renderTeamCards();
}

function showLoading() {
    document.getElementById('loading-state').style.display = 'block';
    document.getElementById('teams-section').style.display = 'none';
}

function hideLoading() {
    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('teams-section').style.display = 'block';
}

function showNoTeams() {
    document.getElementById('no-teams-section').style.display = 'block';
    document.getElementById('teams-list').style.display = 'none';
}

function showTeamsList() {
    document.getElementById('no-teams-section').style.display = 'none';
    document.getElementById('teams-list').style.display = 'block';
}

function renderTeamCards() {
    const container = document.getElementById('teams-container');
    
    // 現有團隊卡片
    const teamsHtml = teams.map(team => `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 team-card">
                <div class="card-body">
                    <div class="d-flex align-items-start mb-3">
                        <div class="flex-shrink-0 me-3">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                 style="width: 48px; height: 48px; font-size: 18px; font-weight: bold;">
                                ${getTeamInitials(team.name)}
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="card-title text-primary mb-1">${escapeHtml(team.name)}</h5>
                            <p class="card-text text-muted small mb-0">
                                ${escapeHtml(team.description || (window.i18n ? window.i18n.t('common.noDescription') : '無描述'))}
                            </p>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted">
                            <i class="fas fa-table me-1"></i>${window.i18n ? window.i18n.t('team.linked') : '已連結 Lark 資料源'}
                        </small>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" onclick="event.stopPropagation(); selectTeamForTestCases(${team.id})">
                            <i class="fas fa-list-check me-2"></i>${window.i18n ? window.i18n.t('navigation.testCaseManagement') : 'Test Case 管理'}
                        </button>
                        <button class="btn btn-secondary" onclick="event.stopPropagation(); selectTeamForTestRuns(${team.id})">
                            <i class="fas fa-play-circle me-2"></i>${window.i18n ? window.i18n.t('navigation.testRunManagement') : 'Test Run 管理'}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    // 新增團隊卡片
    const addTeamCard = `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 add-team-card text-center" onclick="goToTeamManagement()" style="cursor: pointer;">
                <div class="card-body d-flex flex-column justify-content-center">
                    <div class="text-primary rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                         style="width: 48px; height: 48px; font-size: 18px; border: 2px dashed var(--tr-primary);">
                        <i class="fas fa-plus"></i>
                    </div>
                    <h6 class="text-primary mb-1">${window.i18n ? window.i18n.t('team.addMoreTeams') : '新增更多團隊'}</h6>
                    <small class="text-muted">${window.i18n ? window.i18n.t('team.addMoreTeamsHint') : '建立新的團隊專案'}</small>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = teamsHtml + addTeamCard;
    
    // Retranslate the newly added content
    if (window.i18n && window.i18n.isReady()) {
        window.i18n.retranslate();
    }
}

function selectTeamForTestCases(teamId) {
    const team = teams.find(t => t.id === teamId);
    if (!team) return;
    
    // 儲存選擇的團隊
    if (AppUtils && AppUtils.setCurrentTeam) {
        AppUtils.setCurrentTeam(team);
        const successMsg = window.i18n ? 
            window.i18n.t('team.navigateToTestCases', {name: team.name}) : 
            `已選擇團隊：${team.name} - 進入測試案例管理`;
        AppUtils.showSuccess(successMsg);
        
        // 跳轉到測試案例管理
        setTimeout(() => {
            window.location.href = '/test-case-management';
        }, 500);
    }
}

function selectTeamForTestRuns(teamId) {
    const team = teams.find(t => t.id === teamId);
    if (!team) return;
    
    // 儲存選擇的團隊
    if (AppUtils && AppUtils.setCurrentTeam) {
        AppUtils.setCurrentTeam(team);
        const successMsg = window.i18n ? 
            window.i18n.t('team.navigateToTestRuns', {name: team.name}) : 
            `已選擇團隊：${team.name} - 進入測試執行管理`;
        AppUtils.showSuccess(successMsg);
        
        // 跳轉到測試執行管理
        setTimeout(() => {
            window.location.href = '/test-run-management';
        }, 500);
    }
}

function goToTeamManagement() {
    window.location.href = '/team-management';
}

function getTeamInitials(name) {
    if (!name) return 'T';
    
    return name
        .split(' ')
        .map(word => word.charAt(0).toUpperCase())
        .slice(0, 2)
        .join('');
}

function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

// 添加團隊卡片 hover 效果
document.addEventListener('DOMContentLoaded', function() {
    // CSS hover 效果將通過樣式表定義
});

// 更新頁面標題翻譯
function updatePageTitle() {
    const pageTitle = window.i18n ? window.i18n.t('common.home') : '首頁';
    const siteTitle = window.i18n ? window.i18n.t('navigation.title') : 'Test Case Repository';
    document.title = `${pageTitle} - ${siteTitle} Web Tool`;
}

// 監聽 i18n 初始化和語言變更事件
document.addEventListener('i18nReady', updatePageTitle);
document.addEventListener('languageChanged', updatePageTitle);
</script>

<style>
.team-card {
    transition: all 0.2s ease;
    border: 1px solid var(--tr-border-light);
}

.team-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--tr-shadow-md);
    border-color: var(--tr-primary);
}

.team-card:hover .card-title {
    color: var(--tr-primary-dark) !important;
}

.add-team-card {
    transition: all 0.2s ease;
    border: 1px solid var(--tr-border-light);
}

.add-team-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--tr-shadow-md);
    border-color: var(--tr-primary);
}

.add-team-card:hover h5,
.add-team-card:hover h6 {
    color: var(--tr-primary-dark) !important;
}

.add-team-card:hover .fas {
    color: var(--tr-primary-dark) !important;
}
</style>
{% endblock %}