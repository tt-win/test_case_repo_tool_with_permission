# Role-Based 權限管理系統 - 需求規格書

## 專案概述

為現有的測試案例管理系統（Test Case Repository Web Tool）加入 role-based 權限管理功能，實現獨立帳號系統與多層級權限控制。

## 核心需求

### 1. 權限角色定義

#### 1.1 Viewer（檢視者）
- **權限範圍**：只能檢視自己團隊及被授權團隊的資料
- **可執行操作**：
  - 檢視 Test Case
  - 檢視 Test Run
  - 檢視 Team 基本資訊（不含設定）
- **限制**：無任何修改、新增、刪除權限

#### 1.2 User（使用者）
- **權限範圍**：自己團隊及被授權團隊的資料 CRUD
- **可執行操作**：
  - Test Case 的完整 CRUD 操作
  - Test Run 的完整 CRUD 操作
  - 檢視 Team 基本資訊
- **限制**：不能修改 Team 設定、不能管理團隊成員

#### 1.3 Admin（團隊管理員）
- **權限範圍**：擁有 User 權限 + 團隊管理權限
- **可執行操作**：
  - 繼承 User 的所有權限
  - Team 設定的完整管理
  - 團隊成員管理（新增、移除、變更角色）
  - 管理密碼功能
  - 檢視自己團隊的 Audit 記錄
- **授權範圍**：自己團隊及被授權團隊

#### 1.4 Super Admin（超級管理員）
- **權限範圍**：系統所有權限
- **可執行操作**：
  - 系統所有功能的完整權限
  - 使用隱藏模式
  - 管理密碼功能
  - 檢視所有團隊的 Audit 記錄
  - 強制踢掉線上使用者
  - 跨團隊管理權限

### 2. 帳號系統架構

#### 2.1 認證機制
- **類型**：獨立帳號系統，不依靠第三方 OAuth
- **協議**：HTTP Only（無 HTTPS 需求）
- **Token 設計**：
  - JWT 或類似機制
  - 有效期：1 週
  - 包含角色資訊與團隊權限

#### 2.2 與現有系統整合
- **Team**：必須與 Lark Department 連動
- **User**：必須與 Lark User 連動
- **同步機制**：沿用現有的 TCG Ticket、Department、User 同步功能

### 3. 審計系統（Audit）

#### 3.1 審計資料庫
- **儲存位置**：獨立於 test_case_repo.db 的 audit.db
- **記錄範圍**：
  - Team Setting CRUD 操作
  - Test Run CRUD 操作
  - Test Case CRUD 操作

#### 3.2 審計記錄結構
- **必要欄位**：
  - 操作時間（timestamp）
  - 操作者（user_id）
  - 操作類型（action_type: CREATE/READ/UPDATE/DELETE）
  - 資源類型（resource_type: team_setting/test_run/test_case）
  - 資源 ID（resource_id）
  - 操作詳情（details: JSON 格式）
  - 團隊 ID（team_id）

#### 3.3 審計查詢功能
- **權限控制**：
  - Admin：僅能檢視自己團隊的記錄
  - Super Admin：可檢視所有團隊記錄
- **搜尋功能**：
  - 按時間範圍搜尋
  - 按操作者搜尋
  - 按操作類型搜尋
  - 按資源類型搜尋
  - 關鍵字搜尋

### 4. 安全性要求

#### 4.1 存取控制
- **外部存取**：所有資源都需受權限管制
- **API 保護**：所有 API 端點都需驗證 Token 與權限
- **前端保護**：頁面元素根據權限動態顯示/隱藏

#### 4.2 會話管理
- **Token 生命週期**：1 週
- **強制登出**：Super Admin 可踢掉指定使用者
- **自動登出**：Token 過期自動重導向登入頁

### 5. 功能需求

#### 5.1 登入系統
- **登入頁面**：使用者名稱/密碼登入
- **密碼管理**：Admin 與 Super Admin 可重設密碼
- **記住登入**：Token 儲存機制

#### 5.2 權限管理介面
- **使用者管理**：Admin 可管理團隊成員角色
- **權限授予**：跨團隊權限授予機制
- **密碼重設**：管理員密碼重設功能

#### 5.3 審計介面
- **審計日誌頁面**：表格形式展示操作記錄
- **搜尋介面**：多條件搜尋功能
- **匯出功能**：CSV 格式匯出審計記錄

## 非功能性需求

### 效能需求
- 權限檢查響應時間 < 100ms
- 審計記錄寫入不影響主要操作效能
- Token 驗證快取機制

### 相容性需求
- 與現有 Lark 同步功能完全相容
- 現有 API 結構保持不變，僅加入權限檢查
- 前端 UI 保持一致性

### 維護性需求
- 權限規則易於擴展
- 審計資料易於備份與還原
- 清楚的權限錯誤訊息

## 限制條件

1. HTTP Only 環境，無 HTTPS 加密
2. 不使用第三方 OAuth 服務
3. 必須與現有 Lark 整合保持相容
4. 審計資料庫獨立儲存
5. 不影響現有功能的正常運作

## 驗收標準

1. 四種角色權限正確實作且互不衝突
2. 所有 API 端點都有權限保護
3. 審計功能完整記錄指定操作
4. Super Admin 可成功踢掉線上使用者
5. 權限錯誤時有清楚的錯誤訊息
6. 與現有 Lark 同步功能無衝突
7. 系統效能不因權限檢查而明顯下降